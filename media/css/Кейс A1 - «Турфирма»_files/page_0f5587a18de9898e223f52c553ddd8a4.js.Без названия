
; /* Start:"a:4:{s:4:"full";s:84:"/local/components/micros/knowledge.base/templates/.default/script.js?151332154410509";s:6:"source";s:68:"/local/components/micros/knowledge.base/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
$(document).on('click', '.btn-kb-edit, .btn-kb-add', function() {
	var elementID = $(this).data('element-id');
	var isAdd = (elementID > 0 ? false : true);
	var addedElementID = $(this).data('element');
	var saveUrl = (isAdd ? location.pathname + '/?add_element=Y&ajax_knowledge=Y' + '&sessid=' + BX.bitrix_sessid() : location.pathname + '/?save=Y&ajax_knowledge=Y' + '&sessid=' + BX.bitrix_sessid());
	if(elementID) {
		saveUrl += '&ELEMENT_ID=' + elementID;
	}

	var slide = BX.Bitrix24.Slider;
	var slideOpen = slide.open((isAdd ? location.pathname + '?add=Y&ajax_knowledge=Y&clear_cache=Y&addedElementID=' + addedElementID + '&elementID=' + elementID + '&IFRAME=Y' + '&IFRAME_TYPE=SIDE_SLIDER' + '&sessid=' + BX.bitrix_sessid() : location.pathname + '?edit=Y&ajax_knowledge=Y&clear_cache=Y&elementID=' + elementID + '&IFRAME=Y' + '&IFRAME_TYPE=SIDE_SLIDER' + '&sessid=' + BX.bitrix_sessid()), {});
	
	function getSaveAjax () {
		var formData = new FormData($('#kb-form').get(0));
		
	    $.ajax({
	        url: saveUrl,
	        type: 'POST',
	        data: formData,
	        async: false,
	        success: function (data) {
	        	location.href = data;
	        },
	        cache: false,
	        contentType: false,
	        processData: false
	    });
	}
	function getEditAjax (popup) {
		BX.ajax({
			url: (isAdd ? location.pathname + '?add=Y&ajax_knowledge=Y&addedElementID=' + addedElementID + '&elementID=' + elementID + '&IFRAME=Y' + '&IFRAME_TYPE=SIDE_SLIDER' + '&sessid=' + BX.bitrix_sessid() : location.pathname + '?edit=Y&ajax_knowledge=Y&elementID=' + elementID + '&IFRAME=Y' + '&IFRAME_TYPE=SIDE_SLIDER' + '&sessid=' + BX.bitrix_sessid()),
			method: 'GET',
			onsuccess: function(data){
				if (data) {
					popup.setContent(data);
					var editor = editormd("editor", {
					    path: "/local/components/micros/knowledge.base/lib/",
					});
				}
			}
		});
	}

});

// модальное окно для удаления страницы
function DeleteElementKB (id, issetChild) {
	var elementID = id;
	if(issetChild == 'Y'){
		var Confirmer = new BX.PopupWindow("delete_elemeny-confirm", null, {
		     content: '<div id="mainshadow"></div>'+'<h2 class="title-confrim-delete-kb">Данную страницу удалить нельзя, <br /> она имеет дочерние разделы, <br /> предварительно требуется удалить их.</h2>',
		     closeIcon: {right: "0px", top: "0px"},
		     zIndex: 0,
		     offsetLeft: 0,
		     offsetTop: 0,
		     draggable: {restrict: false},
		     overlay: {backgroundColor: 'black', opacity: '80' },  /* затемнение фона */
		     buttons: [
		      new BX.PopupWindowButton({
		          text: "Отмена",
		          
		          events: {click: function(){
		        	  this.popupWindow.close();
		          }}
		      })
		     ]
		 });
	}else{
		var Confirmer = new BX.PopupWindow("delete_elemeny-confirm", null, {
		     content: '<div id="mainshadow"></div>'+'<h2 class="title-confrim-delete-kb">Вы действительно хотите<br /> удалить страницу?</h2>',
		     closeIcon: {right: "0px", top: "0px"},
		     zIndex: 0,
		     offsetLeft: 0,
		     offsetTop: 0,
		     draggable: {restrict: false},
		     overlay: {backgroundColor: 'black', opacity: '80' },  /* затемнение фона */
		     buttons: [
		      new BX.PopupWindowButton({
		          text: "Удалить",
		          className: "delete-confrim-kb",
		          events: {click: function(){
		        	  	var me = this;
		        		var deleteUrl = location.pathname + '?delete_element=Y&ajax_knowledge=Y' + '&sessid=' + BX.bitrix_sessid();
		        		if(elementID) {
		        		    deleteUrl += '&ELEMENT_ID=' + elementID;
		        		    $.get(deleteUrl, function (result) {
		        		    	if(result)
		        		    		result = JSON.parse(result);
		        		    	if(result.success) {
		        		    		location.href = result.url;
		        		    	} else {
		        		    		me.buttonNode.remove();
		        		    		Confirmer.setContent('<div id="mainshadow"></div>'+'<h2 class="title-confrim-delete-kb">' + result.err + '</h2>');
		        		    	}
		        		    });
		        		}
		          }}
		      }),
		      new BX.PopupWindowButton({
		          text: "Отмена",
		          
		          events: {click: function(){
		        	  this.popupWindow.close();
		          }}
		      })
		     ]
		 });
	}
	Confirmer.show();
}

//скопировать ссылку
function copyToClipboard(text) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val(text).select();
    document.execCommand("copy");
    $temp.remove();
}

$(document).on('click', '#copyLinkToClipboard', function() {
	copyToClipboard($('.kb-short-link input').val())
});

// окно для публичной и внутренной ссылки
function copyPublicLink(id, isInternal) {
	var publicLinkWindow = new BX.PopupWindow(
		'publicLinkWindow',
		null,
		{
			overlay: {opacity: 10},
			autoHide: false,
			draggable: true,
			bindOptions: { forceBindPosition: false },
			closeByEsc: true,
			closeIcon: { top: '10px', right: '15px' },
			titleBar: (isInternal)?('Скопировать внутреннюю ссылку'):('Публичная ссылка'),
			events:
			{
				onPopupShow: function()
				{
					BX.ajax({
						url: (isInternal)?(location.pathname + '?internal_id=' + id + '&sessid=' + BX.bitrix_sessid()):(location.pathname + '?public_id=' + id + '&sessid=' + BX.bitrix_sessid()),
						method: 'GET',
						onsuccess: function(data){
							if (data) {
								publicLinkWindow.setContent(data);
								$('input[name="UF_KB_NAME"]').focus().select();
							}
						}
					});
				},
				onPopupSave: function()
				{
					
				},
				onPopupClose: BX.delegate(
					function()
					{
						publicLinkWindow.destroy();
					},
					this
				),
				onPopupDestroy: BX.delegate(
					function()
					{
						delete(publicLinkWindow);
					},
					publicLinkWindow
				)
			},
			content: '<div class="kb-short-link">Загрузка...</div>',
			"buttons": [
				new BX.PopupWindowButton(
					{
						"text": 'Закрыть',
						"events":
						{
							"click": function(){
								publicLinkWindow.destroy();
							}
						}
					}
				)
			]
		}
	);
	publicLinkWindow.show();
	var menu = BX.PopupMenu.getMenuById('settings_disk');
	if(menu && menu.popupWindow)
	{
		if(menu.popupWindow.isShown())
		{
			BX.PopupMenu.destroy('settings_disk');
			return;
		}
	}
}
//копировать ссылку
function copyInternalLink(id){
	copyPublicLink(id, true);
}

//окно для ссылки файла
function copyFileLink(id, link) {
	var fileLinkWindow = new BX.PopupWindow(
		'fileLinkWindow',
		null,
		{
			overlay: {opacity: 10},
			autoHide: false,
			draggable: true,
			bindOptions: { forceBindPosition: false },
			closeByEsc: true,
			closeIcon: { top: '10px', right: '15px' },
			titleBar: 'Скопировать ссылку файла',
			events:
			{
				onPopupShow: function()
				{
					var x = document.createElement("INPUT");
					x.setAttribute("type", "text");
					x.setAttribute("value", window.location.origin + link);
					x.setAttribute("name", 'FILE_LINK');
					x.setAttribute("class", "kb-edit-input focus_input");
					fileLinkWindow.setContent(x);
					$(document).ready(function() {
					    $('input[name="FILE_LINK"]').focus(function() { $(this).select(); } );
					});
					
					
				},
				onPopupSave: function()
				{
					
				},
				onPopupClose: BX.delegate(
					function()
					{
						fileLinkWindow.destroy();
					},
					this
				),
				onPopupDestroy: BX.delegate(
					function()
					{
						delete(fileLinkWindow);
					},
					fileLinkWindow
				)
			},
			content: '<div class="kb-short-link">' + 'Загрузка' + '...</div>',
			"buttons": [
				new BX.PopupWindowButton(
					{
						"text": 'Закрыть',
						"events":
						{
							"click": function(){
								fileLinkWindow.destroy();
							}
						}
					}
				)
			]
		}
	);
	fileLinkWindow.show();
	var menu = BX.PopupMenu.getMenuById('settings_disk');
	if(menu && menu.popupWindow)
	{
		if(menu.popupWindow.isShown())
		{
			BX.PopupMenu.destroy('settings_disk');
			return;
		}
	}
}


//название файла
$(document).on('change', '.adm-input-file input[type="file"]', function(){
	$(this).parent().parent().find('.adm-input-file-desc').addClass('adm-input-file-show-desc');
});

//Сделать главной страницей
$(document).on('click', '.make_main_section', function(){
	var elID = $(this).data('element-id');
	if ($(this).hasClass('make_main_section-active')) {
		$(this).removeClass('make_main_section-active').attr("title","Сделать текущую страницу главной");
		var formData = new FormData($('.make_main_section').get(0));
		var saveUrl = '/bitrix/tools/kb/main_section_ajax.php?add=N&main_section_id=' + elID;
		 $.ajax({
		        url: saveUrl,
		        type: 'POST',
		        data: formData,
		        async: false,
		        success: function (data) {
	        		var str = 'Данный раздел убрано с главной';
	        		 $('#error_message').html(str);
		             $("#error_box").fadeIn(500).delay(1000).fadeOut(500);
		        },
		        cache: false,
		        contentType: false,
		        processData: false
		    });
	} else {
		var formData = new FormData($('.make_main_section').get(0));
		var saveUrl = '/bitrix/tools/kb/main_section_ajax.php?add=Y&main_section_id=' + elID;
		$(this).addClass('make_main_section-active').attr("title","Удалить текущую старницу с главной");
		 $.ajax({
		        url: saveUrl,
		        type: 'POST',
		        data: formData,
		        async: false,
		        success: function (data) {
	        		var str = 'Данный раздел сделан главной';
	        		 $('#error_message').html(str);
		             $("#error_box").fadeIn(500).delay(1000).fadeOut(500);
		        },
		        cache: false,
		        contentType: false,
		        processData: false
		    });
	}
});

/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/local/components/micros/knowledge.breadcrumbs/templates/.default/script.min.js?14444693623353";s:6:"source";s:75:"/local/components/micros/knowledge.breadcrumbs/templates/.default/script.js";s:3:"min";s:79:"/local/components/micros/knowledge.breadcrumbs/templates/.default/script.min.js";s:3:"map";s:79:"/local/components/micros/knowledge.breadcrumbs/templates/.default/script.map.js";}"*/
BX.namespace("BX.Disk");BX.Disk.BreadcrumbsClass=function(){var t=function(t){this.containerId=t.containerId;this.collapsedCrumbs=t.collapsedCrumbs||[];this.showOnlyDeleted=t.showOnlyDeleted||0;this.container=BX(this.containerId);this.ajaxUrl="/bitrix/components/bitrix/disk.breadcrumbs/ajax.php";this.container.style.opacity=1;this.setEvents()};t.prototype.setEvents=function(){BX.bindDelegate(this.container,"click",{className:"icon-arrow"},BX.proxy(this.onClickArrow,this));BX.bind(BX("root_dots_"+this.containerId),"click",BX.proxy(this.onClickDots,this))};t.prototype.adjust=function(){var t=BX.findParent(this.container,{className:"bx-disk-interface-toolbar-container"},BX("workarea-content"));if(t){var e=BX.findChild(t,{className:"bx-disk-interface-sort"},true)}var i=this.container.offsetWidth;var a=t?t.offsetWidth:0;var r=e?e.offsetWidth:0;if(!a){return}var n=r+i;if(a>n){return}var o=BX.findChildren(this.container,{tagName:"span",className:"bx-disk-interface-bread-crumbs-item"},true);var s=o.shift();var d=o.pop();this.collapsedCrumbs=[];for(var c in o){if(r+this.container.offsetWidth-a<=0){break}if(!o.hasOwnProperty(c)){continue}var u=o[c];var l=BX.nextSibling(u);var h=0;if(BX.hasClass(l,"bx-disk-bread-crumbs-separator")){h=l.offsetWidth}else{l=null}this.collapsedCrumbs.push({text:u.getAttribute("data-objectName"),title:u.getAttribute("data-objectName"),href:u.getAttribute("data-objectParentPath")});BX.hide(u);l&&BX.hide(l)}if(r+this.container.offsetWidth-a>0){this.collapsedCrumbs.unshift({text:s.getAttribute("data-objectName"),title:s.getAttribute("data-objectName"),href:s.getAttribute("data-objectParentPath")});BX.hide(s)}BX("root_dots_"+this.containerId).style.display="inline-block";BX("root_arrow_"+this.containerId).style.display="none";BX.bind(BX("root_dots_"+this.containerId),"click",BX.proxy(this.onClickDots,this))};t.prototype.expand=function(t,e,i){var a=t.getAttribute("data-objectId");var r=t.getAttribute("data-objectParentPath");if(r=="/"){r=""}else if(r.lastIndexOf("/")==r.length-1){r=r.substr(0,r.length-1)}var n=[];for(var o in i){if(!i.hasOwnProperty(o)){continue}var s=i[o];n.push({text:s["name"],title:s["name"],href:r+"/"+encodeURIComponent(s["name"])+"/"})}BX.PopupMenu.show("disk_breadcrumbs_"+a,e,n,{autoHide:true,angle:{offset:0},events:{onPopupClose:function(){}}})};t.prototype.onClickDots=function(t){var e=t.srcElement||t.target;BX.PopupMenu.show("disk_breadcrumbs_dots",e,this.collapsedCrumbs,{autoHide:true,angle:{offset:0},events:{onPopupClose:function(){}}});BX.PreventDefault(t)};t.prototype.onClickArrow=function(t){var e=t.srcElement||t.target;var i=BX.findParent(e,{className:"bx-disk-interface-bread-crumbs-item-container"},this.container);var a=i.getAttribute("data-objectId");var r=i.getAttribute("data-isRoot");if(!a){BX.PreventDefault(t);return}var n=BX.PopupMenu.getMenuById("disk_breadcrumbs_"+a);if(n&&n.popupWindow){if(n.popupWindow.isShown()){BX.PopupMenu.destroy("disk_breadcrumbs_"+a)}else{n.popupWindow.show()}BX.PreventDefault(t);return}BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","showSubFolders"),data:{objectId:a,showOnlyDeleted:this.showOnlyDeleted?1:0,isRoot:r?1:0},onsuccess:BX.delegate(function(t){if(!t){return}this.expand(i,e,t.items)},this)});BX.PreventDefault(t)};return t}();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/local/components/micros/knowledge.base.folder.content/templates/.default/script.js?150398876020258";s:6:"source";s:83:"/local/components/micros/knowledge.base.folder.content/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
$(document).ready(function(){
	$("#edit_info").hover(
			function() {
				$("#edit_info_block").addClass('active');
			},
			function(){				
				$("#edit_info_block").removeClass("active");
			}
	);
	$("#create_info").hover(
			function() {
				$("#create_info_block").addClass('active');
			},
			function(){				
				$("#create_info_block").removeClass("active");
			}
	);
});



var markedRendererFunc = function(markdownToC, options) {
    var defaults = {
        toc                  : true,           // Table of contents
        tocm                 : false,
        tocStartLevel        : 1,              // Said from H1 to create ToC  
        pageBreak            : true,
        atLink               : true,           // for @link
        emailLink            : true,           // for mail address auto link
        taskList             : false,          // Enable Github Flavored Markdown task lists
        emoji                : true,          // :emoji: , Support Twemoji, fontAwesome, Editor.md logo emojis.
        tex                  : false,          // TeX(LaTeX), based on KaTeX
        flowChart            : true,          // flowChart.js only support IE9+
        sequenceDiagram      : false,          // sequenceDiagram.js only support IE9+
    };
    
    var settings        = $.extend(defaults, options || {});    
    var marked          = editormd.$marked;
    var markedRenderer  = new marked.Renderer();
    markdownToC         = markdownToC || [];        
        
    var regexs          = editormd.regexs;
    var atLinkReg       = regexs.atLink;
    var emojiReg        = regexs.emoji;
    var emailReg        = regexs.email;
    var emailLinkReg    = regexs.emailLink;
    var twemojiReg      = regexs.twemoji;
    var faIconReg       = regexs.fontAwesome;
    var editormdLogoReg = regexs.editormdLogo;
    var pageBreakReg    = regexs.pageBreak;

    markedRenderer.emoji = function(text) {
        
        text = text.replace(editormd.regexs.emojiDatetime, function($1) {           
            return $1.replace(/:/g, "&#58;");
        });

        var matchs = text.match(emojiReg);

        if (!matchs || !settings.emoji) {
            return text;
        }
        
        for (var i = 0, len = matchs.length; i < len; i++)
        {            
            if (matchs[i] === ":+1:") {
                matchs[i] = ":\\+1:";
            }

            text = text.replace(new RegExp(matchs[i]), function($1, $2){
                var faMatchs = $1.match(faIconReg);
                var name     = $1.replace(/:/g, "");

                if (faMatchs)
                {                        
                    for (var fa = 0, len1 = faMatchs.length; fa < len1; fa++)
                    {
                        var faName = faMatchs[fa].replace(/:/g, "");
                        
                        return "<i class=\"fa " + faName + " fa-emoji\" title=\"" + faName.replace("fa-", "") + "\"></i>";
                    }
                }
                else
                {
                    var emdlogoMathcs = $1.match(editormdLogoReg);
                    var twemojiMatchs = $1.match(twemojiReg);

                    if (emdlogoMathcs)                                        
                    {                            
                        for (var x = 0, len2 = emdlogoMathcs.length; x < len2; x++)
                        {
                            var logoName = emdlogoMathcs[x].replace(/:/g, "");
                            return "<i class=\"" + logoName + "\" title=\"Editor.md logo (" + logoName + ")\"></i>";
                        }
                    }
                    else if (twemojiMatchs) 
                    {
                        for (var t = 0, len3 = twemojiMatchs.length; t < len3; t++)
                        {
                            var twe = twemojiMatchs[t].replace(/:/g, "").replace("tw-", "");
                            return "<img src=\"" + editormd.twemoji.path + twe + editormd.twemoji.ext + "\" title=\"twemoji-" + twe + "\" alt=\"twemoji-" + twe + "\" class=\"emoji twemoji\" />";
                        }
                    }
                    else
                    {
                        var src = (name === "+1") ? "plus1" : name;
                        src     = (src === "black_large_square") ? "black_square" : src;
                        src     = (src === "moon") ? "waxing_gibbous_moon" : src;

                        return "<img src=\"" + editormd.emoji.path + src + editormd.emoji.ext + "\" class=\"emoji\" title=\"&#58;" + name + "&#58;\" alt=\"&#58;" + name + "&#58;\" />";
                    }
                }
            });
        }
        
        return text;
    };

    markedRenderer.atLink = function(text) {

        if (atLinkReg.test(text))
        { 
            if (settings.atLink) 
            {
                text = text.replace(emailReg, function($1, $2, $3, $4) {
                    return $1.replace(/@/g, "_#_&#64;_#_");
                });

                text = text.replace(atLinkReg, function($1, $2) {
                    return "<a href=\"" + editormd.urls.atLinkBase + "" + $2 + "\" title=\"&#64;" + $2 + "\" class=\"at-link\">" + $1 + "</a>";
                }).replace(/_#_&#64;_#_/g, "@");
            }
            
            if (settings.emailLink)
            {
                text = text.replace(emailLinkReg, function($1, $2, $3, $4, $5) {
                    return (!$2 && $.inArray($5, "jpg|jpeg|png|gif|webp|ico|icon|pdf".split("|")) < 0) ? "<a href=\"mailto:" + $1 + "\">"+$1+"</a>" : $1;
                });
            }

            return text;
        }

        return text;
    };
            
    markedRenderer.link = function (href, title, text) {

        if (this.options.sanitize) {
            try {
                var prot = decodeURIComponent(unescape(href)).replace(/[^\w:]/g,"").toLowerCase();
            } catch(e) {
                return "";
            }

            if (prot.indexOf("javascript:") === 0) {
                return "";
            }
        }

        var out = "<a href=\"" + href + "\"";
        
        if (atLinkReg.test(title) || atLinkReg.test(text))
        {
            if (title)
            {
                out += " title=\"" + title.replace(/@/g, "&#64;");
            }
            
            return out + "\">" + text.replace(/@/g, "&#64;") + "</a>";
        }

        if (title) {
            out += " title=\"" + title + "\"";
        }

        out += ">" + text + "</a>";

        return out;
    };
    
    markedRenderer.heading = function(text, level, raw) {
                
        var linkText       = text;
        var hasLinkReg     = /\s*\<a\s*href\=\"(.*)\"\s*([^\>]*)\>(.*)\<\/a\>\s*/;
        var getLinkTextReg = /\s*\<a\s*([^\>]+)\>([^\>]*)\<\/a\>\s*/g;

        if (hasLinkReg.test(text)) 
        {
            var tempText = [];
            text         = text.split(/\<a\s*([^\>]+)\>([^\>]*)\<\/a\>/);

            for (var i = 0, len = text.length; i < len; i++)
            {
                tempText.push(text[i].replace(/\s*href\=\"(.*)\"\s*/g, ""));
            }

            text = tempText.join(" ");
        }
        
        var trim = function(str) {
            return (!String.prototype.trim) ? str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, "") : str.trim();
        };
        
        text = trim(text);
        
        var escapedText    = text.toLowerCase().replace(/[^\w]+/g, "-");
        
        
        
        var isChinese = /^[\u4e00-\u9fa5]+$/.test(text);
        var id        = (isChinese) ? escape(text).replace(/\%/g, "") : text.toLowerCase().replace(/[^\w]+/g, "-");

        
        var toc = {
            text  : text,
            level : level,
            slug  : BX.translit(text)
        };
        markdownToC.push(toc);
        
        var headingHTML = "<h" + level + " id=\""+ BX.translit(text) + "\" >";

        headingHTML    += "<a name=\"" + text + "\" class=\"reference-link\"><i class=\"fa fa-link\" name=\"link\" unselectable=\"on\"></i></a>";
        headingHTML    += "<span class=\"header-link octicon octicon-link\"></span>";
        headingHTML    += (hasLinkReg) ? this.atLink(this.emoji(linkText)) : this.atLink(this.emoji(text));
        headingHTML    += "</h" + level + ">";

        return headingHTML;
    };
    
    markedRenderer.pageBreak = function(text) {
        if (pageBreakReg.test(text) && settings.pageBreak)
        {
            text = "<hr style=\"page-break-after:always;\" class=\"page-break editormd-page-break\" />";
        }
        
        return text;
    };

    markedRenderer.paragraph = function(text) {
        var isTeXInline     = /\$\$(.*)\$\$/g.test(text);
        var isTeXLine       = /^\$\$(.*)\$\$$/.test(text);
        var isTeXAddClass   = (isTeXLine)     ? " class=\"" + editormd.classNames.tex + "\"" : "";
        var isToC           = (settings.tocm) ? /^(\[TOC\]|\[TOCM\])$/.test(text) : /^\[TOC\]$/.test(text);
        var isToCMenu       = /^\[TOCM\]$/.test(text);
        
        if (!isTeXLine && isTeXInline) 
        {
            text = text.replace(/(\$\$([^\$]*)\$\$)+/g, function($1, $2) {
                return "<span class=\"" + editormd.classNames.tex + "\">" + $2.replace(/\$/g, "") + "</span>";
            });
        } 
        else 
        {
            text = (isTeXLine) ? text.replace(/\$/g, "") : text;
        }
        
        var tocHTML = "<div class=\"markdown-toc editormd-markdown-toc\">" + text + "</div>";
        
        return (isToC) ? ( (isToCMenu) ? "<div class=\"editormd-toc-menu\">" + tocHTML + "</div><br/>" : tocHTML )
                       : ( (pageBreakReg.test(text)) ? this.pageBreak(text) : "<p" + isTeXAddClass + ">" + this.atLink(this.emoji(text)) + "</p>\n" );
    };

    markedRenderer.code = function (code, lang, escaped) { 

        if (lang === "seq" || lang === "sequence")
        {
            return "<div class=\"sequence-diagram\">" + code + "</div>";
        } 
        else if ( lang === "flow")
        {
            return "<div class=\"flowchart\">" + code + "</div>";
        } 
        else if ( lang === "math" || lang === "latex" || lang === "katex")
        {
            return "<p class=\"" + editormd.classNames.tex + "\">" + code + "</p>";
        } 
        else 
        {

            return marked.Renderer.prototype.code.apply(this, arguments);
        }
    };
   
    markedRenderer.escapeHtml = function(unsafe) {
        return unsafe
             .replace(/&amp;/g, "&")
             .replace(/&lt;/g, "<")
             .replace(/&gt;/g, ">")
             .replace(/&quot;/g, '"')
             .replace(/&#039;/g, "'");
       
     };
   
    markedRenderer.tablecell = function(content, flags) {
        var type = (flags.header) ? "th" : "td";
        var tag  = (flags.align)  ? "<" + type +" style=\"text-align:" + flags.align + "\">" : "<" + type + ">";
        if(/<[a-z][\s\S]*>/i.test(this.escapeHtml(content))) {
        	content = '<html>' + this.escapeHtml(content) + '</html>';
        }
        return tag + this.atLink(this.emoji(content)) + "</" + type + ">\n";
        
    };

    markedRenderer.listitem = function(text) {
        if (settings.taskList && /^\s*\[[x\s]\]\s*/.test(text)) 
        {
            text = text.replace(/^\s*\[\s\]\s*/, "<input type=\"checkbox\" class=\"task-list-item-checkbox\" /> ")
                       .replace(/^\s*\[x\]\s*/,  "<input type=\"checkbox\" class=\"task-list-item-checkbox\" checked disabled /> ");

            return "<li style=\"list-style: none;\">" + this.atLink(this.emoji(text)) + "</li>";
        }
        else 
        {
            return "<li>" + this.atLink(this.emoji(text)) + "</li>";
        }
    };
    
    return markedRenderer;
};


function LoadAndParse(id) {
	var settings = {
        gfm                  : true,
        toc                  : true,
        tocm                 : false,
        tocStartLevel        : 1,
        tocTitle             : "Оглавление",
        tocDropdown          : false,
        tocContainer         : "",
        markdown             : "",
        markdownSourceCode   : true,
        htmlDecode           : true,
        autoLoadKaTeX        : true,
        pageBreak            : true,
        atLink               : true,    // for @link
        emailLink            : true,    // for mail address auto link
        tex                  : false,
        taskList             : true,   // Github Flavored Markdown task lists
        emoji                : true,
        flowChart            : true,
        sequenceDiagram      : false,
        previewCodeHighlight : true,
        mode                 : "gfm"
    };
	var loadPath = "/local/components/micros/knowledge.base/lib/";
	
/*	editormd.loadScript(loadPath + "marked.min", function() {

        editormd.$marked = marked;
            
        if (settings.previewCodeHighlight) 
        {
            editormd.loadScript(loadPath + "prettify.min", function() {
            	ParseMarkdown(id, settings);
            });
        } 
        else
        {                  
        	ParseMarkdown(id, settings);
        }
    });*/
	
	
	
	var loadFlowChartOrSequenceDiagram = function() {
        
        if (settings.flowChart || settings.sequenceDiagram) 
        {
            editormd.loadScript(loadPath + "raphael.min", function() {

                editormd.loadScript(loadPath + "underscore.min", function() {  

                    if (!settings.flowChart && settings.sequenceDiagram) 
                    {
                        editormd.loadScript(loadPath + "sequence-diagram.min", function() {
                        	ParseMarkdown(id, settings);
                        });
                    }
                    else if (settings.flowChart && !settings.sequenceDiagram) 
                    {      
                        editormd.loadScript(loadPath + "flowchart.min", function() {  
                            editormd.loadScript(loadPath + "jquery.flowchart.min", function() {
                            	ParseMarkdown(id, settings);
                            });
                        });
                    }
                    else if (settings.flowChart && settings.sequenceDiagram) 
                    {  
                        editormd.loadScript(loadPath + "flowchart.min", function() {  
                            editormd.loadScript(loadPath + "jquery.flowchart.min", function() {
                                editormd.loadScript(loadPath + "sequence-diagram.min", function() {
                                	ParseMarkdown(id, settings);
                                });
                            });
                        });
                    }
                });

            });
        } 
        else
        {
        	ParseMarkdown(id, settings);
        }
    }; 

    editormd.loadCSS(loadPath + "codemirror/codemirror.min");
    
    if (settings.searchReplace && !settings.readOnly)
    {
        editormd.loadCSS(loadPath + "codemirror/addon/dialog/dialog");
        editormd.loadCSS(loadPath + "codemirror/addon/search/matchesonscrollbar");
    }
    
    if (settings.codeFold)
    {
        editormd.loadCSS(loadPath + "codemirror/addon/fold/foldgutter");            
    }
    
    editormd.loadScript(loadPath + "codemirror/codemirror.min", function() {
        editormd.$CodeMirror = CodeMirror;
        
        editormd.loadScript(loadPath + "codemirror/modes.min", function() {
        	
            editormd.loadScript(loadPath + "codemirror/addons.min", function() {
            	
                if (settings.mode !== "gfm" && settings.mode !== "markdown") 
                {
                	ParseMarkdown(id, settings);
                    
                    return false;
                }

                editormd.loadScript(loadPath + "marked.min", function() {
                    editormd.$marked = marked;
                        
                    if (settings.previewCodeHighlight) 
                    {
                        editormd.loadScript(loadPath + "prettify.min", function() {
                            loadFlowChartOrSequenceDiagram();
                        });
                    } 
                    else
                    {                  
                        loadFlowChartOrSequenceDiagram();
                    }
                });
                
            });
            
        });
        
    });
	
}

function ParseMarkdown(id, settings){
	
		editormd.$marked  = marked;
		var el = $("#" + id);
        var text = $("#" + id).text();
        var markdownDoc   = text; 
        var markdownToC   = [];

        var rendererOptions = {  
            toc                  : settings.toc,
            tocm                 : settings.tocm,
            tocStartLevel        : settings.tocStartLevel,
            taskList             : settings.taskList,
            emoji                : settings.emoji,
            tex                  : settings.tex,
            pageBreak            : settings.pageBreak,
            atLink               : settings.atLink,           // for @link
            emailLink            : settings.emailLink,        // for mail address auto link
            flowChart            : settings.flowChart,
            sequenceDiagram      : settings.sequenceDiagram,
            previewCodeHighlight : settings.previewCodeHighlight,
        };

        var markedOptions = {
            renderer    : markedRendererFunc(markdownToC, rendererOptions),
            gfm         : settings.gfm,
            tables      : true,
            breaks      : true,
            pedantic    : false,
            sanitize    : (settings.htmlDecode) ? false : true, // 是否忽略HTML标签，即是否开启HTML标签解析，为了安全性，默认不开启
            smartLists  : true,
            smartypants : true
        };
        
		markdownDoc = new String(markdownDoc);
        var markdownParsed = marked(markdownDoc, markedOptions);
        markdownParsed = editormd.filterHTMLTags(markdownParsed, settings.htmlDecode);
        el.next('.markdown-body').html(markdownParsed);
        if (settings.previewCodeHighlight) 
        {
        	el.next('.markdown-body').find("pre").addClass("prettyprint linenums");
            prettyPrint();
        }
        
        var tocContainer = (settings.tocContainer !== "") ? $(settings.tocContainer) : el.next('.markdown-body');
        
        if (settings.tocContainer !== "")
        {
            tocContainer.attr("previewContainer", false);
        }
         
        if (settings.toc) 
        {
            el.next('.markdown-body').tocContainer = editormd.markdownToCRenderer(markdownToC, tocContainer, settings.tocDropdown, settings.tocStartLevel);
            
            if (settings.tocDropdown || el.next('.markdown-body').find("." + this.classPrefix + "toc-menu").length > 0)
            {
            	editormd.tocDropdownMenu(el.next('.markdown-body'), settings.tocTitle);
            }
            
            if (settings.tocContainer !== "")
            {
                el.next('.markdown-body').find(".editormd-toc-menu, .editormd-markdown-toc").remove();
            }
        }
        
        if (!editormd.isIE8) 
        {
            if (settings.flowChart) {
                el.next('.markdown-body').find(".flowchart").flowChart(); 
            }

            if (settings.sequenceDiagram) {
                el.next('.markdown-body').find(".sequence-diagram").sequenceDiagram({theme: "simple"});
            }
        }
}



$(function() {
	LoadAndParse("markdown");
});
/* End */
;
; /* Start:"a:4:{s:4:"full";s:71:"/local/components/micros/knowledge.base/js/editormd.js?1497875504165100";s:6:"source";s:54:"/local/components/micros/knowledge.base/js/editormd.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
/*
 * Editor.md
 *
 * @file        editormd.js 
 * @version     v1.5.0 
 * @description Open source online markdown editor.
 * @license     MIT License
 * @author      Pandao
 * {@link       https://github.com/pandao/editor.md}
 * @updateTime  2015-06-09
 */

;(function(factory) {
    "use strict";
    
	// CommonJS/Node.js
	if (typeof require === "function" && typeof exports === "object" && typeof module === "object")
    { 
        module.exports = factory;
    }
	else if (typeof define === "function")  // AMD/CMD/Sea.js
	{
        if (define.amd) // for Require.js
        {
            /* Require.js define replace */
        } 
        else 
        {
		    define(["jquery"], factory);  // for Sea.js
        }
	} 
	else
	{ 
        window.editormd = factory();
	}
    
}(function() {    

    /* Require.js assignment replace */
    
    "use strict";
    
    var $ = (typeof (jQuery) !== "undefined") ? jQuery : Zepto;

	if (typeof ($) === "undefined") {
		return ;
	}
    
    /**
     * editormd
     * 
     * @param   {String} id           编辑器的ID
     * @param   {Object} options      配置选项 Key/Value
     * @returns {Object} editormd     返回editormd对象
     */
    
    var editormd         = function (id, options) {
        return new editormd.fn.init(id, options);
    };
    
    editormd.title        = editormd.$name = "Editor.md";
    editormd.version      = "1.5.0";
    editormd.homePage     = "https://pandao.github.io/editor.md/";
    editormd.classPrefix  = "editormd-";
    
    editormd.toolbarModes = {
        full : [
            "undo", "redo", "|", 
            "bold", "del", "italic", "quote", "ucwords", "uppercase", "lowercase", "|", 
            "h1", "h2", "h3", "h4", "h5", "h6", "|", 
            "list-ul", "list-ol", "hr", "|",
            "link", "reference-link", "image", "code", "preformatted-text", "code-block", "table", "datetime", "emoji", "html-entities", "pagebreak", "|",
            "goto-line", "watch", "preview", "fullscreen", "clear", "search", "|",
            "help", "info"
        ],
        simple : [
            "undo", "redo", "|", 
            "bold", "del", "italic", "quote", "uppercase", "lowercase", "|", 
            "h1", "h2", "h3", "h4", "h5", "h6", "|", 
            "list-ul", "list-ol", "hr", "|",
            "watch", "preview", "fullscreen", "|",
            "help", "info"
        ],
        mini : [
            "undo", "redo", "|",
            "watch", "preview", "|",
            "help", "info"
        ]
    };
    
    editormd.defaults     = {
        mode                 : "gfm",          //gfm or markdown
        name                 : "",             // Form element name
        value                : "",             // value for CodeMirror, if mode not gfm/markdown
        theme                : "",             // Editor.md self themes, before v1.5.0 is CodeMirror theme, default empty
        editorTheme          : "default",      // Editor area, this is CodeMirror theme at v1.5.0
        previewTheme         : "",             // Preview area theme, default empty
        markdown             : "",             // Markdown source code
        appendMarkdown       : "",             // if in init textarea value not empty, append markdown to textarea
        width                : "100%",
        height               : "77%",
        path                 : "/local/components/micros/knowledge.base/lib/",       // Dependents module file directory
        pluginPath           : "",             // If this empty, default use settings.path + "../plugins/"
        delay                : 300,            // Delay parse markdown to html, Uint : ms
        autoLoadModules      : true,           // Automatic load dependent module files
        watch                : true,
        placeholder          : "Пользуйтесь Базой Знаний! Заполняйте легко ...",
        gotoLine             : true,
        codeFold             : false,
        autoHeight           : false,
		autoFocus            : true,
        autoCloseTags        : true,
        searchReplace        : true,
        syncScrolling        : true,           // true | false | "single", default true
        readOnly             : false,
        tabSize              : 4,
		indentUnit           : 4,
        lineNumbers          : true,
		lineWrapping         : true,
		autoCloseBrackets    : true,
		showTrailingSpace    : true,
		matchBrackets        : true,
		indentWithTabs       : true,
		styleSelectedText    : true,
        matchWordHighlight   : true,           // options: true, false, "onselected"
        styleActiveLine      : true,           // Highlight the current line
        dialogLockScreen     : true,
        dialogShowMask       : true,
        dialogDraggable      : true,
        dialogMaskBgColor    : "#fff",
        dialogMaskOpacity    : 0.1,
        fontSize             : "13px",
        saveHTMLToTextarea   : false,
        disabledKeyMaps      : [],
        
        onload               : function() {},
        onresize             : function() {},
        onchange             : function() {},
        onwatch              : null,
        onunwatch            : null,
        onpreviewing         : function() {},
        onpreviewed          : function() {},
        onfullscreen         : function() {},
        onfullscreenExit     : function() {},
        onscroll             : function() {},
        onpreviewscroll      : function() {},
        
        imageUpload          : true,
        imageFormats         : ["jpg", "jpeg", "gif", "png",],
        imageUploadURL       : "/upload/kb/upload.php",
        crossDomainUpload    : false,
        uploadCallbackURL    : "",
        
        toc                  : true,           // Table of contents
        tocm                 : false,           // Using [TOCM], auto create ToC dropdown menu
        tocTitle             : "Оглавление",             // for ToC dropdown menu btn
        tocDropdown          : false,
        tocContainer         : "",
        tocStartLevel        : 1,              // Said from H1 to create ToC
        htmlDecode           : true,          // Open the HTML tag identification 
        pageBreak            : true,           // Enable parse page break [========]
        atLink               : true,           // for @link
        emailLink            : true,           // for email address auto link
        taskList             : false,          // Enable Github Flavored Markdown task lists
        emoji                : true,          // :emoji: , Support Github emoji, Twitter Emoji (Twemoji);
                                               // Support FontAwesome icon emoji :fa-xxx: > Using fontAwesome icon web fonts;
                                               // Support Editor.md logo icon emoji :editormd-logo: :editormd-logo-1x: > 1~8x;
        tex                  : false,          // TeX(LaTeX), based on KaTeX
        flowChart            : true,          // flowChart.js only support IE9+
        sequenceDiagram      : false,          // sequenceDiagram.js only support IE9+
        previewCodeHighlight : true,
                
        toolbar              : true,           // show/hide toolbar
        toolbarAutoFixed     : true,           // on window scroll auto fixed position
        toolbarIcons         : "full",
        toolbarTitles        : {},
        toolbarHandlers      : {
            ucwords : function() {
                return editormd.toolbarHandlers.ucwords;
            },
            lowercase : function() {
                return editormd.toolbarHandlers.lowercase;
            }
        },
        toolbarCustomIcons   : {               // using html tag create toolbar icon, unused default <a> tag.
            lowercase        : "<a href=\"javascript:;\" title=\"Lowercase\" unselectable=\"on\"><i class=\"fa\" name=\"lowercase\" style=\"font-size:24px;margin-top: -10px;\">a</i></a>",
            "ucwords"        : "<a href=\"javascript:;\" title=\"ucwords\" unselectable=\"on\"><i class=\"fa\" name=\"ucwords\" style=\"font-size:20px;margin-top: -3px;\">Aa</i></a>"
        }, 
        toolbarIconsClass    : {
            undo             : "fa-undo",
            redo             : "fa-repeat",
            bold             : "fa-bold",
            del              : "fa-strikethrough",
            italic           : "fa-italic",
            quote            : "fa-quote-left",
            uppercase        : "fa-font",
            h1               : editormd.classPrefix + "bold",
            h2               : editormd.classPrefix + "bold",
            h3               : editormd.classPrefix + "bold",
            h4               : editormd.classPrefix + "bold",
            h5               : editormd.classPrefix + "bold",
            h6               : editormd.classPrefix + "bold",
            "list-ul"        : "fa-list-ul",
            "list-ol"        : "fa-list-ol",
            hr               : "fa-minus",
            link             : "fa-link",
            "reference-link" : "fa-anchor",
            image            : "fa-picture-o",
            code             : "fa-code",
            "preformatted-text" : "fa-file-code-o",
            "code-block"     : "fa-file-code-o",
            table            : "fa-table",
            datetime         : "fa-clock-o",
            emoji            : "fa-smile-o",
            "html-entities"  : "fa-copyright",
            pagebreak        : "fa-newspaper-o",
            "goto-line"      : "fa-terminal", // fa-crosshairs
            watch            : "fa-eye-slash",
            unwatch          : "fa-eye",
            preview          : "fa-desktop",
            search           : "fa-search",
            fullscreen       : "fa-arrows-alt",
            clear            : "fa-eraser",
            help             : "fa-question-circle",
            info             : "fa-info-circle"
        },        
        toolbarIconTexts     : {},
        
        lang : {
            name        : "ru-RU",
            description : "Редактор Markdown с открытым исходным кодом.",
            tocTitle    : "Оглавление",
            toolbar     : {
                undo             : "Назад（Ctrl+Z）",
                redo             : "Вперёд（Ctrl+Y）",
                bold             : "Жирный",
                del              : "Зачеркивание",
                italic           : "Курсив",
                quote            : "Котировка",
                ucwords          : "Первая буква в верхнем регистре",
                uppercase        : "В верхнем регистре",
                lowercase        : "В нижнем регистре",
                h1               : "Заголовок1",
                h2               : "Заголовок2",
                h3               : "Заголовок3",
                h4               : "Заголовок4",
                h5               : "Заголовок5",
                h6               : "Заголовок6",
                "list-ul"        : "Ненумерованный список",
                "list-ol"        : "Упорядоченный список",
                hr               : "Горизонтальная линия",
                link             : "Ссылка",
                "reference-link" : "Справочные ссылки",
                image            : "Добавить изображение",
                code             : "Встроенные коды",
                "preformatted-text" : "Предварительно отформатированный текст / блок кода (отступы стиль)",
                "code-block"     : "Блок кода (многоязычная стиль)",
                table            : "Добавить таблицу",
                datetime         : "Дата Время",
                emoji            : "Выражение эмодзи",
                "html-entities"  : "HTML Характер сущности",
                pagebreak        : "Разрыв страницы",
                "goto-line"      : "Перейти к строке",
                watch            : "Закрыть Live Preview",
                unwatch          : "Открыть предварительный просмотр",
                preview          : "Полное окно предварительного просмотра HTML (нажмите Shift + ESC уменьшение)",
                fullscreen       : "В полноэкранном режиме (нажмите ESC для восстановления)",
                clear            : "Очистить",
                search           : "Поиск",
                help             : "Помощь",
                info             : "На" + editormd.title
            },
            buttons : {
                enter  : "Применить",
                cancel : "Отменить",
                close  : "Закрыть"
            },
            dialog : {
                link : {
                    title    : "Добавить ссылку",
                    url      : "Адрес ссылки",
                    urlTitle : "Заголовок ссылки",
                    urlEmpty : "Ошибка: Пожалуйста, введите адрес ссылки."
                },
                referenceLink : {
                    title    : "Добавить справочные ссылки",
                    name     : "Имя ссылки",
                    url      : "Адрес ссылки",
                    urlId    : "ID ссылки",
                    urlTitle : "Заголовок ссылки",
                    nameEmpty: "Ошибка: имя ссылки не может быть пустым.",
                    idEmpty  : "Ошибка： заполните, пожалуйста ID ссылки.",
                    urlEmpty : "Ошибка： пожалуйста, заполните соответствующие ссылки URL-адреса."
                },
                image : {
                    title    : "Заголовок",
                    url      : "Путь",
                    link     : "Ссылка",
                    alt      : "Подпись",
                    uploadButton     : "Загрузить",
                    imageURLEmpty    : "Ошибка: адрес изображения не может быть пустым.",
                    uploadFileEmpty  : "Ошибка: загружаемое изображения не может быть пустым.",
                    formatNotAllowed : "Только разрешено загружать файлы изображений, позволяет загружать файл изображения форматов:"
                },
                preformattedText : {
                    title             : "Добавить предварительно отформатированный текст или блоки кода", 
                    emptyAlert        : "Ошибка: пожалуйста, введите форматированный текст или код содержимого."
                },
                codeBlock : {
                    title             : "Добавить блок кода",                    
                    selectLabel       : "Таблица условных сигналов：",
                    selectDefaultText : "Пожалуйста, выберите язык кода",
                    otherLanguage     : "Другие языки",
                    unselectedLanguageAlert : "Ошибка: пожалуйста, выберите тип кода.",
                    codeEmptyAlert    : "Ошибка: Пожалуйста, введите содержимое кода."
                },
                htmlEntities : {
                    title : "HTML Характер сущности"
                },
                help : {
                    title : "Помощь"
                }
            }
        }
    };
    
    editormd.classNames  = {
        tex : editormd.classPrefix + "tex"
    };

    editormd.dialogZindex = 99999;
    
    editormd.$katex       = null;
    editormd.$marked      = null;
    editormd.$CodeMirror  = null;
    editormd.$prettyPrint = null;
    
    var timer, flowchartTimer;

    editormd.prototype    = editormd.fn = {
        state : {
            watching   : false,
            loaded     : false,
            preview    : false,
            fullscreen : false
        },
        
        /**
         * 构造函数/实例初始化
         * Constructor / instance initialization
         * 
         * @param   {String}   id            编辑器的ID
         * @param   {Object}   [options={}]  配置选项 Key/Value
         * @returns {editormd}               返回editormd的实例对象
         */
        
        init : function (id, options) {
            
            options              = options || {};
            
            if (typeof id === "object")
            {
                options = id;
            }
            
            var _this            = this;
            var classPrefix      = this.classPrefix  = editormd.classPrefix; 
            var settings         = this.settings     = $.extend(true, editormd.defaults, options);
            
            id                   = (typeof id === "object") ? settings.id : id;
            
            var editor           = this.editor       = $("#" + id);
            
            this.id              = id;
            this.lang            = settings.lang;
            
            var classNames       = this.classNames   = {
                textarea : {
                    html     : classPrefix + "html-textarea",
                    markdown : classPrefix + "markdown-textarea"
                }
            };
            
            settings.pluginPath = (settings.pluginPath === "") ? settings.path + "../plugins/" : settings.pluginPath; 
            
            this.state.watching = (settings.watch) ? true : false;
            
            if ( !editor.hasClass("editormd") ) {
                editor.addClass("editormd");
            }
            
            editor.css({
                width  : (typeof settings.width  === "number") ? settings.width  + "px" : settings.width,
                height : (typeof settings.height === "number") ? settings.height + "px" : settings.height
            });
            
            if (settings.autoHeight)
            {
                editor.css("height", "auto");
            }
                        
            var markdownTextarea = this.markdownTextarea = editor.children("textarea");
            
            if (markdownTextarea.length < 1)
            {
                editor.append("<textarea></textarea>");
                markdownTextarea = this.markdownTextarea = editor.children("textarea");
            }
            
            markdownTextarea.addClass(classNames.textarea.markdown).attr("placeholder", settings.placeholder);
            
            if (typeof markdownTextarea.attr("name") === "undefined" || markdownTextarea.attr("name") === "")
            {
                markdownTextarea.attr("name", (settings.name !== "") ? settings.name : id + "-markdown-doc");
            }
            
            var appendElements = [
                (!settings.readOnly) ? "<a href=\"javascript:;\" class=\"fa fa-close " + classPrefix + "preview-close-btn\"></a>" : "",
                ( (settings.saveHTMLToTextarea) ? "<textarea class=\"" + classNames.textarea.html + "\" name=\"" + id + "-html-code\"></textarea>" : "" ),
                "<div class=\"" + classPrefix + "preview\"><div class=\"markdown-body " + classPrefix + "preview-container\"></div></div>",
                "<div class=\"" + classPrefix + "container-mask\" style=\"display:block;\"></div>",
                "<div class=\"" + classPrefix + "mask\"></div>"
            ].join("\n");
            
            editor.append(appendElements).addClass(classPrefix + "vertical");
            
            if (settings.theme !== "") 
            {
                editor.addClass(classPrefix + "theme-" + settings.theme);
            }
            
            this.mask          = editor.children("." + classPrefix + "mask");    
            this.containerMask = editor.children("." + classPrefix  + "container-mask");
            
            if (settings.markdown !== "")
            {
                markdownTextarea.val(settings.markdown);
            }
            
            if (settings.appendMarkdown !== "")
            {
                markdownTextarea.val(markdownTextarea.val() + settings.appendMarkdown);
            }
            
            this.htmlTextarea     = editor.children("." + classNames.textarea.html);            
            this.preview          = editor.children("." + classPrefix + "preview");
            this.previewContainer = this.preview.children("." + classPrefix + "preview-container");
            
            if (settings.previewTheme !== "") 
            {
                this.preview.addClass(classPrefix + "preview-theme-" + settings.previewTheme);
            }
            
            if (typeof define === "function" && define.amd)
            {
                if (typeof katex !== "undefined") 
                {
                    editormd.$katex = katex;
                }
                
                if (settings.searchReplace && !settings.readOnly) 
                {
                    editormd.loadCSS(settings.path + "codemirror/addon/dialog/dialog");
                    editormd.loadCSS(settings.path + "codemirror/addon/search/matchesonscrollbar");
                }
            }
            
            if ((typeof define === "function" && define.amd) || !settings.autoLoadModules)
            {
                if (typeof CodeMirror !== "undefined") {
                    editormd.$CodeMirror = CodeMirror;
                }
                
                if (typeof marked     !== "undefined") {
                    editormd.$marked     = marked;
                }
                
                this.setCodeMirror().setToolbar().loadedDisplay();
            } 
            else 
            {
                this.loadQueues();
            }

            return this;
        },
        
        /**
         * 所需组件加载队列
         * Required components loading queue
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        loadQueues : function() {
            var _this        = this;
            var settings     = this.settings;
            var loadPath     = settings.path;
                                
            var loadFlowChartOrSequenceDiagram = function() {
                
                if (editormd.isIE8) 
                {
                    _this.loadedDisplay();
                    
                    return ;
                }

                if (settings.flowChart || settings.sequenceDiagram) 
                {
                    editormd.loadScript(loadPath + "raphael.min", function() {

                        editormd.loadScript(loadPath + "underscore.min", function() {  

                            if (!settings.flowChart && settings.sequenceDiagram) 
                            {
                                editormd.loadScript(loadPath + "sequence-diagram.min", function() {
                                    _this.loadedDisplay();
                                });
                            }
                            else if (settings.flowChart && !settings.sequenceDiagram) 
                            {      
                                editormd.loadScript(loadPath + "flowchart.min", function() {  
                                    editormd.loadScript(loadPath + "jquery.flowchart.min", function() {
                                        _this.loadedDisplay();
                                    });
                                });
                            }
                            else if (settings.flowChart && settings.sequenceDiagram) 
                            {  
                                editormd.loadScript(loadPath + "flowchart.min", function() {  
                                    editormd.loadScript(loadPath + "jquery.flowchart.min", function() {
                                        editormd.loadScript(loadPath + "sequence-diagram.min", function() {
                                            _this.loadedDisplay();
                                        });
                                    });
                                });
                            }
                        });

                    });
                } 
                else
                {
                    _this.loadedDisplay();
                }
            }; 

            editormd.loadCSS(loadPath + "codemirror/codemirror.min");
            
            if (settings.searchReplace && !settings.readOnly)
            {
                editormd.loadCSS(loadPath + "codemirror/addon/dialog/dialog");
                editormd.loadCSS(loadPath + "codemirror/addon/search/matchesonscrollbar");
            }
            
            if (settings.codeFold)
            {
                editormd.loadCSS(loadPath + "codemirror/addon/fold/foldgutter");            
            }
            
            editormd.loadScript(loadPath + "codemirror/codemirror.min", function() {
                editormd.$CodeMirror = CodeMirror;
                
                editormd.loadScript(loadPath + "codemirror/modes.min", function() {
                    
                    editormd.loadScript(loadPath + "codemirror/addons.min", function() {
                        
                        _this.setCodeMirror();
                        
                        if (settings.mode !== "gfm" && settings.mode !== "markdown") 
                        {
                            _this.loadedDisplay();
                            
                            return false;
                        }
                        
                        _this.setToolbar();

                        editormd.loadScript(loadPath + "marked.min", function() {

                            editormd.$marked = marked;
                                
                            if (settings.previewCodeHighlight) 
                            {
                                editormd.loadScript(loadPath + "prettify.min", function() {
                                    loadFlowChartOrSequenceDiagram();
                                });
                            } 
                            else
                            {                  
                                loadFlowChartOrSequenceDiagram();
                            }
                        });
                        
                    });
                    
                });
                
            });

            return this;
        },
        
        /**
         * 设置 Editor.md 的整体主题，主要是工具栏
         * Setting Editor.md theme
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setTheme : function(theme) {
            var editor      = this.editor;
            var oldTheme    = this.settings.theme;
            var themePrefix = this.classPrefix + "theme-";
            
            editor.removeClass(themePrefix + oldTheme).addClass(themePrefix + theme);
            
            this.settings.theme = theme;
            
            return this;
        },
        
        /**
         * 设置 CodeMirror（编辑区）的主题
         * Setting CodeMirror (Editor area) theme
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setEditorTheme : function(theme) {  
            var settings   = this.settings;  
            settings.editorTheme = theme;  
            
            if (theme !== "default")
            {
                editormd.loadCSS(settings.path + "codemirror/theme/" + settings.editorTheme);
            }
            
            this.cm.setOption("theme", theme);
            
            return this;
        },
        
        /**
         * setEditorTheme() 的别名
         * setEditorTheme() alias
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setCodeMirrorTheme : function (theme) {            
            this.setEditorTheme(theme);
            
            return this;
        },
        
        /**
         * 设置 Editor.md 的主题
         * Setting Editor.md theme
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setPreviewTheme : function(theme) {  
            var preview     = this.preview;
            var oldTheme    = this.settings.previewTheme;
            var themePrefix = this.classPrefix + "preview-theme-";
            
            preview.removeClass(themePrefix + oldTheme).addClass(themePrefix + theme);
            
            this.settings.previewTheme = theme;
            
            return this;
        },
        
        /**
         * 配置和初始化CodeMirror组件
         * CodeMirror initialization
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setCodeMirror : function() { 
            var settings         = this.settings;
            var editor           = this.editor;
            
            if (settings.editorTheme !== "default")
            {
                editormd.loadCSS(settings.path + "codemirror/theme/" + settings.editorTheme);
            }
            
            var codeMirrorConfig = {
                mode                      : settings.mode,
                theme                     : settings.editorTheme,
                tabSize                   : settings.tabSize,
                dragDrop                  : false,
                autofocus                 : settings.autoFocus,
                autoCloseTags             : settings.autoCloseTags,
                readOnly                  : (settings.readOnly) ? "nocursor" : false,
                indentUnit                : settings.indentUnit,
                lineNumbers               : settings.lineNumbers,
                lineWrapping              : settings.lineWrapping,
                extraKeys                 : {
                                                "Ctrl-Q": function(cm) { 
                                                    cm.foldCode(cm.getCursor()); 
                                                }
                                            },
                foldGutter                : settings.codeFold,
                gutters                   : ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                matchBrackets             : settings.matchBrackets,
                indentWithTabs            : settings.indentWithTabs,
                styleActiveLine           : settings.styleActiveLine,
                styleSelectedText         : settings.styleSelectedText,
                autoCloseBrackets         : settings.autoCloseBrackets,
                showTrailingSpace         : settings.showTrailingSpace,
                highlightSelectionMatches : ( (!settings.matchWordHighlight) ? false : { showToken: (settings.matchWordHighlight === "onselected") ? false : /\w/ } )
            };
            
            this.codeEditor = this.cm        = editormd.$CodeMirror.fromTextArea(this.markdownTextarea[0], codeMirrorConfig);
            this.codeMirror = this.cmElement = editor.children(".CodeMirror");
            
            if (settings.value !== "")
            {
                this.cm.setValue(settings.value);
            }

            this.codeMirror.css({
                fontSize : settings.fontSize,
                width    : (!settings.watch) ? "100%" : "50%"
            });
            
            if (settings.autoHeight)
            {
                this.codeMirror.css("height", "auto");
                this.cm.setOption("viewportMargin", Infinity);
            }
            
            if (!settings.lineNumbers)
            {
                this.codeMirror.find(".CodeMirror-gutters").css("border-right", "none");
            }

            return this;
        },
        
        /**
         * 获取CodeMirror的配置选项
         * Get CodeMirror setting options
         * 
         * @returns {Mixed}                  return CodeMirror setting option value
         */
        
        getCodeMirrorOption : function(key) {            
            return this.cm.getOption(key);
        },
        
        /**
         * 配置和重配置CodeMirror的选项
         * CodeMirror setting options / resettings
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setCodeMirrorOption : function(key, value) {
            
            this.cm.setOption(key, value);
            
            return this;
        },
        
        /**
         * 添加 CodeMirror 键盘快捷键
         * Add CodeMirror keyboard shortcuts key map
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        addKeyMap : function(map, bottom) {
            this.cm.addKeyMap(map, bottom);
            
            return this;
        },
        
        /**
         * 移除 CodeMirror 键盘快捷键
         * Remove CodeMirror keyboard shortcuts key map
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        removeKeyMap : function(map) {
            this.cm.removeKeyMap(map);
            
            return this;
        },
        
        /**
         * 跳转到指定的行
         * Goto CodeMirror line
         * 
         * @param   {String|Intiger}   line      line number or "first"|"last"
         * @returns {editormd}                   返回editormd的实例对象
         */
        
        gotoLine : function (line) {
            
            var settings = this.settings;
            
            if (!settings.gotoLine)
            {
                return this;
            }
            
            var cm       = this.cm;
            var editor   = this.editor;
            var count    = cm.lineCount();
            var preview  = this.preview;
            
            if (typeof line === "string")
            {
                if(line === "last")
                {
                    line = count;
                }
            
                if (line === "first")
                {
                    line = 1;
                }
            }
            
            if (typeof line !== "number") 
            {  
                alert("Error: The line number must be an integer.");
                return this;
            }
            
            line  = parseInt(line) - 1;
            
            if (line > count)
            {
                alert("Error: The line number range 1-" + count);
                
                return this;
            }
            
            cm.setCursor( {line : line, ch : 0} );
            
            var scrollInfo   = cm.getScrollInfo();
            var clientHeight = scrollInfo.clientHeight; 
            var coords       = cm.charCoords({line : line, ch : 0}, "local");
            
            cm.scrollTo(null, (coords.top + coords.bottom - clientHeight) / 2);
            
            if (settings.watch)
            {            
                var cmScroll  = this.codeMirror.find(".CodeMirror-scroll")[0];
                var height    = $(cmScroll).height(); 
                var scrollTop = cmScroll.scrollTop;         
                var percent   = (scrollTop / cmScroll.scrollHeight);

                if (scrollTop === 0)
                {
                    preview.scrollTop(0);
                } 
                else if (scrollTop + height >= cmScroll.scrollHeight - 16)
                { 
                    preview.scrollTop(preview[0].scrollHeight);                    
                } 
                else
                {                    
                    preview.scrollTop(preview[0].scrollHeight * percent);
                }
            }

            cm.focus();
            
            return this;
        },
        
        /**
         * 扩展当前实例对象，可同时设置多个或者只设置一个
         * Extend editormd instance object, can mutil setting.
         * 
         * @returns {editormd}                  this(editormd instance object.)
         */
        
        extend : function() {
            if (typeof arguments[1] !== "undefined")
            {
                if (typeof arguments[1] === "function")
                {
                    arguments[1] = $.proxy(arguments[1], this);
                }

                this[arguments[0]] = arguments[1];
            }
            
            if (typeof arguments[0] === "object" && typeof arguments[0].length === "undefined")
            {
                $.extend(true, this, arguments[0]);
            }

            return this;
        },
        
        /**
         * 设置或扩展当前实例对象，单个设置
         * Extend editormd instance object, one by one
         * 
         * @param   {String|Object}   key       option key
         * @param   {String|Object}   value     option value
         * @returns {editormd}                  this(editormd instance object.)
         */
        
        set : function (key, value) {
            
            if (typeof value !== "undefined" && typeof value === "function")
            {
                value = $.proxy(value, this);
            }
            
            this[key] = value;

            return this;
        },
        
        /**
         * 重新配置
         * Resetting editor options
         * 
         * @param   {String|Object}   key       option key
         * @param   {String|Object}   value     option value
         * @returns {editormd}                  this(editormd instance object.)
         */
        
        config : function(key, value) {
            var settings = this.settings;
            
            if (typeof key === "object")
            {
                settings = $.extend(true, settings, key);
            }
            
            if (typeof key === "string")
            {
                settings[key] = value;
            }
            
            this.settings = settings;
            this.recreate();
            
            return this;
        },
        
        /**
         * 注册事件处理方法
         * Bind editor event handle
         * 
         * @param   {String}     eventType      event type
         * @param   {Function}   callback       回调函数
         * @returns {editormd}                  this(editormd instance object.)
         */
        
        on : function(eventType, callback) {
            var settings = this.settings;
            
            if (typeof settings["on" + eventType] !== "undefined") 
            {                
                settings["on" + eventType] = $.proxy(callback, this);      
            }

            return this;
        },
        
        /**
         * 解除事件处理方法
         * Unbind editor event handle
         * 
         * @param   {String}   eventType          event type
         * @returns {editormd}                    this(editormd instance object.)
         */
        
        off : function(eventType) {
            var settings = this.settings;
            
            if (typeof settings["on" + eventType] !== "undefined") 
            {
                settings["on" + eventType] = function(){};
            }
            
            return this;
        },
        
        /**
         * 显示工具栏
         * Display toolbar
         * 
         * @param   {Function} [callback=function(){}] 回调函数
         * @returns {editormd}  返回editormd的实例对象
         */
        
        showToolbar : function(callback) {
            var settings = this.settings;
            
            if(settings.readOnly) {
                return this;
            }
            
            if (settings.toolbar && (this.toolbar.length < 1 || this.toolbar.find("." + this.classPrefix + "menu").html() === "") )
            {
                this.setToolbar();
            }
            
            settings.toolbar = true; 
            
            this.toolbar.show();
            this.resize();
            
            $.proxy(callback || function(){}, this)();

            return this;
        },
        
        /**
         * 隐藏工具栏
         * Hide toolbar
         * 
         * @param   {Function} [callback=function(){}] 回调函数
         * @returns {editormd}                         this(editormd instance object.)
         */
        
        hideToolbar : function(callback) { 
            var settings = this.settings;
            
            settings.toolbar = false;  
            this.toolbar.hide();
            this.resize();
            
            $.proxy(callback || function(){}, this)();

            return this;
        },
        
        /**
         * 页面滚动时工具栏的固定定位
         * Set toolbar in window scroll auto fixed position
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setToolbarAutoFixed : function(fixed) {
            
            var state    = this.state;
            var editor   = this.editor;
            var toolbar  = this.toolbar;
            var settings = this.settings;
            
            if (typeof fixed !== "undefined")
            {
                settings.toolbarAutoFixed = fixed;
            }
            
            var autoFixedHandle = function(){
                var $window = $(window);
                var top     = $window.scrollTop();
                
                if (!settings.toolbarAutoFixed)
                {
                    return false;
                }

                if (top - editor.offset().top > 10 && top < editor.height())
                {
                    toolbar.css({
                        position : "fixed",
                        width    : editor.width() + "px",
                        left     : ($window.width() - editor.width()) / 2 + "px"
                    });
                }
                else
                {
                    toolbar.css({
                        position : "absolute",
                        width    : "100%",
                        left     : 0
                    });
                }
            };
            
            if (!state.fullscreen && !state.preview && settings.toolbar && settings.toolbarAutoFixed)
            {
                $(window).bind("scroll", autoFixedHandle);
            }

            return this;
        },
        
        /**
         * 配置和初始化工具栏
         * Set toolbar and Initialization
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setToolbar : function() {
            var settings    = this.settings;  
            
            if(settings.readOnly) {
                return this;
            }
            
            var editor      = this.editor;
            var preview     = this.preview;
            var classPrefix = this.classPrefix;
            
            var toolbar     = this.toolbar = editor.children("." + classPrefix + "toolbar");
            
            if (settings.toolbar && toolbar.length < 1)
            {            
                var toolbarHTML = "<div class=\"" + classPrefix + "toolbar\"><div class=\"" + classPrefix + "toolbar-container\"><ul class=\"" + classPrefix + "menu\"></ul></div></div>";
                
                editor.append(toolbarHTML);
                toolbar = this.toolbar = editor.children("." + classPrefix + "toolbar");
            }
            
            if (!settings.toolbar) 
            {
                toolbar.hide();
                
                return this;
            }
            
            toolbar.show();
            
            var icons       = (typeof settings.toolbarIcons === "function") ? settings.toolbarIcons() 
                            : ((typeof settings.toolbarIcons === "string")  ? editormd.toolbarModes[settings.toolbarIcons] : settings.toolbarIcons);
            
            var toolbarMenu = toolbar.find("." + this.classPrefix + "menu"), menu = "";
            var pullRight   = false;
            
            for (var i = 0, len = icons.length; i < len; i++)
            {
                var name = icons[i];

                if (name === "||") 
                { 
                    pullRight = true;
                } 
                else if (name === "|")
                {
                    menu += "<li class=\"divider\" unselectable=\"on\">|</li>";
                }
                else
                {
                    var isHeader = (/h(\d)/.test(name));
                    var index    = name;
                    
                    if (name === "watch" && !settings.watch) {
                        index = "unwatch";
                    }
                    
                    var title     = settings.lang.toolbar[index];
                    var iconTexts = settings.toolbarIconTexts[index];
                    var iconClass = settings.toolbarIconsClass[index];
                    
                    title     = (typeof title     === "undefined") ? "" : title;
                    iconTexts = (typeof iconTexts === "undefined") ? "" : iconTexts;
                    iconClass = (typeof iconClass === "undefined") ? "" : iconClass;

                    var menuItem = pullRight ? "<li class=\"pull-right\">" : "<li>";
                    
                    if (typeof settings.toolbarCustomIcons[name] !== "undefined" && typeof settings.toolbarCustomIcons[name] !== "function")
                    {
                        menuItem += settings.toolbarCustomIcons[name];
                    }
                    else 
                    {
                        menuItem += "<a href=\"javascript:;\" title=\"" + title + "\" unselectable=\"on\">";
                        menuItem += "<i class=\"fa " + iconClass + "\" name=\""+name+"\" unselectable=\"on\">"+((isHeader) ? name.toUpperCase() : ( (iconClass === "") ? iconTexts : "") ) + "</i>";
                        menuItem += "</a>";
                    }

                    menuItem += "</li>";

                    menu = pullRight ? menuItem + menu : menu + menuItem;
                }
            }

            toolbarMenu.html(menu);
            
            toolbarMenu.find("[title=\"Lowercase\"]").attr("title", settings.lang.toolbar.lowercase);
            toolbarMenu.find("[title=\"ucwords\"]").attr("title", settings.lang.toolbar.ucwords);
            
            this.setToolbarHandler();
            this.setToolbarAutoFixed();

            return this;
        },
        
        /**
         * 工具栏图标事件处理对象序列
         * Get toolbar icons event handlers
         * 
         * @param   {Object}   cm    CodeMirror的实例对象
         * @param   {String}   name  要获取的事件处理器名称
         * @returns {Object}         返回处理对象序列
         */
            
        dialogLockScreen : function() {
            $.proxy(editormd.dialogLockScreen, this)();
            
            return this;
        },

        dialogShowMask : function(dialog) {
            $.proxy(editormd.dialogShowMask, this)(dialog);
            
            return this;
        },
        
        getToolbarHandles : function(name) {  
            var toolbarHandlers = this.toolbarHandlers = editormd.toolbarHandlers;
            
            return (name && typeof toolbarIconHandlers[name] !== "undefined") ? toolbarHandlers[name] : toolbarHandlers;
        },
        
        /**
         * 工具栏图标事件处理器
         * Bind toolbar icons event handle
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        setToolbarHandler : function() {
            var _this               = this;
            var settings            = this.settings;
            
            if (!settings.toolbar || settings.readOnly) {
                return this;
            }
            
            var toolbar             = this.toolbar;
            var cm                  = this.cm;
            var classPrefix         = this.classPrefix;           
            var toolbarIcons        = this.toolbarIcons = toolbar.find("." + classPrefix + "menu > li > a");  
            var toolbarIconHandlers = this.getToolbarHandles();  
                
            toolbarIcons.bind(editormd.mouseOrTouch("click", "touchend"), function(event) {

                var icon                = $(this).children(".fa");
                var name                = icon.attr("name");
                var cursor              = cm.getCursor();
                var selection           = cm.getSelection();

                if (name === "") {
                    return ;
                }
                
                _this.activeIcon = icon;

                if (typeof toolbarIconHandlers[name] !== "undefined") 
                {
                    $.proxy(toolbarIconHandlers[name], _this)(cm);
                }
                else 
                {
                    if (typeof settings.toolbarHandlers[name] !== "undefined") 
                    {
                        $.proxy(settings.toolbarHandlers[name], _this)(cm, icon, cursor, selection);
                    }
                }
                
                if (name !== "link" && name !== "reference-link" && name !== "image" && name !== "code-block" && 
                    name !== "preformatted-text" && name !== "watch" && name !== "preview" && name !== "search" && name !== "fullscreen" && name !== "info") 
                {
                    cm.focus();
                }

                return false;

            });

            return this;
        },
        
        /**
         * 动态创建对话框
         * Creating custom dialogs
         * 
         * @param   {Object} options  配置项键值对 Key/Value
         * @returns {dialog}          返回创建的dialog的jQuery实例对象
         */
        
        createDialog : function(options) {            
            return $.proxy(editormd.createDialog, this)(options);
        },
        
        /**
         * 创建关于Editor.md的对话框
         * Create about Editor.md dialog
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        createInfoDialog : function() {
            var _this        = this;
			var editor       = this.editor;
            var classPrefix  = this.classPrefix;  
            
            var infoDialogHTML = [
                "<div class=\"" + classPrefix + "dialog " + classPrefix + "dialog-info\" style=\"\">",
                "<div class=\"" + classPrefix + "dialog-container\">",
                "<h1><i class=\"editormd-logo editormd-logo-lg editormd-logo-color\"></i> " + editormd.title + "<small>v" + editormd.version + "</small></h1>",
                "<p>" + this.lang.description + "</p>",
                "<p style=\"margin: 10px 0 20px 0;\"><a href=\"" + editormd.homePage + "\" target=\"_blank\">" + editormd.homePage + " <i class=\"fa fa-external-link\"></i></a></p>",
                "<p style=\"font-size: 0.85em;\">Copyright &copy; 2015 <a href=\"https://github.com/pandao\" target=\"_blank\" class=\"hover-link\">Pandao</a>, The <a href=\"https://github.com/pandao/editor.md/blob/master/LICENSE\" target=\"_blank\" class=\"hover-link\">MIT</a> License.</p>",
                "</div>",
                "<a href=\"javascript:;\" class=\"fa fa-close " + classPrefix + "dialog-close\"></a>",
                "</div>"
            ].join("\n");

            editor.append(infoDialogHTML);
            
            var infoDialog  = this.infoDialog = editor.children("." + classPrefix + "dialog-info");

            infoDialog.find("." + classPrefix + "dialog-close").bind(editormd.mouseOrTouch("click", "touchend"), function() {
                _this.hideInfoDialog();
            });
            
            infoDialog.css("border", (editormd.isIE8) ? "1px solid #ddd" : "").css("z-index", editormd.dialogZindex).show();
            
            this.infoDialogPosition();

            return this;
        },
        
        /**
         * 关于Editor.md对话居中定位
         * Editor.md dialog position handle
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        infoDialogPosition : function() {
            var infoDialog = this.infoDialog;
            
			var _infoDialogPosition = function() {
				infoDialog.css({
					top  : ($(window).height() - infoDialog.height()) / 2 + "px",
					left : ($(window).width()  - infoDialog.width()) / 2  + "px"
				});
			};

			_infoDialogPosition();

			$(window).resize(_infoDialogPosition);
            
            return this;
        },
        
        /**
         * 显示关于Editor.md
         * Display about Editor.md dialog
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        showInfoDialog : function() {

            $("html,body").css("overflow-x", "hidden");
            
            var _this       = this;
			var editor      = this.editor;
            var settings    = this.settings;         
			var infoDialog  = this.infoDialog = editor.children("." + this.classPrefix + "dialog-info");
            
            if (infoDialog.length < 1)
            {
                this.createInfoDialog();
            }
            
            this.lockScreen(true);
            
            this.mask.css({
						opacity         : settings.dialogMaskOpacity,
						backgroundColor : settings.dialogMaskBgColor
					}).show();

			infoDialog.css("z-index", editormd.dialogZindex).show();

			this.infoDialogPosition();

            return this;
        },
        
        /**
         * 隐藏关于Editor.md
         * Hide about Editor.md dialog
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        hideInfoDialog : function() {            
            $("html,body").css("overflow-x", "");
            this.infoDialog.hide();
            this.mask.hide();
            this.lockScreen(false);

            return this;
        },
        
        /**
         * 锁屏
         * lock screen
         * 
         * @param   {Boolean}    lock    Boolean 布尔值，是否锁屏
         * @returns {editormd}           返回editormd的实例对象
         */
        
        lockScreen : function(lock) {
            editormd.lockScreen(lock);
            this.resize();

            return this;
        },
        
        /**
         * 编辑器界面重建，用于动态语言包或模块加载等
         * Recreate editor
         * 
         * @returns {editormd}  返回editormd的实例对象
         */
        
        recreate : function() {
            var _this            = this;
            var editor           = this.editor;
            var settings         = this.settings;
            
            this.codeMirror.remove();
            
            this.setCodeMirror();

            if (!settings.readOnly) 
            {
                if (editor.find(".editormd-dialog").length > 0) {
                    editor.find(".editormd-dialog").remove();
                }
                
                if (settings.toolbar) 
                {  
                    this.getToolbarHandles();                  
                    this.setToolbar();
                }
            }
            
            this.loadedDisplay(true);

            return this;
        },
        
        /**
         * 高亮预览HTML的pre代码部分
         * highlight of preview codes
         * 
         * @returns {editormd}             返回editormd的实例对象
         */
        
        previewCodeHighlight : function() {    
            var settings         = this.settings;
            var previewContainer = this.previewContainer;
            
            if (settings.previewCodeHighlight) 
            {
                previewContainer.find("pre").addClass("prettyprint linenums");
                
                if (typeof prettyPrint !== "undefined")
                {                    
                    prettyPrint();
                }
            }

            return this;
        },
        
        /**
         * 解析TeX(KaTeX)科学公式
         * TeX(KaTeX) Renderer
         * 
         * @returns {editormd}             返回editormd的实例对象
         */
        
        katexRender : function() {
            
            if (timer === null)
            {
                return this;
            }
            
            this.previewContainer.find("." + editormd.classNames.tex).each(function(){
                var tex  = $(this);
                editormd.$katex.render(tex.text(), tex[0]);
                
                tex.find(".katex").css("font-size", "1.6em");
            });   

            return this;
        },
        
        /**
         * 解析和渲染流程图及时序图
         * FlowChart and SequenceDiagram Renderer
         * 
         * @returns {editormd}             返回editormd的实例对象
         */
        
        flowChartAndSequenceDiagramRender : function() {
            var $this            = this;
            var settings         = this.settings;
            var previewContainer = this.previewContainer;
            
            if (editormd.isIE8) {
                return this;
            }

            if (settings.flowChart) {
                if (flowchartTimer === null) {
                    return this;
                }
                
                previewContainer.find(".flowchart").flowChart(); 
            }

            if (settings.sequenceDiagram) {
                previewContainer.find(".sequence-diagram").sequenceDiagram({theme: "simple"});
            }
                    
            var preview    = $this.preview;
            var codeMirror = $this.codeMirror;
            var codeView   = codeMirror.find(".CodeMirror-scroll");

            var height    = codeView.height();
            var scrollTop = codeView.scrollTop();                    
            var percent   = (scrollTop / codeView[0].scrollHeight);
            var tocHeight = 0;

            preview.find(".markdown-toc-list").each(function(){
                tocHeight += $(this).height();
            });

            var tocMenuHeight = preview.find(".editormd-toc-menu").height(); 
            tocMenuHeight = (!tocMenuHeight) ? 0 : tocMenuHeight;

            if (scrollTop === 0) 
            {
                preview.scrollTop(0);
            } 
            else if (scrollTop + height >= codeView[0].scrollHeight - 16)
            { 
                preview.scrollTop(preview[0].scrollHeight);                        
            } 
            else
            {                  
                preview.scrollTop((preview[0].scrollHeight + tocHeight + tocMenuHeight) * percent);
            }

            return this;
        },
        
        /**
         * 注册键盘快捷键处理
         * Register CodeMirror keyMaps (keyboard shortcuts).
         * 
         * @param   {Object}    keyMap      KeyMap key/value {"(Ctrl/Shift/Alt)-Key" : function(){}}
         * @returns {editormd}              return this
         */
        
        registerKeyMaps : function(keyMap) {
            
            var _this           = this;
            var cm              = this.cm;
            var settings        = this.settings;
            var toolbarHandlers = editormd.toolbarHandlers;
            var disabledKeyMaps = settings.disabledKeyMaps;
            
            keyMap              = keyMap || null;
            
            if (keyMap)
            {
                for (var i in keyMap)
                {
                    if ($.inArray(i, disabledKeyMaps) < 0)
                    {
                        var map = {};
                        map[i]  = keyMap[i];

                        cm.addKeyMap(keyMap);
                    }
                }
            }
            else
            {
                for (var k in editormd.keyMaps)
                {
                    var _keyMap = editormd.keyMaps[k];
                    var handle = (typeof _keyMap === "string") ? $.proxy(toolbarHandlers[_keyMap], _this) : $.proxy(_keyMap, _this);
                    
                    if ($.inArray(k, ["F9", "F10", "F11"]) < 0 && $.inArray(k, disabledKeyMaps) < 0)
                    {
                        var _map = {};
                        _map[k] = handle;

                        cm.addKeyMap(_map);
                    }
                }
                
                $(window).keydown(function(event) {
                    
                    var keymaps = {
                        "120" : "F9",
                        "121" : "F10",
                        "122" : "F11"
                    };
                    
                    if ( $.inArray(keymaps[event.keyCode], disabledKeyMaps) < 0 )
                    {
                        switch (event.keyCode)
                        {
                            case 120:
                                    $.proxy(toolbarHandlers["watch"], _this)();
                                    return false;
                                break;
                                
                            case 121:
                                    $.proxy(toolbarHandlers["preview"], _this)();
                                    return false;
                                break;
                                
                            case 122:
                                    $.proxy(toolbarHandlers["fullscreen"], _this)();                        
                                    return false;
                                break;
                                
                            default:
                                break;
                        }
                    }
                });
            }

            return this;
        },
        
        /**
         * 绑定同步滚动
         * 
         * @returns {editormd} return this
         */
        
        bindScrollEvent : function() {
            
            var _this            = this;
            var preview          = this.preview;
            var settings         = this.settings;
            var codeMirror       = this.codeMirror;
            var mouseOrTouch     = editormd.mouseOrTouch;
            
            if (!settings.syncScrolling) {
                return this;
            }
                
            var cmBindScroll = function() {    
                codeMirror.find(".CodeMirror-scroll").bind(mouseOrTouch("scroll", "touchmove"), function(event) {
                    var height    = $(this).height();
                    var scrollTop = $(this).scrollTop();                    
                    var percent   = (scrollTop / $(this)[0].scrollHeight);
                    
                    var tocHeight = 0;
                    
                    preview.find(".markdown-toc-list").each(function(){
                        tocHeight += $(this).height();
                    });
                    
                    var tocMenuHeight = preview.find(".editormd-toc-menu").height();
                    tocMenuHeight = (!tocMenuHeight) ? 0 : tocMenuHeight;

                    if (scrollTop === 0) 
                    {
                        preview.scrollTop(0);
                    } 
                    else if (scrollTop + height >= $(this)[0].scrollHeight - 16)
                    { 
                        preview.scrollTop(preview[0].scrollHeight);                        
                    } 
                    else
                    {
                        preview.scrollTop((preview[0].scrollHeight  + tocHeight + tocMenuHeight) * percent);
                    }
                    
                    $.proxy(settings.onscroll, _this)(event);
                });
            };

            var cmUnbindScroll = function() {
                codeMirror.find(".CodeMirror-scroll").unbind(mouseOrTouch("scroll", "touchmove"));
            };

            var previewBindScroll = function() {
                
                preview.bind(mouseOrTouch("scroll", "touchmove"), function(event) {
                    var height    = $(this).height();
                    var scrollTop = $(this).scrollTop();         
                    var percent   = (scrollTop / $(this)[0].scrollHeight);
                    var codeView  = codeMirror.find(".CodeMirror-scroll");

                    if(scrollTop === 0) 
                    {
                        codeView.scrollTop(0);
                    }
                    else if (scrollTop + height >= $(this)[0].scrollHeight)
                    {
                        codeView.scrollTop(codeView[0].scrollHeight);                        
                    }
                    else 
                    {
                        codeView.scrollTop(codeView[0].scrollHeight * percent);
                    }
                    
                    $.proxy(settings.onpreviewscroll, _this)(event);
                });

            };

            var previewUnbindScroll = function() {
                preview.unbind(mouseOrTouch("scroll", "touchmove"));
            }; 

			codeMirror.bind({
				mouseover  : cmBindScroll,
				mouseout   : cmUnbindScroll,
				touchstart : cmBindScroll,
				touchend   : cmUnbindScroll
			});
            
            if (settings.syncScrolling === "single") {
                return this;
            }
            
			preview.bind({
				mouseover  : previewBindScroll,
				mouseout   : previewUnbindScroll,
				touchstart : previewBindScroll,
				touchend   : previewUnbindScroll
			});

            return this;
        },
        
        bindChangeEvent : function() {
            
            var _this            = this;
            var cm               = this.cm;
            var settings         = this.settings;
            
            if (!settings.syncScrolling) {
                return this;
            }
            
            cm.on("change", function(_cm, changeObj) {
                
                if (settings.watch)
                {
                    _this.previewContainer.css("padding", settings.autoHeight ? "20px 20px 50px 40px" : "20px");
                }
                
                timer = setTimeout(function() {
                    clearTimeout(timer);
                    _this.save();
                    timer = null;
                }, settings.delay);
            });

            return this;
        },
        
        /**
         * 加载队列完成之后的显示处理
         * Display handle of the module queues loaded after.
         * 
         * @param   {Boolean}   recreate   是否为重建编辑器
         * @returns {editormd}             返回editormd的实例对象
         */
        
        loadedDisplay : function(recreate) {
            
            recreate             = recreate || false;
            
            var _this            = this;
            var editor           = this.editor;
            var preview          = this.preview;
            var settings         = this.settings;
            
            this.containerMask.hide();
            
            this.save();
            
            if (settings.watch) {
                preview.show();
            }
            
            editor.data("oldWidth", editor.width()).data("oldHeight", editor.height()); // 为了兼容Zepto
            
            this.resize();
            this.registerKeyMaps();
            
            $(window).resize(function(){
                _this.resize();
            });
            
            this.bindScrollEvent().bindChangeEvent();
            
            if (!recreate)
            {
                $.proxy(settings.onload, this)();
            }
            
            this.state.loaded = true;

            return this;
        },
        
        /**
         * 设置编辑器的宽度
         * Set editor width
         * 
         * @param   {Number|String} width  编辑器宽度值
         * @returns {editormd}             返回editormd的实例对象
         */
        
        width : function(width) {
                
            this.editor.css("width", (typeof width === "number") ? width  + "px" : width);            
            this.resize();
            
            return this;
        },
        
        /**
         * 设置编辑器的高度
         * Set editor height
         * 
         * @param   {Number|String} height  编辑器高度值
         * @returns {editormd}              返回editormd的实例对象
         */
        
        height : function(height) {
                
            this.editor.css("height", (typeof height === "number")  ? height  + "px" : height);            
            this.resize();
            
            return this;
        },
        
        /**
         * 调整编辑器的尺寸和布局
         * Resize editor layout
         * 
         * @param   {Number|String} [width=null]  编辑器宽度值
         * @param   {Number|String} [height=null] 编辑器高度值
         * @returns {editormd}                    返回editormd的实例对象
         */
        
        resize : function(width, height) {
            
            width  = width  || null;
            height = height || null;
            
            var state      = this.state;
            var editor     = this.editor;
            var preview    = this.preview;
            var toolbar    = this.toolbar;
            var settings   = this.settings;
            var codeMirror = this.codeMirror;
            
            if (width)
            {
                editor.css("width", (typeof width  === "number") ? width  + "px" : width);
            }
            
            if (settings.autoHeight && !state.fullscreen && !state.preview)
            {
                editor.css("height", "auto");
                codeMirror.css("height", "auto");
            } 
            else 
            {
                if (height) 
                {
                    editor.css("height", (typeof height === "number") ? height + "px" : height);
                }
                
                if (state.fullscreen)
                {
                    editor.height($(window).height());
                }

                if (settings.toolbar && !settings.readOnly) 
                {
                    codeMirror.css("margin-top", toolbar.height() + 1).height(editor.height() - toolbar.height());
                } 
                else
                {
                    codeMirror.css("margin-top", 0).height(editor.height());
                }
            }
            
            if(settings.watch) 
            {
                codeMirror.width(editor.width() / 2);
                preview.width((!state.preview) ? editor.width() / 2 : editor.width());
                
                this.previewContainer.css("padding", settings.autoHeight ? "20px 20px 50px 40px" : "20px");
                
                if (settings.toolbar && !settings.readOnly) 
                {
                    preview.css("top", toolbar.height() + 1);
                } 
                else 
                {
                    preview.css("top", 0);
                }
                
                if (settings.autoHeight && !state.fullscreen && !state.preview)
                {
                    preview.height("");
                }
                else
                {                
                    var previewHeight = (settings.toolbar && !settings.readOnly) ? editor.height() - toolbar.height() : editor.height();
                    
                    preview.height(previewHeight);
                }
            } 
            else 
            {
                codeMirror.width(editor.width());
                preview.hide();
            }
            
            if (state.loaded) 
            {
                $.proxy(settings.onresize, this)();
            }

            return this;
        },
        
        /**
         * 解析和保存Markdown代码
         * Parse & Saving Markdown source code
         * 
         * @returns {editormd}     返回editormd的实例对象
         */
        
        save : function() {
            
            var _this            = this;
            var state            = this.state;
            var settings         = this.settings;

            if (timer === null && !(!settings.watch && state.preview))
            {
                return this;
            }
            
            var cm               = this.cm;            
            var cmValue          = cm.getValue();
            var previewContainer = this.previewContainer;

            if (settings.mode !== "gfm" && settings.mode !== "markdown") 
            {
                this.markdownTextarea.val(cmValue);
                
                return this;
            }
            
            var marked          = editormd.$marked;
            var markdownToC     = this.markdownToC = [];            
            var rendererOptions = this.markedRendererOptions = {  
                toc                  : settings.toc,
                tocm                 : settings.tocm,
                tocStartLevel        : settings.tocStartLevel,
                pageBreak            : settings.pageBreak,
                taskList             : settings.taskList,
                emoji                : settings.emoji,
                tex                  : settings.tex,
                atLink               : settings.atLink,           // for @link
                emailLink            : settings.emailLink,        // for mail address auto link
                flowChart            : settings.flowChart,
                sequenceDiagram      : settings.sequenceDiagram,
                previewCodeHighlight : settings.previewCodeHighlight,
            };
            
            var markedOptions = this.markedOptions = {
                renderer    : editormd.markedRenderer(markdownToC, rendererOptions),
                gfm         : true,
                tables      : true,
                breaks      : true,
                pedantic    : false,
                sanitize    : (settings.htmlDecode) ? false : true,  // 关闭忽略HTML标签，即开启识别HTML标签，默认为false
                smartLists  : true,
                smartypants : true
            };
            
            marked.setOptions(markedOptions);
                    
            var newMarkdownDoc = editormd.$marked(cmValue, markedOptions);
            
            //console.info("cmValue", cmValue, newMarkdownDoc);
            
            newMarkdownDoc = editormd.filterHTMLTags(newMarkdownDoc, settings.htmlDecode);
            
            //console.error("cmValue", cmValue, newMarkdownDoc);
            
            this.markdownTextarea.text(cmValue);
            
            cm.save();
            
            if (settings.saveHTMLToTextarea) 
            {
                this.htmlTextarea.text(newMarkdownDoc);
            }
            
            if(settings.watch || (!settings.watch && state.preview))
            {
                previewContainer.html(newMarkdownDoc);

                this.previewCodeHighlight();
                
                if (settings.toc) 
                {
                    var tocContainer = (settings.tocContainer === "") ? previewContainer : $(settings.tocContainer);
                    var tocMenu      = tocContainer.find("." + this.classPrefix + "toc-menu");
                    
                    tocContainer.attr("previewContainer", (settings.tocContainer === "") ? "true" : "false");
                    
                    if (settings.tocContainer !== "" && tocMenu.length > 0)
                    {
                        tocMenu.remove();
                    }
                    
                    editormd.markdownToCRenderer(markdownToC, tocContainer, settings.tocDropdown, settings.tocStartLevel);
            
                    if (settings.tocDropdown || tocContainer.find("." + this.classPrefix + "toc-menu").length > 0)
                    {
                        editormd.tocDropdownMenu(tocContainer, (settings.tocTitle !== "") ? settings.tocTitle : this.lang.tocTitle);
                    }
            
                    if (settings.tocContainer !== "")
                    {
                        previewContainer.find(".markdown-toc").css("border", "none");
                    }
                }
                
                if (settings.tex)
                {
                    if (!editormd.kaTeXLoaded && settings.autoLoadModules) 
                    {
                        editormd.loadKaTeX(function() {
                            editormd.$katex = katex;
                            editormd.kaTeXLoaded = true;
                            _this.katexRender();
                        });
                    } 
                    else 
                    {
                        editormd.$katex = katex;
                        this.katexRender();
                    }
                }                
                
                if (settings.flowChart || settings.sequenceDiagram)
                {
                    flowchartTimer = setTimeout(function(){
                        clearTimeout(flowchartTimer);
                        _this.flowChartAndSequenceDiagramRender();
                        flowchartTimer = null;
                    }, 10);
                }

                if (state.loaded) 
                {
                    $.proxy(settings.onchange, this)();
                }
            }

            return this;
        },
        
        /**
         * 聚焦光标位置
         * Focusing the cursor position
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        focus : function() {
            this.cm.focus();

            return this;
        },
        
        /**
         * 设置光标的位置
         * Set cursor position
         * 
         * @param   {Object}    cursor 要设置的光标位置键值对象，例：{line:1, ch:0}
         * @returns {editormd}         返回editormd的实例对象
         */
        
        setCursor : function(cursor) {
            this.cm.setCursor(cursor);

            return this;
        },
        
        /**
         * 获取当前光标的位置
         * Get the current position of the cursor
         * 
         * @returns {Cursor}         返回一个光标Cursor对象
         */
        
        getCursor : function() {
            return this.cm.getCursor();
        },
        
        /**
         * 设置光标选中的范围
         * Set cursor selected ranges
         * 
         * @param   {Object}    from   开始位置的光标键值对象，例：{line:1, ch:0}
         * @param   {Object}    to     结束位置的光标键值对象，例：{line:1, ch:0}
         * @returns {editormd}         返回editormd的实例对象
         */
        
        setSelection : function(from, to) {
        
            this.cm.setSelection(from, to);
        
            return this;
        },
        
        /**
         * 获取光标选中的文本
         * Get the texts from cursor selected
         * 
         * @returns {String}         返回选中文本的字符串形式
         */
        
        getSelection : function() {
            return this.cm.getSelection();
        },
        
        /**
         * 设置光标选中的文本范围
         * Set the cursor selection ranges
         * 
         * @param   {Array}    ranges  cursor selection ranges array
         * @returns {Array}            return this
         */
        
        setSelections : function(ranges) {
            this.cm.setSelections(ranges);
            
            return this;
        },
        
        /**
         * 获取光标选中的文本范围
         * Get the cursor selection ranges
         * 
         * @returns {Array}         return selection ranges array
         */
        
        getSelections : function() {
            return this.cm.getSelections();
        },
        
        /**
         * 替换当前光标选中的文本或在当前光标处插入新字符
         * Replace the text at the current cursor selected or insert a new character at the current cursor position
         * 
         * @param   {String}    value  要插入的字符值
         * @returns {editormd}         返回editormd的实例对象
         */
        
        replaceSelection : function(value) {
            this.cm.replaceSelection(value);

            return this;
        },
        
        /**
         * 在当前光标处插入新字符
         * Insert a new character at the current cursor position
         *
         * 同replaceSelection()方法
         * With the replaceSelection() method
         * 
         * @param   {String}    value  要插入的字符值
         * @returns {editormd}         返回editormd的实例对象
         */
        
        insertValue : function(value) {
            this.replaceSelection(value);

            return this;
        },
        
        /**
         * 追加markdown
         * append Markdown to editor
         * 
         * @param   {String}    md     要追加的markdown源文档
         * @returns {editormd}         返回editormd的实例对象
         */
        
        appendMarkdown : function(md) {
            var settings = this.settings;
            var cm       = this.cm;
            
            cm.setValue(cm.getValue() + md);
            
            return this;
        },
        
        /**
         * 设置和传入编辑器的markdown源文档
         * Set Markdown source document
         * 
         * @param   {String}    md     要传入的markdown源文档
         * @returns {editormd}         返回editormd的实例对象
         */
        
        setMarkdown : function(md) {
            this.cm.setValue(md || this.settings.markdown);
            
            return this;
        },
        
        /**
         * 获取编辑器的markdown源文档
         * Set Editor.md markdown/CodeMirror value
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        getMarkdown : function() {
            return this.cm.getValue();
        },
        
        /**
         * 获取编辑器的源文档
         * Get CodeMirror value
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        getValue : function() {
            return this.cm.getValue();
        },
        
        /**
         * 设置编辑器的源文档
         * Set CodeMirror value
         * 
         * @param   {String}     value   set code/value/string/text
         * @returns {editormd}           返回editormd的实例对象
         */
        
        setValue : function(value) {
            this.cm.setValue(value);
            
            return this;
        },
        
        /**
         * 清空编辑器
         * Empty CodeMirror editor container
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        clear : function() {
            this.cm.setValue("");
            
            return this;
        },
        
        /**
         * 获取解析后存放在Textarea的HTML源码
         * Get parsed html code from Textarea
         * 
         * @returns {String}               返回HTML源码
         */
        
        getHTML : function() {
            if (!this.settings.saveHTMLToTextarea)
            {
                alert("Error: settings.saveHTMLToTextarea == false");

                return false;
            }
            
            return this.htmlTextarea.val();
        },
        
        /**
         * getHTML()的别名
         * getHTML (alias)
         * 
         * @returns {String}           Return html code 返回HTML源码
         */
        
        getTextareaSavedHTML : function() {
            return this.getHTML();
        },
        
        /**
         * 获取预览窗口的HTML源码
         * Get html from preview container
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        getPreviewedHTML : function() {
            if (!this.settings.watch)
            {
                alert("Error: settings.watch == false");

                return false;
            }
            
            return this.previewContainer.html();
        },
        
        /**
         * 开启实时预览
         * Enable real-time watching
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        watch : function(callback) {     
            var settings        = this.settings;
            
            if ($.inArray(settings.mode, ["gfm", "markdown"]) < 0)
            {
                return this;
            }
            
            this.state.watching = settings.watch = true;
            this.preview.show();
            
            if (this.toolbar)
            {
                var watchIcon   = settings.toolbarIconsClass.watch;
                var unWatchIcon = settings.toolbarIconsClass.unwatch;
                
                var icon        = this.toolbar.find(".fa[name=watch]");
                icon.parent().attr("title", settings.lang.toolbar.watch);
                icon.removeClass(unWatchIcon).addClass(watchIcon);
            }
            
            this.codeMirror.css("border-right", "1px solid #ddd").width(this.editor.width() / 2); 
            
            timer = 0;
            
            this.save().resize();
            
            if (!settings.onwatch)
            {
                settings.onwatch = callback || function() {};
            }
            
            $.proxy(settings.onwatch, this)();
            
            return this;
        },
        
        /**
         * 关闭实时预览
         * Disable real-time watching
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        unwatch : function(callback) {
            var settings        = this.settings;
            this.state.watching = settings.watch = false;
            this.preview.hide();
            
            if (this.toolbar) 
            {
                var watchIcon   = settings.toolbarIconsClass.watch;
                var unWatchIcon = settings.toolbarIconsClass.unwatch;
                
                var icon    = this.toolbar.find(".fa[name=watch]");
                icon.parent().attr("title", settings.lang.toolbar.unwatch);
                icon.removeClass(watchIcon).addClass(unWatchIcon);
            }
            
            this.codeMirror.css("border-right", "none").width(this.editor.width());
            
            this.resize();
            
            if (!settings.onunwatch)
            {
                settings.onunwatch = callback || function() {};
            }
            
            $.proxy(settings.onunwatch, this)();
            
            return this;
        },
        
        /**
         * 显示编辑器
         * Show editor
         * 
         * @param   {Function} [callback=function()] 回调函数
         * @returns {editormd}                       返回editormd的实例对象
         */
        
        show : function(callback) {
            callback  = callback || function() {};
            
            var _this = this;
            this.editor.show(0, function() {
                $.proxy(callback, _this)();
            });
            
            return this;
        },
        
        /**
         * 隐藏编辑器
         * Hide editor
         * 
         * @param   {Function} [callback=function()] 回调函数
         * @returns {editormd}                       返回editormd的实例对象
         */
        
        hide : function(callback) {
            callback  = callback || function() {};
            
            var _this = this;
            this.editor.hide(0, function() {
                $.proxy(callback, _this)();
            });
            
            return this;
        },
        
        /**
         * 隐藏编辑器部分，只预览HTML
         * Enter preview html state
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        previewing : function() {
            
            var _this            = this;
            var editor           = this.editor;
            var preview          = this.preview;
            var toolbar          = this.toolbar;
            var settings         = this.settings;
            var codeMirror       = this.codeMirror;
            var previewContainer = this.previewContainer;
            
            if ($.inArray(settings.mode, ["gfm", "markdown"]) < 0) {
                return this;
            }
            
            if (settings.toolbar && toolbar) {
                toolbar.toggle();
                toolbar.find(".fa[name=preview]").toggleClass("active");
            }
            
            codeMirror.toggle();
            
            var escHandle = function(event) {
                if (event.shiftKey && event.keyCode === 27) {
                    _this.previewed();
                }
            };

            if (codeMirror.css("display") === "none") // 为了兼容Zepto，而不使用codeMirror.is(":hidden")
            {
                this.state.preview = true;

                if (this.state.fullscreen) {
                    preview.css("background", "#fff");
                }
                
                editor.find("." + this.classPrefix + "preview-close-btn").show().bind(editormd.mouseOrTouch("click", "touchend"), function(){
                    _this.previewed();
                });
            
                if (!settings.watch)
                {
                    this.save();
                } 
                else 
                {
                    previewContainer.css("padding", "");
                }
                
                previewContainer.addClass(this.classPrefix + "preview-active");

                preview.show().css({
                    position  : "",
                    top       : 0,
                    width     : editor.width(),
                    height    : (settings.autoHeight && !this.state.fullscreen) ? "auto" : editor.height()
                });
                
                if (this.state.loaded)
                {
                    $.proxy(settings.onpreviewing, this)();
                }

                $(window).bind("keyup", escHandle);
            } 
            else 
            {
                $(window).unbind("keyup", escHandle);
                this.previewed();
            }
        },
        
        /**
         * 显示编辑器部分，退出只预览HTML
         * Exit preview html state
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        previewed : function() {
            
            var editor           = this.editor;
            var preview          = this.preview;
            var toolbar          = this.toolbar;
            var settings         = this.settings;
            var previewContainer = this.previewContainer;
            var previewCloseBtn  = editor.find("." + this.classPrefix + "preview-close-btn");

            this.state.preview   = false;
            
            this.codeMirror.show();
            
            if (settings.toolbar) {
                toolbar.show();
            }
            
            preview[(settings.watch) ? "show" : "hide"]();
            
            previewCloseBtn.hide().unbind(editormd.mouseOrTouch("click", "touchend"));
                
            previewContainer.removeClass(this.classPrefix + "preview-active");
                
            if (settings.watch)
            {
                previewContainer.css("padding", "20px");
            }
            
            preview.css({ 
                background : null,
                position   : "absolute",
                width      : editor.width() / 2,
                height     : (settings.autoHeight && !this.state.fullscreen) ? "auto" : editor.height() - toolbar.height(),
                top        : (settings.toolbar)    ? toolbar.height() : 0
            });

            if (this.state.loaded)
            {
                $.proxy(settings.onpreviewed, this)();
            }
            
            return this;
        },
        
        /**
         * 编辑器全屏显示
         * Fullscreen show
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        fullscreen : function() {
            
            var _this            = this;
            var state            = this.state;
            var editor           = this.editor;
            var preview          = this.preview;
            var toolbar          = this.toolbar;
            var settings         = this.settings;
            var fullscreenClass  = this.classPrefix + "fullscreen";
            
            if (toolbar) {
                toolbar.find(".fa[name=fullscreen]").parent().toggleClass("active"); 
            }
            
            var escHandle = function(event) {
                if (!event.shiftKey && event.keyCode === 27) 
                {
                    if (state.fullscreen)
                    {
                        _this.fullscreenExit();
                    }
                }
            };

            if (!editor.hasClass(fullscreenClass)) 
            {
                state.fullscreen = true;

                $("html,body").css("overflow", "hidden");
                
                editor.css({
                    width    : $(window).width(),
                    height   : $(window).height()
                }).addClass(fullscreenClass);

                this.resize();
    
                $.proxy(settings.onfullscreen, this)();

                $(window).bind("keyup", escHandle);
            }
            else
            {           
                $(window).unbind("keyup", escHandle); 
                this.fullscreenExit();
            }

            return this;
        },
        
        /**
         * 编辑器退出全屏显示
         * Exit fullscreen state
         * 
         * @returns {editormd}         返回editormd的实例对象
         */
        
        fullscreenExit : function() {
            
            var editor            = this.editor;
            var settings          = this.settings;
            var toolbar           = this.toolbar;
            var fullscreenClass   = this.classPrefix + "fullscreen";  
            
            this.state.fullscreen = false;
            
            if (toolbar) {
                toolbar.find(".fa[name=fullscreen]").parent().removeClass("active"); 
            }

            $("html,body").css("overflow", "");

            editor.css({
                width    : editor.data("oldWidth"),
                height   : editor.data("oldHeight")
            }).removeClass(fullscreenClass);

            this.resize();
            
            $.proxy(settings.onfullscreenExit, this)();

            return this;
        },
        
        /**
         * 加载并执行插件
         * Load and execute the plugin
         * 
         * @param   {String}     name    plugin name / function name
         * @param   {String}     path    plugin load path
         * @returns {editormd}           返回editormd的实例对象
         */
        
        executePlugin : function(name, path) {
            
            var _this    = this;
            var cm       = this.cm;
            var settings = this.settings;
            
            path = settings.pluginPath + path;
            
            if (typeof define === "function") 
            {            
                if (typeof this[name] === "undefined")
                {
                    alert("Error: " + name + " plugin is not found, you are not load this plugin.");
                    
                    return this;
                }
                
                this[name](cm);
                
                return this;
            }
            
            if ($.inArray(path, editormd.loadFiles.plugin) < 0)
            {
                editormd.loadPlugin(path, function() {
                    editormd.loadPlugins[name] = _this[name];
                    _this[name](cm);
                });
            }
            else
            {
                $.proxy(editormd.loadPlugins[name], this)(cm);
            }
            
            return this;
        },
                
        /**
         * 搜索替换
         * Search & replace
         * 
         * @param   {String}     command    CodeMirror serach commands, "find, fintNext, fintPrev, clearSearch, replace, replaceAll"
         * @returns {editormd}              return this
         */
        
        search : function(command) {
            var settings = this.settings;
            
            if (!settings.searchReplace)
            {
                alert("Error: settings.searchReplace == false");
                return this;
            }
            
            if (!settings.readOnly)
            {
                this.cm.execCommand(command || "find");
            }
            
            return this;
        },
        
        searchReplace : function() {            
            this.search("replace");
            
            return this;
        },
        
        searchReplaceAll : function() {          
            this.search("replaceAll");
            
            return this;
        }
    };
    
    editormd.fn.init.prototype = editormd.fn; 
   
    /**
     * 锁屏
     * lock screen when dialog opening
     * 
     * @returns {void}
     */

    editormd.dialogLockScreen = function() {
        var settings = this.settings || {dialogLockScreen : true};
        
        if (settings.dialogLockScreen) 
        {            
            $("html,body").css("overflow", "hidden");
            this.resize();
        }
    };
   
    /**
     * 显示透明背景层
     * Display mask layer when dialog opening
     * 
     * @param   {Object}     dialog    dialog jQuery object
     * @returns {void}
     */
    
    editormd.dialogShowMask = function(dialog) {
        var editor   = this.editor;
        var settings = this.settings || {dialogShowMask : true};
        
        dialog.css({
            top  : ($(window).height() - dialog.height()) / 2 + "px",
            left : ($(window).width()  - dialog.width())  / 2 + "px"
        });

        if (settings.dialogShowMask) {
            editor.children("." + this.classPrefix + "mask").css("z-index", parseInt(dialog.css("z-index")) - 1).show();
        }
    };

    editormd.toolbarHandlers = {
        undo : function() {
            this.cm.undo();
        },
        
        redo : function() {
            this.cm.redo();
        },
        
        bold : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection("**" + selection + "**");

            if(selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 2);
            }
        },
        
        del : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection("~~" + selection + "~~");

            if(selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 2);
            }
        },

        italic : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection("*" + selection + "*");

            if(selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 1);
            }
        },

        quote : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("> " + selection);
                cm.setCursor(cursor.line, cursor.ch + 2);
            }
            else
            {
                cm.replaceSelection("> " + selection);
            }

            //cm.replaceSelection("> " + selection);
            //cm.setCursor(cursor.line, (selection === "") ? cursor.ch + 2 : cursor.ch + selection.length + 2);
        },
        
        ucfirst : function() {
            var cm         = this.cm;
            var selection  = cm.getSelection();
            var selections = cm.listSelections();

            cm.replaceSelection(editormd.firstUpperCase(selection));
            cm.setSelections(selections);
        },
        
        ucwords : function() {
            var cm         = this.cm;
            var selection  = cm.getSelection();
            var selections = cm.listSelections();

            cm.replaceSelection(editormd.wordsFirstUpperCase(selection));
            cm.setSelections(selections);
        },
        
        uppercase : function() {
            var cm         = this.cm;
            var selection  = cm.getSelection();
            var selections = cm.listSelections();

            cm.replaceSelection(selection.toUpperCase());
            cm.setSelections(selections);
        },
        
        lowercase : function() {
            var cm         = this.cm;
            var cursor     = cm.getCursor();
            var selection  = cm.getSelection();
            var selections = cm.listSelections();
            
            cm.replaceSelection(selection.toLowerCase());
            cm.setSelections(selections);
        },

        h1 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("# " + selection);
                cm.setCursor(cursor.line, cursor.ch + 2);
            }
            else
            {
                cm.replaceSelection("# " + selection);
            }
        },

        h2 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("## " + selection);
                cm.setCursor(cursor.line, cursor.ch + 3);
            }
            else
            {
                cm.replaceSelection("## " + selection);
            }
        },

        h3 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("### " + selection);
                cm.setCursor(cursor.line, cursor.ch + 4);
            }
            else
            {
                cm.replaceSelection("### " + selection);
            }
        },

        h4 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("#### " + selection);
                cm.setCursor(cursor.line, cursor.ch + 5);
            }
            else
            {
                cm.replaceSelection("#### " + selection);
            }
        },

        h5 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("##### " + selection);
                cm.setCursor(cursor.line, cursor.ch + 6);
            }
            else
            {
                cm.replaceSelection("##### " + selection);
            }
        },

        h6 : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (cursor.ch !== 0)
            {
                cm.setCursor(cursor.line, 0);
                cm.replaceSelection("###### " + selection);
                cm.setCursor(cursor.line, cursor.ch + 7);
            }
            else
            {
                cm.replaceSelection("###### " + selection);
            }
        },

        "list-ul" : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if (selection === "") 
            {
                cm.replaceSelection("- " + selection);
            } 
            else 
            {
                var selectionText = selection.split("\n");

                for (var i = 0, len = selectionText.length; i < len; i++) 
                {
                    selectionText[i] = (selectionText[i] === "") ? "" : "- " + selectionText[i];
                }

                cm.replaceSelection(selectionText.join("\n"));
            }
        },

        "list-ol" : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            if(selection === "") 
            {
                cm.replaceSelection("1. " + selection);
            }
            else
            {
                var selectionText = selection.split("\n");

                for (var i = 0, len = selectionText.length; i < len; i++) 
                {
                    selectionText[i] = (selectionText[i] === "") ? "" : (i+1) + ". " + selectionText[i];
                }

                cm.replaceSelection(selectionText.join("\n"));
            }
        },

        hr : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection(((cursor.ch !== 0) ? "\n\n" : "\n") + "------------\n\n");
        },

        tex : function() {
            if (!this.settings.tex)
            {
                alert("settings.tex === false");
                return this;
            }
            
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection("$$" + selection + "$$");

            if(selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 2);
            }
        },

        link : function() {
            this.executePlugin("linkDialog", "link-dialog/link-dialog");
        },

        "reference-link" : function() {
            this.executePlugin("referenceLinkDialog", "reference-link-dialog/reference-link-dialog");
        },

        pagebreak : function() {
            if (!this.settings.pageBreak)
            {
                alert("settings.pageBreak === false");
                return this;
            }
            
            var cm        = this.cm;
            var selection = cm.getSelection();

            cm.replaceSelection("\r\n[========]\r\n");
        },

        image : function() {
            this.executePlugin("imageDialog", "image-dialog/image-dialog");
        },
        
        code : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();

            cm.replaceSelection("`" + selection + "`");

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 1);
            }
        },

        "code-block" : function() {
            this.executePlugin("codeBlockDialog", "code-block-dialog/code-block-dialog");            
        },

        "preformatted-text" : function() {
            this.executePlugin("preformattedTextDialog", "preformatted-text-dialog/preformatted-text-dialog");
        },
        
        table : function() {
            this.executePlugin("tableDialog", "table-dialog/table-dialog");         
        },
        
        datetime : function() {
            var cm        = this.cm;
            var selection = cm.getSelection();
            var date      = new Date();
            var langName  = this.settings.lang.name;
            var datefmt   = editormd.dateFormat() + " " + editormd.dateFormat((langName === "zh-cn" || langName === "zh-tw") ? "cn-week-day" : "week-day");

            cm.replaceSelection(datefmt);
        },
        
        emoji : function() {
            this.executePlugin("emojiDialog", "emoji-dialog/emoji-dialog");
        },
                
        "html-entities" : function() {
            this.executePlugin("htmlEntitiesDialog", "html-entities-dialog/html-entities-dialog");
        },
                
        "goto-line" : function() {
            this.executePlugin("gotoLineDialog", "goto-line-dialog/goto-line-dialog");
        },

        watch : function() {    
            this[this.settings.watch ? "unwatch" : "watch"]();
        },

        preview : function() {
            this.previewing();
        },

        fullscreen : function() {
            this.fullscreen();
        },

        clear : function() {
            this.clear();
        },
        
        search : function() {
            this.search();
        },

        help : function() {
            this.executePlugin("helpDialog", "help-dialog/help-dialog");
        },

        info : function() {
            this.showInfoDialog();
        }
    };
    
    editormd.keyMaps = {
        "Ctrl-1"       : "h1",
        "Ctrl-2"       : "h2",
        "Ctrl-3"       : "h3",
        "Ctrl-4"       : "h4",
        "Ctrl-5"       : "h5",
        "Ctrl-6"       : "h6",
        "Ctrl-B"       : "bold",  // if this is string ==  editormd.toolbarHandlers.xxxx
        "Ctrl-D"       : "datetime",
        
        "Ctrl-E"       : function() { // emoji
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();
            
            if (!this.settings.emoji)
            {
                alert("Error: settings.emoji == false");
                return ;
            }

            cm.replaceSelection(":" + selection + ":");

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 1);
            }
        },
        "Ctrl-Alt-G"   : "goto-line",
        "Ctrl-H"       : "hr",
        "Ctrl-I"       : "italic",
        "Ctrl-K"       : "code",
        
        "Ctrl-L"        : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();
            
            var title = (selection === "") ? "" : " \""+selection+"\"";

            cm.replaceSelection("[" + selection + "]("+title+")");

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 1);
            }
        },
        "Ctrl-U"         : "list-ul",
        
        "Shift-Ctrl-A"   : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();
            
            if (!this.settings.atLink)
            {
                alert("Error: settings.atLink == false");
                return ;
            }

            cm.replaceSelection("@" + selection);

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 1);
            }
        },
        
        "Shift-Ctrl-C"     : "code",
        "Shift-Ctrl-Q"     : "quote",
        "Shift-Ctrl-S"     : "del",
        "Shift-Ctrl-K"     : "tex",  // KaTeX
        
        "Shift-Alt-C"      : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();
            
            cm.replaceSelection(["```", selection, "```"].join("\n"));

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 3);
            } 
        },
        
        "Shift-Ctrl-Alt-C" : "code-block",
        "Shift-Ctrl-H"     : "html-entities",
        "Shift-Alt-H"      : "help",
        "Shift-Ctrl-E"     : "emoji",
        "Shift-Ctrl-U"     : "uppercase",
        "Shift-Alt-U"      : "ucwords",
        "Shift-Ctrl-Alt-U" : "ucfirst",
        "Shift-Alt-L"      : "lowercase",
        
        "Shift-Ctrl-I"     : function() {
            var cm        = this.cm;
            var cursor    = cm.getCursor();
            var selection = cm.getSelection();
            
            var title = (selection === "") ? "" : " \""+selection+"\"";

            cm.replaceSelection("![" + selection + "]("+title+")");

            if (selection === "") {
                cm.setCursor(cursor.line, cursor.ch + 4);
            }
        },
        
        "Shift-Ctrl-Alt-I" : "image",
        "Shift-Ctrl-L"     : "link",
        "Shift-Ctrl-O"     : "list-ol",
        "Shift-Ctrl-P"     : "preformatted-text",
        "Shift-Ctrl-T"     : "table",
        "Shift-Alt-P"      : "pagebreak",
        "F9"               : "watch",
        "F10"              : "preview",
        "F11"              : "fullscreen",
    };
    
    /**
     * 清除字符串两边的空格
     * Clear the space of strings both sides.
     * 
     * @param   {String}    str            string
     * @returns {String}                   trimed string    
     */
    
    var trim = function(str) {
        return (!String.prototype.trim) ? str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, "") : str.trim();
    };
    
    editormd.trim = trim;
    
    /**
     * 所有单词首字母大写
     * Words first to uppercase
     * 
     * @param   {String}    str            string
     * @returns {String}                   string
     */
    
    var ucwords = function (str) {
        return str.toLowerCase().replace(/\b(\w)|\s(\w)/g, function($1) {  
            return $1.toUpperCase();
        });
    };
    
    editormd.ucwords = editormd.wordsFirstUpperCase = ucwords;
    
    /**
     * 字符串首字母大写
     * Only string first char to uppercase
     * 
     * @param   {String}    str            string
     * @returns {String}                   string
     */
    
    var firstUpperCase = function(str) {        
        return str.toLowerCase().replace(/\b(\w)/, function($1){
            return $1.toUpperCase();
        });
    };
    
    var ucfirst = firstUpperCase;
    
    editormd.firstUpperCase = editormd.ucfirst = firstUpperCase;
    
    editormd.urls = {
        atLinkBase : "https://github.com/"
    };
    
    editormd.regexs = {
        atLink        : /@(\w+)/g,
        email         : /(\w+)@(\w+)\.(\w+)\.?(\w+)?/g,
        emailLink     : /(mailto:)?([\w\.\_]+)@(\w+)\.(\w+)\.?(\w+)?/g,
        emoji         : /:([\w\+-]+):/g,
        emojiDatetime : /(\d{2}:\d{2}:\d{2})/g,
        twemoji       : /:(tw-([\w]+)-?(\w+)?):/g,
        fontAwesome   : /:(fa-([\w]+)(-(\w+)){0,}):/g,
        editormdLogo  : /:(editormd-logo-?(\w+)?):/g,
        pageBreak     : /^\[[=]{8,}\]$/
    };

    // Emoji graphics files url path
    editormd.emoji     = {
        path  : "http://www.emoji-cheat-sheet.com/graphics/emojis/",
        ext   : ".png"
    };

    // Twitter Emoji (Twemoji)  graphics files url path    
    editormd.twemoji = {
        path : "http://twemoji.maxcdn.com/36x36/",
        ext  : ".png"
    };

    /**
     * 自定义marked的解析器
     * Custom Marked renderer rules
     * 
     * @param   {Array}    markdownToC     传入用于接收TOC的数组
     * @returns {Renderer} markedRenderer  返回marked的Renderer自定义对象
     */

    editormd.markedRenderer = function(markdownToC, options) {
        var defaults = {
            toc                  : true,           // Table of contents
            tocm                 : true,
            tocStartLevel        : 1,              // Said from H1 to create ToC  
            pageBreak            : true,
            atLink               : true,           // for @link
            emailLink            : true,           // for mail address auto link
            taskList             : false,          // Enable Github Flavored Markdown task lists
            emoji                : false,          // :emoji: , Support Twemoji, fontAwesome, Editor.md logo emojis.
            tex                  : false,          // TeX(LaTeX), based on KaTeX
            flowChart            : true,          // flowChart.js only support IE9+
            sequenceDiagram      : true,          // sequenceDiagram.js only support IE9+
        };
        
        var settings        = $.extend(defaults, options || {});    
        var marked          = editormd.$marked;
        var markedRenderer  = new marked.Renderer();
        markdownToC         = markdownToC || [];        
            
        var regexs          = editormd.regexs;
        var atLinkReg       = regexs.atLink;
        var emojiReg        = regexs.emoji;
        var emailReg        = regexs.email;
        var emailLinkReg    = regexs.emailLink;
        var twemojiReg      = regexs.twemoji;
        var faIconReg       = regexs.fontAwesome;
        var editormdLogoReg = regexs.editormdLogo;
        var pageBreakReg    = regexs.pageBreak;

        markedRenderer.emoji = function(text) {
            
            text = text.replace(editormd.regexs.emojiDatetime, function($1) {           
                return $1.replace(/:/g, "&#58;");
            });
            
            var matchs = text.match(emojiReg);

            if (!matchs || !settings.emoji) {
                return text;
            }

            for (var i = 0, len = matchs.length; i < len; i++)
            {            
                if (matchs[i] === ":+1:") {
                    matchs[i] = ":\\+1:";
                }

                text = text.replace(new RegExp(matchs[i]), function($1, $2){
                    var faMatchs = $1.match(faIconReg);
                    var name     = $1.replace(/:/g, "");

                    if (faMatchs)
                    {                        
                        for (var fa = 0, len1 = faMatchs.length; fa < len1; fa++)
                        {
                            var faName = faMatchs[fa].replace(/:/g, "");
                            
                            return "<i class=\"fa " + faName + " fa-emoji\" title=\"" + faName.replace("fa-", "") + "\"></i>";
                        }
                    }
                    else
                    {
                        var emdlogoMathcs = $1.match(editormdLogoReg);
                        var twemojiMatchs = $1.match(twemojiReg);

                        if (emdlogoMathcs)                                        
                        {                            
                            for (var x = 0, len2 = emdlogoMathcs.length; x < len2; x++)
                            {
                                var logoName = emdlogoMathcs[x].replace(/:/g, "");
                                return "<i class=\"" + logoName + "\" title=\"Editor.md logo (" + logoName + ")\"></i>";
                            }
                        }
                        else if (twemojiMatchs) 
                        {
                            for (var t = 0, len3 = twemojiMatchs.length; t < len3; t++)
                            {
                                var twe = twemojiMatchs[t].replace(/:/g, "").replace("tw-", "");
                                return "<img src=\"" + editormd.twemoji.path + twe + editormd.twemoji.ext + "\" title=\"twemoji-" + twe + "\" alt=\"twemoji-" + twe + "\" class=\"emoji twemoji\" />";
                            }
                        }
                        else
                        {
                            var src = (name === "+1") ? "plus1" : name;
                            src     = (src === "black_large_square") ? "black_square" : src;
                            src     = (src === "moon") ? "waxing_gibbous_moon" : src;

                            return "<img src=\"" + editormd.emoji.path + src + editormd.emoji.ext + "\" class=\"emoji\" title=\"&#58;" + name + "&#58;\" alt=\"&#58;" + name + "&#58;\" />";
                        }
                    }
                });
            }

            return text;
        };

        markedRenderer.atLink = function(text) {

            if (atLinkReg.test(text))
            { 
                if (settings.atLink) 
                {
                    text = text.replace(emailReg, function($1, $2, $3, $4) {
                        return $1.replace(/@/g, "_#_&#64;_#_");
                    });

                    text = text.replace(atLinkReg, function($1, $2) {
                        return "<a href=\"" + editormd.urls.atLinkBase + "" + $2 + "\" title=\"&#64;" + $2 + "\" class=\"at-link\">" + $1 + "</a>";
                    }).replace(/_#_&#64;_#_/g, "@");
                }
                
                if (settings.emailLink)
                {
                    text = text.replace(emailLinkReg, function($1, $2, $3, $4, $5) {
                        return (!$2 && $.inArray($5, "jpg|jpeg|png|gif|webp|ico|icon|pdf".split("|")) < 0) ? "<a href=\"mailto:" + $1 + "\">"+$1+"</a>" : $1;
                    });
                }

                return text;
            }

            return text;
        };
                
        markedRenderer.link = function (href, title, text) {

            if (this.options.sanitize) {
                try {
                    var prot = decodeURIComponent(unescape(href)).replace(/[^\w:]/g,"").toLowerCase();
                } catch(e) {
                    return "";
                }

                if (prot.indexOf("javascript:") === 0) {
                    return "";
                }
            }

            var out = "<a href=\"" + href + "\"";
            
            if (atLinkReg.test(title) || atLinkReg.test(text))
            {
                if (title)
                {
                    out += " title=\"" + title.replace(/@/g, "&#64;");
                }
                
                return out + "\">" + text.replace(/@/g, "&#64;") + "</a>";
            }

            if (title) {
                out += " title=\"" + title + "\"";
            }

            out += ">" + text + "</a>";

            return out;
        };
        
        markedRenderer.heading = function(text, level, raw) {
                    
            var linkText       = text;
            var hasLinkReg     = /\s*\<a\s*href\=\"(.*)\"\s*([^\>]*)\>(.*)\<\/a\>\s*/;
            var getLinkTextReg = /\s*\<a\s*([^\>]+)\>([^\>]*)\<\/a\>\s*/g;

            if (hasLinkReg.test(text)) 
            {
                var tempText = [];
                text         = text.split(/\<a\s*([^\>]+)\>([^\>]*)\<\/a\>/);

                for (var i = 0, len = text.length; i < len; i++)
                {
                    tempText.push(text[i].replace(/\s*href\=\"(.*)\"\s*/g, ""));
                }

                text = tempText.join(" ");
            }
            
            text = trim(text);
            
            var escapedText    = text.toLowerCase().replace(/[^\w]+/g, "-");
            var toc = {
                text  : text,
                level : level,
                slug  : escapedText
            };
            
            var isChinese = /^[\u4e00-\u9fa5]+$/.test(text);
            var id        = (isChinese) ? escape(text).replace(/\%/g, "") : text.toLowerCase().replace(/[^\w]+/g, "-");

            markdownToC.push(toc);
            
            var headingHTML = "<h" + level + " id=\"h"+ level + "-" + this.options.headerPrefix + id +"\">";
            
            headingHTML    += "<a name=\"" + text + "\" class=\"reference-link\"></a>";
            headingHTML    += "<span class=\"header-link octicon octicon-link\"></span>";
            headingHTML    += (hasLinkReg) ? this.atLink(this.emoji(linkText)) : this.atLink(this.emoji(text));
            headingHTML    += "</h" + level + ">";

            return headingHTML;
        };
        
        markedRenderer.pageBreak = function(text) {
            if (pageBreakReg.test(text) && settings.pageBreak)
            {
                text = "<hr style=\"page-break-after:always;\" class=\"page-break editormd-page-break\" />";
            }
            
            return text;
        };

        markedRenderer.paragraph = function(text) {
            var isTeXInline     = /\$\$(.*)\$\$/g.test(text);
            var isTeXLine       = /^\$\$(.*)\$\$$/.test(text);
            var isTeXAddClass   = (isTeXLine)     ? " class=\"" + editormd.classNames.tex + "\"" : "";
            var isToC           = (settings.tocm) ? /^(\[TOC\]|\[TOCM\])$/.test(text) : /^\[TOC\]$/.test(text);
            var isToCMenu       = /^\[TOCM\]$/.test(text);
            
            if (!isTeXLine && isTeXInline) 
            {
                text = text.replace(/(\$\$([^\$]*)\$\$)+/g, function($1, $2) {
                    return "<span class=\"" + editormd.classNames.tex + "\">" + $2.replace(/\$/g, "") + "</span>";
                });
            } 
            else 
            {
                text = (isTeXLine) ? text.replace(/\$/g, "") : text;
            }
            
            var tocHTML = "<div class=\"markdown-toc editormd-markdown-toc\">" + text + "</div>";
            
            return (isToC) ? ( (isToCMenu) ? "<div class=\"editormd-toc-menu\">" + tocHTML + "</div><br/>" : tocHTML )
                           : ( (pageBreakReg.test(text)) ? this.pageBreak(text) : "<p" + isTeXAddClass + ">" + this.atLink(this.emoji(text)) + "</p>\n" );
        };

        markedRenderer.code = function (code, lang, escaped) { 

            if (lang === "seq" || lang === "sequence")
            {
                return "<div class=\"sequence-diagram\">" + code + "</div>";
            } 
            else if ( lang === "flow")
            {
                return "<div class=\"flowchart\">" + code + "</div>";
            } 
            else if ( lang === "math" || lang === "latex" || lang === "katex")
            {
                return "<p class=\"" + editormd.classNames.tex + "\">" + code + "</p>";
            } 
            else 
            {

                return marked.Renderer.prototype.code.apply(this, arguments);
            }
        };

        markedRenderer.tablecell = function(content, flags) {
            var type = (flags.header) ? "th" : "td";
            var tag  = (flags.align)  ? "<" + type +" style=\"text-align:" + flags.align + "\">" : "<" + type + ">";

            return tag + this.atLink(this.emoji(content)) + "</" + type + ">\n";
        };

        markedRenderer.listitem = function(text) {
            if (settings.taskList && /^\s*\[[x\s]\]\s*/.test(text)) 
            {
                text = text.replace(/^\s*\[\s\]\s*/, "<input type=\"checkbox\" class=\"task-list-item-checkbox\" /> ")
                           .replace(/^\s*\[x\]\s*/,  "<input type=\"checkbox\" class=\"task-list-item-checkbox\" checked disabled /> ");

                return "<li style=\"list-style: none;\">" + this.atLink(this.emoji(text)) + "</li>";
            }
            else 
            {
                return "<li>" + this.atLink(this.emoji(text)) + "</li>";
            }
        };
        
        return markedRenderer;
    };
    
    /**
     *
     * 生成TOC(Table of Contents)
     * Creating ToC (Table of Contents)
     * 
     * @param   {Array}    toc             从marked获取的TOC数组列表
     * @param   {Element}  container       插入TOC的容器元素
     * @param   {Integer}  startLevel      Hx 起始层级
     * @returns {Object}   tocContainer    返回ToC列表容器层的jQuery对象元素
     */
    
    editormd.markdownToCRenderer = function(toc, container, tocDropdown, startLevel) {
        
        var html        = "";    
        var lastLevel   = 0;
        var classPrefix = this.classPrefix;
        
        startLevel      = startLevel  || 1;
        
        for (var i = 0, len = toc.length; i < len; i++) 
        {
            var text  = toc[i].text;
            var level = toc[i].level;
            var slug = toc[i].slug;
            
            if (level < startLevel) {
                continue;
            }
            
            if (level > lastLevel) 
            {
                html += "";
            }
            else if (level < lastLevel) 
            {
                html += (new Array(lastLevel - level + 2)).join("</ul></li>");
            } 
            else 
            {
                html += "</ul></li>";
            }

            html += "<li><a class=\"toc-level-" + level + "\" href=\"#" + slug + "\" level=\"" + level + "\">" + text + "</a><ul>";
            lastLevel = level;
        }
        
        var tocContainer = container.find(".markdown-toc");
        
        if ((tocContainer.length < 1 && container.attr("previewContainer") === "false"))
        {
            var tocHTML = "<div class=\"markdown-toc " + classPrefix + "markdown-toc\"></div>";
            
            tocHTML = (tocDropdown) ? "<div class=\"" + classPrefix + "toc-menu\">" + tocHTML + "</div>" : tocHTML;
            
            container.html(tocHTML);
            
            tocContainer = container.find(".markdown-toc");
        }
        
        if (tocDropdown)
        {
            tocContainer.wrap("<div class=\"" + classPrefix + "toc-menu\"></div><br/>");
        }
        
        tocContainer.html("<ul class=\"markdown-toc-list\"></ul>").children(".markdown-toc-list").html(html.replace(/\r?\n?\<ul\>\<\/ul\>/g, ""));
        
        return tocContainer;
    };
    
    /**
     *
     * 生成TOC下拉菜单
     * Creating ToC dropdown menu
     * 
     * @param   {Object}   container       插入TOC的容器jQuery对象元素
     * @param   {String}   tocTitle        ToC title
     * @returns {Object}                   return toc-menu object
     */
    
    editormd.tocDropdownMenu = function(container, tocTitle) {
        
        tocTitle      = tocTitle || "Table of Contents";
        
        var zindex    = 400;
        var tocMenus  = container.find("." + this.classPrefix + "toc-menu");

        tocMenus.each(function() {
            var $this  = $(this);
            var toc    = $this.children(".markdown-toc");
            var icon   = "<i class=\"fa fa-angle-down\"></i>";
            var btn    = "<a href=\"javascript:;\" class=\"toc-menu-btn\">" + icon + tocTitle + "</a>";
            var menu   = toc.children("ul");            
            var list   = menu.find("li");
            
            toc.append(btn);
            
            list.first().before("<li><h1>" + tocTitle + " " + icon + "</h1></li>");
            
            $this.mouseover(function(){
                menu.show();

                list.each(function(){
                    var li = $(this);
                    var ul = li.children("ul");

                    if (ul.html() === "")
                    {
                        ul.remove();
                    }

                    if (ul.length > 0 && ul.html() !== "")
                    {
                        var firstA = li.children("a").first();

                        if (firstA.children(".fa").length < 1)
                        {
                            firstA.append( $(icon).css({ float:"right", paddingTop:"4px" }) );
                        }
                    }

                    li.mouseover(function(){
                        ul.css("z-index", zindex).show();
                        zindex += 1;
                    }).mouseleave(function(){
                        ul.hide();
                    });
                });
            }).mouseleave(function(){
                menu.hide();
            }); 
        });       
        
        return tocMenus;
    };
    
    /**
     * 简单地过滤指定的HTML标签
     * Filter custom html tags
     * 
     * @param   {String}   html          要过滤HTML
     * @param   {String}   filters       要过滤的标签
     * @returns {String}   html          返回过滤的HTML
     */
    
    editormd.filterHTMLTags = function(html, filters) {
        
        if (typeof html !== "string") {
            html = new String(html);
        }
            
        if (typeof filters !== "string") {
            return html;
        }

        var expression = filters.split("|");
        var filterTags = expression[0].split(",");
        var attrs      = expression[1];

        for (var i = 0, len = filterTags.length; i < len; i++)
        {
            var tag = filterTags[i];

            html = html.replace(new RegExp("\<\s*" + tag + "\s*([^\>]*)\>([^\>]*)\<\s*\/" + tag + "\s*\>", "igm"), "");
        }
        
        //return html;

        if (typeof attrs !== "undefined")
        {
            var htmlTagRegex = /\<(\w+)\s*([^\>]*)\>([^\>]*)\<\/(\w+)\>/ig;

            if (attrs === "*")
            {
                html = html.replace(htmlTagRegex, function($1, $2, $3, $4, $5) {
                    return "<" + $2 + ">" + $4 + "</" + $5 + ">";
                });         
            }
            else if (attrs === "on*")
            {
                html = html.replace(htmlTagRegex, function($1, $2, $3, $4, $5) {
                    var el = $("<" + $2 + ">" + $4 + "</" + $5 + ">");
                    var _attrs = $($1)[0].attributes;
                    var $attrs = {};
                    
                    $.each(_attrs, function(i, e) {
                        if (e.nodeName !== '"') $attrs[e.nodeName] = e.nodeValue;
                    });
                    
                    $.each($attrs, function(i) {                        
                        if (i.indexOf("on") === 0) {
                            delete $attrs[i];
                        }
                    });
                    
                    el.attr($attrs);
                    
                    var text = (typeof el[1] !== "undefined") ? $(el[1]).text() : "";

                    return el[0].outerHTML + text;
                });
            }
            else
            {
                html = html.replace(htmlTagRegex, function($1, $2, $3, $4) {
                    var filterAttrs = attrs.split(",");
                    var el = $($1);
                    el.html($4);

                    $.each(filterAttrs, function(i) {
                        el.attr(filterAttrs[i], null);
                    });

                    return el[0].outerHTML;
                });
            }
        }
        
        return html;
    };
    
    /**
     * 将Markdown文档解析为HTML用于前台显示
     * Parse Markdown to HTML for Font-end preview.
     * 
     * @param   {String}   id            用于显示HTML的对象ID
     * @param   {Object}   [options={}]  配置选项，可选
     * @returns {Object}   div           返回jQuery对象元素
     */
    
    editormd.markdownToHTML = function(id, options) {
        var defaults = {
            gfm                  : true,
            toc                  : true,
            tocm                 : false,
            tocStartLevel        : 1,
            tocTitle             : "Оглавление",
            tocDropdown          : false,
            tocContainer         : "",
            markdown             : "",
            markdownSourceCode   : false,
            htmlDecode           : false,
            autoLoadKaTeX        : true,
            pageBreak            : true,
            atLink               : true,    // for @link
            emailLink            : true,    // for mail address auto link
            tex                  : false,
            taskList             : false,   // Github Flavored Markdown task lists
            emoji                : false,
            flowChart            : true,
            sequenceDiagram      : false,
            previewCodeHighlight : true
        };
        
        editormd.$marked  = marked;

        var div           = $("#" + id);
        var settings      = div.settings = $.extend(true, defaults, options || {});
        var saveTo        = div.find("textarea");
        
        if (saveTo.length < 1)
        {
            div.append("<textarea></textarea>");
            saveTo        = div.find("textarea");
        }        
        
        var markdownDoc   = (settings.markdown === "") ? saveTo.val() : settings.markdown; 
        var markdownToC   = [];

        var rendererOptions = {  
            toc                  : settings.toc,
            tocm                 : settings.tocm,
            tocStartLevel        : settings.tocStartLevel,
            taskList             : settings.taskList,
            emoji                : settings.emoji,
            tex                  : settings.tex,
            pageBreak            : settings.pageBreak,
            atLink               : settings.atLink,           // for @link
            emailLink            : settings.emailLink,        // for mail address auto link
            flowChart            : settings.flowChart,
            sequenceDiagram      : settings.sequenceDiagram,
            previewCodeHighlight : settings.previewCodeHighlight,
        };

        var markedOptions = {
            renderer    : editormd.markedRenderer(markdownToC, rendererOptions),
            gfm         : settings.gfm,
            tables      : true,
            breaks      : true,
            pedantic    : false,
            sanitize    : (settings.htmlDecode) ? false : true, // 是否忽略HTML标签，即是否开启HTML标签解析，为了安全性，默认不开启
            smartLists  : true,
            smartypants : true
        };
        
		markdownDoc = new String(markdownDoc);
        
        var markdownParsed = marked(markdownDoc, markedOptions);
        
        markdownParsed = editormd.filterHTMLTags(markdownParsed, settings.htmlDecode);
        
        if (settings.markdownSourceCode) {
            saveTo.text(markdownDoc);
        } else {
            saveTo.remove();
        }
        
        div.addClass("markdown-body " + this.classPrefix + "html-preview").append(markdownParsed);
        
        var tocContainer = (settings.tocContainer !== "") ? $(settings.tocContainer) : div;
        
        if (settings.tocContainer !== "")
        {
            tocContainer.attr("previewContainer", false);
        }
         
        if (settings.toc) 
        {
            div.tocContainer = this.markdownToCRenderer(markdownToC, tocContainer, settings.tocDropdown, settings.tocStartLevel);
            
            if (settings.tocDropdown || div.find("." + this.classPrefix + "toc-menu").length > 0)
            {
                this.tocDropdownMenu(div, settings.tocTitle);
            }
            
            if (settings.tocContainer !== "")
            {
                div.find(".editormd-toc-menu, .editormd-markdown-toc").remove();
            }
        }
            
        if (settings.previewCodeHighlight) 
        {
            div.find("pre").addClass("prettyprint linenums");
            prettyPrint();
        }
        
        if (!editormd.isIE8) 
        {
            if (settings.flowChart) {
                div.find(".flowchart").flowChart(); 
            }

            if (settings.sequenceDiagram) {
                div.find(".sequence-diagram").sequenceDiagram({theme: "simple"});
            }
        }

        if (settings.tex)
        {
            var katexHandle = function() {
                div.find("." + editormd.classNames.tex).each(function(){
                    var tex  = $(this);                    
                    katex.render(tex.html().replace(/&lt;/g, "<").replace(/&gt;/g, ">"), tex[0]);                    
                    tex.find(".katex").css("font-size", "1.6em");
                });
            };
            
            if (settings.autoLoadKaTeX && !editormd.$katex && !editormd.kaTeXLoaded)
            {
                this.loadKaTeX(function() {
                    editormd.$katex      = katex;
                    editormd.kaTeXLoaded = true;
                    katexHandle();
                });
            }
            else
            {
                katexHandle();
            }
        }
        
        div.getMarkdown = function() {            
            return saveTo.val();
        };
        
        return div;
    };
    
    // Editor.md themes, change toolbar themes etc.
    // added @1.5.0
    editormd.themes        = ["default", "dark"];
    
    // Preview area themes
    // added @1.5.0
    editormd.previewThemes = ["default", "dark"];
    
    // CodeMirror / editor area themes
    // @1.5.0 rename -> editorThemes, old version -> themes
    editormd.editorThemes = [
        "default", "3024-day", "3024-night",
        "ambiance", "ambiance-mobile",
        "base16-dark", "base16-light", "blackboard",
        "cobalt",
        "eclipse", "elegant", "erlang-dark",
        "lesser-dark",
        "mbo", "mdn-like", "midnight", "monokai",
        "neat", "neo", "night",
        "paraiso-dark", "paraiso-light", "pastel-on-dark",
        "rubyblue",
        "solarized",
        "the-matrix", "tomorrow-night-eighties", "twilight",
        "vibrant-ink",
        "xq-dark", "xq-light"
    ];

    editormd.loadPlugins = {};
    
    editormd.loadFiles = {
        js     : [],
        css    : [],
        plugin : []
    };
    
    /**
     * 动态加载Editor.md插件，但不立即执行
     * Load editor.md plugins
     * 
     * @param {String}   fileName              插件文件路径
     * @param {Function} [callback=function()] 加载成功后执行的回调函数
     * @param {String}   [into="head"]         嵌入页面的位置
     */
    
    editormd.loadPlugin = function(fileName, callback, into) {
        callback   = callback || function() {};
        
        this.loadScript(fileName, function() {
            editormd.loadFiles.plugin.push(fileName);
            callback();
        }, into);
    };
    
    /**
     * 动态加载CSS文件的方法
     * Load css file method
     * 
     * @param {String}   fileName              CSS文件名
     * @param {Function} [callback=function()] 加载成功后执行的回调函数
     * @param {String}   [into="head"]         嵌入页面的位置
     */
    
    editormd.loadCSS   = function(fileName, callback, into) {
        into       = into     || "head";        
        callback   = callback || function() {};
        
        var css    = document.createElement("link");
        css.type   = "text/css";
        css.rel    = "stylesheet";
        css.onload = css.onreadystatechange = function() {
            editormd.loadFiles.css.push(fileName);
            callback();
        };

        css.href   = fileName + ".css";

        if(into === "head") {
            document.getElementsByTagName("head")[0].appendChild(css);
        } else {
            document.body.appendChild(css);
        }
    };
    
    editormd.isIE    = (navigator.appName == "Microsoft Internet Explorer");
    editormd.isIE8   = (editormd.isIE && navigator.appVersion.match(/8./i) == "8.");

    /**
     * 动态加载JS文件的方法
     * Load javascript file method
     * 
     * @param {String}   fileName              JS文件名
     * @param {Function} [callback=function()] 加载成功后执行的回调函数
     * @param {String}   [into="head"]         嵌入页面的位置
     */

    editormd.loadScript = function(fileName, callback, into) {
        
        into          = into     || "head";
        callback      = callback || function() {};
        
        var script    = null; 
        script        = document.createElement("script");
        script.id     = fileName.replace(/[\./]+/g, "-");
        script.type   = "text/javascript";        
        script.src    = fileName + ".js" + '?' + new Date().getTime();
        
        if (editormd.isIE8) 
        {            
            script.onreadystatechange = function() {
                if(script.readyState) 
                {
                    if (script.readyState === "loaded" || script.readyState === "complete") 
                    {
                        script.onreadystatechange = null; 
                        editormd.loadFiles.js.push(fileName);
                        callback();
                    }
                } 
            };
        }
        else
        {
            script.onload = function() {
                editormd.loadFiles.js.push(fileName);
                callback();
            };
        }

        if (into === "head") {
            document.getElementsByTagName("head")[0].appendChild(script);
        } else {
            document.body.appendChild(script);
        }
    };
    
    // 使用国外的CDN，加载速度有时会很慢，或者自定义URL
    // You can custom KaTeX load url.
    editormd.katexURL  = {
        css : "//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min",
        js  : "//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min"
    };
    
    editormd.kaTeXLoaded = false;
    
    /**
     * 加载KaTeX文件
     * load KaTeX files
     * 
     * @param {Function} [callback=function()]  加载成功后执行的回调函数
     */
    
    editormd.loadKaTeX = function (callback) {
        editormd.loadCSS(editormd.katexURL.css, function(){
            editormd.loadScript(editormd.katexURL.js, callback || function(){});
        });
    };
        
    /**
     * 锁屏
     * lock screen
     * 
     * @param   {Boolean}   lock   Boolean 布尔值，是否锁屏
     * @returns {void}
     */
    
    editormd.lockScreen = function(lock) {
        $("html,body").css("overflow", (lock) ? "hidden" : "");
    };
        
    /**
     * 动态创建对话框
     * Creating custom dialogs
     * 
     * @param   {Object} options 配置项键值对 Key/Value
     * @returns {dialog} 返回创建的dialog的jQuery实例对象
     */

    editormd.createDialog = function(options) {
        var defaults = {
            name : "",
            width : 420,
            height: 240,
            title : "",
            drag  : true,
            closed : true,
            content : "",
            mask : true,
            maskStyle : {
                backgroundColor : "#fff",
                opacity : 0.1
            },
            lockScreen : true,
            footer : true,
            buttons : false
        };

        options          = $.extend(true, defaults, options);
        
        var $this        = this;
        var editor       = this.editor;
        var classPrefix  = editormd.classPrefix;
        var guid         = (new Date()).getTime();
        var dialogName   = ( (options.name === "") ? classPrefix + "dialog-" + guid : options.name);
        var mouseOrTouch = editormd.mouseOrTouch;

        var html         = "<div class=\"" + classPrefix + "dialog " + dialogName + "\">";

        if (options.title !== "")
        {
            html += "<div class=\"" + classPrefix + "dialog-header\"" + ( (options.drag) ? " style=\"cursor: move;\"" : "" ) + ">";
            html += "<strong class=\"" + classPrefix + "dialog-title\">" + options.title + "</strong>";
            html += "</div>";
        }

        if (options.closed)
        {
            html += "<a href=\"javascript:;\" class=\"fa fa-close " + classPrefix + "dialog-close\"></a>";
        }

        html += "<div class=\"" + classPrefix + "dialog-container\">" + options.content;                    

        if (options.footer || typeof options.footer === "string") 
        {
            html += "<div class=\"" + classPrefix + "dialog-footer\">" + ( (typeof options.footer === "boolean") ? "" : options.footer) + "</div>";
        }

        html += "</div>";

        html += "<div class=\"" + classPrefix + "dialog-mask " + classPrefix + "dialog-mask-bg\"></div>";
        html += "<div class=\"" + classPrefix + "dialog-mask " + classPrefix + "dialog-mask-con\"></div>";
        html += "</div>";

        editor.append(html);

        var dialog = editor.find("." + dialogName);

        dialog.lockScreen = function(lock) {
            if (options.lockScreen)
            {                
                $("html,body").css("overflow", (lock) ? "hidden" : "");
                $this.resize();
            }

            return dialog;
        };

        dialog.showMask = function() {
            if (options.mask)
            {
                editor.find("." + classPrefix + "mask").css(options.maskStyle).css("z-index", editormd.dialogZindex - 1).show();
            }
            return dialog;
        };

        dialog.hideMask = function() {
            if (options.mask)
            {
                editor.find("." + classPrefix + "mask").hide();
            }

            return dialog;
        };

        dialog.loading = function(show) {                        
            var loading = dialog.find("." + classPrefix + "dialog-mask");
            loading[(show) ? "show" : "hide"]();

            return dialog;
        };

        dialog.lockScreen(true).showMask();

        dialog.show().css({
            zIndex : editormd.dialogZindex,
            border : (editormd.isIE8) ? "1px solid #ddd" : "",
            width  : (typeof options.width  === "number") ? options.width + "px"  : options.width,
            height : (typeof options.height === "number") ? options.height + "px" : options.height
        });

        var dialogPosition = function(){
            dialog.css({
                top    : ($(window).height() - dialog.height()) / 2 + "px",
                left   : ($(window).width() - dialog.width()) / 2 + "px"
            });
        };

        dialogPosition();

        $(window).resize(dialogPosition);

        dialog.children("." + classPrefix + "dialog-close").bind(mouseOrTouch("click", "touchend"), function() {
            dialog.hide().lockScreen(false).hideMask();
        });

        if (typeof options.buttons === "object")
        {
            var footer = dialog.footer = dialog.find("." + classPrefix + "dialog-footer");

            for (var key in options.buttons)
            {
                var btn = options.buttons[key];
                var btnClassName = classPrefix + key + "-btn";

                footer.append("<button class=\"" + classPrefix + "btn " + btnClassName + "\">" + btn[0] + "</button>");
                btn[1] = $.proxy(btn[1], dialog);
                footer.children("." + btnClassName).bind(mouseOrTouch("click", "touchend"), btn[1]);
            }
        }

        if (options.title !== "" && options.drag)
        {                        
            var posX, posY;
            var dialogHeader = dialog.children("." + classPrefix + "dialog-header");

            if (!options.mask) {
                dialogHeader.bind(mouseOrTouch("click", "touchend"), function(){
                    editormd.dialogZindex += 2;
                    dialog.css("z-index", editormd.dialogZindex);
                });
            }

            dialogHeader.mousedown(function(e) {
                e = e || window.event;  //IE
                posX = e.clientX - parseInt(dialog[0].style.left);
                posY = e.clientY - parseInt(dialog[0].style.top);

                document.onmousemove = moveAction;                   
            });

            var userCanSelect = function (obj) {
                obj.removeClass(classPrefix + "user-unselect").off("selectstart");
            };

            var userUnselect = function (obj) {
                obj.addClass(classPrefix + "user-unselect").on("selectstart", function(event) { // selectstart for IE                        
                    return false;
                });
            };

            var moveAction = function (e) {
                e = e || window.event;  //IE

                var left, top, nowLeft = parseInt(dialog[0].style.left), nowTop = parseInt(dialog[0].style.top);

                if( nowLeft >= 0 ) {
                    if( nowLeft + dialog.width() <= $(window).width()) {
                        left = e.clientX - posX;
                    } else {	
                        left = $(window).width() - dialog.width();
                        document.onmousemove = null;
                    }
                } else {
                    left = 0;
                    document.onmousemove = null;
                }

                if( nowTop >= 0 ) {
                    top = e.clientY - posY;
                } else {
                    top = 0;
                    document.onmousemove = null;
                }


                document.onselectstart = function() {
                    return false;
                };

                userUnselect($("body"));
                userUnselect(dialog);
                dialog[0].style.left = left + "px";
                dialog[0].style.top  = top + "px";
            };

            document.onmouseup = function() {                            
                userCanSelect($("body"));
                userCanSelect(dialog);

                document.onselectstart = null;         
                document.onmousemove = null;
            };

            dialogHeader.touchDraggable = function() {
                var offset = null;
                var start  = function(e) {
                    var orig = e.originalEvent; 
                    var pos  = $(this).parent().position();

                    offset = {
                        x : orig.changedTouches[0].pageX - pos.left,
                        y : orig.changedTouches[0].pageY - pos.top
                    };
                };

                var move = function(e) {
                    e.preventDefault();
                    var orig = e.originalEvent;

                    $(this).parent().css({
                        top  : orig.changedTouches[0].pageY - offset.y,
                        left : orig.changedTouches[0].pageX - offset.x
                    });
                };

                this.bind("touchstart", start).bind("touchmove", move);
            };

            dialogHeader.touchDraggable();
        }

        editormd.dialogZindex += 2;

        return dialog;
    };
    
    /**
     * 鼠标和触摸事件的判断/选择方法
     * MouseEvent or TouchEvent type switch
     * 
     * @param   {String} [mouseEventType="click"]    供选择的鼠标事件
     * @param   {String} [touchEventType="touchend"] 供选择的触摸事件
     * @returns {String} EventType                   返回事件类型名称
     */
    
    editormd.mouseOrTouch = function(mouseEventType, touchEventType) {
        mouseEventType = mouseEventType || "click";
        touchEventType = touchEventType || "touchend";
        
        var eventType  = mouseEventType;

        try {
            document.createEvent("TouchEvent");
            eventType = touchEventType;
        } catch(e) {}

        return eventType;
    };
    
    /**
     * 日期时间的格式化方法
     * Datetime format method
     * 
     * @param   {String}   [format=""]  日期时间的格式，类似PHP的格式
     * @returns {String}   datefmt      返回格式化后的日期时间字符串
     */
    
    editormd.dateFormat = function(format) {                
        format      = format || "";

        var addZero = function(d) {
            return (d < 10) ? "0" + d : d;
        };

        var date    = new Date(); 
        var year    = date.getFullYear();
        var year2   = year.toString().slice(2, 4);
        var month   = addZero(date.getMonth() + 1);
        var day     = addZero(date.getDate());
        var weekDay = date.getDay();
        var hour    = addZero(date.getHours());
        var min     = addZero(date.getMinutes());
        var second  = addZero(date.getSeconds());
        var ms      = addZero(date.getMilliseconds()); 
        var datefmt = "";

        var ymd     = year2 + "-" + month + "-" + day;
        var fymd    = year  + "-" + month + "-" + day;
        var hms     = hour  + ":" + min   + ":" + second;

        switch (format) 
        {
            case "UNIX Time" :
                    datefmt = date.getTime();
                break;

            case "UTC" :
                    datefmt = date.toUTCString();
                break;	

            case "yy" :
                    datefmt = year2;
                break;	

            case "year" :
            case "yyyy" :
                    datefmt = year;
                break;

            case "month" :
            case "mm" :
                    datefmt = month;
                break;                        

            case "cn-week-day" :
            case "cn-wd" :
                    var cnWeekDays = ["日", "一", "二", "三", "四", "五", "六"];
                    datefmt = "星期" + cnWeekDays[weekDay];
                break;

            case "week-day" :
            case "wd" :
                    var weekDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    datefmt = weekDays[weekDay];
                break;

            case "day" :
            case "dd" :
                    datefmt = day;
                break;

            case "hour" :
            case "hh" :
                    datefmt = hour;
                break;

            case "min" :
            case "ii" :
                    datefmt = min;
                break;

            case "second" :
            case "ss" :
                    datefmt = second;
                break;

            case "ms" :
                    datefmt = ms;
                break;

            case "yy-mm-dd" :
                    datefmt = ymd;
                break;

            case "yyyy-mm-dd" :
                    datefmt = fymd;
                break;

            case "yyyy-mm-dd h:i:s ms" :
            case "full + ms" : 
                    datefmt = fymd + " " + hms + " " + ms;
                break;

            case "full" :
            case "yyyy-mm-dd h:i:s" :
                default:
                    datefmt = fymd + " " + hms;
                break;
        }

        return datefmt;
    };

    return editormd;

}));

/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/main.ui.grid/templates/.default/script.min.js?151124257227443";s:6:"source";s:67:"/bitrix/components/bitrix/main.ui.grid/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.grid=function(t,e,i,n,s,o,a,r,l){this.settings=null;this.containerId="";this.container=null;this.wrapper=null;this.fadeContainer=null;this.scrollContainer=null;this.pagination=null;this.moreButton=null;this.table=null;this.rows=null;this.history=false;this.userOptions=null;this.checkAll=null;this.sortable=null;this.updater=null;this.data=null;this.fader=null;this.editor=null;this.isEditMode=null;this.pinHeader=null;this.pinPanel=null;this.arParams=null;this.resize=null;this.init(t,e,i,n,s,o,a,r,l)};BX.Main.grid.isNeedResourcesReady=function(t){return BX.hasClass(t,"main-grid-load-animation")};BX.Main.grid.prototype={init:function(t,e,i,n,s,o,a,r,l){this.initArguments=[].slice.call(arguments);this.container=BX(t);var d=BX.browser.IsSafari()&&!BX.browser.IsChrome();var h=!!BX.Main.gridManager&&BX.Main.gridManager.data.length>0;if(!d&&!h&&BX.Main.grid.isNeedResourcesReady(this.container)){BX.bind(this.container,"animationend",BX.proxy(this._onResourcesReady,this))}else{this.initAfterResourcesReady.apply(this,this.initArguments)}},_onResourcesReady:function(t){if(t.animationName==="main-grid-load"){this.initAfterResourcesReady.apply(this,this.initArguments)}},initAfterResourcesReady:function(t,e,i,n,s,o,a,r,l){if(!BX.type.isNotEmptyString(t)){throw"BX.Main.grid.init: parameter containerId is empty"}if(BX.type.isPlainObject(e)){this.arParams=e}else{throw new Error("BX.Main.grid.init: arParams isn't object")}this.settings=new BX.Grid.Settings;this.containerId=t;this.userOptions=new BX.Grid.UserOptions(this,i,n,s);this.gridSettings=new BX.Grid.SettingsWindow(this);this.messages=new BX.Grid.Message(this,l);if(this.getParam("ALLOW_PIN_HEADER")){this.pinHeader=new BX.Grid.PinHeader(this);BX.addCustomEvent(window,"Grid::headerUpdated",BX.proxy(this.bindOnCheckAll,this))}this.bindOnCheckAll();if(this.getParam("ALLOW_HORIZONTAL_SCROLL")){this.fader=new BX.Grid.Fader(this)}this.pageSize=new BX.Grid.Pagesize(this);this.editor=new BX.Grid.InlineEditor(this,r);if(this.getParam("SHOW_ACTION_PANEL")){this.actionPanel=new BX.Grid.ActionPanel(this,o,a);this.pinPanel=new BX.Grid.PinPanel(this)}this.isEditMode=false;if(!BX.type.isDomNode(this.getContainer())){throw"BX.Main.grid.init: Failed to find container with id "+this.getContainerId()}if(!BX.type.isDomNode(this.getTable())){throw"BX.Main.grid.init: Failed to find table"}this.bindOnRowEvents();if(this.getParam("ALLOW_COLUMNS_RESIZE")){this.resize=new BX.Grid.Resize(this)}this.bindOnMoreButtonEvents();this.bindOnClickPaginationLinks();this.bindOnClickHeader();if(this.getParam("ALLOW_ROWS_SORT")){this.initRowsDragAndDrop()}if(this.getParam("ALLOW_COLUMNS_SORT")){this.initColsDragAndDrop()}this.getRows().initSelected();this.adjustEmptyTable(this.getRows().getSourceBodyChild());BX.onCustomEvent(this.getContainer(),"Grid::ready",[this]);BX.addCustomEvent(window,"Grid::unselectRow",BX.proxy(this._onUnselectRows,this));BX.addCustomEvent(window,"Grid::unselectRows",BX.proxy(this._onUnselectRows,this));BX.addCustomEvent(window,"Grid::allRowsUnselected",BX.proxy(this._onUnselectRows,this));window.frames[this.getFrameId()].onresize=BX.throttle(this._onFrameResize,20,this)},destroy:function(){BX.removeCustomEvent(window,"Grid::unselectRow",BX.proxy(this._onUnselectRows,this));BX.removeCustomEvent(window,"Grid::unselectRows",BX.proxy(this._onUnselectRows,this));BX.removeCustomEvent(window,"Grid::allRowsUnselected",BX.proxy(this._onUnselectRows,this));BX.removeCustomEvent(window,"Grid::headerPinned",BX.proxy(this.bindOnCheckAll,this));this.getPinHeader()&&this.getPinHeader().destroy();this.getFader()&&this.getFader().destroy();this.getResize()&&this.getResize().destroy();this.getColsSortable()&&this.getColsSortable().destroy();this.getRowsSortable()&&this.getRowsSortable().destroy();this.getSettingsWindow()&&this.getSettingsWindow().destroy()},_onFrameResize:function(){BX.onCustomEvent(window,"Grid::resize",[this])},getFrameId:function(){return"main-grid-tmp-frame-"+this.getContainerId()},enableActionsPanel:function(){if(this.getParam("SHOW_ACTION_PANEL")){var t=this.getActionsPanel().getPanel();if(BX.type.isDomNode(t)){BX.removeClass(t,this.settings.get("classDisable"))}}},disableActionsPanel:function(){if(this.getParam("SHOW_ACTION_PANEL")){var t=this.getActionsPanel().getPanel();if(BX.type.isDomNode(t)){BX.addClass(t,this.settings.get("classDisable"))}}},getSettingsWindow:function(){return this.gridSettings},_onUnselectRows:function(){var t=this.getActionsPanel();var e;if(t instanceof BX.Grid.ActionPanel){e=t.getForAllCheckbox();if(BX.type.isDomNode(e)){e.checked=null;this.disableForAllCounter()}}},isIE:function(){if(!BX.type.isBoolean(this.ie)){this.ie=BX.hasClass(document.documentElement,"bx-ie")}return this.ie},isTouch:function(){if(!BX.type.isBoolean(this.touch)){this.touch=BX.hasClass(document.documentElement,"bx-touch")}return this.touch},getParam:function(t,e){if(e===undefined){e=null}return this.arParams.hasOwnProperty(t)?this.arParams[t]:e},getCounterTotal:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classCounterTotal"),true)},getActionKey:function(){return"action_button_"+this.getId()},getPinHeader:function(){if(this.getParam("ALLOW_PIN_HEADER")){this.pinHeader=this.pinHeader||new BX.Grid.PinHeader(this)}return this.pinHeader},getResize:function(){if(!(this.resize instanceof BX.Grid.Resize)&&this.getParam("ALLOW_COLUMNS_RESIZE")){this.resize=new BX.Grid.Resize(this)}return this.resize},confirmForAll:function(t){var e;var i=this;if(BX.type.isDomNode(t)){e=BX.Grid.Utils.getByTag(t,"input",true)}if(e.checked){this.getActionsPanel().confirmDialog({CONFIRM:true,CONFIRM_MESSAGE:this.arParams.CONFIRM_FOR_ALL_MESSAGE},function(){if(BX.type.isDomNode(e)){e.checked=true}i.selectAllCheckAllCheckboxes();i.getRows().selectAll();i.enableForAllCounter();i.updateCounterDisplayed();i.updateCounterSelected();i.enableActionsPanel();BX.onCustomEvent(window,"Grid::allRowsSelected",[])},function(){if(BX.type.isDomNode(e)){e.checked=null;i.disableForAllCounter();i.updateCounterDisplayed();i.updateCounterSelected()}})}else{this.unselectAllCheckAllCheckboxes();this.getRows().unselectAll();this.disableForAllCounter();this.updateCounterDisplayed();this.updateCounterSelected();this.disableActionsPanel();BX.onCustomEvent(window,"Grid::allRowsUnselected",[])}},editSelected:function(){this.getRows().editSelected()},editSelectedSave:function(){var t={FIELDS:this.getRows().getEditSelectedValues()};t[this.getActionKey()]="edit";this.reloadTable("POST",t)},getForAllKey:function(){return"action_all_rows_"+this.getId()},updateRow:function(t,e,i,n){var s=this.getRows().getById(t);if(s instanceof BX.Grid.Row){s.update(e,i,n)}},removeRow:function(t,e,i,n){var s=this.getRows().getById(t);if(s instanceof BX.Grid.Row){s.remove(e,i,n)}},addRow:function(t,e,i){var n=this.getUserOptions().getAction("GRID_ADD_ROW");var s={action:n,data:t};var o=this;this.tableFade();this.getData().request(e,"POST",s,null,function(){var e=this.getBodyRows();o.getUpdater().updateBodyRows();o.tableUnfade();o.getRows().reset();o.getUpdater().updateFootRows(this.getFootRows());o.getUpdater().updatePagination(this.getPagination());o.getUpdater().updateMoreButton(this.getMoreButton());o.getUpdater().updateCounterTotal(this.getCounterTotal());o.bindOnRowEvents();o.adjustEmptyTable(e);o.bindOnMoreButtonEvents();o.bindOnClickPaginationLinks();o.updateCounterDisplayed();o.updateCounterSelected();if(o.getParam("ALLOW_COLUMNS_SORT")){o.colsSortable.reinit()}if(o.getParam("ALLOW_ROWS_SORT")){o.rowsSortable.reinit()}BX.onCustomEvent(window,"Grid::rowAdded",[{data:t,grid:o,response:this}]);BX.onCustomEvent(window,"Grid::updated",[]);if(BX.type.isFunction(i)){i({data:t,grid:o,response:this})}})},editSelectedCancel:function(){this.getRows().editSelectedCancel()},removeSelected:function(){var t={ID:this.getRows().getSelectedIds()};var e=this.getActionsPanel().getValues();t[this.getActionKey()]="delete";t[this.getForAllKey()]=this.getForAllKey()in e?e[this.getForAllKey()]:"N";this.reloadTable("POST",t)},sendSelected:function(){var t=this.getActionsPanel().getValues();var e=this.getRows().getSelectedIds();var i={rows:e,controls:t};this.reloadTable("POST",i)},getActionsPanel:function(){return this.actionPanel},getApplyButton:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classPanelButton"),true)},getEditor:function(){return this.editor},reload:function(t){this.reloadTable("GET",{},null,t)},getPanels:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classPanels"),true)},getEmptyBlock:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classEmptyBlock"),true)},adjustEmptyTable:function(t){function e(t){var e=t.currentTarget;BX.Grid.Utils.requestAnimationFrame(function(){BX.style(a,"transform","translate3d("+BX.scrollLeft(e)+"px, 0px, 0")})}if(!BX.hasClass(document.documentElement,"bx-ie")&&BX.type.isArray(t)&&t.length===1&&BX.hasClass(t[0],this.settings.get("classEmptyRows"))){var i=BX.pos(this.getContainer());var n=BX.scrollTop(window)+BX.height(window);var s=i.bottom-n;var o=BX.height(this.getPanels());var a=this.getEmptyBlock();var r=BX.width(this.getContainer());BX.width(a,r);BX.style(a,"transform","translate3d("+BX.scrollLeft(this.getScrollContainer())+"px, 0px, 0");BX.unbind(this.getScrollContainer(),"scroll",e);BX.bind(this.getScrollContainer(),"scroll",e);if(s>0){BX.style(this.getTable(),"min-height",i.height-s-o+"px")}else{BX.style(this.getTable(),"min-height",i.height+Math.abs(s)-o+"px")}}else{BX.style(this.getTable(),"min-height","")}},reloadTable:function(t,e,i,n){var s;if(!BX.type.isNotEmptyString(t)){t="GET"}if(!BX.type.isPlainObject(e)){e={}}var o=this;this.tableFade();if(!BX.type.isString(n)){n=""}this.getData().request(n,t,e,"",function(){o.getRows().reset();s=this.getBodyRows();o.getUpdater().updateHeadRows(this.getHeadRows());o.getUpdater().updateBodyRows(s);o.getUpdater().updateFootRows(this.getFootRows());o.getUpdater().updatePagination(this.getPagination());o.getUpdater().updateMoreButton(this.getMoreButton());o.getUpdater().updateCounterTotal(this.getCounterTotal());o.adjustEmptyTable(s);o.bindOnRowEvents();o.bindOnMoreButtonEvents();o.bindOnClickPaginationLinks();o.bindOnClickHeader();o.bindOnCheckAll();o.updateCounterDisplayed();o.updateCounterSelected();o.disableActionsPanel();o.disableForAllCounter();if(o.getParam("SHOW_ACTION_PANEL")){o.getUpdater().updateGroupActions(this.getActionPanel())}if(o.getParam("ALLOW_COLUMNS_SORT")){o.colsSortable.reinit()}if(o.getParam("ALLOW_ROWS_SORT")){o.rowsSortable.reinit()}o.tableUnfade();BX.onCustomEvent(window,"Grid::updated",[]);if(BX.type.isFunction(i)){i()}})},getGroupEditButton:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classGroupEditButton"),true)},getGroupDeleteButton:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classGroupDeleteButton"),true)},enableGroupActions:function(){var t=this.getGroupEditButton();var e=this.getGroupDeleteButton();if(BX.type.isDomNode(t)){BX.removeClass(t,this.settings.get("classGroupActionsDisabled"))}if(BX.type.isDomNode(e)){BX.removeClass(e,this.settings.get("classGroupActionsDisabled"))}},disableGroupActions:function(){var t=this.getGroupEditButton();var e=this.getGroupDeleteButton();if(BX.type.isDomNode(t)){BX.addClass(t,this.settings.get("classGroupActionsDisabled"))}if(BX.type.isDomNode(e)){BX.addClass(e,this.settings.get("classGroupActionsDisabled"))}},closeActionsMenu:function(){var t=this.getRows().getRows();for(var e=0,i=t.length;e<i;e++){t[e].closeActionsMenu()}},getPageSize:function(){return this.pageSize},getFader:function(){return this.fader},getData:function(){this.data=this.data||new BX.Grid.Data(this);return this.data},getUpdater:function(){this.updater=this.updater||new BX.Grid.Updater(this);return this.updater},isSortableHeader:function(t){return BX.hasClass(t,this.settings.get("classHeaderSortable"))},isNoSortableHeader:function(t){return BX.hasClass(t,this.settings.get("classHeaderNoSortable"))},bindOnClickHeader:function(){var t=this;var e;BX.bind(this.getContainer(),"click",function(i){e=BX.findParent(i.target,{tag:"th"},true,false);if(e&&t.isSortableHeader(e)){t._clickOnSortableHeader(e,i)}})},enableEditMode:function(){this.isEditMode=true},disableEditMode:function(){this.isEditMode=false},isEditMode:function(){return this.isEditMode},getColumnHeaderCellByName:function(t){return BX.Grid.Utils.getBySelector(this.getContainer(),"#"+this.getId()+' th[data-name="'+t+'"]',true)},getColumnByName:function(t){var e=this.getParam("DEFAULT_COLUMNS");return!!t&&t in e?e[t]:null},sortByColumn:function(t){var e=null;var i=null;if(!BX.type.isPlainObject(t)){e=this.getColumnHeaderCellByName(t);i=this.getColumnByName(t)}else{i=t;i.sort_url=this.prepareSortUrl(t)}if(i&&(!!e&&!BX.hasClass(e,this.settings.get("classLoad"))||!e)){!!e&&BX.addClass(e,this.settings.get("classLoad"));this.tableFade();var n=this;this.getUserOptions().setSort(i.sort_by,i.sort_order,function(){n.getData().request(i.sort_url,null,null,"sort",function(){n.rows=null;n.getUpdater().updateHeadRows(this.getHeadRows());n.getUpdater().updateBodyRows(this.getBodyRows());n.getUpdater().updatePagination(this.getPagination());n.getUpdater().updateMoreButton(this.getMoreButton());n.bindOnRowEvents();n.bindOnMoreButtonEvents();n.bindOnClickPaginationLinks();n.bindOnClickHeader();n.bindOnCheckAll();n.updateCounterDisplayed();n.updateCounterSelected();n.disableActionsPanel();n.disableForAllCounter();if(n.getParam("SHOW_ACTION_PANEL")){n.getActionsPanel().resetForAllCheckbox()}if(n.getParam("ALLOW_ROWS_SORT")){n.rowsSortable.reinit()}if(n.getParam("ALLOW_COLUMNS_SORT")){n.colsSortable.reinit()}BX.onCustomEvent(window,"BX.Main.grid:sort",[i,n]);BX.onCustomEvent(window,"Grid::updated",[]);n.tableUnfade()})})}},prepareSortUrl:function(t){var e=window.location.toString();if("sort_by"in t){e=BX.util.add_url_param(e,{by:t.sort_by})}if("sort_order"in t){e=BX.util.add_url_param(e,{order:t.sort_order})}return e},_clickOnSortableHeader:function(t,e){e.preventDefault();this.sortByColumn(BX.data(t,"name"))},getObserver:function(){return BX.Grid.observer},initRowsDragAndDrop:function(){this.rowsSortable=new BX.Grid.RowsSortable(this)},initColsDragAndDrop:function(){this.colsSortable=new BX.Grid.ColsSortable(this)},getRowsSortable:function(){return this.rowsSortable},getColsSortable:function(){return this.colsSortable},getUserOptionsHandlerUrl:function(){return this.userOptionsHandlerUrl||""},getUserOptions:function(){return this.userOptions},getCheckAllCheckboxes:function(){var t=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classCheckAllCheckboxes"));return t.map(function(t){return new BX.Grid.Element(t)})},selectAllCheckAllCheckboxes:function(){this.getCheckAllCheckboxes().forEach(function(t){t.getNode().checked=true})},unselectAllCheckAllCheckboxes:function(){this.getCheckAllCheckboxes().forEach(function(t){t.getNode().checked=false})},adjustCheckAllCheckboxes:function(){var t=this.getRows().getBodyChild().filter(function(t){return t.isShown()}).length;var e=this.getRows().getSelected().filter(function(t){return t.isShown()}).length;t===e?this.selectAllCheckAllCheckboxes():this.unselectAllCheckAllCheckboxes()},bindOnCheckAll:function(){var t=this;this.getCheckAllCheckboxes().forEach(function(e){e.getObserver().add(e.getNode(),"change",t._clickOnCheckAll,t)})},_clickOnCheckAll:function(t){t.preventDefault();if(t.target.checked){this.getRows().selectAll();this.selectAllCheckAllCheckboxes();this.enableActionsPanel();BX.onCustomEvent(window,"Grid::allRowsSelected",[])}else{this.getRows().unselectAll();this.unselectAllCheckAllCheckboxes();this.disableActionsPanel();BX.onCustomEvent(window,"Grid::allRowsUnselected",[])}this.updateCounterSelected()},bindOnClickPaginationLinks:function(){var t=this;this.getPagination().getLinks().forEach(function(e){e.getObserver().add(e.getNode(),"click",t._clickOnPaginationLink,t)})},bindOnMoreButtonEvents:function(){var t=this;this.getMoreButton().getObserver().add(this.getMoreButton().getNode(),"click",t._clickOnMoreButton,t)},bindOnRowEvents:function(){var t=this.getObserver();var e=this.getParam("SHOW_ROW_CHECKBOXES");var i=this.getParam("ENABLE_COLLAPSIBLE_ROWS");this.getRows().getBodyChild().forEach(function(n){e&&t.add(n.getNode(),"click",this._onClickOnRow,this);n.getDefaultAction()&&t.add(n.getNode(),"dblclick",this._onRowDblclick,this);n.getActionsButton()&&t.add(n.getActionsButton(),"click",this._clickOnRowActionsButton,this);i&&n.getCollapseButton()&&t.add(n.getCollapseButton(),"click",this._onCollapseButtonClick,this)},this)},_onCollapseButtonClick:function(t){t.preventDefault();t.stopPropagation();var e=this.getRows().get(t.currentTarget);e.toggleChildRows();if(e.isCustom()){this.getUserOptions().setCollapsedGroups(this.getRows().getIdsCollapsedGroups())}else{this.getUserOptions().setExpandedRows(this.getRows().getIdsExpandedRows())}BX.fireEvent(document.body,"click")},_clickOnRowActionsButton:function(t){var e=this.getRows().get(t.target);t.preventDefault();if(!e.actionsMenuIsShown()){e.showActionsMenu()}else{e.closeActionsMenu()}},_onRowDblclick:function(event){event.preventDefault();var row=this.getRows().get(event.target);var defaultJs="";if(!row.isEdit()){clearTimeout(this.clickTimer);this.clickPrevent=true;try{defaultJs=row.getDefaultAction();eval(defaultJs)}catch(t){console.warn(t)}}},_onClickOnRow:function(t){var e=50;var i=window.getSelection();if(t.target.nodeName==="LABEL"){t.preventDefault()}if(t.shiftKey||i.toString().length===0){i.removeAllRanges();this.clickTimer=setTimeout(BX.delegate(function(){if(!this.clickPrevent){n.apply(this,[t])}this.clickPrevent=false},this),e)}function n(t){var e,i,n,s,o,a;var r=true;if(t.target.nodeName!=="A"&&t.target.nodeName!=="INPUT"){i=this.getRows().get(t.target);a=i.getContentContainer(t.target);if(BX.type.isDomNode(a)&&t.target.nodeName!=="TD"&&t.target!==a){r=BX.data(a,"prevent-default")==="true"}if(r){if(i.getCheckbox()){e=[];this.currentIndex=i.getIndex();this.lastIndex=this.lastIndex||this.currentIndex;if(!t.shiftKey){if(!i.isSelected()){i.select();BX.onCustomEvent(window,"Grid::selectRow",[i,this])}else{i.unselect();BX.onCustomEvent(window,"Grid::unselectRow",[i,this])}}else{s=Math.min(this.currentIndex,this.lastIndex);o=Math.max(this.currentIndex,this.lastIndex);while(s<=o){e.push(this.getRows().getByIndex(s));s++}n=e.some(function(t){return!t.isSelected()});if(n){e.forEach(function(t){t.select()});BX.onCustomEvent(window,"Grid::selectRows",[e,this])}else{e.forEach(function(t){t.unselect()});BX.onCustomEvent(window,"Grid::unselectRows",[e,this])}}this.updateCounterSelected();this.lastIndex=this.currentIndex}this.adjustRows();this.adjustCheckAllCheckboxes()}}}},adjustRows:function(){if(this.getRows().isSelected()){BX.onCustomEvent(window,"Grid::thereSelectedRows",[]);this.enableActionsPanel()}else{BX.onCustomEvent(window,"Grid::noSelectedRows",[]);this.disableActionsPanel()}},getPagination:function(){return new BX.Grid.Pagination(this)},getState:function(){return window.history.state},tableFade:function(){BX.addClass(this.getTable(),this.settings.get("classTableFade"));this.getLoader().show()},tableUnfade:function(){BX.removeClass(this.getTable(),this.settings.get("classTableFade"));this.getLoader().hide()},_clickOnPaginationLink:function(t){t.preventDefault();var e=this;var i=this.getPagination().getLink(t.target);if(!i.isLoad()){this.getUserOptions().resetExpandedRows();i.load();this.tableFade();this.getData().request(i.getLink(),null,null,"pagination",function(){e.rows=null;e.getUpdater().updateBodyRows(this.getBodyRows());e.getUpdater().updateHeadRows(this.getHeadRows());e.getUpdater().updateMoreButton(this.getMoreButton());e.getUpdater().updatePagination(this.getPagination());e.bindOnRowEvents();e.bindOnMoreButtonEvents();e.bindOnClickPaginationLinks();e.bindOnClickHeader();e.bindOnCheckAll();e.updateCounterDisplayed();e.updateCounterSelected();e.disableActionsPanel();e.disableForAllCounter();if(e.getParam("SHOW_ACTION_PANEL")){e.getActionsPanel().resetForAllCheckbox()}if(e.getParam("ALLOW_ROWS_SORT")){e.rowsSortable.reinit()}if(e.getParam("ALLOW_COLUMNS_SORT")){e.colsSortable.reinit()}i.unload();e.tableUnfade();BX.onCustomEvent(window,"Grid::updated",[])})}},_clickOnMoreButton:function(t){t.preventDefault();var e=this;var i=this.getMoreButton();i.load();this.getData().request(i.getLink(),null,null,"more",function(){e.getUpdater().appendBodyRows(this.getBodyRows());e.getUpdater().updateMoreButton(this.getMoreButton());e.getUpdater().updatePagination(this.getPagination());e.getRows().reset();e.bindOnRowEvents();e.bindOnMoreButtonEvents();e.bindOnClickPaginationLinks();e.bindOnClickHeader();e.bindOnCheckAll();e.updateCounterDisplayed();e.updateCounterSelected();if(e.getParam("ALLOW_ROWS_SORT")){e.rowsSortable.reinit()}if(e.getParam("ALLOW_COLUMNS_SORT")){e.colsSortable.reinit()}e.unselectAllCheckAllCheckboxes()})},getAjaxId:function(){return BX.data(this.getContainer(),this.settings.get("ajaxIdDataProp"))},update:function(t,e){var i,n,s,o,a,r;if(!BX.type.isNotEmptyString(t)){return}o=BX.Grid.Utils.getByTag(this.getTable(),"tbody",true);a=BX.Grid.Utils.getByTag(this.getTable(),"thead",true);r=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classNavPanel"),true);t=BX.create("div",{html:t});n=BX.Grid.Utils.getByClass(t,this.settings.get("classHeadRow"));i=BX.Grid.Utils.getByClass(t,this.settings.get("classDataRows"));s=BX.Grid.Utils.getByClass(t,this.settings.get("classNavPanel"),true);if(e===this.settings.get("updateActionMore")){this.getRows().addRows(i);this.unselectAllCheckAllCheckboxes()}if(e===this.settings.get("updateActionPagination")){BX.cleanNode(o);this.getRows().addRows(i);this.unselectAllCheckAllCheckboxes()}if(e===this.settings.get("updateActionSort")){BX.cleanNode(a);BX.cleanNode(o);a.appendChild(n[0]);this.getRows().addRows(i)}r.innerHTML=s.innerHTML;this.bindOnRowEvents();this.bindOnMoreButtonEvents();this.bindOnClickPaginationLinks();this.bindOnClickHeader();this.bindOnCheckAll();this.updateCounterDisplayed();this.updateCounterSelected();this.sortable.reinit()},getCounterDisplayed:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classCounterDisplayed"))},getCounterSelected:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classCounterSelected"))},updateCounterDisplayed:function(){var t=this.getCounterDisplayed();var e;if(BX.type.isArray(t)){e=this.getRows();t.forEach(function(t){if(BX.type.isDomNode(t)){t.innerText=e.getCountDisplayed()}},this)}},updateCounterSelected:function(){var t=this.getCounterSelected();var e;if(BX.type.isArray(t)){e=this.getRows();t.forEach(function(t){if(BX.type.isDomNode(t)){t.innerText=e.getCountSelected()}},this)}},getContainerId:function(){return this.containerId},getId:function(){return this.containerId},getContainer:function(){return BX(this.getContainerId())},getCounter:function(){if(!this.counter){this.counter=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classCounter"))}return this.counter},enableForAllCounter:function(){var t=this.getCounter();if(BX.type.isArray(t)){t.forEach(function(t){BX.addClass(t,this.settings.get("classForAllCounterEnabled"))},this)}},disableForAllCounter:function(){var t=this.getCounter();if(BX.type.isArray(t)){t.forEach(function(t){BX.removeClass(t,this.settings.get("classForAllCounterEnabled"))},this)}},getScrollContainer:function(){if(!this.scrollContainer){this.scrollContainer=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classScrollContainer"),true)}return this.scrollContainer},getWrapper:function(){if(!this.wrapper){this.wrapper=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classWrapper"),true)}return this.wrapper},getFadeContainer:function(){if(!this.fadeContainer){this.fadeContainer=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classFadeContainer"),true)}return this.fadeContainer},getTable:function(){return BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classTable"),true)},getHeaders:function(){return BX.Grid.Utils.getBySelector(this.getWrapper(),'.main-grid-header[data-relative="'+this.getContainerId()+'"]')},getHead:function(){return BX.Grid.Utils.getByTag(this.getContainer(),"thead",true)},getBody:function(){return BX.Grid.Utils.getByTag(this.getContainer(),"tbody",true)},getFoot:function(){return BX.Grid.Utils.getByTag(this.getContainer(),"tfoot",true)},getRows:function(){if(!(this.rows instanceof BX.Grid.Rows)){this.rows=new BX.Grid.Rows(this)}return this.rows},getMoreButton:function(){var t=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classMoreButton"),true);return new BX.Grid.Element(t,this)},getLoader:function(){if(!(this.loader instanceof BX.Grid.Loader)){this.loader=new BX.Grid.Loader(this)}return this.loader},blockSorting:function(){var t=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classHeadCell"));t.forEach(function(t){if(this.isSortableHeader(t)){BX.removeClass(t,this.settings.get("classHeaderSortable"));BX.addClass(t,this.settings.get("classHeaderNoSortable"))}},this)},unblockSorting:function(){var t=BX.Grid.Utils.getByClass(this.getContainer(),this.settings.get("classHeadCell"));t.forEach(function(t){if(this.isNoSortableHeader(t)&&t.dataset.sortBy){BX.addClass(t,this.settings.get("classHeaderSortable"));BX.removeClass(t,this.settings.get("classHeaderNoSortable"))}},this)},confirmDialog:function(t,e,i){var n,s,o,a;if("CONFIRM"in t&&t.CONFIRM){t.CONFIRM_MESSAGE=t.CONFIRM_MESSAGE||this.arParams.CONFIRM_MESSAGE;t.CONFIRM_APPLY_BUTTON=t.CONFIRM_APPLY_BUTTON||this.arParams.CONFIRM_APPLY;t.CONFIRM_CANCEL_BUTTON=t.CONFIRM_CANCEL_BUTTON||this.arParams.CONFIRM_CANCEL;n=new BX.PopupWindow(this.getContainerId()+"-confirm-dialog",null,{content:'<div class="main-grid-confirm-content">'+t.CONFIRM_MESSAGE+"</div>",titleBar:"CONFIRM_TITLE"in t?t.CONFIRM_TITLE:"",autoHide:false,zIndex:9999,overlay:.4,offsetTop:-100,closeIcon:true,closeByEsc:true,events:{onClose:function(){BX.unbind(window,"keydown",r)}},buttons:[new BX.PopupWindowButton({text:t.CONFIRM_APPLY_BUTTON,id:this.getContainerId()+"-confirm-dialog-apply-button",events:{click:function(){BX.type.isFunction(e)?e():null;this.popupWindow.close();this.popupWindow.destroy();BX.onCustomEvent(window,"Grid::confirmDialogApply",[this]);BX.unbind(window,"keydown",r)}}}),new BX.PopupWindowButtonLink({text:t.CONFIRM_CANCEL_BUTTON,id:this.getContainerId()+"-confirm-dialog-cancel-button",events:{click:function(){BX.type.isFunction(i)?i():null;this.popupWindow.close();this.popupWindow.destroy();BX.onCustomEvent(window,"Grid::confirmDialogCancel",[this]);BX.unbind(window,"keydown",r)}}})]});if(!n.isShown()){n.show();s=n.popupContainer;BX.removeClass(s,this.settings.get("classCloseAnimation"));BX.addClass(s,this.settings.get("classShowAnimation"));o=BX(this.getContainerId()+"-confirm-dialog-apply-button");a=BX(this.getContainerId()+"-confirm-dialog-cancel-button");BX.bind(window,"keydown",r)}}else{BX.type.isFunction(e)?e():null}function r(t){if(t.code==="Enter"){t.preventDefault();t.stopPropagation();BX.fireEvent(o,"click")}if(t.code==="Escape"){t.preventDefault();t.stopPropagation();BX.fireEvent(a,"click")}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/action-panel.min.js?150459572111207";s:6:"source";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/action-panel.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/action-panel.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/action-panel.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.ActionPanel=function(t,e,n){this.parent=null;this.rel={};this.actions=null;this.types=null;this.lastActivated=[];this.init(t,e,n)};BX.Grid.ActionPanel.prototype={init:function(parent,actions,types){this.parent=parent;this.actions=eval(actions);this.types=eval(types);BX.addCustomEvent(window,"Dropdown::change",BX.proxy(function(t,e,n,a){this.isPanelControl(BX(t))&&this._dropdownChange(t,e,n,a)},this));BX.addCustomEvent(window,"Dropdown::load",BX.proxy(function(t,e,n,a){this.isPanelControl(BX(t))&&this._dropdownChange(t,e,n,a)},this));var panel=this.getPanel();BX.bind(panel,"change",BX.delegate(this._checkboxChange,this));BX.bind(panel,"click",BX.delegate(this._clickOnButton,this));BX.addCustomEvent(window,"Grid::updated",function(){var t=BX("grid_cancel_button");t&&BX.fireEvent(BX.firstChild(t),"click")})},resetForAllCheckbox:function(){var t=this.getForAllCheckbox();if(BX.type.isDomNode(t)){t.checked=null}},getForAllCheckbox:function(){return BX.Grid.Utils.getByClass(this.getPanel(),this.parent.settings.get("classForAllCheckbox"),true)},getPanel:function(){return BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classActionPanel"),true)},getApplyButton:function(){return BX.Grid.Utils.getByClass(this.getPanel(),this.parent.settings.get("classPanelApplyButton"),true)},isPanelControl:function(t){return BX.hasClass(t,this.parent.settings.get("classPanelControl"))},getTextInputs:function(){return BX.Grid.Utils.getBySelector(this.getPanel(),'input[type="text"]')},getHiddenInputs:function(){return BX.Grid.Utils.getBySelector(this.getPanel(),'input[type="hidden"]')},getDropdowns:function(){return BX.Grid.Utils.getByClass(this.getPanel(),this.parent.settings.get("classDropdown"))},getCheckboxes:function(){return BX.Grid.Utils.getByClass(this.getPanel(),this.parent.settings.get("classPanelCheckbox"))},getButtons:function(){return BX.Grid.Utils.getByClass(this.getPanel(),this.parent.settings.get("classPanelButton"))},isDropdown:function(t){return BX.hasClass(t,this.parent.settings.get("classDropdown"))},isCheckbox:function(t){return BX.hasClass(t,this.parent.settings.get("classPanelCheckbox"))},isTextInput:function(t){return t.type==="text"},isHiddenInput:function(t){return t.type==="hidden"},createDropdown:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.create("div",{props:{className:"main-dropdown main-grid-panel-control",id:t.ID+"_control"},attrs:{name:t.NAME,"data-name":t.NAME,"data-items":JSON.stringify(t.ITEMS),"data-value":t.ITEMS[0].VALUE},children:[BX.create("span",{props:{className:"main-dropdown-inner"},html:t.ITEMS[0].NAME})]});n.appendChild(a);return n},createCheckbox:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.create("span",{props:{className:"main-grid-checkbox-container"}});var i=BX.create("span",{props:{className:"main-grid-control-panel-content-title"}});var r=BX.create("input",{props:{type:"checkbox",className:this.parent.settings.get("classPanelCheckbox")+" main-grid-checkbox",id:t.ID+"_control"},attrs:{value:t.VALUE||"",title:t.TITLE||"",name:t.NAME||"","data-onchange":JSON.stringify(t.ONCHANGE)}});r.checked=t.CHECKED||null;n.appendChild(a);n.appendChild(i);a.appendChild(r);a.appendChild(BX.create("label",{props:{className:"main-grid-checkbox"},attrs:{"for":t.ID+"_control",title:t.TITLE}}));i.appendChild(BX.create("label",{attrs:{"for":t.ID+"_control",title:t.TITLE},html:t.LABEL}));return n},createText:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.type.isNotEmptyString(t["TITLE"])?t["TITLE"]:"";if(a!==""){n.appendChild(BX.create("label",{attrs:{title:a,"for":t.ID+"_control"},text:a}))}n.appendChild(BX.create("input",{props:{className:"main-grid-control-panel-input-text main-grid-panel-control",id:t.ID+"_control"},attrs:{name:t.NAME,title:a,placeholder:t.PLACEHOLDER||"",value:t.VALUE||"",type:"text","data-onchange":JSON.stringify(t.ONCHANGE||[])}}));return n},createHidden:function(t,e){var n=this.createContainer(t.ID,e);n.appendChild(BX.create("input",{props:{id:t.ID+"_control",type:"hidden"},attrs:{name:t.NAME,value:t.VALUE||""}}));return n},createButton:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.create("button",{props:{className:"main-grid-buttons"+(t.CLASS?" "+t.CLASS:""),id:t.id+"_control"},attrs:{name:t.NAME||"","data-onchange":JSON.stringify(t.ONCHANGE||[])},html:t.TEXT});n.appendChild(a);return n},createLink:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.create("a",{props:{className:"main-grid-link"+(t.CLASS?" "+t.CLASS:""),id:t.ID+"_control"},attrs:{href:t.HREF||"","data-onchange":JSON.stringify(t.ONCHANGE||[])},html:t.TEXT});n.appendChild(a);return n},createCustom:function(t,e){},createContainer:function(t,e){t=t.replace("_control","");e=e.replace("_control","");return BX.create("span",{props:{className:this.parent.settings.get("classPanelControlContainer"),id:t},attrs:{"data-relative":e}})},removeItemsRelativeCurrent:function(t){var e=t;var n=t.id;var a=[];var i;while(e){i=BX.data(e,"relative");if(i===n||i===t.id){n=e.id;a.push(e)}e=e.nextElementSibling}a.forEach(function(t){BX.remove(t)})},validateData:function(t){return"ONCHANGE"in t&&BX.type.isArray(t.ONCHANGE)},activateControl:function(t){var e=BX(t);if(BX.type.isDomNode(e)){BX.removeClass(e,this.parent.settings.get("classDisable"));e.disabled=null}},deactivateControl:function(t){var e=BX(t);if(BX.type.isDomNode(e)){BX.addClass(e,this.parent.settings.get("classDisable"));e.disabled=true}},showControl:function(t){var e=BX(t);e&&BX.show(e)},hideControl:function(t){var e=BX(t);e&&BX.hide(e)},validateActionObject:function(t){return BX.type.isPlainObject(t)&&"ACTION"in t&&BX.type.isNotEmptyString(t.ACTION)&&(t.ACTION===this.actions.RESET_CONTROLS||"DATA"in t&&BX.type.isArray(t.DATA))},validateControlObject:function(t){return BX.type.isPlainObject(t)&&"TYPE"in t&&"ID"in t},createDate:function(t,e){var n=this.createContainer(t.ID,e);var a=BX.decl({block:"main-ui-date",mix:["main-grid-panel-date"],calendarButton:true,valueDelete:true,placeholder:"PLACEHOLDER"in t?t.PLACEHOLDER:"",name:"NAME"in t?t.NAME+"_from":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUE"in t?t.VALUE:"",enableTime:"TIME"in t?t.TIME?"true":"false":"false"});n.appendChild(a);return n},createControl:function(t,e){var n=null;switch(t.TYPE){case this.types.DROPDOWN:n=this.createDropdown(t,e);break;case this.types.CHECKBOX:n=this.createCheckbox(t,e);break;case this.types.TEXT:n=this.createText(t,e);break;case this.types.HIDDEN:n=this.createHidden(t,e);break;case this.types.BUTTON:n=this.createButton(t,e);break;case this.types.LINK:n=this.createLink(t,e);break;case this.types.CUSTOM:n=this.createCustom(t,e);break;case this.types.DATE:n=this.createDate(t,e);break}return n},onChangeHandler:function(container,actions,isPseudo){var newElement,callback;var self=this;if(BX.type.isDomNode(container)&&BX.type.isArray(actions)){actions.forEach(function(action){if(self.validateActionObject(action)){if(action.ACTION===self.actions.CREATE){self.removeItemsRelativeCurrent(container);action.DATA.reverse();action.DATA.forEach(function(t){if(self.validateControlObject(t)){newElement=self.createControl(t,BX.data(container,"relative")||container.id);if(BX.type.isDomNode(newElement)){BX.insertAfter(newElement,container);if("ONCHANGE"in t&&t.TYPE===self.types.CHECKBOX&&"CHECKED"in t&&t.CHECKED){self.onChangeHandler(newElement,t.ONCHANGE)}if(t.TYPE===self.types.DROPDOWN&&BX.type.isArray(t.ITEMS)&&t.ITEMS.length&&"ONCHANGE"in t.ITEMS[0]&&BX.type.isArray(t.ITEMS[0].ONCHANGE)){self.onChangeHandler(newElement,t.ITEMS[0].ONCHANGE)}}}})}if(action.ACTION===self.actions.ACTIVATE){self.removeItemsRelativeCurrent(container);if(BX.type.isArray(action.DATA)){action.DATA.forEach(function(t){self.lastActivated.push(t.ID);self.activateControl(t.ID)})}}if(action.ACTION===self.actions.SHOW){if(BX.type.isArray(action.DATA)){action.DATA.forEach(function(t){self.showControl(t.ID)})}}if(action.ACTION===self.actions.HIDE){if(BX.type.isArray(action.DATA)){action.DATA.forEach(function(t){self.hideControl(t.ID)})}}if(action.ACTION===self.actions.HIDE_ALL_EXPECT){if(BX.type.isArray(action.DATA)){(self.getControls()||[]).forEach(function(t){if(!action.DATA.some(function(e){return e.ID===t.id})){self.hideControl(t.id)}})}}if(action.ACTION===self.actions.SHOW_ALL){(self.getControls()||[]).forEach(function(t){self.showControl(t.id)})}if(action.ACTION===self.actions.REMOVE){if(BX.type.isArray(action.DATA)){action.DATA.forEach(function(t){BX.remove(BX(t.ID))})}}if(action.ACTION===self.actions.CALLBACK){this.confirmDialog(action,BX.delegate(function(){if(BX.type.isArray(action.DATA)){action.DATA.forEach(function(currentCallback){if(currentCallback.JS.indexOf("Grid.")!==-1){callback=currentCallback.JS.replace("Grid","self.parent");callback=callback.replace("()","");callback+=".apply(self.parent, [container])";try{eval(callback)}catch(err){throw new Error(err)}}else if(BX.type.isNotEmptyString(currentCallback.JS)){try{eval(currentCallback.JS)}catch(err){throw new Error(err)}}})}},this))}if(action.ACTION===self.actions.RESET_CONTROLS){this.removeItemsRelativeCurrent(container)}}},this)}else{if(!isPseudo){this.removeItemsRelativeCurrent(container)}self.lastActivated.forEach(function(t){self.deactivateControl(t)});self.lastActivated=[]}},confirmDialog:function(t,e,n){this.parent.confirmDialog(t,e,n)},_dropdownChange:function(t,e,n,a){var i=BX(t);var r=i.parentNode;var s=a&&"ONCHANGE"in a?a.ONCHANGE:null;var o="PSEUDO"in a&&a.PSEUDO!==false;this.onChangeHandler(r,s,o)},_checkboxChange:function(event){var onChange;try{onChange=eval(BX.data(event.target,"onchange"))}catch(err){onChange=null}this.onChangeHandler(BX.findParent(event.target,{className:this.parent.settings.get("classPanelContainer")},true,false),event.target.checked||event.target.id.indexOf("actallrows_")!==-1?onChange:null)},_clickOnButton:function(event){var onChange;if(this.isButton(event.target)){event.preventDefault();try{onChange=eval(BX.data(event.target,"onchange"))}catch(err){onChange=null}this.onChangeHandler(BX.findParent(event.target,{className:this.parent.settings.get("classPanelContainer")},true,false),onChange)}},isButton:function(t){return BX.hasClass(t,this.parent.settings.get("classPanelButton"))},getSelectedIds:function(){var t=this.parent.getRows().getSelected().filter(function(t){return t.isShown()});return t.map(function(t){return t.getId()})},getControls:function(){return BX.findChild(this.getPanel(),{className:this.parent.settings.get("classPanelControlContainer")},true,true)},getValues:function(){var t={};var e=this;var n=[].concat(this.getDropdowns(),this.getTextInputs(),this.getHiddenInputs(),this.getCheckboxes(),this.getButtons());(n||[]).forEach(function(n){if(BX.type.isDomNode(n)){if(e.isDropdown(n)){var a=BX.data(n,"value");a=a!==null&&a!==undefined?a:"";t[BX.data(n,"name")]=a}if(e.isCheckbox(n)&&n.checked){t[n.getAttribute("name")]=n.value}if(e.isTextInput(n)||e.isHiddenInput(n)){t[n.getAttribute("name")]=n.value}if(e.isButton(n)){var i=BX.data(n,"name");var r=BX.data(n,"value");r=r!==null&&r!==undefined?r:"";if(i){t[i]=r}}}});return t}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/resize.min.js?14980344533275";s:6:"source";s:70:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/resize.js";s:3:"min";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/resize.min.js";s:3:"map";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/resize.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Resize=function(t){this.parent=null;this.lastRegisterButtons=null;this.init(t)};BX.Grid.Resize.prototype={init:function(t){this.parent=t;BX.addCustomEvent(window,"Grid::updated",BX.proxy(this.registerTableButtons,this));BX.addCustomEvent(window,"Grid::headerUpdated",BX.proxy(this.registerPinnedTableButtons,this));this.registerTableButtons();this.registerPinnedTableButtons()},destroy:function(){BX.removeCustomEvent(window,"Grid::updated",BX.proxy(this.registerTableButtons,this));BX.removeCustomEvent(window,"Grid::headerUpdated",BX.proxy(this.registerPinnedTableButtons,this));BX.type.isArray(this.lastRegisterButtons)&&this.lastRegisterButtons.forEach(jsDD.unregisterObject);(this.getButtons()||[]).forEach(jsDD.unregisterObject)},registerTableButtons:function(){(this.getButtons()||[]).forEach(this.register,this);this.registerPinnedTableButtons()},register:function(t){if(BX.type.isDomNode(t)){t.onbxdragstart=BX.delegate(this._onDragStart,this);t.onbxdragstop=BX.delegate(this._onDragEnd,this);t.onbxdrag=BX.delegate(this._onDrag,this);jsDD.registerObject(t)}},registerPinnedTableButtons:function(){if(this.parent.getParam("ALLOW_PIN_HEADER")){var t=this.getPinnedTableButtons();if(BX.type.isArray(this.lastRegisterButtons)&&this.lastRegisterButtons.length){this.lastRegisterButtons.forEach(jsDD.unregisterObject)}this.lastRegisterButtons=t;(this.getPinnedTableButtons()||[]).forEach(this.register,this)}},getButtons:function(){return BX.Grid.Utils.getByClass(this.parent.getRows().getHeadFirstChild().getNode(),this.parent.settings.get("classResizeButton"))},getPinnedTableButtons:function(){return BX.Grid.Utils.getByClass(this.parent.getPinHeader().getFixedTable(),this.parent.settings.get("classResizeButton"))},_onDragStart:function(){var t=BX.findParent(jsDD.current_node,{className:this.parent.settings.get("classHeadCell")});var e=this.parent.getRows().getHeadFirstChild().getCells();var s=Object.keys(e);var i;this.__overlay=BX.create("div",{props:{className:"main-grid-cell-overlay"}});BX.append(this.__overlay,t);this.__resizeCell=t.cellIndex;s.forEach(function(t){if(BX.hasClass(e[t],"main-grid-special-empty")){BX.style(e[t],"width","100%")}else{BX.width(e[t],BX.width(e[t]));i=BX.firstChild(e[t]);BX.width(i,BX.width(e[t]))}})},_onDrag:function(t){var e=this.parent.getTable();var s=this.parent.getParam("ALLOW_PIN_HEADER")?this.parent.getPinHeader().getFixedTable():null;var i=e.rows[0].cells[this.__resizeCell];var r,n;var a=BX.pos(i);var o=BX.firstChild(i);var l=parseFloat(i.style.width);var d;t-=a.left;d=t;if(a.width>l){t=a.width}t=d>t?d:t;if(t!==a.width){i.style.width=t+"px";o.style.width=t+"px";if(BX.type.isDomNode(s)&&BX.type.isDomNode(s.rows[0])){r=s.rows[0].cells[this.__resizeCell];n=BX.firstChild(r);n.style.width=t+"px";r.style.width=t+"px"}}BX.onCustomEvent(window,"Grid::columnResize",[])},_onDragEnd:function(){this.saveSizes()},getColumnSizes:function(){var t=this.parent.getRows().getHeadFirstChild().getCells();var e={};var s;[].forEach.call(t,function(t){s=BX.data(t,"name");if(BX.type.isNotEmptyString(s)){e[s]=BX.width(t)}},this);return e},saveSizes:function(){this.parent.getUserOptions().setColumnSizes(this.getColumnSizes(),1)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/baseclass.min.js?1491454246207";s:6:"source";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/baseclass.js";s:3:"min";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/baseclass.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/baseclass.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.BaseClass=function(t){this.parent=t};BX.Grid.BaseClass.prototype={getParent:function(){return this.parent}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows.min.js?14988222185401";s:6:"source";s:68:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows.js";s:3:"min";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows.min.js";s:3:"map";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Rows=function(t){this.parent=null;this.rows=null;this.headChild=null;this.bodyChild=null;this.footChild=null;this.init(t)};BX.Grid.Rows.prototype={init:function(t){this.parent=t},reset:function(){this.rows=null;this.headChild=null;this.bodyChild=null;this.footChild=null},enableDragAndDrop:function(){this.parent.arParams["ALLOW_ROWS_SORT"]=true;if(!(this.parent.getRowsSortable()instanceof BX.Grid.RowsSortable)){this.parent.rowsSortable=new BX.Grid.RowsSortable(this.parent)}},disableDragAndDrop:function(){this.parent.arParams["ALLOW_ROWS_SORT"]=false;if(this.parent.getRowsSortable()instanceof BX.Grid.RowsSortable){this.parent.getRowsSortable().destroy();this.parent.rowsSortable=null}},getFootLastChild:function(){return this.getLast(this.getFootChild())},getFootFirstChild:function(){return this.getFirst(this.getFootChild())},getBodyLastChild:function(){return this.getLast(this.getBodyChild())},getBodyFirstChild:function(){return this.getFirst(this.getBodyChild())},getHeadLastChild:function(){return this.getLast(this.getHeadChild())},getHeadFirstChild:function(){return this.getFirst(this.getHeadChild())},getEditSelectedValues:function(){var t=this.getSelected();var e={};t.forEach(function(t){e[t.getId()]=t.editGetValues()});return e},getSelectedIds:function(){return this.getSelected().map(function(t){return t.getId()})},initSelected:function(){var t=this.getSelected();if(BX.type.isArray(t)&&t.length){t.forEach(function(t){t.initSelect()});this.parent.enableActionsPanel()}},editSelected:function(){this.getSelected().forEach(function(t){t.edit()});BX.onCustomEvent(window,"Grid::thereEditedRows",[])},editSelectedCancel:function(){this.getSelected().forEach(function(t){t.editCancel()});BX.onCustomEvent(window,"Grid::noEditedRows",[])},isSelected:function(){return this.getBodyChild().some(function(t){return t.isShown()&&t.isSelected()})},isAllSelected:function(){return!this.getBodyChild().some(function(t){return!t.isSelected()})},getParent:function(){return this.parent},getCountSelected:function(){var t;try{t=this.getSelected().filter(function(t){return!t.isNotCount()&&t.isShown()}).length}catch(e){t=0}return t},getCountDisplayed:function(){var t;try{t=this.getBodyChild().filter(function(t){return t.isShown()&&!t.isNotCount()}).length}catch(e){t=0}return t},addRows:function(t){var e=BX.findChild(this.getParent().getTable(),{tag:"TBODY"},true,false);t.forEach(function(t){e.appendChild(t)})},getRows:function(){var t;var e=this;if(!this.rows){t=BX.Grid.Utils.getByTag(this.getParent().getTable(),"tr");this.rows=t.map(function(t){return new BX.Grid.Row(e.parent,t)})}return this.rows},getSelected:function(){return this.getBodyChild().filter(function(t){return t.isShown()&&t.isSelected()})},normalizeNode:function(t){if(!BX.hasClass(t,this.getParent().settings.get("classBodyRow"))){t=BX.findParent(t,{className:this.getParent().settings.get("classBodyRow")},true,false)}return t},getById:function(t){t=t.toString();var e=this.getBodyChild();var n=e.filter(function(e){return e.getId()===t});return n.length===1?n[0]:null},get:function(t){var e=null;var n;if(BX.type.isDomNode(t)){t=this.normalizeNode(t);n=this.getRows().filter(function(e){return t===e.getNode()});if(n.length){e=n[0]}}return e},getLast:function(t){var e;try{e=t[t.length-1]}catch(n){e=null}return e},getFirst:function(t){var e;try{e=t[0]}catch(n){e=null}return e},getHeadChild:function(){this.headChild=this.headChild||this.getRows().filter(function(t){return t.isHeadChild()});return this.headChild},getBodyChild:function(){this.bodyChild=this.bodyChild||this.getRows().filter(function(t){return t.isBodyChild()});return this.bodyChild},getFootChild:function(){this.footChild=this.footChild||this.getRows().filter(function(t){return t.isFootChild()});return this.footChild},selectAll:function(){this.getRows().map(function(t){t.isShown()&&t.select()})},unselectAll:function(){this.getRows().map(function(t){t.unselect()})},getByIndex:function(t){var e=this.getBodyChild().filter(function(e){return e.getNode().rowIndex===t});return e.length?e[0]:null},getRowsByParentId:function(t,e){var n=[];var i=this;if(!t){return n}t=t.toString();function r(t){i.getBodyChild().forEach(function(i){if(i.getParentId()===t){n.push(i);e&&r(i.getId())}},i)}r(t);return n},getRowsByGroupId:function(t){var e=[];var n=this;if(!t){return e}t=t.toString();function i(t){n.getBodyChild().forEach(function(n){if(n.getGroupId()===t&&!n.isCustom()){e.push(n)}},n)}i(t);return e},getExpandedRows:function(){return this.getRows().filter(function(t){return t.isShown()&&t.isExpand()})},getIdsExpandedRows:function(){return this.getExpandedRows().map(function(t){return t.getId()})},getIdsCollapsedGroups:function(){return this.getRows().filter(function(t){return t.isCustom()&&!t.isExpand()}).map(function(t){return t.getId()})},getSourceRows:function(){return BX.Grid.Utils.getByTag(this.getParent().getTable(),"tr")},getSourceBodyChild:function(){return this.getSourceRows().filter(function(t){return BX.Grid.Utils.closestParent(t).nodeName==="TBODY"})},getSourceHeadChild:function(){return this.getSourceRows().filter(function(t){return BX.Grid.Utils.closestParent(t).nodeName==="THEAD"})},getSourceFootChild:function(){return this.getSourceRows().filter(function(t){return BX.Grid.Utils.closestParent(t).nodeName==="TFOOT"})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/cols-sortable.min.js?14980344535340";s:6:"source";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/cols-sortable.js";s:3:"min";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/cols-sortable.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/cols-sortable.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.ColsSortable=function(t){this.parent=null;this.dragItem=null;this.targetItem=null;this.rowsList=null;this.colsList=null;this.dragRect=null;this.offset=null;this.startDragOffset=null;this.dragColumn=null;this.targetColumn=null;this.isDrag=null;this.init(t)};BX.Grid.ColsSortable.prototype={init:function(t){this.parent=t;this.colsList=this.getColsList();this.rowsList=this.getRowsList();if(!this.inited){this.inited=true;BX.addCustomEvent("Grid::updated",BX.proxy(this.reinit,this));BX.addCustomEvent("Grid::headerUpdated",BX.proxy(this.reinit,this))}this.registerObjects()},destroy:function(){BX.removeCustomEvent("Grid::updated",BX.proxy(this.reinit,this));this.unregisterObjects()},reinit:function(){this.unregisterObjects();this.reset();this.init(this.parent)},reset:function(){this.dragItem=null;this.targetItem=null;this.rowsList=null;this.colsList=null;this.dragRect=null;this.offset=null;this.startDragOffset=null;this.dragColumn=null;this.targetColumn=null;this.isDrag=null;this.fixedTableColsList=null},isActive:function(){return this.isDrag},registerObjects:function(){this.unregisterObjects();this.getColsList().forEach(this.register,this);this.getFixedHeaderColsList().forEach(this.register,this)},unregisterObjects:function(){this.getColsList().forEach(this.unregister,this);this.getFixedHeaderColsList().forEach(this.unregister,this)},unregister:function(t){jsDD.unregisterObject(t)},register:function(t){t.onbxdragstart=BX.proxy(this._onDragStart,this);t.onbxdrag=BX.proxy(this._onDrag,this);t.onbxdragstop=BX.proxy(this._onDragEnd,this);jsDD.registerObject(t)},getColsList:function(){if(!this.colsList){this.colsList=BX.Grid.Utils.getByTag(this.parent.getRows().getHeadFirstChild().getNode(),"th");this.colsList=this.colsList.filter(function(t){return!this.isStatic(t)},this)}return this.colsList},getFixedHeaderColsList:function(){if(!this.fixedTableColsList&&this.parent.getParam("ALLOW_PIN_HEADER")){this.fixedTableColsList=BX.Grid.Utils.getByTag(this.parent.getPinHeader().getFixedTable(),"th");this.fixedTableColsList=this.fixedTableColsList.filter(function(t){return!this.isStatic(t)},this)}return this.fixedTableColsList||[]},getRowsList:function(){var t=this.parent.getRows().getSourceRows();if(this.parent.getParam("ALLOW_PIN_HEADER")){t=t.concat(BX.Grid.Utils.getByTag(this.parent.getPinHeader().getFixedTable(),"tr"))}return t},isStatic:function(t){return BX.hasClass(t,this.parent.settings.get("classCellStatic"))},getDragOffset:function(){return jsDD.x-this.startDragOffset-this.dragRect.left},getColumn:function(t){var i=[];if(t instanceof HTMLTableCellElement){i=this.rowsList.map(function(i){return i.cells[t.cellIndex]})}return i},_onDragStart:function(){if(this.parent.getParam("ALLOW_PIN_HEADER")&&this.parent.getPinHeader().isPinned()){this.colsList=this.getFixedHeaderColsList()}else{this.colsList=this.getColsList()}this.isDrag=true;this.dragItem=jsDD.current_node;this.dragRect=this.dragItem.getBoundingClientRect();this.offset=Math.ceil(this.dragRect.width);this.startDragOffset=jsDD.start_x-this.dragRect.left;this.dragColumn=this.getColumn(this.dragItem);this.dragIndex=BX.Grid.Utils.getIndex(this.colsList,this.dragItem)},isDragToRight:function(t,i){var s=t.getBoundingClientRect();var e=Math.ceil(s.left+s.width/2+BX.scrollLeft(window));var r=this.dragIndex;var n=jsDD.x;return i>r&&n>e},isDragToLeft:function(t,i){var s=t.getBoundingClientRect();var e=Math.ceil(s.left+s.width/2+BX.scrollLeft(window));var r=this.dragIndex;var n=jsDD.x;return i<r&&n<e},isDragToBack:function(t,i){var s=t.getBoundingClientRect();var e=Math.ceil(s.left+s.width/2+BX.scrollLeft(window));var r=this.dragIndex;var n=jsDD.x;return i>r&&n<e||i<r&&n>e},isMovedToRight:function(t){return t.style.transform==="translate3d("+-this.offset+"px, 0px, 0px)"},isMovedToLeft:function(t){return t.style.transform==="translate3d("+this.offset+"px, 0px, 0px)"},isMoved:function(t){return t.style.transform!=="translate3d(0px, 0px, 0px)"&&t.style.transform!==""},moveColumn:function(t,i,s){s=BX.type.isNumber(s)?s:300;BX.Grid.Utils.styleForEach(t,{transition:s+"ms",transform:"translate3d("+i+"px, 0px, 0px)"})},_onDrag:function(){this.dragOffset=this.getDragOffset();this.targetItem=this.targetItem||this.dragItem;this.targetColumn=this.targetColumn||this.dragColumn;var t=-this.offset;var i=this.offset;var s=0;var e=0;this.moveColumn(this.dragColumn,this.dragOffset,e);[].forEach.call(this.colsList,function(e,r){if(e){if(this.isDragToRight(e,r)&&!this.isMovedToRight(e)){this.targetColumn=this.getColumn(e);this.moveColumn(this.targetColumn,t)}if(this.isDragToLeft(e,r)&&!this.isMovedToLeft(e)){this.targetColumn=this.getColumn(e);this.moveColumn(this.targetColumn,i)}if(this.isDragToBack(e,r)&&this.isMoved(e)){this.targetColumn=this.getColumn(e);this.moveColumn(this.targetColumn,s)}}},this)},_onDragEnd:function(){[].forEach.call(this.dragColumn,function(t,i){BX.Grid.Utils.collectionSort(t,this.targetColumn[i])},this);this.rowsList.forEach(function(t){BX.Grid.Utils.styleForEach(t.cells,{transition:"",transform:""})});this.reinit();var t=this.colsList.map(function(t){return BX.data(t,"name")});this.parent.getUserOptions().setColumns(t);BX.onCustomEvent(this.parent.getContainer(),"Grid::columnMoved",[this.parent])}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:105:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window-column.min.js?15145717862950";s:6:"source";s:86:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window-column.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.SettingsWindowColumn=function(t,e){this.node=null;this.label=null;this.checkbox=null;this.editButton=null;this.settings=null;this.parent=null;this.default=null;this.defaultTitle=null;this.state=null;this.init(t,e)};BX.Grid.SettingsWindowColumn.prototype={init:function(t,e){this.parent=t;this.node=e;this.updateState();BX.bind(this.getEditButton(),"click",BX.proxy(this.onEditButtonClick,this))},onEditButtonClick:function(t){t.stopPropagation();this.isEditEnabled()?this.disableEdit():this.enableEdit()},setState:function(t){this.state=t},getState:function(){return this.state},updateState:function(){this.setState({selected:this.isSelected(),title:this.getTitle()})},restoreState:function(){var t=this.getState();t.selected?this.select():this.unselect();this.setTitle(t.title)},getId:function(){return this.getNode().dataset.name},getTitle:function(){return this.getLabel().innerText},setTitle:function(t){this.getLabel().innerText=!!t&&t!=="undefined"?t:this.getDefaultTitle()},isEdited:function(){return this.getTitle()!==this.getDefaultTitle()},getSettings:function(){if(this.settings===null){var t=this.parent.getParam("DEFAULT_COLUMNS");this.settings=this.getId()in t?t[this.getId()]:{}}return this.settings},isDefault:function(){if(this.default===null){var t=this.getSettings();this.default="default"in t?t.default:false}return this.default},restore:function(){this.isDefault()?this.select():this.unselect();this.setTitle(this.getDefaultTitle());this.disableEdit();this.updateState()},getDefaultTitle:function(){if(this.defaultTitle===null){var t=this.getSettings();this.defaultTitle="name"in t?t.name:""}return this.defaultTitle},getNode:function(){return this.node},getLabel:function(){if(this.label===null){this.label=BX.Grid.Utils.getByTag(this.getNode(),"label",true)}return this.label},getCheckbox:function(){if(this.checkbox===null){this.checkbox=BX.Grid.Utils.getBySelector(this.getNode(),'input[type="checkbox"]',true)}return this.checkbox},getEditButton:function(){if(this.editButton===null){this.editButton=BX.Grid.Utils.getByClass(this.getNode(),this.parent.settings.get("classSettingsWindowColumnEditButton"),true)}return this.editButton},enableEdit:function(){this.getLabel().contentEditable=true;this.getCheckbox().disabled=true;this.adjustCaret()},disableEdit:function(){this.getLabel().contentEditable=false;this.getCheckbox().disabled=false},isEditEnabled:function(){return this.getLabel().isContentEditable},isSelected:function(){return this.getCheckbox().checked},select:function(){this.getCheckbox().checked=true},unselect:function(){this.getCheckbox().checked=false},adjustCaret:function(){var t=document.createRange();var e=window.getSelection();var i=this.getLabel().innerText.length;var n=this.getLabel().childNodes;var s=n[n.length-1];t.setStart(s,i);t.setEnd(s,i);t.collapse(true);e.removeAllRanges();e.addRange(t);BX.fireEvent(this.getNode(),"focus")}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/data.min.js?15145717865232";s:6:"source";s:68:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/data.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Data=function(t){this.parent=t;this.reset()};BX.Grid.Data.prototype.reset=function(){this.response=null;this.xhr=null;this.headRows=null;this.bodyRows=null;this.footRows=null;this.moreButton=null;this.pagination=null;this.counterDisplayed=null;this.counterSelected=null;this.counterTotal=null;this.limit=null;this.actionPanel=null;this.rowsByParentId={};this.rowById={};this.isValidResponse=null};BX.Grid.Data.prototype.getParent=function(){return this.parent};BX.Grid.Data.prototype.validateResponse=function(){if(!BX.type.isBoolean(this.isValidResponse)){this.isValidResponse=!!this.getResponse()&&!!BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classContainer"),true)}return this.isValidResponse};BX.Grid.Data.prototype.request=function(t,e,i,s,n,r){if(!BX.type.isString(t)){t=""}if(!BX.type.isNotEmptyString(e)){e="GET"}if(!BX.type.isPlainObject(i)){i={}}var a={gridId:this.parent.getId(),url:t,method:e,data:i};BX.onCustomEvent(window,"Grid::beforeRequest",[this,a]);t=a.url;if(!BX.type.isNotEmptyString(t)){if(BX.SidePanel&&BX.SidePanel.Instance&&BX.SidePanel.Instance.isOpen()){t=BX.SidePanel.Instance.getPageUrl()}else{t=window.location.pathname+window.location.search}}t=BX.Grid.Utils.addUrlParams(t,{sessid:BX.bitrix_sessid(),internal:"true",grid_id:this.parent.getId()});if("apply_filter"in i&&i.apply_filter==="Y"){t=BX.Grid.Utils.addUrlParams(t,{apply_filter:"Y"})}else{t=BX.util.remove_url_param(t,"apply_filter")}if("clear_nav"in i&&i.clear_nav==="Y"){t=BX.Grid.Utils.addUrlParams(t,{clear_nav:"Y"})}else{t=BX.util.remove_url_param(t,"clear_nav")}t=BX.Grid.Utils.addUrlParams(t,{grid_action:s||"showpage"});e=a.method;i=a.data;this.reset();var o=this;setTimeout(function(){var a=BX.ajax({url:BX.Grid.Utils.ajaxUrl(t,o.getParent().getAjaxId()),data:i,method:e,dataType:"html",headers:[{name:"X-Ajax-Grid-UID",value:o.getParent().getAjaxId()},{name:"X-Ajax-Grid-Req",value:JSON.stringify({action:s||"showpage"})}],processData:true,scriptsRunFirst:false,onsuccess:function(t){o.response=BX.create("div",{html:t});o.response=o.response.querySelector("#"+o.parent.getContainerId());o.xhr=a;if(BX.type.isFunction(n)){BX.delegate(n,o)(t,a)}},onerror:function(t){o.error=r;o.xhr=a;if(BX.type.isFunction(r)){BX.delegate(r,o)(a,t)}}})},0)};BX.Grid.Data.prototype.getResponse=function(){return this.response};BX.Grid.Data.prototype.getHeadRows=function(){if(!this.headRows){this.headRows=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classHeadRow"))}return this.headRows};BX.Grid.Data.prototype.getBodyRows=function(){if(!this.bodyRows){this.bodyRows=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classBodyRow"))}return this.bodyRows};BX.Grid.Data.prototype.getRowsByParentId=function(t){if(!(t in this.rowsByParentId)){this.rowsByParentId[t]=BX.Grid.Utils.getBySelector(this.getResponse(),"."+this.getParent().settings.get("classBodyRow")+'[data-parent-id="'+t+'"]')}return this.rowsByParentId[t]};BX.Grid.Data.prototype.getRowById=function(t){if(!(t in this.rowById)){this.rowById[t]=BX.Grid.Utils.getBySelector(this.getResponse(),"."+this.getParent().settings.get("classBodyRow")+'[data-id="'+t+'"]',true)}return this.rowById[t]};BX.Grid.Data.prototype.getFootRows=function(){if(!this.footRows){this.footRows=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classFootRow"))}return this.footRows};BX.Grid.Data.prototype.getMoreButton=function(){if(!this.moreButton){this.moreButton=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classMoreButton"),true)}return this.moreButton};BX.Grid.Data.prototype.getPagination=function(){if(!this.pagination){this.pagination=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classPagination"),true);if(BX.type.isDomNode(this.pagination)){this.pagination=BX.firstChild(this.pagination)}}return this.pagination};BX.Grid.Data.prototype.getCounterDisplayed=function(){if(!this.counterDisplayed){this.counterDisplayed=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classCounterDisplayed"),true)}return this.counterDisplayed};BX.Grid.Data.prototype.getCounterSelected=function(){if(!this.counterSelected){this.counterSelected=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classCounterSelected"),true)}return this.counterSelected};BX.Grid.Data.prototype.getCounterTotal=function(){if(!BX.type.isDomNode(this.counterTotal)){var t="."+this.getParent().settings.get("classCounterTotal")+" ."+this.getParent().settings.get("classPanelCellContent");this.counterTotal=BX.Grid.Utils.getBySelector(this.getResponse(),t,true)}return this.counterTotal};BX.Grid.Data.prototype.getLimit=function(){if(!this.limit){this.limit=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classPageSize"),true)}return this.limit};BX.Grid.Data.prototype.getPageSize=function(){return this.getLimit()};BX.Grid.Data.prototype.getActionPanel=function(){if(!this.actionPanel){this.actionPanel=BX.Grid.Utils.getByClass(this.getResponse(),this.getParent().settings.get("classActionPanel"),true)}return this.actionPanel}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown-manager.min.js?1491454246996";s:6:"source";s:80:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown-manager.js";s:3:"min";s:84:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown-manager.min.js";s:3:"map";s:84:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown-manager.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.dropdownManager={dropdownClass:"main-dropdown",data:{},init:function(){var self=this;var result;var onLoadItems;var items;BX.bind(document,"click",BX.delegate(function(t){if(BX.hasClass(t.target,this.dropdownClass)){t.preventDefault();result=this.getById(t.target.id);if(result&&result.dropdown===t.target){self.push(t.target.id,this.getById(t.target.id))}else{self.push(t.target.id,new BX.Main.dropdown(t.target))}}},this));onLoadItems=BX.Grid.Utils.getByClass(document.body,this.dropdownClass);if(BX.type.isArray(onLoadItems)){onLoadItems.forEach(function(current){result=self.getById(current.id);try{items=eval(BX.data(current,"items"))}catch(err){}BX.onCustomEvent(window,"Dropdown::load",[current.id,{},null,BX.type.isArray(items)&&items.length?items[0]:[],BX.data(current,"value")])})}},push:function(t,e){this.data[t]=e},getById:function(t){return t in this.data?this.data[t]:null}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-panel.min.js?14980344534993";s:6:"source";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-panel.js";s:3:"min";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-panel.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-panel.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.PinPanel=function(t){this.parent=null;this.panel=null;this.panelRect=null;this.isSelected=null;this.offset=null;this.animationDuration=null;this.lastIsSelected=null;this.init(t)};BX.Grid.PinPanel.prototype={init:function(t){this.parent=t;this.offset=10;this.animationDuration=200;this.panel=this.getPanel();this.bindOnRowsEvents()},bindOnRowsEvents:function(){BX.addCustomEvent("Grid::thereSelectedRows",BX.delegate(this._onThereSelectedRows,this));BX.addCustomEvent("Grid::allRowsSelected",BX.delegate(this._onThereSelectedRows,this));BX.addCustomEvent("Grid::noSelectedRows",BX.delegate(this._onNoSelectedRows,this));BX.addCustomEvent("Grid::allRowsUnselected",BX.delegate(this._onNoSelectedRows,this));BX.addCustomEvent("Grid::updated",BX.delegate(this._onNoSelectedRows,this))},bindOnWindowEvents:function(){BX.bind(window,"resize",BX.proxy(this._onResize,this));document.addEventListener("scroll",BX.proxy(this._onScroll,this),BX.Grid.Utils.listenerParams({passive:true}))},unbindOnWindowEvents:function(){BX.unbind(window,"resize",BX.proxy(this._onResize,this));document.removeEventListener("scroll",BX.proxy(this._onScroll,this),BX.Grid.Utils.listenerParams({passive:true}))},getPanel:function(){this.panel=this.panel||this.parent.getActionsPanel().getPanel();return this.panel},getScrollBottom:function(){return BX.scrollTop(window)+this.getWindowHeight()},getPanelRect:function(){if(!BX.type.isPlainObject(this.panelRect)){this.panelRect=BX.pos(this.getPanel())}return this.panelRect},getPanelPrevBottom:function(){var t=BX.previousSibling(this.getPanel());return BX.pos(t).bottom+parseFloat(BX.style(t,"margin-bottom"))},getWindowHeight:function(){this.windowHeight=this.windowHeight||BX.height(window);return this.windowHeight},pinPanel:function(){BX.style(this.getPanel(),"width",BX.width(this.getPanel().parentNode)+"px");BX.style(this.getPanel().parentNode,"height",BX.height(this.getPanel().parentNode)+"px");BX.addClass(this.getPanel(),"main-grid-fixed-bottom");BX.style(this.getPanel(),"bottom","");setTimeout(BX.delegate(function(){BX.style(this.getPanel(),"transition","none")},this),200)},unpinPanel:function(){BX.removeClass(this.getPanel(),"main-grid-fixed-bottom");BX.style(this.getPanel(),"width","");BX.style(this.getPanel().parentNode,"height","");BX.style(this.getPanel(),"bottom","");setTimeout(BX.delegate(function(){BX.style(this.getPanel(),"transition","")},this),200)},isSelectedRows:function(){return this.isSelected},isNeedPinAbsolute:function(){return BX.pos(this.parent.getBody()).top+this.getPanelRect().height>=this.getScrollBottom()},isNeedPin:function(){return this.getScrollBottom()-this.getPanelRect().height<=this.getPanelPrevBottom()},adjustPanelPosition:function(){var t=window.pageXOffset;this.lastScrollX=this.lastScrollX!==null?this.lastScrollX:t;BX.Grid.Utils.requestAnimationFrame(BX.proxy(function(){if(t!==this.lastScrollX){var e=this.getPanelRect();BX.style(this.getPanel(),"left",e.left-t+"px")}},this));this.lastScrollX=t},pinController:function(t){if(!this.getPanel()){return}var e=this;if(this.isNeedPin()&&this.isSelectedRows()){if(t){BX.style(this.getPanel(),"bottom",-this.getStartDiffPanelPosition()+"px");setTimeout(function(){e.pinPanel()},200)}else{this.pinPanel()}if(this.isNeedPinAbsolute()&&!this.absolutePin){this.absolutePin=true;BX.style(this.getPanel(),"transition","");BX.style(this.getPanel(),"top",BX.pos(this.parent.getBody()).top-parseFloat(BX.style(this.getPanel(),"margin-top"))+"px");BX.style(e.getPanel(),"position","absolute")}else if(!this.isNeedPinAbsolute()&&this.absolutePin){this.absolutePin=false;BX.style(this.getPanel(),"position","");BX.style(this.getPanel(),"top","")}this.adjustPanelPosition()}else{if(t){BX.style(this.getPanel(),"bottom",-this.getEndDiffPanelPosition()+"px");setTimeout(function(){e.unpinPanel()},200)}else{this.unpinPanel()}}},getEndDiffPanelPosition:function(){var t=BX.pos(this.getPanel());var e=BX.pos(BX.previousSibling(this.getPanel()));var i=BX.scrollTop(window);var n=i+BX.height(window);var s=t.height+this.offset;var o=e.bottom+parseFloat(BX.style(this.getPanel(),"margin-top"));if(o<n&&o+t.height>n){s=Math.abs(n-(o+t.height))}return s},getStartDiffPanelPosition:function(){var t=BX.pos(this.getPanel());var e=BX.scrollTop(window);var i=e+BX.height(window);var n=t.height+this.offset;if(t.bottom>i&&t.top<i){n=t.bottom-i}return n},_onThereSelectedRows:function(){this.bindOnWindowEvents();this.isSelected=true;if(this.lastIsSelected){this.pinController()}else{this.lastIsSelected=true;this.pinController(true)}},_onNoSelectedRows:function(){this.unbindOnWindowEvents();this.isSelected=false;this.pinController(true);this.lastIsSelected=false},_onScroll:function(){this.pinController()},_onResize:function(){this.windowHeight=BX.height(window);this.panel=this.parent.getActionsPanel().getPanel();this.panelRect=this.getPanel().getBoundingClientRect();this.pinController()}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown.min.js?14950213673586";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown.js";s:3:"min";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.dropdown=function(t){this.id=null;this.dropdown=null;this.items=null;this.value=null;this.menuId=null;this.menu=null;this.menuItems=null;this.dataItems="items";this.dataValue="value";this.dataPseudo="pseudo";this.dropdownItemClass="main-dropdown-item";this.activeClass="main-dropdown-active";this.selectedClass="main-dropdown-item-selected";this.notSelectedClass="main-dropdown-item-not-selected";this.menuItemClass="menu-popup-item";this.init(t)};BX.Main.dropdown.prototype={init:function(t){this.id=t.id;this.dropdown=t;this.items=this.getItems();this.value=this.getValue();this.menuId=this.getMenuId();this.menu=this.createMenu();this.menu.popupWindow.show();BX.bind(this.dropdown,"click",BX.delegate(this.showMenu,this))},getMenuId:function(){return this.id+"_menu"},getItems:function(){var result;try{var str=BX.data(this.dropdown,this.dataItems);result=eval(str)}catch(err){result=[]}return result},getValue:function(){return BX.data(this.dropdown,this.dataValue)},prepareMenuItems:function(){var t=this;var e,s;var n=this.getValue();function i(a){return a.map(function(a){e={};e["data-"+t.dataValue]=a.VALUE;e["data-"+t.dataPseudo]="PSEUDO"in a&&a.PSEUDO?"true":"false";s=BX.create("div",{children:[BX.create("span",{props:{className:t.dropdownItemClass},attrs:e,text:a.NAME})]});return{text:s.innerHTML,className:n===a.VALUE?t.selectedClass:t.notSelectedClass,delimiter:a.DELIMITER,items:"ITEMS"in a?i(a.ITEMS):null}})}return i(this.getItems())},createMenu:function(){var t=this;return BX.PopupMenu.create(this.getMenuId(),this.dropdown,this.prepareMenuItems(),{autoHide:true,offsetTop:-8,offsetLeft:40,angle:{position:"bottom",offset:0},events:{onPopupClose:BX.delegate(this._onCloseMenu,this),onPopupShow:function(){t._onShowMenu()}}})},showMenu:function(){this.menu=BX.PopupMenu.getMenuById(this.menuId);if(!this.menu){this.menu=this.createMenu();this.menu.popupWindow.show()}},getSubItem:function(t){return BX.Grid.Utils.getByClass(t,this.dropdownItemClass,true)},refresh:function(t){var e=this.getSubItem(t);var s=BX.data(e,this.dataValue);BX.firstChild(this.dropdown).innerText=e.innerText;this.dropdown.dataset[this.dataValue]=s},selectItem:function(t){var e=this;(this.menu.menuItems||[]).forEach(function(s){BX.removeClass(s.layout.item,e.selectedClass);if(t!==s.layout.item){BX.addClass(s.layout.item,e.notSelectedClass)}else{BX.removeClass(s.layout.item,e.notSelectedClass)}});BX.addClass(t,this.selectedClass)},getDataItemIndexByValue:function(t,e){var s;if(BX.type.isArray(t)){t.map(function(t,n){if(t.VALUE===e){s=n;return false}})}return false},getDataItemByValue:function(t){var e=this.getItems().filter(function(e){return e.VALUE===t});return e.length>0?e[0]:null},_onShowMenu:function(){var t=this;BX.addClass(this.dropdown,this.activeClass);(this.menu.menuItems||[]).forEach(function(e){BX.bind(e.layout.item,"click",BX.delegate(t._onItemClick,t))})},_onCloseMenu:function(){BX.removeClass(this.dropdown,this.activeClass);BX.PopupMenu.destroy(this.menuId)},_onItemClick:function(t){var e=this.getMenuItem(t.target);var s,n;var i=this.getSubItem(e);var a=BX.data(i,"pseudo");if(!(a==="true")){this.refresh(e);this.selectItem(e);this.menu.popupWindow.close();s=this.getValue();n=this.getDataItemByValue(s)}else{s=BX.data(i,"value");n=this.getDataItemByValue(s)}BX.onCustomEvent(window,"Dropdown::change",[this.dropdown.id,t,e,n,s])},getMenuItem:function(t){var e=t;if(!BX.hasClass(e,this.menuItemClass)){e=BX.findParent(e,{"class":this.menuItemClass})}return e}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window.min.js?15145718318369";s:6:"source";s:79:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.SettingsWindow=function(t){this.parent=null;this.popupItems=null;this.items=null;this.popup=null;this.sourceContent=null;this.applyButton=null;this.resetButton=null;this.cancelButton=null;this.init(t);BX.onCustomEvent(window,"BX.Grid.SettingsWindow:init",[this])};BX.Grid.SettingsWindow.prototype={init:function(t){this.parent=t;BX.bind(this.parent.getContainer(),"click",BX.proxy(this._onContainerClick,this));BX.addCustomEvent(window,"Grid::columnMoved",BX.proxy(this._onColumnMoved,this))},destroy:function(){BX.unbind(this.parent.getContainer(),"click",BX.proxy(this._onContainerClick,this));BX.removeCustomEvent(window,"Grid::columnMoved",BX.proxy(this._onColumnMoved,this));this.getPopup().close()},getSelectAllButton:function(){if(!this.selectAllButton){this.selectAllButton=BX.Grid.Utils.getByClass(this.getPopup().contentContainer,this.parent.settings.get("classSettingsWindowSelectAll"),true)}return this.selectAllButton},getUnselectAllButton:function(){if(!this.unselectAllButton){this.unselectAllButton=BX.Grid.Utils.getByClass(this.getPopup().contentContainer,this.parent.settings.get("classSettingsWindowUnselectAll"),true)}return this.unselectAllButton},reset:function(){this.popupItems=null;this.allColumns=null;this.items=null},_onContainerClick:function(t){if(BX.hasClass(t.target,this.parent.settings.get("classSettingsButton"))){this._onSettingsButtonClick(t)}},_onSettingsButtonClick:function(){BX.onCustomEvent(window,"BX.Grid.SettingsWindow:show",[this]);this.getPopup().show()},getSourceContent:function(){if(!this.sourceContent){this.sourceContent=BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classSettingsWindow"),true)}return this.sourceContent},getPopupItems:function(){var t;if(!this.popupItems){t=this.getPopup().contentContainer;this.popupItems=BX.Grid.Utils.getByClass(t,this.parent.settings.get("classSettingsWindowColumn"))}return this.popupItems},getSelectedColumns:function(){var t=[];this.getItems().forEach(function(e){e.isSelected()&&t.push(e.getId())});return t},restoreColumns:function(){this.getItems().forEach(function(t){t.restore()});this.sortItems();this.reset()},restoreLastColumns:function(){this.getItems().forEach(function(t){t.restoreState()})},updateColumnsState:function(){this.getItems().forEach(function(t){t.updateState()})},saveColumns:function(t,e){var n=this.parent.getUserOptions();var i=this.getColumnNames();var s=[];s.push({action:n.getAction("GRID_SET_COLUMNS"),columns:t.join(",")});s.push({action:n.getAction("SET_CUSTOM_NAMES"),custom_names:i});if(this.isForAll()){s.push({action:n.getAction("GRID_SAVE_SETTINGS"),view_id:"default",set_default_settings:"Y",delete_user_settings:"Y"})}n.batch(s,BX.delegate(function(){this.parent.reloadTable(null,null,e)},this));this.updateColumnsState()},disableAllColumnslabelEdit:function(){this.getItems().forEach(function(t){t.disableEdit()})},getAllColumns:function(){if(!this.allColumns){this.allColumns=this.getItems().map(function(t){return t.getId()})}return this.allColumns},isShowedColumn:function(t){return this.getSelectedColumns().some(function(e){return e===t})},getShowedColumns:function(){var t=[];var e=this.parent.getRows().getHeadFirstChild().getCells();[].slice.call(e).forEach(function(e){if("name"in e.dataset){t.push(e.dataset.name)}});return t},sortItems:function(){var t=this.getShowedColumns();var e={};this.getAllColumns().forEach(function(t){e[t]=t},this);var n=0;Object.keys(e).forEach(function(i){if(this.isShowedColumn(i)){e[i]=t[n];n++}var s=this.getColumnByName(e[i]);s&&s.parentNode.appendChild(s)},this)},getColumnNames:function(){var t={};this.getItems().map(function(e){if(e.isEdited()){t[e.getId()]=e.getTitle()}});return t},getColumnByName:function(t){return BX.Grid.Utils.getBySelector(this.getPopup().popupContainer,"."+this.parent.settings.get("classSettingsWindowColumn")+'[data-name="'+t+'"]',true)},_onColumnMoved:function(){this.sortItems();this.reset()},onResetButtonClick:function(){this.parent.confirmDialog({CONFIRM:true,CONFIRM_MESSAGE:this.parent.arParams.CONFIRM_RESET_MESSAGE},BX.delegate(function(){this.enableWait(this.getApplyButton());this.parent.getUserOptions().reset(this.isForAll(),BX.delegate(function(){this.parent.reloadTable(null,null,BX.delegate(function(){this.restoreColumns();this.disableWait(this.getApplyButton());this.getPopup().close()},this))},this))},this))},getResetButtonId:function(){return this.parent.getContainerId()+"-grid-settings-reset-button"},onApplyButtonClick:function(){this.parent.confirmDialog({CONFIRM:this.isForAll(),CONFIRM_MESSAGE:this.parent.getParam("SETTINGS_FOR_ALL_CONFIRM_MESSAGE")},BX.delegate(function(){this.enableWait(this.getApplyButton());this.saveColumns(this.getSelectedColumns(),BX.delegate(function(){this.getPopup().close();this.disableWait(this.getApplyButton());this.unselectForAllCheckbox()},this));BX.onCustomEvent(window,"BX.Grid.SettingsWindow:save",[this])},this),BX.delegate(function(){this.unselectForAllCheckbox()},this))},getApplyButtonId:function(){return this.parent.getContainerId()+"-grid-settings-apply-button"},getApplyButton:function(){if(this.applyButton===null){this.applyButton=BX(this.getApplyButtonId())}return this.applyButton},getCancelButtonId:function(){return this.parent.getContainerId()+"-grid-settings-cancel-button"},getCancelButton:function(){if(this.cancelButton===null){this.cancelButton=BX(this.getCancelButtonId())}return this.cancelButton},unselectForAllCheckbox:function(){var t=this.getForAllCheckbox();t&&(t.checked=null)},enableWait:function(t){BX.addClass(t,"webform-small-button-wait");BX.removeClass(t,"popup-window-button")},disableWait:function(t){BX.removeClass(t,"webform-small-button-wait");BX.addClass(t,"popup-window-button")},createTitle:function(){var t=BX.create("div");var e=BX("pagetitle");var n=!!e?"&laquo;"+e.innerText+"&raquo;":"";t.innerHTML="<span>"+this.parent.getParam("SETTINGS_TITLE")+" "+n+"</span>";return t.firstChild.innerText},getPopupId:function(){return this.parent.getContainerId()+"-grid-settings-window"},createPopup:function(){this.popup=new BX.PopupWindow(this.getPopupId(),null,{titleBar:this.createTitle(),autoHide:false,overlay:.6,width:800,closeIcon:true,closeByEsc:true,contentNoPaddings:true,content:this.getSourceContent(),events:{onPopupClose:BX.delegate(this.onPopupClose,this)}});this.getItems().forEach(function(t){BX.bind(t.getNode(),"click",BX.delegate(this.onItemClick,this))},this);BX.bind(this.getResetButton(),"click",BX.proxy(this.onResetButtonClick,this));BX.bind(this.getApplyButton(),"click",BX.proxy(this.onApplyButtonClick,this));BX.bind(this.getCancelButton(),"click",BX.proxy(this.popup.close,this.popup));BX.bind(this.getSelectAllButton(),"click",BX.delegate(this.onSelectAll,this));BX.bind(this.getUnselectAllButton(),"click",BX.delegate(this.onUnselectAll,this));return this.popup},onItemClick:function(){this.adjustActionButtonsState()},getItems:function(){if(this.items===null){this.items=this.getPopupItems().map(function(t){return new BX.Grid.SettingsWindowColumn(this.parent,t)},this)}return this.items},onPopupClose:function(){BX.onCustomEvent(window,"BX.Grid.SettingsWindow:close",[this]);this.restoreLastColumns();this.disableAllColumnslabelEdit();this.adjustActionButtonsState()},getPopup:function(){return!!this.popup?this.popup:this.popup=this.createPopup()},onSelectAll:function(){this.selectAll();this.enableActions()},onUnselectAll:function(){this.unselectAll();this.disableActions()},selectAll:function(){this.getItems().forEach(function(t){t.select()})},unselectAll:function(){this.getItems().forEach(function(t){t.unselect()})},isForAll:function(){var t=this.getForAllCheckbox();return t&&!!t.checked},getForAllCheckbox:function(){return BX.Grid.Utils.getByClass(this.getPopup().popupContainer,"main-grid-settings-window-for-all-checkbox",true)},getResetButton:function(){if(this.resetButton===null){this.resetButton=BX(this.getResetButtonId())}return this.resetButton},disableActions:function(){var t=this.getApplyButton();if(!!t){BX.addClass(t,this.parent.settings.get("classDisable"))}},enableActions:function(){var t=this.getApplyButton();if(!!t){BX.removeClass(t,this.parent.settings.get("classDisable"))}},adjustActionButtonsState:function(){if(this.getSelectedColumns().length){this.enableActions()}else{this.disableActions()}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/element.min.js?1498034453857";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/element.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/element.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/element.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Element=function(t,e){this.node=null;this.href=null;this.parent=null;this.init(t,e)};BX.Grid.Element.prototype={init:function(t,e){this.node=t;this.parent=e;this.resetOnclickAttr()},getParent:function(){return this.parent},load:function(){BX.addClass(this.getNode(),this.getParent().settings.get("classLoad"))},unload:function(){BX.removeClass(this.getNode(),this.getParent().settings.get("classLoad"))},isLoad:function(){return BX.hasClass(this.getNode(),this.getParent().settings.get("classLoad"))},resetOnclickAttr:function(){if(BX.type.isDomNode(this.getNode())){this.getNode().onclick=null}},getObserver:function(){return BX.Grid.observer},getNode:function(){return this.node},getLink:function(){var t;try{t=this.getNode().href}catch(e){t=null}return t}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings.min.js?15112425725162";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Settings=function(){this.settings={};this.defaultSettings={classContainer:"main-grid",classWrapper:"main-grid-wrapper",classTable:"main-grid-table",classScrollContainer:"main-grid-container",classFadeContainer:"main-grid-fade",classFadeContainerRight:"main-grid-fade-right",classFadeContainerLeft:"main-grid-fade-left",classNavPanel:"main-grid-nav-panel",classActionPanel:"main-grid-action-panel",classCursor:"main-grid-cursor",classRowCustom:"main-grid-row-custom",classMoreButton:"main-grid-more-btn",classRow:"main-grid-row",classHeadRow:"main-grid-row-head",classBodyRow:"main-grid-row-body",classFootRow:"main-grid-row-foot",classDataRows:"main-grid-row-data",classPanels:"main-grid-bottom-panels",classCellHeadContainer:"main-grid-cell-head-container",classCellHeadOndrag:"main-grid-cell-head-ondrag",classEmptyRows:"main-grid-row-empty",classEmptyBlock:"main-grid-empty-block",classCheckAllCheckboxes:"main-grid-check-all",classCheckedRow:"main-grid-row-checked",classRowCheckbox:"main-grid-row-checkbox",classPagination:"main-grid-panel-cell-pagination",classActionCol:"main-grid-cell-action",classCounterDisplayed:"main-grid-counter-displayed",classCounterSelected:"main-grid-counter-selected",classCounterTotal:"main-grid-panel-total",classTableFade:"main-grid-table-fade",classDragActive:"main-grid-on-row-drag",classResizeButton:"main-grid-resize-button",classOnDrag:"main-grid-ondrag",classDisableDrag:"main-grid-row-drag-disabled",classPanelCellContent:"main-grid-panel-content",classCollapseButton:"main-grid-plus-button",classRowStateLoad:"main-grid-load-row",classRowStateExpand:"main-grid-row-expand",classHeaderSortable:"main-grid-col-sortable",classHeaderNoSortable:"main-grid-col-no-sortable",classCellStatic:"main-grid-cell-static",classHeadCell:"main-grid-cell-head",classPageSize:"main-grid-panel-select-pagesize",classGroupEditButton:"main-grid-control-panel-action-edit",classGroupDeleteButton:"main-grid-control-panel-action-remove",classGroupActionsDisabled:"main-grid-control-panel-action-icon-disable",classPanelButton:"main-grid-buttons",classPanelApplyButton:"main-grid-control-panel-apply-button",classPanelCheckbox:"main-grid-panel-checkbox",classEditor:"main-grid-editor",classEditorContainer:"main-grid-editor-container",classEditorText:"main-grid-editor-text",classEditorDate:"main-grid-editor-date",classEditorNumber:"main-grid-editor-number",classEditorRange:"main-grid-editor-range",classEditorCheckbox:"main-grid-editor-checkbox",classEditorTextarea:"main-grid-editor-textarea",classEditorCustom:"main-grid-editor-custom",classCellContainer:"main-grid-cell-content",classEditorOutput:"main-grid-editor-output",classSettingsWindow:"main-grid-settings-window",classSettingsWindowColumn:"main-grid-settings-window-list-item",classSettingsWindowColumnLabel:"main-grid-settings-window-list-item-label",classSettingsWindowColumnEditState:"main-grid-settings-window-list-item-edit",classSettingsWindowColumnEditInput:"main-grid-settings-window-list-item-edit-input",classSettingsWindowColumnEditButton:"main-grid-settings-window-list-item-edit-button",classSettingsWindowColumnCheckbox:"main-grid-settings-window-list-item-checkbox",classSettingsWindowShow:"main-grid-settings-window-show",classSettingsWindowSelectAll:"main-grid-settings-window-select-all",classSettingsWindowUnselectAll:"main-grid-settings-window-unselect-all",classSettingsButton:"main-grid-interface-settings-icon",classSettingsButtonActive:"main-grid-interface-settings-icon-active",classSettingsWindowClose:"main-grid-settings-window-actions-item-close",classSettingsWindowReset:"main-grid-settings-window-actions-item-reset",classSettingsWindowColumnChecked:"main-grid-settings-window-list-item-checked",classShowAnimation:"main-grid-show-popup-animation",classCloseAnimation:"main-grid-close-popup-animation",classLoader:"main-grid-loader-container",classLoaderShow:"main-grid-show-loader",classLoaderHide:"main-grid-hide-loader",classRowError:"main-grid-error",loaderHideAnimationName:"hideLoader",classHide:"main-grid-hide",classEar:"main-grid-ear",classEarLeft:"main-grid-ear-left",classEarRight:"main-grid-ear-right",classNotCount:"main-grid-not-count",classCounter:"main-grid-panel-counter",classForAllCounterEnabled:"main-grid-panel-counter-for-all-enable",classLoad:"load",classRowActionButton:"main-grid-row-action-button",classDropdown:"main-dropdown",classPanelControl:"main-grid-panel-control",classPanelControlContainer:"main-grid-panel-control-container",classForAllCheckbox:"main-grid-for-all-checkbox",classDisable:"main-grid-disable",dataActionsKey:"actions",updateActionMore:"more",classShow:"show",classGridShow:"main-grid-show",updateActionPagination:"pagination",updateActionSort:"sort",ajaxIdDataProp:"ajaxid",pageSizeId:"grid_page_size",sortableRows:true,sortableColumns:true,animationDuration:300};this.prepare()};BX.Grid.Settings.prototype={prepare:function(){this.settings=this.defaultSettings},getDefault:function(){return this.defaultSettings},get:function(i){var a;try{a=this.getDefault()[i]}catch(i){a=null}return a},getList:function(){return this.getDefault()}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:88:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/fader.min.js?15045957215868";s:6:"source";s:69:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/fader.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/fader.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/fader.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Fader=function(t){this.parent=null;this.table=null;this.container=null;this.init(t)};BX.Grid.Fader.prototype={init:function(t){this.parent=t;this.table=this.parent.getTable();this.container=this.table.parentNode;this.scrollStartEventName=this.parent.isTouch()?"touchstart":"mouseenter";this.scrollEndEventName=this.parent.isTouch()?"touchend":"mouseleave";if(this.parent.getParam("ALLOW_PIN_HEADER")){this.fixedTable=this.parent.getPinHeader().getFixedTable()}this.debounceScrollHandler=BX.debounce(this._onWindowScroll,400,this);BX.bind(window,"resize",BX.proxy(this.toggle,this));document.addEventListener("scroll",this.debounceScrollHandler,BX.Grid.Utils.listenerParams({passive:true}));this.container.addEventListener("scroll",BX.proxy(this.toggle,this),BX.Grid.Utils.listenerParams({passive:true}));BX.addCustomEvent(window,"Grid::updated",BX.proxy(this.toggle,this));BX.addCustomEvent(window,"Grid::resize",BX.proxy(this.toggle,this));BX.addCustomEvent(window,"Grid::headerUpdated",BX.proxy(this._onHeaderUpdated,this));BX.addCustomEvent(window,"Grid::columnResize",BX.proxy(this.toggle,this));BX.bind(this.getEarLeft(),this.scrollStartEventName,BX.proxy(this._onMouseoverLeft,this));BX.bind(this.getEarRight(),this.scrollStartEventName,BX.proxy(this._onMouseoverRight,this));BX.bind(this.getEarLeft(),this.scrollEndEventName,BX.proxy(this.stopScroll,this));BX.bind(this.getEarRight(),this.scrollEndEventName,BX.proxy(this.stopScroll,this));this.toggle();this.adjustEarOffset(true)},destroy:function(){BX.unbind(window,"resize",BX.proxy(this.toggle,this));document.removeEventListener("scroll",this.debounceScrollHandler,BX.Grid.Utils.listenerParams({passive:true}));this.container.removeEventListener("scroll",BX.proxy(this.toggle,this),BX.Grid.Utils.listenerParams({passive:true}));BX.removeCustomEvent(window,"Grid::updated",BX.proxy(this.toggle,this));BX.removeCustomEvent(window,"Grid::headerUpdated",BX.proxy(this._onHeaderUpdated,this));BX.removeCustomEvent(window,"Grid::columnResize",BX.proxy(this.toggle,this));BX.unbind(this.getEarLeft(),this.scrollStartEventName,BX.proxy(this._onMouseoverLeft,this));BX.unbind(this.getEarRight(),this.scrollStartEventName,BX.proxy(this._onMouseoverRight,this));BX.unbind(this.getEarLeft(),this.scrollEndEventName,BX.proxy(this.stopScroll,this));BX.unbind(this.getEarRight(),this.scrollEndEventName,BX.proxy(this.stopScroll,this));this.hideLeftEar();this.hideRightEar();this.stopScroll()},_onHeaderUpdated:function(){this.fixedTable=this.parent.getPinHeader().getFixedTable()},_onMouseoverLeft:function(t){this.parent.isTouch()&&t.preventDefault();this.startScrollByDirection("left")},_onMouseoverRight:function(t){this.parent.isTouch()&&t.preventDefault();this.startScrollByDirection("right")},stopScroll:function(){clearTimeout(this.scrollTimer);clearInterval(this.scrollInterval)},startScrollByDirection:function(t){var e=this.container;var i=e.scrollLeft;var s=this;var r=8;var o=1e3/60/2;this.scrollTimer=setTimeout(function(){s.scrollInterval=setInterval(function(){e.scrollLeft=t=="right"?i+=r:i-=r},o)},100)},getEarLeft:function(){if(!this.earLeft){this.earLeft=BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classEarLeft"),true)}return this.earLeft},getEarRight:function(){if(!this.earRight){this.earRight=BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classEarRight"),true)}return this.earRight},adjustEarOffset:function(t){if(t){this.windowHeight=BX.height(window);this.tbodyPos=BX.pos(this.table.tBodies[0]);this.headerPos=BX.pos(this.table.tHead)}var e=window.scrollY;if(this.parent.isIE()){e=document.documentElement.scrollTop}var i=e+this.windowHeight-this.tbodyPos.top;var s=e-this.tbodyPos.top;if(i>this.tbodyPos.bottom-this.tbodyPos.top){i=this.tbodyPos.bottom-this.tbodyPos.top}if(s<this.headerPos.height){s=this.headerPos.height}else{i-=s;i+=this.headerPos.height}BX.Grid.Utils.requestAnimationFrame(BX.proxy(function(){if(s!==this.lastPosTop){var t="translate3d(0px, "+s+"px, 0)";this.getEarLeft().style.transform=t;this.getEarRight().style.transform=t}if(i!==this.lastBottomPos){this.getEarLeft().style.height=i+"px";this.getEarRight().style.height=i+"px"}this.lastPosTop=s;this.lastBottomPos=i},this))},_onWindowScroll:function(){this.adjustEarOffset()},hasScroll:function(){return this.table.offsetWidth>this.container.clientWidth},hasScrollLeft:function(){return this.container.scrollLeft>0},hasScrollRight:function(){return this.table.offsetWidth>this.container.scrollLeft+this.container.clientWidth},showLeftEar:function(){BX.addClass(this.container.parentNode,this.parent.settings.get("classFadeContainerLeft"));BX.addClass(this.getEarLeft(),this.parent.settings.get("classShow"))},hideLeftEar:function(){BX.removeClass(this.container.parentNode,this.parent.settings.get("classFadeContainerLeft"));BX.removeClass(this.getEarLeft(),this.parent.settings.get("classShow"))},showRightEar:function(){BX.addClass(this.container.parentNode,this.parent.settings.get("classFadeContainerRight"));BX.addClass(this.getEarRight(),this.parent.settings.get("classShow"))},hideRightEar:function(){BX.removeClass(this.container.parentNode,this.parent.settings.get("classFadeContainerRight"));BX.removeClass(this.getEarRight(),this.parent.settings.get("classShow"))},adjustFixedTablePosition:function(){var t=this.container.scrollLeft;BX.Grid.Utils.requestAnimationFrame(BX.delegate(function(){this.fixedTable.style.transform="translate3d(-"+t+"px, 0px, 0)"},this))},toggle:function(){this.adjustEarOffset(true);this.fixedTable&&this.adjustFixedTablePosition();if(this.hasScroll()){this.hasScrollLeft()?this.showLeftEar():this.hideLeftEar();this.hasScrollRight()?this.showRightEar():this.hideRightEar()}else{this.hideLeftEar();this.hideRightEar()}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/gridupdater.min.js?15096143322660";s:6:"source";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/gridupdater.js";s:3:"min";s:79:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/gridupdater.min.js";s:3:"map";s:79:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/gridupdater.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Updater=function(t){this.parent=t};BX.Grid.Updater.prototype.getParent=function(){return this.parent};BX.Grid.Updater.prototype.updateHeadRows=function(t){var e;if(BX.type.isArray(t)&&t.length){e=this.getParent().getHeaders();e.forEach(function(e){e=BX.cleanNode(e);t.forEach(function(t){if(BX.type.isDomNode(t)){e.appendChild(BX.clone(t))}})})}};BX.Grid.Updater.prototype.appendHeadRows=function(t){var e;if(BX.type.isArray(t)&&t.length){e=this.getParent().getHeaders();e.forEach(function(e){t.forEach(function(t){if(BX.type.isDomNode(t)){e.appendChild(BX.clone(t))}})})}};BX.Grid.Updater.prototype.prependHeadRows=function(t){var e;if(BX.type.isArray(t)&&t.length){e=this.getParent().getHeaders();e.forEach(function(e){e=BX.cleanNode(e);t.forEach(function(t){if(BX.type.isDomNode(t)){e.prepend(BX.clone(t))}})})}};BX.Grid.Updater.prototype.updateBodyRowById=function(t,e){if((BX.type.isNumber(t)||BX.type.isNotEmptyString(t))&&BX.type.isDomNode(e)){var o=this.getParent().getRows().getById(t);if(o){var i=o.getNode();BX.insertAfter(e,i);BX.remove(i)}}};BX.Grid.Updater.prototype.updateBodyRows=function(t){if(BX.type.isArray(t)){var e=this.getParent().getBody();e.innerHTML="";t.forEach(function(t){!!t&&e.appendChild(t)})}};BX.Grid.Updater.prototype.appendBodyRows=function(t){var e;if(BX.type.isArray(t)){e=this.getParent().getBody();t.forEach(function(t){if(BX.type.isDomNode(t)){e.appendChild(t)}})}};BX.Grid.Updater.prototype.prependBodyRows=function(t){var e;if(BX.type.isArray(t)){e=this.getParent().getBody();t.forEach(function(t){if(BX.type.isDomNode(t)){BX.prepend(e,t)}})}};BX.Grid.Updater.prototype.updateFootRows=function(t){var e;if(BX.type.isArray(t)){e=BX.cleanNode(this.getParent().getFoot());t.forEach(function(t){if(BX.type.isDomNode(t)){e.appendChild(t)}})}};BX.Grid.Updater.prototype.updateCounterTotal=function(t){var e;if(BX.type.isDomNode(t)){e=BX.cleanNode(this.getParent().getCounterTotal());e.appendChild(t)}};BX.Grid.Updater.prototype.updatePagination=function(t){var e=this.getParent().getPagination().getContainer();if(!!e){e.innerHTML="";if(BX.type.isDomNode(t)){e.appendChild(t)}}};BX.Grid.Updater.prototype.updateMoreButton=function(t){if(BX.type.isDomNode(t)){var e=BX.Grid.Utils.closestParent(this.getParent().getMoreButton().getNode());e.innerHTML="";e.appendChild(t)}};BX.Grid.Updater.prototype.updateGroupActions=function(t){var e=this.parent.getActionsPanel();if(!!e&&BX.type.isDomNode(t)){var o=e.getPanel();if(BX.type.isDomNode(o)){o.innerHTML="";var i=BX.firstChild(t);if(BX.type.isDomNode(i)){o.appendChild(i)}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/inline-editor.min.js?15096143325273";s:6:"source";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/inline-editor.js";s:3:"min";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/inline-editor.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/inline-editor.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.InlineEditor=function(t,e){this.parent=null;this.types=null;this.init(t,e)};BX.Grid.InlineEditor.prototype={init:function(parent,types){this.parent=parent;try{this.types=eval(types)}catch(err){this.types=null}},createContainer:function(){return BX.create("div",{props:{className:this.parent.settings.get("classEditorContainer")}})},createTextarea:function(t,e){var i=BX.create("textarea",{props:{className:[this.parent.settings.get("classEditor"),this.parent.settings.get("classEditorTextarea")].join(" ")},attrs:{name:t.NAME,style:"height:"+e+"px"},html:t.VALUE});return i},createInput:function(t){var e=this.parent.settings.get("classEditorText");var i={value:t.VALUE!==undefined&&t.VALUE!==null?BX.util.htmlspecialcharsback(t.VALUE):"",name:t.NAME!==undefined&&t.NAME!==null?t.NAME:""};if(t.TYPE===this.types.CHECKBOX){e=this.parent.settings.get("classEditorCheckbox");i.type="checkbox";i.checked=i.value=="Y"}if(t.TYPE===this.types.DATE){e=[e,this.parent.settings.get("classEditorDate")].join(" ")}if(t.TYPE===this.types.NUMBER){e=[e,this.parent.settings.get("classEditorNumber")].join(" ");i.type="number"}if(t.TYPE===this.types.RANGE){e=[e,this.parent.settings.get("classEditorRange")].join(" ");i.type="range";if(BX.type.isPlainObject(t.DATA)){i.min=t.DATA.MIN||"0";i.max=t.DATA.MAX||99999;i.step=t.DATA.STEP||""}}e=[this.parent.settings.get("classEditor"),e].join(" ");return BX.create("input",{props:{className:e,id:t.NAME+"_control"},attrs:i})},createCustom:function(t){var e=this.parent.settings.get("classEditorCustom");e=[this.parent.settings.get("classEditor"),e].join(" ");var i=BX.create("div",{props:{className:e},attrs:{"data-name":t.NAME},html:t.HTML});i.querySelectorAll("input, select, checkbox, textarea").forEach(function(e){switch(e.tagName){case"SELECT":e.value="";if(e.multiple){e.querySelectorAll("option").forEach(function(e){e.selected=false;if(Array.isArray(t.VALUE)){if(BX.util.in_array(e.value,t.VALUE)){e.selected=true}}else{if(e.value===t.VALUE){e.selected=true}}})}else{e.value=t.VALUE}break;case"INPUT":switch(e.type.toUpperCase()){case"CHECKBOX":e.checked=t.VALUE==="1"||t.VALUE==="Y";break;case"HIDDEN":break;default:e.value=t.VALUE}break;default:e.value=t.VALUE}});return i},createOutput:function(t){return BX.create("output",{props:{className:this.parent.settings.get("classEditorOutput")||""},attrs:{"for":t.NAME+"_control"},text:t.VALUE||""})},getDropdownValueItemByValue:function(t,e){var i=t.filter(function(t){return t.VALUE===e});return i.length>0?i[0]:t[0]},createDropdown:function(t){var e=this.getDropdownValueItemByValue(t.DATA.ITEMS,t.VALUE);return BX.create("div",{props:{className:[this.parent.settings.get("classEditor"),"main-dropdown main-grid-editor-dropdown"].join(" "),id:t.NAME+"_control"},attrs:{name:t.NAME,"data-items":JSON.stringify(t.DATA.ITEMS),"data-value":e.VALUE},children:[BX.create("span",{props:{className:"main-dropdown-inner"},html:e.NAME})]})},validateEditObject:function(t){return BX.type.isPlainObject(t)&&"TYPE"in t&&"NAME"in t&&"VALUE"in t},initCalendar:function(t){BX.calendar({node:t.target,field:t.target})},bindOnRangeChange:function(t,e){function i(t,e){BX.html(e,t.value);var i=parseFloat(t.value);var n=parseFloat(t.getAttribute("max"));var a=parseFloat(t.getAttribute("min"));var s=16;var r=n-a;var o=(i-a)/r*100;var c=Math.round(s*o/100)-s/2;e.style.left=o+"%";e.style.marginLeft=-c+"px"}setTimeout(function(){i(t,e)},0);BX.bind(t,"input",function(){i(t,e)})},getEditor:function(t,e){var i,n;var a=this.createContainer();if(this.validateEditObject(t)){t.VALUE=t.VALUE===null?"":t.VALUE;switch(t.TYPE){case this.types.TEXT:{i=this.createInput(t);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.DATE:{i=this.createInput(t);BX.bind(i,"click",this.initCalendar);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.NUMBER:{i=this.createInput(t);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.RANGE:{i=this.createInput(t);n=this.createOutput(t);this.bindOnRangeChange(i,n);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.CHECKBOX:{i=this.createInput(t);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.TEXTAREA:{i=this.createTextarea(t,e);BX.bind(i,"click",function(t){t.stopPropagation()});BX.bind(i,"keydown",BX.delegate(this._onControlKeydown,this));break}case this.types.DROPDOWN:{i=this.createDropdown(t);break}case this.types.CUSTOM:{i=this.createCustom(t);BX.bind(i,"click",function(t){t.stopPropagation()});break}default:{break}}}if(BX.type.isDomNode(n)){a.appendChild(n)}if(BX.type.isDomNode(i)){a.appendChild(i)}return a},_onControlKeydown:function(t){if(t.code==="Enter"){t.stopPropagation();t.preventDefault();var e=BX.Grid.Utils.getBySelector(this.parent.getContainer(),"#grid_save_button > button",true);if(e){BX.fireEvent(e,"click")}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/useroptions.min.js?14980344532994";s:6:"source";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/useroptions.js";s:3:"min";s:79:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/useroptions.min.js";s:3:"map";s:79:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/useroptions.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.UserOptions=function(t,i,e,s){this.options=null;this.actions=null;this.parent=null;this.url=null;this.init(t,i,e,s)};BX.Grid.UserOptions.prototype={init:function(parent,userOptions,userOptionsActions,url){this.url=url;this.parent=parent;try{this.options=eval(userOptions)}catch(err){console.warn("BX.Grid.UserOptions.init: Failed parse user options json string")}try{this.actions=eval(userOptionsActions)}catch(err){console.warn("BX.Grid.UserOptions.init: Failed parse user options actions json string")}},getCurrentViewName:function(){var t=this.getOptions();return"current_view"in t?t.current_view:null},getViewsList:function(){var t=this.getOptions();return"views"in t?t.views:{}},getCurrentOptions:function(){var t=this.getCurrentViewName();var i=this.getViewsList();var e=null;if(t in i){e=i[t]}if(!BX.type.isPlainObject(e)){e={}}return e},getUrl:function(t){return BX.util.add_url_param(this.url,{GRID_ID:this.parent.getContainerId(),bxajaxid:this.parent.getAjaxId(),action:t})},getOptions:function(){return this.options||{}},getActions:function(){return this.actions},getAction:function(t){var i=null;try{i=this.getActions()[t]}catch(e){i=null}return i},update:function(t){this.options=t},setColumns:function(t,i){var e=this.getCurrentOptions();if(BX.type.isPlainObject(e)){e.columns=t.join(",");this.save(this.getAction("GRID_SET_COLUMNS"),{columns:e.columns},i)}return this},setColumnsNames:function(t,i){var e={view_id:"default"};if(BX.type.isPlainObject(e)){e.custom_names=t;this.save(this.getAction("SET_CUSTOM_NAMES"),e,i)}return this},setColumnSizes:function(t,i){this.save(this.getAction("GRID_SET_COLUMN_SIZES"),{sizes:t,expand:i})},reset:function(t,i){var e={};if(!!t){e={view_id:"default",set_default_settings:"Y",delete_user_settings:"Y",view_settings:this.getCurrentOptions()}}this.save(this.getAction("GRID_RESET"),e,i)},setSort:function(t,i,e){if(t&&i){this.save(this.getAction("GRID_SET_SORT"),{by:t,order:i},e)}return this},setPageSize:function(t,i){if(BX.type.isNumber(parseInt(t))){this.save(this.getAction("GRID_SET_PAGE_SIZE"),{pageSize:t},i)}},setExpandedRows:function(t,i){BX.type.isArray(t)&&this.save(this.getAction("GRID_SET_EXPANDED_ROWS"),{ids:t},i)},setCollapsedGroups:function(t,i){BX.type.isArray(t)&&this.save(this.getAction("GRID_SET_COLLAPSED_GROUPS"),{ids:t},i)},resetExpandedRows:function(){this.save(this.getAction("GRID_RESET_EXPANDED_ROWS"),{})},saveForAll:function(t){this.save(this.getAction("GRID_SAVE_SETTINGS"),{view_id:"default",set_default_settings:"Y",delete_user_settings:"Y",view_settings:this.getCurrentOptions()},t)},batch:function(t,i){this.save(this.getAction("GRID_SAVE_BATH"),{bath:t},i)},save:function(t,i,e){var s=this;BX.ajax.post(this.getUrl(t),i,function(t){try{t=JSON.parse(t);if(!t.error){s.update(t);if(BX.type.isFunction(e)){e(t)}BX.onCustomEvent(s.parent.getContainer(),"Grid::optionsChanged",[s.parent])}}catch(i){}})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/loader.min.js?15096143322398";s:6:"source";s:70:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/loader.js";s:3:"min";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/loader.min.js";s:3:"map";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/loader.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Loader=function(t){this.parent=null;this.container=null;this.windowHeight=null;this.tbodyPos=null;this.headerPos=null;this.lastPosTop=null;this.lastBottomPos=null;this.table=null;this.init(t)};BX.Grid.Loader.prototype={init:function(t){this.parent=t;this.table=this.parent.getTable();BX.bind(this.getContainer(),"animationend",BX.proxy(this._onAnimationEnd,this));BX.bind(this.getContainer(),"webkitAnimationEnd",BX.proxy(this._onAnimationEnd,this));BX.bind(this.getContainer(),"oanimationend",BX.proxy(this._onAnimationEnd,this));BX.bind(this.getContainer(),"MSAnimationEnd",BX.proxy(this._onAnimationEnd,this))},adjustLoaderOffset:function(){this.windowHeight=BX.height(window);this.tbodyPos=BX.pos(this.table.tBodies[0]);this.headerPos=BX.pos(this.table.tHead);var t=window.scrollY;if(this.parent.isIE()){t=document.documentElement.scrollTop}var i=t+this.windowHeight-this.tbodyPos.top;var s=t-this.tbodyPos.top;if(i>this.tbodyPos.bottom-this.tbodyPos.top){i=this.tbodyPos.bottom-this.tbodyPos.top}if(s<this.headerPos.height){s=this.headerPos.height}else{i-=s;i+=this.headerPos.height}BX.Grid.Utils.requestAnimationFrame(BX.proxy(function(){if(s!==this.lastPosTop){this.getContainer().style.transform="translate3d(0px, "+s+"px, 0)"}if(i!==this.lastBottomPos){this.getContainer().style.height=i+"px"}this.lastPosTop=s;this.lastBottomPos=i},this))},getContainer:function(){if(!this.container){this.container=BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classLoader"),true)}return this.container},show:function(){var t=this.getContainer();this.adjustLoaderOffset();BX.style(t,"display","block");BX.removeClass(t,this.parent.settings.get("classLoaderHide"));setTimeout(BX.delegate(function(){BX.addClass(t,this.parent.settings.get("classLoaderShow"))},this),0)},hide:function(){var t=this.getContainer();this.adjustLoaderOffset();BX.removeClass(t,this.parent.settings.get("classLoaderShow"));BX.addClass(t,this.parent.settings.get("classLoaderHide"))},_onAnimationEnd:function(t){if("animationName"in t&&t.animationName&&t.animationName===this.parent.settings.get("loaderHideAnimationName")){var i=this.getContainer();BX.removeClass(i,this.parent.settings.get("classLoaderShow"));BX.removeClass(i,this.parent.settings.get("classLoaderHide"));BX.style(i,"display","")}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/manager.min.js?1492513428903";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/manager.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/manager.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/manager.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");if(BX.Main.gridManager){return}BX.Main.gridManager={data:[],push:function(t,n){if(BX.type.isNotEmptyString(t)&&n){var i={id:t,instance:n,old:null};if(this.getById(t)===null){this.data.push(i)}else{this.data[0]=i}}},getById:function(t){var n=this.data.filter(function(n){return n.id===t||n.id.replace("main_grid_","")===t});return n.length===1?n[0]:null},getInstanceById:function(t){var n=this.getById(t);return BX.type.isPlainObject(n)?n["instance"]:null},reload:function(t,n){var i=this.getInstanceById(t);if(i){i.reload(n)}},getDataIndex:function(t){var n=null;this.data.forEach(function(i,a){if(i.id===t){n=a}});return n},destroy:function(t){if(BX.type.isNotEmptyString(t)){var n=this.getInstanceById(t);if(n instanceof BX.Main.grid){n.destroy();var i=this.getDataIndex(t);if(i!==null){delete this.data[i]}}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:88:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/utils.min.js?15096143322120";s:6:"source";s:69:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/utils.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/utils.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Utils={ajaxUrl:function(e,n){return this.addUrlParams(e,{bxajaxid:n})},addUrlParams:function(e,n){return BX.util.add_url_param(e,n)},arrayMove:function(e,n,t){if(t>=e.length){var i=t-e.length;while(i--+1){e.push(undefined)}}e.splice(t,0,e.splice(n,1)[0]);return e},getIndex:function(e,n){return[].indexOf.call(e||[],n)},getNext:function(e){if(e){return e.nextElementSibling||null}},getPrev:function(e){if(e){return e.previousElementSibling||null}},closestParent:function(e,n){if(e){if(!n){return e.parentNode||null}else{return BX.findParent(e,{className:n})}}},closestChilds:function(e){if(e){return e.children||null}},collectionSort:function(e,n){var t,i,l,r,a;if(e&&n&&e!==n&&e.parentNode===n.parentNode){t=this.closestParent(n);i=this.closestChilds(t);l=i.length;r=this.getIndex(i,e);a=this.getIndex(i,n);if(l===a){t.appendChild(n)}if(r>a){t.insertBefore(e,n)}if(r<a&&l!==a){t.insertBefore(e,this.getNext(n))}}},getColumn:function(e,n){var t=this.getIndex(this.closestChilds(this.closestParent(n)),n);var i=[];[].forEach.call(e.rows,function(e){i.push(e.cells[t])});return i},styleForEach:function(e,n){n=BX.type.isPlainObject(n)?n:null;var t=Object.keys(n);[].forEach.call(e||[],function(e){t.forEach(function(t){BX.style(e,t,n[t])})})},requestAnimationFrame:function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};e.apply(window,arguments)},getByClass:function(e,n,t){var i=[];if(n){i=e?e.getElementsByClassName(n):[];if(t){i=i.length?i[0]:null}else{i=[].slice.call(i)}}return i},getByTag:function(e,n,t){var i=[];if(n){i=e?e.getElementsByTagName(n):[];if(t){i=i.length?i[0]:null}else{i=[].slice.call(i)}}return i},getBySelector:function(e,n,t){var i=[];if(n){if(t){i=e?e.querySelector(n):null}else{i=e?e.querySelectorAll(n):[];i=[].slice.call(i)}}return i},listenerParams:function(e){try{window.addEventListener("test",null,e)}catch(n){e=false}return e}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:90:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/message.min.js?14980344531571";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/message.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/message.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/message.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Message=function(t,e){this.parent=null;this.types=null;this.messages=null;this.popup=null;this.init(t,e)};BX.Grid.Message.prototype={init:function(t,e){this.parent=t;this.types=e;this.show();BX.addCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onUpdated,this))},onUpdated:function(){this.show()},getData:function(){return this.parent.arParams.MESSAGES},isNeedShow:function(){return this.getData().length>0},show:function(){if(this.isNeedShow()){this.getPopup().setContent(this.getContent());this.getPopup().show()}},getContent:function(){var t=this.getData();var e=null;if(BX.type.isArray(t)&&t.length){var n={block:"main-grid-messages",content:[]};t.forEach(function(t){var e={block:"main-grid-message",mix:"main-grid-message-"+t.TYPE.toLowerCase(),content:[]};if(BX.type.isNotEmptyString(t.TITLE)){e.content.push({block:"main-grid-message-title",content:t.TITLE})}if(BX.type.isNotEmptyString(t.TEXT)){e.content.push({block:"main-grid-message-text",content:t.TEXT})}n.content.push(e)});e=BX.decl(n)}return e},getPopup:function(){if(this.popup===null){this.popup=new BX.PopupWindow(this.getPopupId(),null,{autoHide:true,overlay:.3,width:400,contentNoPaddings:true,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:this.parent.getParam("CLOSE"),className:"webform-small-button-blue webform-small-button",events:{click:function(){this.popupWindow.close()}}})]})}return this.popup},getPopupId:function(){return this.parent.getContainerId()+"-main-grid-message"}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:90:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/observer.min.js?1492513428175";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/observer.js";s:3:"min";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/observer.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/observer.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.observer={handlers:[],add:function(n,r,d,e){BX.bind(n,r,e?BX.proxy(d,e):d)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:90:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagesize.min.js?1495021367593";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagesize.js";s:3:"min";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagesize.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagesize.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Pagesize=function(t){this.parent=null;this.init(t)};BX.Grid.Pagesize.prototype={init:function(t){this.parent=t;BX.addCustomEvent("Dropdown::change",BX.delegate(this.onChange,this))},onChange:function(t,e,n,i,a){var s=this;if(t===this.parent.getContainerId()+"_"+this.parent.settings.get("pageSizeId")){if(a>=0){this.parent.tableFade();this.parent.getUserOptions().setPageSize(a,function(){s.parent.reloadTable();BX.onCustomEvent(s.parent.getContainer(),"Grid::pageSizeChanged",[s.parent])})}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagination.min.js?1491454246842";s:6:"source";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagination.js";s:3:"min";s:78:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagination.min.js";s:3:"map";s:78:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagination.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Pagination=function(t){this.parent=null;this.container=null;this.links=null;this.init(t)};BX.Grid.Pagination.prototype={init:function(t){this.parent=t},getParent:function(){return this.parent},getContainer:function(){if(!this.container){this.container=BX.Grid.Utils.getByClass(this.getParent().getContainer(),this.getParent().settings.get("classPagination"),true)}return this.container},getLinks:function(){var t=this;var n=BX.Grid.Utils.getByTag(this.getContainer(),"a");this.links=[];if(n){this.links=n.map(function(n){return new BX.Grid.Element(n,t.getParent())})}return this.links},getLink:function(t){var n=null;var i;if(BX.type.isDomNode(t)){i=this.getLinks().filter(function(n){return t===n.getNode()});if(i.length){n=i[0]}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-header.min.js?15096143323104";s:6:"source";s:74:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-header.js";s:3:"min";s:78:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-header.min.js";s:3:"map";s:78:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-header.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.PinHeader=function(t){this.parent=null;this.table=null;this.header=null;this.container=null;this.parentNodeResizeObserver=null;this.init(t)};BX.Grid.PinHeader.prototype={init:function(t){this.parent=t;this.rect=BX.pos(this.parent.getHead());this.gridRect=BX.pos(this.parent.getTable());var e=BX.Grid.Utils.getBySelector(document,"#workarea-content",true);if(!e){e=this.parent.getContainer().parentNode;e=!!e?e.parentNode:e}if(!!e){this.parentNodeResizeObserver=new BX.ResizeObserver(BX.proxy(this.refreshRect,this));this.parentNodeResizeObserver.observe(e)}this.create();document.addEventListener("scroll",BX.proxy(this._onScroll,this),BX.Grid.Utils.listenerParams({passive:true}));document.addEventListener("resize",BX.proxy(this._onResize,this),BX.Grid.Utils.listenerParams({passive:true}));BX.addCustomEvent("Grid::updated",BX.proxy(this._onGridUpdate,this));BX.addCustomEvent("Grid::resize",BX.proxy(this._onGridUpdate,this));BX.bind(window,"resize",BX.proxy(this._onGridUpdate,this))},refreshRect:function(){this.gridRect=BX.pos(this.parent.getTable());this.rect=BX.pos(this.parent.getHead())},_onGridUpdate:function(){var t=this.isPinned();BX.remove(this.getContainer());this.create();t&&this.pin();this.table=null;this.refreshRect();BX.onCustomEvent(window,"Grid::headerUpdated",[])},create:function(){var t=BX.Grid.Utils.getByTag(this.parent.getHead(),"th");var e=t.length-1;var i=BX.clone(this.parent.getHead());var n=BX.Grid.Utils.getByTag(i,"th");t.forEach(function(t,i){var s=BX.width(t);n[i].firstElementChild&&(n[i].firstElementChild.style.width=s+"px");if(e!==i){n[i].style.width=s+"px"}else{if(this.parent.getRows().getCountDisplayed()>0){n[i].style.width="100%"}}},this);this.container=BX.decl({block:"main-grid-fixed-bar",mix:"main-grid-fixed-top",attrs:{style:"width: "+BX.width(this.parent.getContainer())+"px"},content:{block:"main-grid-table",tag:"table",content:i}});this.container.hidden=true;this.parent.getWrapper().appendChild(this.container)},getContainer:function(){return this.container},getFixedTable:function(){return this.table||(this.table=BX.Grid.Utils.getByTag(this.getContainer(),"table",true))},pin:function(){!!this.getContainer()&&(this.getContainer().hidden=false);BX.onCustomEvent(window,"Grid::headerPinned",[])},unpin:function(){!!this.getContainer()&&(this.getContainer().hidden=true);BX.onCustomEvent(window,"Grid::headerUnpinned",[])},stopPin:function(){BX.Grid.Utils.styleForEach([this.getContainer()],{position:"absolute",top:this.gridRect.bottom-this.rect.height-this.gridRect.top+"px","box-shadow":"none"})},startPin:function(){BX.Grid.Utils.styleForEach([this.getContainer()],{position:"fixed",top:0,"box-shadow":""})},isPinned:function(){return!this.getContainer().hidden},_onScroll:function(){if(this.gridRect.bottom>window.scrollY+this.rect.height){this.startPin();if(this.rect.top<=window.scrollY){!this.isPinned()&&this.pin()}else{this.isPinned()&&this.unpin()}}else{this.stopPin()}},_onResize:function(){this.rect=BX.pos(this.parent.getHead())}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/row.min.js?151124257214764";s:6:"source";s:67:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/row.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.Row=function(t,e){this.node=null;this.checkbox=null;this.sort=null;this.actions=null;this.settings=null;this.index=null;this.actionsButton=null;this.parent=null;this.depth=null;this.parentId=null;this.editData=null;this.custom=null;this.init(t,e)};BX.Grid.Row.prototype={init:function(t,e){if(BX.type.isDomNode(e)){this.node=e;this.parent=t;this.settings=new BX.Grid.Settings;if(this.parent.getParam("ALLOW_CONTEXT_MENU")){BX.bind(this.getNode(),"contextmenu",BX.delegate(this._onRightClick,this))}}},isCustom:function(){if(this.custom===null){this.custom=BX.hasClass(this.getNode(),this.parent.settings.get("classRowCustom"))}return this.custom},_onRightClick:function(t){t.preventDefault();this.showActionsMenu(t)},getDefaultAction:function(){return BX.data(this.getNode(),"default-action")},editGetValues:function(){var t=this;var e=this.getCells();var i={};var s;[].forEach.call(e,function(e){s=t.getCellEditorValue(e);if(BX.type.isArray(s)){s.forEach(function(t){i[t.NAME]=t.VALUE!==undefined?t.VALUE:""})}else if(s){i[s.NAME]=s.VALUE!==undefined?s.VALUE:""}});return i},getCellEditorValue:function(t){var e=BX.Grid.Utils.getByClass(t,this.parent.settings.get("classEditor"),true);var i=null;if(BX.type.isDomNode(e)){if(BX.hasClass(e,"main-grid-editor-checkbox")){i={NAME:e.getAttribute("name"),VALUE:e.checked?"Y":"N"}}else if(BX.hasClass(e,"main-grid-editor-custom")){i=[];e.querySelectorAll("input, select, checkbox, textarea").forEach(function(t){switch(t.tagName){case"SELECT":if(t.multiple){var s=[];t.querySelectorAll("option").forEach(function(t){if(t.selected){s.push(t.value)}});i.push({NAME:e.getAttribute("data-name"),VALUE:s})}else{i.push({NAME:e.getAttribute("data-name"),VALUE:t.value})}break;case"INPUT":switch(t.type.toUpperCase()){case"CHECKBOX":i.push({NAME:e.getAttribute("data-name"),VALUE:t.checked?t.value:""});break;case"HIDDEN":break;default:i.push({NAME:e.getAttribute("data-name"),VALUE:t.value})}break;default:i.push({NAME:e.getAttribute("data-name"),VALUE:t.value})}})}else{if(e.value){i={NAME:e.getAttribute("name"),VALUE:e.value}}else{i={NAME:e.getAttribute("name"),VALUE:BX.data(e,"value")}}}}return i},isEdit:function(){return BX.hasClass(this.getNode(),"main-grid-row-edit")},hide:function(){BX.addClass(this.getNode(),this.parent.settings.get("classHide"))},show:function(){BX.removeClass(this.getNode(),this.parent.settings.get("classHide"))},isShown:function(){return!BX.hasClass(this.getNode(),this.parent.settings.get("classHide"))},isNotCount:function(){return BX.hasClass(this.getNode(),this.parent.settings.get("classNotCount"))},getContentContainer:function(t){var e=null;if(!BX.hasClass(t,this.parent.settings.get("classCellContainer"))){if(t.nodeName==="TD"||t.nodeName==="TR"){e=BX.Grid.Utils.getByClass(t,this.parent.settings.get("classCellContainer"),true)}else{e=BX.findParent(t,{className:this.parent.settings.get("classCellContainer")},true,false)}}else{e=t}return e},getContent:function(t){var e=this.getContentContainer(t);var i;if(BX.type.isDomNode(e)){i=BX.html(e)}return i},getEditorContainer:function(t){return BX.Grid.Utils.getByClass(t,this.parent.settings.get("classEditorContainer"),true)},getCollapseButton:function(){if(!this.collapseButton){this.collapseButton=BX.Grid.Utils.getByClass(this.getNode(),this.parent.settings.get("classCollapseButton"),true)}return this.collapseButton},stateLoad:function(){BX.addClass(this.getNode(),this.parent.settings.get("classRowStateLoad"))},stateUnload:function(){BX.removeClass(this.getNode(),this.parent.settings.get("classRowStateLoad"))},stateExpand:function(){BX.addClass(this.getNode(),this.parent.settings.get("classRowStateExpand"))},stateCollapse:function(){BX.removeClass(this.getNode(),this.parent.settings.get("classRowStateExpand"))},getParentId:function(){if(this.parentId===null){this.parentId=BX.data(this.getNode(),"parent-id");if(typeof this.parentId!=="undefined"&&this.parentId!==null){this.parentId=this.parentId.toString()}}return this.parentId},getDataset:function(){return this.getNode().dataset},getDepth:function(){if(this.depth===null){this.depth=BX.data(this.getNode(),"depth")}return this.depth},setDepth:function(t){t=parseInt(t);if(BX.type.isNumber(t)){var e=t-parseInt(this.getDepth());var i=this.parent.getRows();this.getDataset().depth=t;this.getShiftCells().forEach(function(e){BX.data(e,"depth",t);BX.style(e,"padding-left",t*20+"px")},this);i.getRowsByParentId(this.getId(),true).forEach(function(t){var i=parseInt(e)+parseInt(t.getDepth());t.getDataset().depth=i;t.getShiftCells().forEach(function(t){BX.data(t,"depth",i);BX.style(t,"padding-left",i*20+"px")})})}},setParentId:function(t){t=t.toString();var e=this.getDataset();e["parentId"]=t},getShiftCells:function(){return BX.Grid.Utils.getBySelector(this.getNode(),'td[data-shift="true"]')},showChildRows:function(){var t=this.getChildren();var e=this.isCustom();t.forEach(function(t){t.show();if(!e&&t.isExpand()){t.showChildRows()}});this.parent.updateCounterDisplayed();this.parent.updateCounterSelected();this.parent.adjustCheckAllCheckboxes();this.parent.adjustRows()},getChildren:function(){var t=this.isCustom()?"getRowsByGroupId":"getRowsByParentId";var e=this.isCustom()?this.getGroupId():this.getId();return this.parent.getRows()[t](e,true)},hideChildRows:function(){var t=this.getChildren();t.forEach(function(t){t.hide()});this.parent.updateCounterDisplayed();this.parent.updateCounterSelected();this.parent.adjustCheckAllCheckboxes();this.parent.adjustRows()},isChildsLoaded:function(){if(!BX.type.isBoolean(this.childsLoaded)){this.childsLoaded=this.isCustom()||BX.data(this.getNode(),"child-loaded")==="true"}return this.childsLoaded},expand:function(){var t=this;this.stateExpand();if(this.isChildsLoaded()){this.showChildRows()}else{this.stateLoad();this.loadChildRows(function(e){e.reverse().forEach(function(e){BX.insertAfter(e,t.getNode())});t.parent.getRows().reset();t.parent.bindOnRowEvents();if(t.parent.getParam("ALLOW_ROWS_SORT")){t.parent.getRowsSortable().reinit()}if(t.parent.getParam("ALLOW_COLUMNS_SORT")){t.parent.getColsSortable().reinit()}t.stateUnload();BX.data(t.getNode(),"child-loaded","true");t.parent.updateCounterDisplayed();t.parent.updateCounterSelected();t.parent.adjustCheckAllCheckboxes()})}},collapse:function(){this.stateCollapse();this.hideChildRows()},isExpand:function(){return BX.hasClass(this.getNode(),this.parent.settings.get("classRowStateExpand"))},toggleChildRows:function(){if(!this.isExpand()){this.expand()}else{this.collapse()}},loadChildRows:function(t){if(BX.type.isFunction(t)){var e=this;var i=parseInt(this.getDepth());var s=this.parent.getUserOptions().getAction("GRID_GET_CHILD_ROWS");i=BX.type.isNumber(i)?i+1:1;this.parent.getData().request("","POST",{action:s,parent_id:this.getId(),depth:i},null,function(){var i=this.getRowsByParentId(e.getId());t.apply(null,[i])})}},update:function(t,e,i){t=!!t?t:"";var s=this.parent.getUserOptions().getAction("GRID_UPDATE_ROW");var n=this.getDepth();var a=this.getId();var o=this.getParentId();var r={id:a,parentId:o,action:s,depth:n,data:t};var d=this;this.stateLoad();this.parent.getData().request(e,"POST",r,null,function(){var e=this.getBodyRows();d.parent.getUpdater().updateBodyRows(e);d.stateUnload();d.parent.getRows().reset();d.parent.getUpdater().updateFootRows(this.getFootRows());d.parent.getUpdater().updatePagination(this.getPagination());d.parent.getUpdater().updateMoreButton(this.getMoreButton());d.parent.getUpdater().updateCounterTotal(this.getCounterTotal());d.parent.bindOnRowEvents();d.parent.adjustEmptyTable(e);d.parent.bindOnMoreButtonEvents();d.parent.bindOnClickPaginationLinks();d.parent.updateCounterDisplayed();d.parent.updateCounterSelected();if(d.parent.getParam("ALLOW_COLUMNS_SORT")){d.parent.colsSortable.reinit()}if(d.parent.getParam("ALLOW_ROWS_SORT")){d.parent.rowsSortable.reinit()}BX.onCustomEvent(window,"Grid::rowUpdated",[{id:a,data:t,grid:d.parent,response:this}]);BX.onCustomEvent(window,"Grid::updated",[]);if(BX.type.isFunction(i)){i({id:a,data:t,grid:d.parent,response:this})}})},remove:function(t,e,i){t=!!t?t:"";var s=this.parent.getUserOptions().getAction("GRID_DELETE_ROW");var n=this.getDepth();var a=this.getId();var o=this.getParentId();var r={id:a,parentId:o,action:s,depth:n,data:t};var d=this;this.stateLoad();this.parent.getData().request(e,"POST",r,null,function(){var e=this.getBodyRows();d.parent.getUpdater().updateBodyRows(e);d.stateUnload();d.parent.getRows().reset();d.parent.getUpdater().updateFootRows(this.getFootRows());d.parent.getUpdater().updatePagination(this.getPagination());d.parent.getUpdater().updateMoreButton(this.getMoreButton());d.parent.getUpdater().updateCounterTotal(this.getCounterTotal());d.parent.bindOnRowEvents();d.parent.adjustEmptyTable(e);d.parent.bindOnMoreButtonEvents();d.parent.bindOnClickPaginationLinks();d.parent.updateCounterDisplayed();d.parent.updateCounterSelected();if(d.parent.getParam("ALLOW_COLUMNS_SORT")){d.parent.colsSortable.reinit()}if(d.parent.getParam("ALLOW_ROWS_SORT")){d.parent.rowsSortable.reinit()}BX.onCustomEvent(window,"Grid::rowRemoved",[{id:a,data:t,grid:d.parent,response:this}]);BX.onCustomEvent(window,"Grid::updated",[]);if(BX.type.isFunction(i)){i({id:a,data:t,grid:d.parent,response:this})}})},editCancel:function(){var t=this.getCells();var e=this;var i;[].forEach.call(t,function(t){i=e.getEditorContainer(t);if(BX.type.isDomNode(i)){BX.remove(e.getEditorContainer(t));BX.show(e.getContentContainer(t))}});BX.removeClass(this.getNode(),"main-grid-row-edit")},getCellByIndex:function(t){return this.getCells()[t]},getEditDataByCellIndex:function(index){return eval(BX.data(this.getCellByIndex(index),"edit"))},getCellNameByCellIndex:function(t){return BX.data(this.getCellByIndex(t),"name")},getEditData:function(){if(this.editData===null){var t=this.parent.getParam("EDITABLE_DATA");var e=this.getId();if(BX.type.isPlainObject(t)&&e in t){this.editData=t[e]}else{this.editData={}}}return this.editData},getCellEditDataByCellIndex:function(t){var e=this.getEditData();var i=null;t=parseInt(t);if(BX.type.isNumber(t)&&BX.type.isPlainObject(e)){var s=this.parent.getRows().getHeadFirstChild().getEditDataByCellIndex(t);if(BX.type.isPlainObject(s)){i=s;i.VALUE=e[s.NAME]}}return i},edit:function(){var t=this.getCells();var e=this;var i,s,n,a;[].forEach.call(t,function(t,o){try{i=e.getCellEditDataByCellIndex(o)}catch(t){throw new Error(t)}if(e.parent.getEditor().validateEditObject(i)){a=e.getContentContainer(t);n=BX.height(a);s=e.parent.getEditor().getEditor(i,n);if(!e.getEditorContainer(t)&&BX.type.isDomNode(s)){t.appendChild(s);BX.hide(a)}}});BX.addClass(this.getNode(),"main-grid-row-edit")},setDraggable:function(t){if(!t){BX.addClass(this.getNode(),this.parent.settings.get("classDisableDrag"));this.parent.getRowsSortable().unregister(this.getNode())}else{BX.removeClass(this.getNode(),this.parent.settings.get("classDisableDrag"));this.parent.getRowsSortable().register(this.getNode())}},isDraggable:function(){return!BX.hasClass(this.getNode(),this.parent.settings.get("classDisableDrag"))},getNode:function(){return this.node},getIndex:function(){return this.getNode().rowIndex},getId:function(){return BX.data(this.getNode(),"id").toString()},getGroupId:function(){return BX.data(this.getNode(),"group-id").toString()},getObserver:function(){return BX.Grid.observer},getCheckbox:function(){if(!this.checkbox){this.checkbox=BX.Grid.Utils.getByClass(this.getNode(),this.settings.get("classRowCheckbox"),true)}return this.checkbox},getActionsMenu:function(){if(!this.actionsMenu){var t=this.getActionsButton().getBoundingClientRect();this.actionsMenu=BX.PopupMenu.create("main-grid-actions-menu-"+this.getId(),this.getActionsButton(),this.getMenuItems(),{autoHide:true,offsetTop:-(t.height/2+26),offsetLeft:30,angle:{position:"left",offset:t.height/2-8},events:{onPopupClose:BX.delegate(this._onCloseMenu,this),onPopupShow:BX.delegate(this._onPopupShow,this)}});BX.addCustomEvent("Grid::updated",function(){if(this.actionsMenu){this.actionsMenu.destroy();this.actionsMenu=null}}.bind(this));BX.bind(this.actionsMenu.popupWindow.popupContainer,"click",BX.delegate(function(){var t=this.getActionsMenu();if(t){t.close()}},this))}return this.actionsMenu},_onCloseMenu:function(){},_onPopupShow:function(t){t.setBindElement(this.getActionsButton())},actionsMenuIsShown:function(){return this.getActionsMenu().popupWindow.isShown()},showActionsMenu:function(t){this.getActionsMenu().popupWindow.show();if(t){BX.fireEvent(document.body,"click");this.getActionsMenu().popupWindow.popupContainer.style.top=t.pageY-25+BX.PopupWindow.getOption("offsetTop")+"px";this.getActionsMenu().popupWindow.popupContainer.style.left=t.pageX+20+BX.PopupWindow.getOption("offsetLeft")+"px"}else{var e=BX.pos(this.getActionsButton());e.forceBindPosition=true;this.getActionsMenu().popupWindow.adjustPosition(e)}},closeActionsMenu:function(){if(this.actionsMenu){if(this.actionsMenu.popupWindow){this.actionsMenu.popupWindow.close()}}},getMenuItems:function(){return this.getActions()||[]},getActions:function(){try{this.actions=this.actions||eval(BX.data(this.getActionsButton(),this.settings.get("dataActionsKey")))}catch(t){this.actions=null}return this.actions},getActionsButton:function(){if(!this.actionsButton){this.actionsButton=BX.Grid.Utils.getByClass(this.getNode(),this.settings.get("classRowActionButton"),true)}return this.actionsButton},initSelect:function(){if(this.isSelected()&&!BX.hasClass(this.getNode(),this.settings.get("classCheckedRow"))){BX.addClass(this.getNode(),this.settings.get("classCheckedRow"))}},getParentNode:function(){var t;try{t=this.getNode().parentNode}catch(e){t=null}return t},getParentNodeName:function(){var t;try{t=this.getParentNode().nodeName}catch(e){t=null}return t},select:function(){var t;if(!this.isEdit()){t=this.getCheckbox();if(t){if(!BX.data(t,"disabled")){BX.addClass(this.getNode(),this.settings.get("classCheckedRow"));t.checked=true}}}},unselect:function(){if(!this.isEdit()){BX.removeClass(this.getNode(),this.settings.get("classCheckedRow"));if(this.getCheckbox()){this.getCheckbox().checked=false}}},getCells:function(){return this.getNode().cells},isSelected:function(){return this.getCheckbox()&&this.getCheckbox().checked||BX.hasClass(this.getNode(),this.settings.get("classCheckedRow"))},isHeadChild:function(){return this.getParentNodeName()==="THEAD"&&BX.hasClass(this.getNode(),this.settings.get("classHeadRow"))},isBodyChild:function(){return BX.hasClass(this.getNode(),this.settings.get("classBodyRow"))&&!BX.hasClass(this.getNode(),this.settings.get("classEmptyRows"))},isFootChild:function(){return this.getParentNodeName()==="TFOOT"&&BX.hasClass(this.getNode(),this.settings.get("classFootRow"))}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows-sortable.min.js?149803445310600";s:6:"source";s:77:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows-sortable.js";s:3:"min";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows-sortable.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows-sortable.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.RowDragEvent=function(t){this.allowMoveRow=true;this.allowInsertBeforeTarget=true;this.dragItem=null;this.targetItem=null;this.eventName=!!t?t:"";this.errorMessage=""};BX.Grid.RowDragEvent.prototype={allowMove:function(){this.allowMoveRow=true;this.errorMessage=""},allowInsertBefore:function(){this.allowInsertBeforeTarget=true},disallowMove:function(t){this.allowMoveRow=false;this.errorMessage=t||""},disallowInsertBefore:function(){this.allowInsertBeforeTarget=false},getDragItem:function(){return this.dragItem},getTargetItem:function(){return this.targetItem},getEventName:function(){return this.eventName},setDragItem:function(t){return this.dragItem=t},setTargetItem:function(t){return this.targetItem=t},setEventName:function(t){return this.eventName=t},isAllowedMove:function(){return this.allowMoveRow},isAllowedInsertBefore:function(){return this.allowInsertBeforeTarget},getErrorMessage:function(){return this.errorMessage}};BX.Grid.RowsSortable=function(t){this.parent=null;this.list=null;this.setDefaultProps();this.init(t)};BX.Grid.RowsSortable.prototype={init:function(t){this.parent=t;this.list=this.getList();this.prepareListItems();jsDD.Enable();if(!this.inited){this.inited=true;this.onscrollDebounceHandler=BX.debounce(this._onWindowScroll,300,this);BX.addCustomEvent("Grid::thereEditedRows",BX.proxy(this.disable,this));BX.addCustomEvent("Grid::noEditedRows",BX.proxy(this.enable,this));document.addEventListener("scroll",this.onscrollDebounceHandler,BX.Grid.Utils.listenerParams({passive:true}))}},destroy:function(){BX.removeCustomEvent("Grid::thereEditedRows",BX.proxy(this.disable,this));BX.removeCustomEvent("Grid::noEditedRows",BX.proxy(this.enable,this));document.removeEventListener("scroll",this.onscrollDebounceHandler,BX.Grid.Utils.listenerParams({passive:true}));this.unregisterObjects()},_onWindowScroll:function(){this.windowScrollTop=BX.scrollTop(window);this.rowsRectList=null},disable:function(){this.unregisterObjects()},enable:function(){this.reinit()},reinit:function(){this.unregisterObjects();this.setDefaultProps();this.init(this.parent)},getList:function(){return this.parent.getRows().getSourceBodyChild()},unregisterObjects:function(){this.list.forEach(this.unregister,this)},prepareListItems:function(){this.list.forEach(this.register,this)},register:function(t){var e=this.parent.getRows();if(e.get(t).isDraggable()){t.onbxdragstart=BX.delegate(this._onDragStart,this);t.onbxdrag=BX.delegate(this._onDrag,this);t.onbxdragstop=BX.delegate(this._onDragEnd,this);jsDD.registerObject(t)}},unregister:function(t){jsDD.unregisterObject(t)},getIndex:function(t){return BX.Grid.Utils.getIndex(this.list,t)},calcOffset:function(){var t=this.dragRect.height;if(this.additionalDragItems.length){this.additionalDragItems.forEach(function(e){t+=e.clientHeight})}return t},getTheadCells:function(t){return[].map.call(t,function(e,r){return{block:"",tag:"th",attrs:{style:"width: "+BX.width(t[r])+"px;"}}})},createFake:function(){var t=[];this.cloneDragItem=BX.clone(this.dragItem);this.cloneDragAdditionalDragItems=[];this.cloneDragAdditionalDragItemRows=[];var e=this.getTheadCells(this.dragItem.cells);t.push(this.cloneDragItem);this.additionalDragItems.forEach(function(e){var r=BX.clone(e);t.push(r);this.cloneDragAdditionalDragItems.push(r);this.cloneDragAdditionalDragItemRows.push(new BX.Grid.Row(this.parent,r))},this);var r=BX.width(this.parent.getTable());this.fake=BX.decl({block:"main-grid-fake-container",attrs:{style:"position: absolute; top: "+this.getDragStartRect().top+"px; width: "+r+"px"},content:{block:"main-grid-table",mix:"main-grid-table-fake",tag:"table",attrs:{style:"width: "+r+"px"},content:[{block:"main-grid-header",tag:"thead",content:{block:"main-grid-row-head",tag:"tr",content:e}},{block:"",tag:"tbody",content:t}]}});BX.insertAfter(this.fake,this.parent.getTable());this.cloneDragItem=new BX.Grid.Row(this.parent,this.cloneDragItem);return this.fake},getDragStartRect:function(){return BX.pos(this.dragItem,this.parent.getTable())},_onDragStart:function(){this.dragItem=jsDD.current_node;this.targetItem=this.dragItem;this.additionalDragItems=this.getAdditionalDragItems(this.dragItem);this.dragIndex=this.getIndex(this.dragItem);this.dragRect=this.getRowRect(this.dragItem,this.dragIndex);this.offset=this.calcOffset();this.dragStartOffset=jsDD.start_y-this.dragRect.top;this.dragEvent=new BX.Grid.RowDragEvent;this.dragEvent.setEventName("BX.Main.grid:rowDragStart");this.dragEvent.setDragItem(this.dragItem);this.dragEvent.setTargetItem(this.targetItem);this.dragEvent.allowInsertBefore();var t=this.parent.getRows().get(this.dragItem);this.startDragDepth=t.getDepth();this.startDragParentId=t.getParentId();this.createFake();BX.addClass(this.parent.getContainer(),this.parent.settings.get("classOnDrag"));BX.addClass(this.dragItem,this.parent.settings.get("classDragActive"));BX.onCustomEvent(window,"BX.Main.grid:rowDragStart",[this.dragEvent,this.parent])},getAdditionalDragItems:function(t){var e=this.parent.getRows();return e.getRowsByParentId(e.get(t).getId(),true).map(function(t){return t.getNode()})},moveRow:function(t,e,r){if(!!t){var i=BX.type.isNumber(r)?r:300;t.style.transition=i+"ms";t.style.transform="translate3d(0px, "+e+"px, 0px)"}},getDragOffset:function(){return jsDD.y-this.dragRect.top-this.dragStartOffset},getWindowScrollTop:function(){if(this.windowScrollTop===null){this.windowScrollTop=BX.scrollTop(window)}return this.windowScrollTop},getSortOffset:function(){return jsDD.y},getRowRect:function(t,e){if(!this.rowsRectList){this.rowsRectList={};this.list.forEach(function(t,e){this.rowsRectList[e]=t.getBoundingClientRect()},this)}return this.rowsRectList[e]},getRowCenter:function(t,e){var r=this.getRowRect(t,e);return r.top+this.getWindowScrollTop()+r.height/2},isDragToBottom:function(t,e){var r=this.getRowCenter(t,e);var i=this.getSortOffset();return e>this.dragIndex&&r<i},isMovedToBottom:function(t){return t.style.transform==="translate3d(0px, "+-this.offset+"px, 0px)"},isDragToTop:function(t,e){var r=this.getRowCenter(t,e);var i=this.getSortOffset();return e<this.dragIndex&&r>i},isMovedToTop:function(t){return t.style.transform==="translate3d(0px, "+this.offset+"px, 0px)"},isDragToBack:function(t,e){var r=this.getRowCenter(t,e);var i=this.dragIndex;var s=jsDD.y;return e>i&&s<r||e<i&&s>r},isMoved:function(t){return t.style.transform!=="translate3d(0px, 0px, 0px)"&&t.style.transform!==""},_onDrag:function(){var t=0;var e=0;this.moveRow(this.dragItem,this.getDragOffset(),t);this.moveRow(this.fake,this.getDragOffset(),t);BX.Grid.Utils.styleForEach(this.additionalDragItems,{transition:t+"ms",transform:"translate3d(0px, "+this.getDragOffset()+"px, 0px)"});this.list.forEach(function(t,r){if(!!t&&t!==this.dragItem&&this.additionalDragItems.indexOf(t)===-1){if(this.isDragToTop(t,r)&&!this.isMovedToTop(t)){this.targetItem=t;this.moveRow(t,this.offset);this.dragEvent.setEventName("BX.Main.grid:rowDragMove");this.dragEvent.setTargetItem(this.targetItem);BX.onCustomEvent(window,"BX.Main.grid:rowDragMove",[this.dragEvent,this.parent]);this.checkError(this.dragEvent);this.updateProperties(this.dragItem,this.targetItem);this.isDragetToTop=true}if(this.isDragToBottom(t,r)&&!this.isMovedToBottom(t)){this.targetItem=this.findNextVisible(this.list,r);this.moveRow(t,-this.offset);this.dragEvent.setEventName("BX.Main.grid:rowDragMove");this.dragEvent.setTargetItem(this.targetItem);BX.onCustomEvent(window,"BX.Main.grid:rowDragMove",[this.dragEvent,this.parent]);this.checkError(this.dragEvent);this.updateProperties(this.dragItem,this.targetItem);this.isDragetToTop=false}if(this.isDragToBack(t,r)&&this.isMoved(t)){this.moveRow(t,e);this.targetItem=t;if(this.isDragetToTop){this.targetItem=this.findNextVisible(this.list,r)}this.dragEvent.setEventName("BX.Main.grid:rowDragMove");this.dragEvent.setTargetItem(this.targetItem);BX.onCustomEvent(window,"BX.Main.grid:rowDragMove",[this.dragEvent,this.parent]);this.checkError(this.dragEvent);this.updateProperties(this.dragItem,this.targetItem)}}},this)},createError:function(t,e){var r=BX.decl({block:"main-grid-error",content:!!e?e:""});!!t&&t.appendChild(r);setTimeout(function(){BX.addClass(r,"main-grid-error-show")},0);return r},checkError:function(t){if(!t.isAllowedMove()&&!this.error){this.error=this.createError(this.fake,t.getErrorMessage())}if(t.isAllowedMove()&&this.error){BX.remove(this.error);this.error=null}},findNextVisible:function(t,e){var r=null;var i=this.parent.getRows();t.forEach(function(t,s){if(!r&&s>e){var n=i.get(t);if(n.isShown()){r=t}}});return r},updateProperties:function(t,e){var r=this.parent.getRows();var i=r.get(t);var s=0;var n=0;if(!!e){var a=r.get(e);s=a.getDepth();n=a.getParentId()}i.setDepth(s);i.setParentId(n);this.cloneDragItem.setDepth(s);this.cloneDragAdditionalDragItemRows.forEach(function(t,e){t.setDepth(BX.data(this.additionalDragItems[e],"depth"))},this)},resetDragProperties:function(){var t=this.parent.getRows().get(this.dragItem);t.setDepth(this.startDragDepth);t.setParentId(this.startDragParentId)},_onDragOver:function(){},_onDragLeave:function(){},_onDragEnd:function(){BX.onCustomEvent(window,"BX.Main.grid:rowDragEnd",[this.dragEvent,this.parent]);BX.removeClass(this.parent.getContainer(),this.parent.settings.get("classOnDrag"));BX.removeClass(this.dragItem,this.parent.settings.get("classDragActive"));BX.Grid.Utils.styleForEach(this.list,{transition:"",transform:""});if(this.dragEvent.isAllowedMove()){this.sortRows(this.dragItem,this.targetItem);this.sortAdditionalDragItems(this.dragItem,this.additionalDragItems);this.list=this.getList();this.parent.getRows().reset();var t=this.parent.getRows().get(this.dragItem);var e=this.parent.getRows().getBodyChild().map(function(t){return t.getId()});this.saveRowsSort(e);BX.onCustomEvent(window,"Grid::rowMoved",[e,t,this.parent])}else{this.resetDragProperties()}BX.remove(this.fake);this.setDefaultProps()},sortAdditionalDragItems:function(t,e){e.reduce(function(t,e){!!e&&BX.insertAfter(e,t);return e},t)},sortRows:function(t,e){if(!!e){e.parentNode.insertBefore(t,e)}else{t.parentNode.appendChild(t)}},saveRowsSort:function(t){var e={ids:t,action:this.parent.getUserOptions().getAction("GRID_SAVE_ROWS_SORT")};this.parent.getData().request(null,"POST",e)},setDefaultProps:function(){this.dragItem=null;this.targetItem=null;this.dragRect=null;this.dragIndex=null;this.offset=null;this.realX=null;this.realY=null;this.dragStartOffset=null;this.windowScrollTop=null;this.rowsRectList=null;this.error=false}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/forum.comments/templates/.default/script.min.js?1453385126678";s:6:"source";s:69:"/bitrix/components/bitrix/forum.comments/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/forum.comments/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/forum.comments/templates/.default/script.map.js";}"*/
(function(i){i.__fcOnUCFormClear=function(e){i.LHEPostForm.reinitDataBefore(e.editorId)};i.__fcOnUCFormAfterShow=function(e,t,r){var n={MID:e.id[1],ENTITY_XML_ID:e.id[0],ENTITY_TYPE:e.entitiesId[e.id[0]][0],ENTITY_ID:e.entitiesId[e.id[0]][1]},I;for(I in n){if(n.hasOwnProperty(I)&&typeof I=="string"&&(I.indexOf("MID")===0||I.indexOf("ENTITY")===0)){if(!e.form[I])e.form.appendChild(BX.create("INPUT",{attrs:{name:I,type:"hidden"}}));e.form[I].value=n[I]}}var o=r?r["UF"]:{};if(r&&r["FILES"]){o["FILES"]={USER_TYPE_ID:"file",FIELD_NAME:"FILE_NEW[]",VALUE:r["FILES"],CID:BX.message("FCCID")}}i.LHEPostForm.reinitData(e.editorId,t,o)}})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.list/templates/.default/script.min.js?151457184536636";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.list/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){window["UC"]=window["UC"]||{};if(window["FCList"])return;var safeEditing=true,safeEditingCurrentObj=null,quoteData=null,repo={commentExemplarId:{}};window.FCList=function(e,t){this.CID=e["CID"];this.ENTITY_XML_ID=e["ENTITY_XML_ID"];this.container=e["container"];this.nav=e["nav"];this.mid=e["mid"];this.order=e["order"];this.status="ready";this.msg=!!this.nav?this.nav.innerHTML:"";this.params=t||{};this.pullNewRecords={};this.rights=e["rights"];this.DATE_TIME_FORMAT=this.params["DATE_TIME_FORMAT"]||null;this.comments={};this.bindEvents=[[this.nav,"click",BX.proxy(function(e){BX.eventCancelBubble(e);BX.PreventDefault(e);this.get();return false},this)]];this.exemplarId=BX.util.getRandomString(20);this.windowEvents={OnUCUserIsWriting:BX.delegate(function(t,i,s){if(this.ENTITY_XML_ID==t){BX.ajax({url:this.url.activity,method:"POST",data:{AJAX_POST:"Y",ENTITY_XML_ID:this.ENTITY_XML_ID,COMMENT_EXEMPLAR_ID:s,MODE:"PUSH&PULL",sessid:BX.bitrix_sessid(),sign:e["sign"],PATH_TO_USER:this.params["PATH_TO_USER"],AVATAR_SIZE:this.params["AVATAR_SIZE"],NAME_TEMPLATE:this.params["NAME_TEMPLATE"],SHOW_LOGIN:this.params["SHOW_LOGIN"]}})}},this),OnUCAfterRecordAdd:BX.delegate(function(e,t){if(this.ENTITY_XML_ID==e){this.add(t["messageId"],t,true,"simple")}},this),OnUCFormSubmit:BX.delegate(function(e,t,i,s){if(this.ENTITY_XML_ID==e){s["EXEMPLAR_ID"]=this.exemplarId;this.pullNewRecords[e+"-0"]="busy"}},this),OnUCFormResponse:BX.delegate(function(e,t){if(this.ENTITY_XML_ID==e){this.pullNewRecords[e+"-0"]="ready";this.pullNewRecords[e+"-"+t]="done"}},this),OnUCUserQuote:BX.delegate(function(e){if(this.ENTITY_XML_ID==e&&this.quote&&this.quote.popup){this.quote.popup.hide()}},this),"onPullEvent-unicomments":BX.delegate(function(e,t){if(this.ENTITY_XML_ID==t["ENTITY_XML_ID"]&&(t["USER_ID"]+""!=BX.message("USER_ID")+""||t["EXEMPLAR_ID"]&&t["EXEMPLAR_ID"]!=this.exemplarId||typeof t["AUX"]!="undefined"&&BX.util.in_array(t["AUX"],["createtask","fileversion"]))){if(e==="comment"&&t["ID"]){if(t["COMMENT_EXEMPLAR_ID"])repo.commentExemplarId[t["ENTITY_XML_ID"]+"_"+t["COMMENT_EXEMPLAR_ID"]]=true;this.pullNewRecord(t)}else if(e==="answer"&&t["USER_ID"]+""!==BX.message("USER_ID")+""&&(!t["COMMENT_EXEMPLAR_ID"]||repo.commentExemplarId[t["ENTITY_XML_ID"]+"_"+t["COMMENT_EXEMPLAR_ID"]]!==true)){this.pullNewAuthor(t["USER_ID"],t["NAME"],t["AVATAR"])}}},this)};if(this.params&&this.params["NOTIFY_TAG"]&&!!this.params["NOTIFY_TEXT"]&&!!window["UC"]["Informer"]){this.windowEvents["OnUCCommentWasPulled"]=BX.delegate(function(e,t){if(this.ENTITY_XML_ID==e[0]){window["UC"]["Informer"].check(e,t,this.params["NOTIFY_TAG"],this.params["NOTIFY_TEXT"])}},this);window["UC"]["InformerTags"][this.params["NOTIFY_TAG"]]=window["UC"]["InformerTags"][this.params["NOTIFY_TAG"]]||[]}var i;for(i=0;i<this.bindEvents.length;i++){BX.bind(this.bindEvents[i][0],this.bindEvents[i][1],this.bindEvents[i][2])}for(i in this.windowEvents){if(this.windowEvents.hasOwnProperty(i)){BX.addCustomEvent(window,i,this.windowEvents[i])}}var s=/%23com(\d+)/gi.exec(location.href),n=parseInt(location.hash&&location.hash.indexOf("#com")>=0?location.hash.replace("#com",""):s?s[1]:0);if(n>0)this.checkHash(n);if(this.params["BIND_VIEWER"]=="Y"&&BX["viewElementBind"]){BX.viewElementBind(BX("record-"+this.ENTITY_XML_ID+"-new").parentNode,{},function(e){return BX.type.isElementNode(e)&&(e.getAttribute("data-bx-viewer")||e.getAttribute("data-bx-image"))})}this.init(e);if(this.mid>0&&BX("record-"+[this.ENTITY_XML_ID,this.mid].join("-")+"-cover")){var o=BX("record-"+[this.ENTITY_XML_ID,this.mid].join("-")+"-cover").parentNode.firstChild,a=new RegExp("record-("+this.ENTITY_XML_ID+")-([0-9]+)-cover","gi");while(BX(o)){if(o["hasAttribute"]&&o.hasAttribute("id")&&a.test(o.getAttribute("id"))){(o.getAttribute("id")+"").replace(a,function(e,t,i){traceForReading([t,i])})}o=o.nextSibling}}if(repo[this.ENTITY_XML_ID])repo[this.ENTITY_XML_ID].destroy();repo[this.ENTITY_XML_ID]=this;BX.ready(function(){setTimeout(BX.delegate(function(){BX.onCustomEvent(window,"OnUCHasBeenInitialized",[this.ENTITY_XML_ID,this])},this),100)});return this};window.FCList.prototype={url:{activity:"/bitrix/components/bitrix/main.post.list/activity.php"},destroy:function(){var e,t;while((t=this.bindEvents.pop())&&t){BX.unbindAll(t[0]);t[0]=null;t[2]=null}for(e in this.windowEvents){if(this.windowEvents.hasOwnProperty(e)){BX.removeCustomEvent(window,e,this.windowEvents[e]);this.windowEvents[e]=null}}this.windowEvents=null;delete repo[this.ENTITY_XML_ID];BX.onCustomEvent(window,"OnUCHasBeenDestroyed",[this.ENTITY_XML_ID,this])},init:function(){if(this.params["SHOW_POST_FORM"]=="Y"){this.quote.show=BX.delegate(function(e,t){setTimeout(BX.delegate(function(){this.quoteShow(e,t)},this),50)},this);var e=BX("record-"+this.ENTITY_XML_ID+"-new"),t=BX.findChildren(e.parentNode,{tagName:"DIV",className:"feed-com-block-cover"},false);t=!!t?t:[];t.push(e);if(!!this.container)t.push(this.container);for(var i=0;i<t.length;i++){BX.bind(t[i],"mouseup",this.quote.show)}var s=BX("record-"+this.ENTITY_XML_ID+"-switcher");if(s&&!s.bxDndIsBound){s.bxDndIsBound="Y";BX.bind(s,"dragenter",BX.delegate(this.reply,this))}BX.addCustomEvent(window,"onQuote"+this.ENTITY_XML_ID,this.quote.show)}},quote:{show:BX.DoNothing(),popup:null},quoteCheck:function(){var e="",t,i=null;if(window.getSelection){t=window.getSelection();e=t.toString()}else if(document.selection){t=document.selection;e=t.createRange().text}if(e!=""){var s=BX("record-"+this.ENTITY_XML_ID+"-new"),n=BX.findParent(t.focusNode,{tagName:"DIV",className:"feed-com-block-cover"},s.parentNode),o=BX.findParent(t.anchorNode,{tagName:"DIV",className:"feed-com-block-cover"},s.parentNode);if(n!=o||BX(n)&&!n.hasAttribute("id")){e=""}else if(BX(n)){var a=BX(n.getAttribute("id").replace(/\-cover$/,"-actions-reply"));if(a){i={id:parseInt(a.getAttribute("bx-mpl-author-id")),name:a.getAttribute("bx-mpl-author-name")}}}}if(e==""){if(!!this.quote.popup)this.quote.popup.hide();return false}return{text:e,author:i}},quoteShow:function(e,t){t=t||this.quoteCheck();if(!t||!t["text"]){quoteData=null;return}quoteData=t;if(this.quote.popup==null){this.quote.popup=new MPLQuote({id:this.ENTITY_XML_ID,closeByEsc:true,autoHide:true,autoHideTimeout:2500,events:{click:BX.delegate(function(e){BX.PreventDefault(e);BX.eventCancelBubble(e);safeEditingCurrentObj=safeEditing;BX.onCustomEvent(window,"OnUCUserQuote",[this.ENTITY_XML_ID,t["author"],t["text"],safeEditingCurrentObj]);this.quote.popup.hide();return false},this)},classEvents:{onQuoteHide:BX.proxy(function(){quoteData=null;this.quote.popup=null},this)}})}this.quote.popup.show(e)},display:function(e,t){var i=0,s=0,n=0,o=this.container;e=e=="hide"?"hide":"show";if(e=="hide"){i=parseInt(this.container.offsetHeight);n=i/2e3;n=n<.3?.3:n>.5?.5:n;o.style.overflow="hidden";new BX["easing"]({duration:n*1e3,start:{height:i,opacity:100},finish:{height:s,opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){o.style.maxHeight=e.height+"px";o.style.opacity=e.opacity/100},complete:BX.proxy(function(){o.style.cssText="";o.style.display="none";BX.onCustomEvent(this,"OnUCListWasHidden",[this,[],o])},this)}).animate()}else{i=parseInt(t||20);o.style.display="block";o.style.overflow="hidden";o.style.maxHeight=i;s=parseInt(this.container.offsetHeight);n=(s-i)/(2e3-i);n=n<.3?.3:n>.8?.8:n;new BX["easing"]({duration:n*1e3,start:{height:i,opacity:i>0?100:0},finish:{height:s,opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){o.style.maxHeight=e.height+"px";o.style.opacity=e.opacity/100},complete:BX.proxy(function(){o.style.cssText="";o.style.maxHeight="none";BX.onCustomEvent(this,"OnUCListWasShown",[this,[],o])},this)}).animate()}},get:function(){if(this.status=="done"){if(this.nav.getAttribute("bx-visibility-status")=="visible"){this.display("hide");BX.adjust(this.nav,{attrs:{"bx-visibility-status":"none"},html:this.msg})}else{this.display("show");BX.adjust(this.nav,{attrs:{"bx-visibility-status":"visible"},html:BX.message("BLOG_C_HIDE")})}}else if(this.status=="ready"){this.send()}return false},send:function(){this.status="busy";BX.addClass(this.nav,"feed-com-all-hover");var e=BX.ajax.prepareData({AJAX_POST:"Y",ENTITY_XML_ID:this.ENTITY_XML_ID,MODE:"LIST",FILTER:this.order=="ASC"?{">ID":this.mid}:{"<ID":this.mid},sessid:BX.bitrix_sessid()}),t=BX.util.htmlspecialcharsback(this.nav.getAttribute("href"));t=t.indexOf("#")!==-1?t.substr(0,t.indexOf("#")):t;var i={url:t,data:e};BX.onCustomEvent(this,"OnUCListHasToBeEnlarged",[this,i]);t=i.url;e=i.data;BX.ajax({url:t+(t.indexOf("?")!==-1?"&":"?")+e,method:"GET",dataType:"json",data:"",onsuccess:BX.proxy(this.build,this),onfailure:BX.proxy(this.complete,this)})},build:function(e){this.status="ready";this.wait("hide");BX.removeClass(this.nav,"feed-com-all-hover");if(!!e&&e["status"]=="success"){var t=!!e["navigation"]?BX.create("DIV",{html:e["navigation"]}):null,i=BX.processHTML(e["messageList"],false);var s=this.container.offsetHeight,n=BX.create("DIV",{html:i.HTML});if(this.order=="ASC"||!this.container.firstChild){this.container.appendChild(n)}else{this.container.insertBefore(n,this.container.firstChild)}BX.onCustomEvent(window,"OnUCFeedChanged",[[this.ENTITY_XML_ID,this.mid]]);this.display("show",s);if(!!t)t=t.firstChild;if(!!t)BX.adjust(this.nav,{attrs:{href:t.getAttribute("href")},html:t.innerHTML});else{BX.adjust(this.nav,{attrs:{href:"#","bx-visibility-status":"visible"},html:BX.message("BLOG_C_HIDE"),events:{click:function(e){BX.eventCancelBubble(e);BX.PreventDefault(e);return false}}});this.status="done"}var o=0,a=BX.delegate(function(){o++;if(o<100){if(this.container.childNodes.length>0){BX.ajax.processScripts(i.SCRIPT);var t=n.firstChild,s=n.lastChild,r=0,d=0;if(t&&t.hasAttribute("id")){r=parseInt(t.getAttribute("id").replace("record-"+this.ENTITY_XML_ID+"-","").replace("-cover",""));r=r>0?r:0}if(s&&s.hasAttribute("id")){d=parseInt(s.getAttribute("id").replace("record-"+this.ENTITY_XML_ID+"-","").replace("-cover",""));d=d>0?d:0}if(r>d){d=d+r;r=d-r;d=d-r}n.setAttribute("bx-mpl-min",r+"");n.setAttribute("bx-mpl-max",d+"");n.setAttribute("bx-mpl-loaded","Y");BX.onCustomEvent(this,"OnUCListWasBuilt",[this,e,n])}else BX.defer(a)()}},this);BX.defer(a)()}},complete:function(){this.status="done";BX.removeClass(this.nav,"feed-com-all-hover");this.wait("hide")},wait:function(e){e=e=="show"?"show":"hide";return e},reply:function(e){safeEditingCurrentObj=safeEditing;if(BX.type.isElementNode(e))BX.onCustomEvent(window,"OnUCUserReply",[this.ENTITY_XML_ID,e.getAttribute("bx-mpl-author-id"),e.getAttribute("bx-mpl-author-name"),safeEditingCurrentObj]);else BX.onCustomEvent(window,"OnUCUserReply",[this.ENTITY_XML_ID,undefined,undefined,safeEditingCurrentObj])},add:function(e,t,i,s){if(!(!!t&&!!e&&parseInt(e[1])>0))return false;var n=BX("record-"+e.join("-")+"-cover"),o=!!t["message"]?t["message"]:window.fcParseTemplate({messageFields:t["messageFields"]},{RIGHTS:this.rights,DATE_TIME_FORMAT:this.DATE_TIME_FORMAT,VIEW_URL:this.params.VIEW_URL,EDIT_URL:this.params.EDIT_URL,MODERATE_URL:this.params.MODERATE_URL,DELETE_URL:this.params.DELETE_URL,AUTHOR_URL:this.params.AUTHOR_URL,AUTHOR_URL_PARAMS:this.params.AUTHOR_URL_PARAMS,NAME_TEMPLATE:this.params.NAME_TEMPLATE,SHOW_LOGIN:this.params.SHOW_LOGIN},this.getTemplate()),a=BX.processHTML(o,false),r,d=BX("record-"+e[0]+"-new"),l=["MODERATE","EDIT","DELETE"],c=false,h=0;for(var u in l){if(l.hasOwnProperty(u)){if(this.rights[l[u]]=="OWNLAST"){c=true;break}}}if(c){r=!!d.lastChild&&d.lastChild.className=="feed-com-block-cover"?[d.lastChild]:[];var T,E;if(this.addCheckPreviousNodes!==true){r=BX.findChildren(d.parentNode,{tagName:"DIV",className:"feed-com-block-cover"},false);var m=BX.findChildren(d,{tagName:"DIV",className:"feed-com-block-cover"},false);r=!!r?r:[];m=!!m?m:[];while(m.length>0&&(T=m.pop())&&!!T)r.push(T);this.addCheckPreviousNodes=true}while((T=r.pop())&&T){E=BX(T.id.replace("-cover","-actions"));if(!!E){if(this.rights["EDIT"]=="OWNLAST")E.setAttribute("bx-mpl-edit-show","N");if(this.rights["MODERATE"]=="OWNLAST")E.setAttribute("bx-mpl-moderate-show","N");if(this.rights["DELETE"]=="OWNLAST")E.setAttribute("bx-mpl-delete-show","N")}}}var p=false;if(!n){n=BX.create("DIV",{attrs:{id:"record-"+e.join("-")+"-cover",className:"feed-com-block-cover"},style:{opacity:0,height:0,overflow:"hidden"},html:a.HTML});d.appendChild(n);p=true}else{var f=BX.create("DIV",{attrs:{id:"record-"+e.join("-")+"-cover",className:"feed-com-block-cover"},style:{display:"none"},html:a.HTML}),X=n;n.parentNode.insertBefore(f,n);n.removeAttribute("id");h=n.scrollHeight;BX.hide(n);BX.show(f);n=f;setTimeout(function(){BX.remove(X)},1e3)}if(s!=="simple"){var I=BX.pos(n),_=BX.GetWindowScrollPos(),B=BX.GetWindowInnerSize();new BX["easing"]({duration:1e3,start:{opacity:p?0:100,height:h},finish:{opacity:100,height:n.scrollHeight},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){n.style.height=e.height+"px";n.style.opacity=e.opacity/100;if(_.scrollTop>0&&I.top<_.scrollTop+B.innerHeight)window.scrollTo(0,_.scrollTop+e.height)},complete:function(){n.style.cssText=""}}).animate()}else{new BX["easing"]({duration:500,start:{height:h,opacity:p?0:100},finish:{height:n.scrollHeight,opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.cubic),step:function(e){n.style.height=e.height+"px";n.style.opacity=e.opacity/100},complete:BX.proxy(function(){n.style.cssText="";BX.onCustomEvent(this,"OnUCRecordWasShown",[this.ENTITY_XML_ID,e,n])},this)}).animate()}var A=0,R=function(){A++;if(A<100){var i=BX("record-"+e.join("-")+"-cover");if(i&&i.childNodes.length>0){BX.ajax.processScripts(a.SCRIPT);if(this.params["BIND_VIEWER"]=="Y"&&BX["viewElementBind"]){BX.viewElementBind(i,{},function(e){return BX.type.isElementNode(e)&&(e.getAttribute("data-bx-viewer")||e.getAttribute("data-bx-image"))})}}else BX.defer(R,this)()}BX.onCustomEvent(window,"OnUCRecordHasDrawn",[this.ENTITY_XML_ID,e,t["messageFields"]]);BX.onCustomEvent(window,"OnUCFeedChanged",[e])};BX.defer(R,this)();return true},pullNewAuthor:function(e,t,i){BX.onCustomEvent(window,"OnUCUsersAreWriting",[this.ENTITY_XML_ID,e,t,i])},pullNewRecord:function(e){var t=[this.ENTITY_XML_ID,parseInt(e["ID"])];if(!!this.pullNewRecords[t.join("-")]&&this.pullNewRecords[t.join("-")]=="busy")return true;else if(!!this.pullNewRecords[t[0]+"-0"]&&this.pullNewRecords[t[0]+"-0"]=="busy")return setTimeout(BX.proxy(function(){this.pullNewRecord(e)},this),100);BX.onCustomEvent(window,"OnUCBeforeCommentWillBePulled",[t,e]);if(e["NEED_REQUEST"]=="Y"){if(e["URL"]["LINK"].indexOf("#GROUPS_PATH#")>=0&&!!BX.message("MPL_WORKGROUPS_PATH"))e["URL"]["LINK"]=e["URL"]["LINK"].replace("#GROUPS_PATH#",BX.message("MPL_WORKGROUPS_PATH"));this.pullNewRecords[t.join("-")]="busy";var i=BX.ajax.prepareData({AJAX_POST:"Y",ENTITY_XML_ID:this.ENTITY_XML_ID,MODE:"RECORD",FILTER:{ID:e["ID"]},sessid:BX.bitrix_sessid()}),s=e["URL"]["LINK"];s=s.indexOf("#")!==-1?s.substr(0,s.indexOf("#")):s;BX.ajax({url:s+(s.indexOf("?")!==-1?"&":"?")+i,method:"GET",dataType:"json",data:"",onsuccess:BX.delegate(function(i){if(!!BX("record-"+t.join("-")+"-cover"))return;this.add([this.ENTITY_XML_ID,parseInt(e["ID"])],i);var s=BX("record-"+t.join("-")+"-cover"),n=BX.findChild(s,{className:"feed-com-block"},true,false);BX.addClass(s,"comment-new-answer");BX.addClass(n,"feed-com-block-pointer-to-new feed-com-block-new");this.pullNewRecords[t.join("-")]="done";if(BX("record-"+t[0]+"-corner")){BX.addClass(BX("record-"+t[0]+"-corner"),BX.hasClass(n,"feed-com-block-new")?"feed-post-block-yellow-corner":"");BX("record-"+t[0]+"-corner").removeAttribute("id")}BX.onCustomEvent(window,"OnUCCommentWasPulled",[t,i])},this)})}else if(e["ACTION"]=="DELETE"){if(BX("record-"+this.ENTITY_XML_ID+"-"+e["ID"]))BX.fx.hide(BX("record-"+this.ENTITY_XML_ID+"-"+e["ID"]),"scroll",{time:.2});BX.onCustomEvent(window,"OnUCommentWasDeleted",[this.ENTITY_XML_ID,[this.ENTITY_XML_ID,e["ID"]],e]);BX.onCustomEvent(window,"OnUCFeedChanged",[e["ID"]])}else if(e["ACTION"]=="HIDE"){var n=BX("record-"+this.ENTITY_XML_ID+"-"+e["ID"]),o=n?BX.findChild(n,{tagName:"DIV",className:"feed-com-block"},true):null;if(BX(o)){if(BX.hasClass(o,"blog-comment-user-"+BX.message("USER_ID"))){BX.removeClass(o,"feed-com-block-approved");BX.addClass(o,"feed-com-block-hidden")}else{BX.fx.hide(n,"scroll",{time:.2});BX.onCustomEvent(window,"OnUCommentWasHidden",[this.ENTITY_XML_ID,[this.ENTITY_XML_ID,e["ID"]],e]);BX.onCustomEvent(window,"OnUCFeedChanged",[e["ID"]])}}}else if(e["ACTION"]=="EDIT"&&!BX("record-"+this.ENTITY_XML_ID+"-"+e["ID"])){BX.DoNothing()}else{if(e&&!(e["AUTHOR"]&&e["AUTHOR"]["ID"]+""==BX.message("USER_ID")+""))e["NEW"]="Y";this.add(t,{messageFields:e});var a=BX("record-"+t.join("-")+"-cover"),r=BX.findChild(a,{className:"feed-com-block"},true,false);if(BX("record-"+t[0]+"-corner")){BX.addClass(BX("record-"+t[0]+"-corner"),e["NEW"]=="Y"?"feed-post-block-yellow-corner":"");BX("record-"+t[0]+"-corner").removeAttribute("id")}BX.addClass(a,"comment-new-answer");if(e["NEW"]=="Y"){BX.addClass(r,"feed-com-block-pointer-to-new feed-com-block-new")}this.pullNewRecords[t.join("-")]="done";BX.onCustomEvent(window,"OnUCCommentWasPulled",[t,{messageFields:e}])}return true},act:function(url,id,act){if(url.substr(0,1)!="/"){try{eval(url);return false}catch(e){}if(BX.type.isFunction(url)){url(this,id,act);return false}}this.showWait(id);act=act==="EDIT"?"EDIT":act==="DELETE"?"DELETE":"MODERATE";id=parseInt(id);var data=BX.ajax.prepareData({sessid:BX.bitrix_sessid(),MODE:"RECORD",NOREDIRECT:"Y",AJAX_POST:"Y",FILTER:{ID:id},ENTITY_XML_ID:this.ENTITY_XML_ID});url=url.indexOf("#")!==-1?url.substr(0,url.indexOf("#")):url;BX.ajax({method:"GET",url:url+(url.indexOf("?")!==-1?"&":"?")+data,data:"",dataType:"json",onsuccess:BX.proxy(function(e){this.closeWait(id);if(e["status"]=="error"){this.showError(id,e["message"]||"Unknown error.")}else{if(act!=="EDIT"){var t=BX("record-"+this.ENTITY_XML_ID+"-"+id+"-cover");if(!!e["message"]&&!!t){var i=BX.processHTML(e["message"],false);t.innerHTML=i.HTML;var s=0,n=function(){s++;if(s<100){if(t.childNodes.length>0)BX.ajax.processScripts(i.SCRIPT);else BX.defer(n)()}};BX.defer(n)();e["okMessage"]=""}else if(act=="DELETE"&&!!e["okMessage"]){BX.hide(BX("record-"+this.ENTITY_XML_ID+"-"+id));BX.onCustomEvent(window,"OnUCommentWasDeleted",[this.ENTITY_XML_ID,[this.ENTITY_XML_ID,id]])}}BX.onCustomEvent(window,"OnUCAfterRecordEdit",[this.ENTITY_XML_ID,id,e,act]);BX.onCustomEvent(window,"OnUCFeedChanged",[id])}this.busy=false},this),onfailure:BX.delegate(function(e){this.closeWait(id);this.showError(id,e)},this)});return false},showError:function(e,t){if(this.errorWindow)this.errorWindow.close();this.errorWindow=new BX.PopupWindow("bx-comments-error",null,{autoHide:false,zIndex:200,overlay:{opacity:50,backgroundColor:"#000000"},buttons:[new BX.PopupWindowButton({text:BX.message("MPL_CLOSE"),events:{click:BX.delegate(function(){if(this.errorWindow)this.errorWindow.close()},this)}})],closeByEsc:true,titleBar:{content:BX.create("span",{props:{className:"popup-window-titlebar-text feed-error-title"},html:'<div class="feed-error-icon"></div>'+BX.message("MPL_ERROR_OCCURRED")})},closeIcon:true,contentColor:"white",content:'<div class="feed-error-block">'+t+"</div>"});this.errorWindow.show()},checkHash:function(e){var t=[this.ENTITY_XML_ID,e],i=BX("record-"+t.join("-")+"-cover");if(!!i){var s=BX.pos(i);window.scrollTo(0,s["top"]);i=BX.findChild(i,{className:"feed-com-block"},true,false);BX.removeClass(i,"feed-com-block-pointer-to-new feed-com-block-new");BX.addClass(i,"feed-com-block-pointer")}},getTemplate:function(){return BX.message("MPL_RECORD_TEMPLATE")},showWait:function(e){window.fcShowWait(BX("record-"+this.ENTITY_XML_ID+"-"+e+"-actions"))},closeWait:function(e){window.fcCloseWait(BX("record-"+this.ENTITY_XML_ID+"-"+e+"-actions")||null)}};window.FCList.getQuoteData=function(){return quoteData};window.FCList.getInstance=function(e,t){if(!repo[e["ENTITY_XML_ID"]])new window.FCList(e,t);return repo[e["ENTITY_XML_ID"]]};window["fcExpandComment"]=function(e,t){if(!BX("record-"+e+"-text")){return}var i=BX("record-"+e+"-text"),s=i.parentNode,n=200,o=parseInt(i.offsetHeight),a={height:n},r={height:o};if(!!t)BX.remove(t);var d=(o-n)/(2e3-n);d=d<.3?.3:d>.8?.8:d;s.style.maxHeight=a.height+"px";s.style.overflow="hidden";new BX["easing"]({duration:d*1e3,start:a,finish:r,transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){s.style.maxHeight=e.height+"px";s.style.opacity=e.opacity/100},complete:function(){s.style.cssText="";s.style.maxHeight="none";BX.onCustomEvent(window,"OnUCRecordWasExpanded",[s]);BX.LazyLoad.showImages(true)}}).animate();BX.onCustomEvent(window,"OnUCFeedChanged",[e.split("-")])};var lastWaitElement=null;window["fcShowWait"]=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;if(BX.type.isElementNode(e)){BX.defer(function(){e.disabled=true})();var t=BX.findParent(e,BX.is_relative);e.bxwaiter=(t||document.body).appendChild(BX.create("DIV",{props:{className:"feed-com-loader"},style:{position:"absolute"}}));lastWaitElement=e;return e.bxwaiter}return true};window["fcCloseWait"]=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||lastWaitElement||this;if(BX.type.isElementNode(e)){if(e.bxwaiter&&e.bxwaiter.parentNode){e.bxwaiter.parentNode.removeChild(e.bxwaiter);e.bxwaiter=null}e.disabled=false;if(lastWaitElement==e)lastWaitElement=null}};window["fcShowActions"]=function(e,t,i){var s=[];if(i.getAttribute("bx-mpl-view-show")=="Y"){s.push({text:BX.message("MPL_MES_HREF"),href:i.getAttribute("bx-mpl-view-url").replace(/\\#(.+)$/gi,"")+"#com"+t});s.push({text:'<span id="record-popup-'+e+"-"+t+'-link-text">'+BX.message("B_B_MS_LINK")+"</span>"+'<span id="record-popup-'+e+"-"+t+'-link-icon-animate" class="comment-menu-link-icon-wrap">'+'<span class="comment-menu-link-icon" id="record-popup-'+e+"-"+t+'-link-icon-done" style="display: none;">'+"</span>"+"</span>",onclick:function(){var s="record-popup-"+e+"-"+t+"-link",n=i.getAttribute("bx-mpl-view-url").replace(/#(.+)$/gi,"")+"#com"+t,o=BX(s+"-text"),a=BX(s+"-icon-done");n=(n.indexOf("http")<0?location.protocol+"//"+location.host:"")+n;if(BX.clipboard.isCopySupported()){if(o&&o.getAttribute("data-block-click")=="Y"){return}BX.clipboard.copy(n);if(o&&a){a.style.display="inline-block";BX.removeClass(BX(s+"-icon-animate"),"comment-menu-link-icon-animate");BX.adjust(BX(s+"-text"),{attrs:{"data-block-click":"Y"}});setTimeout(function(){BX.addClass(BX(s+"-icon-animate"),"comment-menu-link-icon-animate")},1);setTimeout(function(){BX.adjust(BX(s+"-text"),{attrs:{"data-block-click":"N"}})},500)}return}var r=BX.proxy_context,d=parseInt(!!r.getAttribute("bx-height")?r.getAttribute("bx-height"):r.offsetHeight);if(r.getAttribute("bx-status")!="shown"){r.setAttribute("bx-status","shown");if(!BX(s)&&!!BX(s+"-text")){var l=BX(s+"-text"),c=BX.pos(l),h=BX.pos(l.parentNode),u=BX.findChildren(l.parentNode.parentNode.parentNode,{className:"menu-popup-item-text"},true);c["height"]=h["height"]-1;if(u){var T=0,E;for(var m=0;m<u.length;m++){E=BX.pos(u[m]);T=Math.max(T,E["width"])}h["width"]=T}BX.adjust(r,{attrs:{"bx-height":r.offsetHeight},style:{overflow:"hidden",display:"block"},children:[BX.create("BR"),BX.create("DIV",{attrs:{id:s},children:[BX.create("SPAN",{attrs:{className:"menu-popup-item-left"}}),BX.create("SPAN",{attrs:{className:"menu-popup-item-icon"}}),BX.create("SPAN",{attrs:{className:"menu-popup-item-text"},children:[BX.create("INPUT",{attrs:{id:s+"-input",type:"text",value:n},style:{height:h["height"]+"px",width:h["width"]+"px"},events:{click:function(e){this.select();BX.PreventDefault(e)}}})]})]}),BX.create("SPAN",{className:"menu-popup-item-right"})]})}new BX["fx"]({time:.2,step:.05,type:"linear",start:d,finish:d*2,callback:BX.delegate(function(e){this.style.height=e+"px"},r)}).start();BX.fx.show(BX(s),.2);BX(s+"-input").select()}else{r.setAttribute("bx-status","hidden");new BX["fx"]({time:.2,step:.05,type:"linear",start:r.offsetHeight,finish:d,callback:BX.delegate(function(e){this.style.height=e+"px"},r)}).start();BX.fx.hide(BX(s),.2)}}})}if(i.getAttribute("bx-mpl-edit-show")=="Y")s.push({text:BX.message("BPC_MES_EDIT"),onclick:function(){window["UC"][e].act(i.getAttribute("bx-mpl-edit-url"),t,"EDIT");this.popupWindow.close();return false}});if(i.getAttribute("bx-mpl-moderate-show")=="Y"){var n=i.getAttribute("bx-mpl-moderate-approved")=="hidden";s.push({text:n?BX.message("BPC_MES_SHOW"):BX.message("BPC_MES_HIDE"),onclick:function(){window["UC"][e].act(i.getAttribute("bx-mpl-moderate-url").replace("#action#",n?"show":"hide").replace("#ACTION#",n?"SHOW":"HIDE"),t,"MODERATE");this.popupWindow.close()}})}if(i.getAttribute("bx-mpl-delete-show")=="Y"){s.push({text:BX.message("BPC_MES_DELETE"),onclick:function(){if(window.confirm(BX.message("BPC_MES_DELETE_POST_CONFIRM")))window["UC"][e].act(i.getAttribute("bx-mpl-delete-url"),t,"DELETE");this.popupWindow.close();return false}})}if(i.getAttribute("bx-mpl-createtask-show")=="Y"&&typeof oLF!="undefined"){s.push({text:BX.message("BPC_MES_CREATE_TASK"),onclick:function(){oLF.createTask({entityType:"BLOG_COMMENT",entityId:t});this.popupWindow.close();return false}})}if(s.length>0){for(var o in s){if(s.hasOwnProperty(o)){s[o]["className"]="blog-comment-popup-menu"}}BX.PopupMenu.show("action-"+e+"-"+t,i,s,{offsetLeft:-18,offsetTop:2,lightShadow:false,angle:{position:"top",offset:50},events:{onPopupClose:function(){this.destroy();BX.PopupMenu.Data["action-"+e+"-"+t]=null}}})}};window["fcParseTemplate"]=function(e,t,i){t=t||{};t["RIGHTS"]=t["RIGHTS"]||{};for(var s=0,n=["MODERATE","EDIT","DELETE"];s<n.length;s++){t["RIGHTS"][n[s]]=BX.util.in_array(t["RIGHTS"][n[s]],["Y","ALL","OWN","OWNLAST"])?t["RIGHTS"][n[s]]:"N"}t["DATE_TIME_FORMAT"]=!!t["DATE_TIME_FORMAT"]?t["DATE_TIME_FORMAT"]:"d F Y G:i";t["TIME_FORMAT"]=!!t["DATE_TIME_FORMAT"]&&t["DATE_TIME_FORMAT"].indexOf("a")>=0?"g:i a":"G:i";t["VIEW_URL"]=t["VIEW_URL"]||"";t["EDIT_URL"]=t["EDIT_URL"]||"";t["MODERATE_URL"]=t["MODERATE_URL"]||"";t["DELETE_URL"]=t["DELETE_URL"]||"";t["AUTHOR_URL"]=t["AUTHOR_URL"]||"";t["NAME_TEMPLATE"]=t["NAME_TEMPLATE"]||"";t["SHOW_LOGIN"]=t["SHOW_LOGIN"]||"";var o=e&&e["messageFields"]?e["messageFields"]:e,a={ID:"",FULL_ID:"",CONTENT_ID:"",ENTITY_XML_ID:"",NEW:"old",APPROVED:"Y",DATE:"",TEXT:"",CLASSNAME:"",VIEW_URL:"",VIEW_SHOW:"N",EDIT_URL:"",EDIT_SHOW:"N",MODERATE_URL:"",MODERATE_SHOW:"N",DELETE_URL:"",DELETE_SHOW:"N",CREATETASK_SHOW:"N",BEFORE_HEADER:"",BEFORE_ACTIONS:"",AFTER_ACTIONS:"",AFTER_HEADER:"",BEFORE:"",AFTER:"",BEFORE_RECORD:"",AFTER_RECORD:"",AUTHOR_ID:0,AUTHOR_AVATAR_IS:"N",AUTHOR_AVATAR:"",AUTHOR_URL:"",AUTHOR_NAME:"",AUTHOR_EXTRANET_STYLE:"",SHOW_POST_FORM:"Y",VOTE_ID:"",AUTHOR_TOOLTIP_PARAMS:"","background:url('') no-repeat center;":""};if(!!o&&!!e["messageFields"]){o["AUTHOR"]=!!o["AUTHOR"]?o["AUTHOR"]:{};var r=parseInt(o["POST_TIMESTAMP"])+parseInt(BX.message("USER_TZ_OFFSET"))+parseInt(BX.message("SERVER_TZ_OFFSET"));var d=[["today",t["TIME_FORMAT"].indexOf("today")<0?"today, "+t["TIME_FORMAT"]:t["TIME_FORMAT"]],["yesterday",t["TIME_FORMAT"].indexOf("yesterday")<0?"yesterday, "+t["TIME_FORMAT"]:t["TIME_FORMAT"]],["",t["DATE_TIME_FORMAT"]]];var l="";if(typeof o["AUTHOR"]["TYPE"]!="undefined"){if(o["AUTHOR"]["TYPE"]=="EMAIL"){l=" feed-com-name-email"}else if(o["AUTHOR"]["TYPE"]=="EXTRANET"){l=" feed-com-name-extranet"}}else if(o["AUTHOR"]["IS_EXTRANET"]=="Y"){l=" feed-com-name-extranet"}var c=!!o.AUX&&o.AUX.length>0?BX.CommentAux.getLiveText(o.AUX,!!o.AUX_LIVE_PARAMS?o.AUX_LIVE_PARAMS:{}):o["POST_MESSAGE_TEXT"].replace(/\001/gi,"").replace(/#/gi,"");a={ID:o["ID"],FULL_ID:o["FULL_ID"].join("-"),CONTENT_ID:o["RATING"]&&o["RATING"]["ENTITY_TYPE_ID"]&&o["RATING"]["ENTITY_ID"]?o["RATING"]["ENTITY_TYPE_ID"]+"-"+o["RATING"]["ENTITY_ID"]:"",ENTITY_XML_ID:o["ENTITY_XML_ID"],NEW:o["NEW"]=="Y"?"new":"old",APPROVED:o["APPROVED"]!="Y"?"hidden":"approved",DATE:BX.date.format(d,r,false,true),TEXT:c,CLASSNAME:o["CLASSNAME"]?" "+o["CLASSNAME"]:"",VIEW_URL:t["VIEW_URL"].replace("#ID#",o["ID"]).replace("#id#",o["ID"]),VIEW_SHOW:t["VIEW_URL"]!==""?"Y":"N",EDIT_URL:t["EDIT_URL"].replace("#ID#",o["ID"]).replace("#id#",o["ID"]),EDIT_SHOW:(!o.AUX||o.AUX.length<=0)&&(t["RIGHTS"]["EDIT"]=="Y"||t["RIGHTS"]["EDIT"]=="ALL"||t["RIGHTS"]["EDIT"]=="OWN"&&BX.message("USER_ID")==o["AUTHOR"]["ID"])?"Y":"N",MODERATE_URL:t["MODERATE_URL"].replace("#ID#",o["ID"]).replace("#id#",o["ID"]),MODERATE_SHOW:t["RIGHTS"]["MODERATE"]=="Y"||t["RIGHTS"]["MODERATE"]=="ALL"||t["RIGHTS"]["MODERATE"]=="OWN"&&BX.message("USER_ID")==o["AUTHOR"]["ID"]?"Y":"N",DELETE_URL:t["DELETE_URL"].replace("#ID#",o["ID"]).replace("#id#",o["ID"]),DELETE_SHOW:t["RIGHTS"]["DELETE"]=="Y"||t["RIGHTS"]["DELETE"]=="ALL"||t["RIGHTS"]["DELETE"]=="OWN"&&BX.message("USER_ID")==o["AUTHOR"]["ID"]?"Y":"N",CREATETASK_SHOW:(!o.AUX||o.AUX.length<=0)&&t["RIGHTS"]["CREATETASK"]=="Y"?"Y":"N",BEFORE_HEADER:o["BEFORE_HEADER"],BEFORE_ACTIONS:o["BEFORE_ACTIONS"],AFTER_ACTIONS:o["AFTER_ACTIONS"],AFTER_HEADER:o["AFTER_HEADER"],BEFORE:o["BEFORE"],AFTER:o["AFTER"],BEFORE_RECORD:o["BEFORE_RECORD"],AFTER_RECORD:o["AFTER_RECORD"],AUTHOR_ID:o["AUTHOR"]["ID"],AUTHOR_AVATAR_IS:!!o["AUTHOR"]["AVATAR"]?"Y":"N",AUTHOR_AVATAR:!!o["AUTHOR"]["AVATAR"]?o["AUTHOR"]["AVATAR"]:"/bitrix/images/1.gif",AUTHOR_URL:t["AUTHOR_URL"].replace("#ID#",o["ID"]).replace("#id#",o["ID"]).replace("#USER_ID#",o["AUTHOR"]["ID"]).replace("#user_id#",o["AUTHOR"]["ID"])+(typeof o["AUTHOR"]["EXTERNAL_AUTH_ID"]!="undefined"&&o["AUTHOR"]["EXTERNAL_AUTH_ID"]=="email"&&typeof t["AUTHOR_URL_PARAMS"]!="undefined"?(t["AUTHOR_URL"].indexOf("?")>=0?"&":"?")+"entityType="+t["AUTHOR_URL_PARAMS"]["entityType"]+"&entityId="+t["AUTHOR_URL_PARAMS"]["entityId"]:""),AUTHOR_NAME:BX.formatName(o["AUTHOR"],t["NAME_TEMPLATE"],t["SHOW_LOGIN"]),AUTHOR_EXTRANET_STYLE:l,VOTE_ID:o["RATING"]&&o["RATING"]["VOTE_ID"]?o["RATING"]["VOTE_ID"]:"",AUTHOR_TOOLTIP_PARAMS:typeof o["AUTHOR_TOOLTIP_PARAMS"]!="undefined"?o["AUTHOR_TOOLTIP_PARAMS"]:"{}","background:url('') no-repeat center;":""}}else{for(s in a){if(a.hasOwnProperty(s)){a[s]=!!e[s]?e[s]:a[s]}}}for(s in a){if(a.hasOwnProperty(s)){a[s]=!!a[s]?a[s]:""}}a["SHOW_POST_FORM"]=BX("record-"+a["ENTITY_XML_ID"]+"-0-placeholder")?"Y":"N";for(var h in a){if(a.hasOwnProperty(h)){i=i.replace(new RegExp("#"+h+"#","g"),a[h])}}return i.replace("background:url('') no-repeat center;","").replace(/\001/gi,"#")};window["fcPull"]=function(e,t){BX.ajax({url:"/bitrix/components/bitrix/main.post.list/templates/.default/component_epilog.php",method:"POST",data:{AJAX_POST:"Y",ENTITY_XML_ID:e,MODE:"PUSH&PULL",sessid:BX.bitrix_sessid(),DATA:t}})};var newCommentsToCheckForReading={data:[],screen:{},timeout:0},traceForReading=function(e){newCommentsToCheckForReading.data.push(e);newCommentsToCheckForReading.screen=newCommentsToCheckForReading.screen||{scrollTop:BX.GetWindowScrollPos().scrollTop,time:(new Date).getTime()};newCommentsToCheckForReading.screen["checked"]=false;newCommentsToCheckForReading.timeout=newCommentsToCheckForReading.timeout||setTimeout(markReadComments,1e3)};BX.addCustomEvent(window,"OnUCRecordHasDrawn",function(e,t){traceForReading(t)});var markReadComments=function(){var e=BX.GetWindowScrollPos();if(e.scrollTop!=newCommentsToCheckForReading.screen["scrollTop"]){newCommentsToCheckForReading.screen["time"]=(new Date).getTime();newCommentsToCheckForReading.screen["scrollTop"]=e.scrollTop;newCommentsToCheckForReading.screen["checked"]=false}else if(!newCommentsToCheckForReading.screen["checked"]&&(new Date).getTime()-newCommentsToCheckForReading.screen["time"]>3e3){newCommentsToCheckForReading.screen["time"]=(new Date).getTime();newCommentsToCheckForReading.screen["checked"]=true;var t=0,i=BX.GetWindowInnerSize(),s=[],n,o,a,r,d,l;for(r=0;r<newCommentsToCheckForReading.data.length;r++){n=BX("record-"+newCommentsToCheckForReading.data[r].join("-")+"-cover");if(n){o=BX.pos(n);if(o.top>=e.scrollTop&&o.top<=e.scrollTop+i.innerHeight-20){BX.onCustomEvent(window,"OnUCCommentWasRead",[newCommentsToCheckForReading.data[r],n]);BX.removeClass(n,"comment-new-answer");d=BX.findParent(n,{className:"feed-comments-block"});if(d){l=BX.findChild(d,{className:"feed-com-corner"});if(l){BX.addClass(l,"feed-post-block-corner-fade")}}a=BX.findChild(n,{className:"feed-com-block"},true,false);BX.removeClass(a,"feed-com-block-pointer-to-new feed-com-block-new");BX.addClass(a,"feed-com-block-read");t++}else{s.push(newCommentsToCheckForReading.data[r])}}}newCommentsToCheckForReading.data=s;if(t>0)BX.onCustomEvent(window,"onCounterDecrement",[t])}if(newCommentsToCheckForReading.data.length>0)newCommentsToCheckForReading.timeout=setTimeout(markReadComments,1e3);else{newCommentsToCheckForReading.timeout=0}};var MPLQuote=function(e){this.params=e;this.id=e["id"];this.closeByEsc=!!e["closeByEsc"];this.autoHide=!!e["autoHide"];this.autoHideTimeout=!!e["autoHideTimeout"]?parseInt(e["autoHideTimeout"]):0;if(this.params.classEvents){for(var t in this.params.classEvents)if(this.params.classEvents.hasOwnProperty(t))BX.addCustomEvent(this,t,this.params.classEvents[t])}this.node=document.createElement("A");BX.adjust(this.node,{props:{id:this.id},style:{zIndex:BX.PopupWindow.getOption("popupZindex")+this.params.zIndex,position:"absolute",display:"none",top:"0px",left:"0px"},attrs:{className:"mpl-quote-block",href:"#"},events:this.params.events});document.body.appendChild(this.node)};MPLQuote.prototype={show:function(e){var t=this.getPosition(this.node,e);BX.adjust(this.node,{style:{top:t.y+"px",left:t.x+"px",display:"block"}});BX.addClass(this.node,"mpl-quote-block-show");if(this.closeByEsc&&!this.isCloseByEscBinded){this.isCloseByEscBinded=BX.delegate(this._onKeyUp,this);BX.bind(document,"keyup",this.isCloseByEscBinded)}if(this.params.autoHide&&!this.isAutoHideBinded){setTimeout(BX.proxy(function(){BX.bind(this.node,"click",this.cancelBubble);this.isAutoHideBinded=BX.delegate(this.hide,this);BX.bind(document,"click",this.isAutoHideBinded)},this),0)}if(this.autoHideTimeout>0&&this.autoHideTimeoutInt<=0){if(!this.autoHideTimeoutBinded)this.autoHideTimeoutBinded=BX.delegate(this.hide,this);this.autoHideTimeoutInt=setTimeout(this.autoHideTimeoutBinded,this.autoHideTimeout)}},hide:function(e){if(!this.isShown())return;if(e&&!(BX.getEventButton(e)&BX.MSLEFT))return;this.node.style.display="none";if(this.isCloseByEscBinded){BX.unbind(document,"keyup",this.isCloseByEscBinded);this.isCloseByEscBinded=false}if(this.autoHideTimeout>0){clearTimeout(this.autoHideTimeoutInt);this.autoHideTimeoutInt=0}setTimeout(BX.proxy(this._hide,this),0)},_hide:function(){BX.onCustomEvent(this,"onQuoteHide",[this]);if(this.params.autoHide&&this.isAutoHideBinded){BX.unbind(this.node,"click",this.cancelBubble);BX.unbind(document,"click",this.isAutoHideBinded);this.isAutoHideBinded=false}BX.remove(this.node)},getPosition:function(e,t){var i;if(t.pageX==null){var s=document.documentElement,n=document.body;var o=t.clientX+(s&&s.scrollLeft||n&&n.scrollLeft||0)-(s.clientLeft||0);var a=t.clientY+(s&&s.scrollTop||n&&n.scrollTop||0)-(s.clientTop||0);i={x:o,y:a}}else{i={x:t.pageX,y:t.pageY}}return{x:i.x+5,y:i.y-16}},isShown:function(){return this.node.style.display=="block"},cancelBubble:function(e){if(!e)e=window.event;if(e.stopPropagation)e.stopPropagation();else e.cancelBubble=true},_onKeyUp:function(e){e=e||window.event;if(e.keyCode==27)this.hide(e)}};window.mplCheckForQuote=function(e,t,i,s){e=document.all?window.event:e;var n="",o,a=null;if(window.getSelection){o=window.getSelection();n=o.toString()}else if(document.selection){o=document.selection;n=o.createRange().text}if(n!=""){var r=BX.findParent(o.focusNode,{tagName:t.tagName,className:t.className},t),d=BX.findParent(o.anchorNode,{tagName:t.tagName,className:t.className},t);if(r!=d||r!=t){n=""}else{if(!!s&&BX(s,true)){var l=BX(s,true);if(!!l&&l.hasAttribute("bx-post-author-id")){a={id:parseInt(l.getAttribute("bx-post-author-id")),name:l.innerHTML}}}}}if(n!=""){BX.onCustomEvent(window,"onQuote"+i,[e,{text:n,author:a}]);return true}return false};window.mplReplaceUserPath=function(e){if(typeof e!="string"||e.length<=0){return""}if(BX("MPL_IS_EXTRANET_SITE")=="Y"){e=e.replace("/company/personal/user/","/extranet/contacts/personal/user/")}else{e=e.replace("/extranet/contacts/personal/user/","/company/personal/user/")}e=e.replace(new RegExp("[\\w/]*/mobile/users/\\?user_id=(\\d+)","igm"),BX("MPL_IS_EXTRANET_SITE")=="Y"?"/extranet/contacts/personal/user/$1/":"/company/personal/user/$1/");return e};BX.onCustomEvent("main.post.list/default",["script.js"])})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_form.min.js?149502136714797";s:6:"source";s:79:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_form.js";s:3:"min";s:83:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_form.min.js";s:3:"map";s:83:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_form.map.js";}"*/
(function(){window["UC"]=window["UC"]||{};if(!!window["FCForm"])return;window.FCForm=function(e){this.url="";this.lhe="";this.entitiesId={};this.form=BX(e["formId"]);this.handler=window.LHEPostForm.getHandler(e["editorId"]);this.editorName=e["editorName"];this.editorId=e["editorId"];this.windowEvents={OnUCUnlinkForm:BX.delegate(function(e){if(!!e&&!!this.entitiesId[e]){var t={},i=true;for(var s in this.entitiesId){if(this.entitiesId.hasOwnProperty(s)&&s!=e){i=false;t[s]=this.entitiesId[s]}}this.entitiesId=t;if(i&&!!this.windowEvents){for(s in this.windowEvents){if(this.windowEvents.hasOwnProperty(s)&&s)BX.removeCustomEvent(window,s,this.windowEvents[s])}this.windowEventsSet=false}}},this),OnUCUserQuote:BX.delegate(function(e,t,i,s,n){var o=BX.util.htmlspecialchars(i);if(this.entitiesId[e]){if(!this._checkTextSafety([e,0],s))return;this.show([e,0]);if(n!==true){this.handler.exec(this.windowEvents.OnUCUserQuote,[e,t,i,s,true])}else if(!this.handler.oEditor.toolbar.controls.Quote){BX.DoNothing()}else if(!t&&!i){this.handler.oEditor.action.Exec("quote")}else{i=o;if(this.handler.oEditor.GetViewMode()=="wysiwyg"){i=i.replace(/\n/g,"<br/>");if(t){if(t.id>0){t='<span id="'+this.handler.oEditor.SetBxTag(false,{tag:"postuser",params:{value:t.id}})+'" class="bxhtmled-metion">'+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}else{t="<span>"+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}t=t!==""?t+BX.message("MPL_HAVE_WRITTEN")+"<br/>":"";i=t+i}}else if(this.handler.oEditor.bbCode){if(t){if(t.id>0){t="[USER="+t.id+"]"+t.name+"[/USER]"}else{t=t.name}t=t!==""?t+BX.message("MPL_HAVE_WRITTEN")+"\n":"";i=t+i}}if(this.handler.oEditor.action.actions.quote.setExternalSelectionFromRange){this.handler.oEditor.action.actions.quote.setExternalSelectionFromRange();var r=this.handler.oEditor.action.actions.quote.getExternalSelection();if(r===""&&o!==""){r=o}r=(BX.type.isNotEmptyString(t)?t:"")+r;if(BX.type.isNotEmptyString(r))this.handler.oEditor.action.actions.quote.setExternalSelection(r)}else{this.handler.oEditor.action.actions.quote.setExternalSelection(i)}this.handler.oEditor.action.Exec("quote")}}},this),OnUCUserReply:BX.delegate(function(e,t,i,s){if(!this._checkTextSafety([e,0],s))return;if(this.entitiesId[e]){this.show([e,0]);if(t>0){this.handler.exec(window.BxInsertMention,[{item:{entityId:t,name:i},type:"users",formID:this.form.id,editorId:this.editorId,bNeedComa:true,insertHtml:true}])}}},this),OnUCAfterRecordEdit:BX.delegate(function(e,t,i,s){if(!!this.entitiesId[e]){if(s==="EDIT"){this.show([e,t],i["messageBBCode"],i["messageFields"]);this.editing=true}else{this.hide(true);if(!!i["errorMessage"]){this.id=[e,t];this.showError(i["errorMessage"])}else if(!!i["okMessage"]){this.id=[e,t];this.showNote(i["okMessage"]);this.id=null}}}},this),OnUCUsersAreWriting:BX.delegate(function(e,t,i,s,n){if(!!this.entitiesId[e]){this.showAnswering([e,0],t,i,s,n)}},this),OnUCRecordHasDrawn:BX.delegate(function(e,t,i){if(!!this.entitiesId[e]){var s=parseInt(i&&i["AUTHOR"]?i["AUTHOR"]["ID"]:0);if(s>0)this.hideAnswering([e,0],s)}},this)};this.linkEntity(e["entitiesId"]);BX.remove(BX("micro"+e["editorName"]));BX.remove(BX("micro"+e["editorId"]));this.eventNode=this.handler.eventNode;if(this.eventNode){BX.addCustomEvent(this.eventNode,"OnBeforeHideLHE",BX.delegate(function(){BX.removeClass(document.documentElement,"bx-ios-fix-frame-focus");if(top&&top["document"])BX.removeClass(top["document"]["documentElement"],"bx-ios-fix-frame-focus");if(!!this.id&&!!BX("uc-writing-"+this.form.id+"-"+this.id[0]))BX.hide(BX("uc-writing-"+this.form.id+"-"+this.id[0]))},this));BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",BX.delegate(function(){var e=this._getPlacehoder();if(e){BX.hide(e)}e=this._getSwitcher();if(e){BX.show(e);BX.focus(e.firstChild)}this.__content_length=0;if(!!this.id){BX.onCustomEvent(this.eventNode,"OnUCFormAfterHide",[this]);this.showAnswering(this.id)}clearTimeout(this._checkWriteTimeout);this._checkWriteTimeout=0;this.clear();BX.onCustomEvent(window,"OnUCFeedChanged",[this.id])},this));BX.addCustomEvent(this.eventNode,"OnBeforeShowLHE",BX.delegate(function(){if(BX.browser.IsIOS()&&BX.browser.IsMobile()){BX.addClass(window["document"]["documentElement"],"bx-ios-fix-frame-focus");if(top&&top["document"])BX.addClass(top["document"]["documentElement"],"bx-ios-fix-frame-focus")}var e=this._getPlacehoder();if(e){BX.show(e)}e=this._getSwitcher();if(e){BX.hide(e)}if(!!this.id&&!!BX("uc-writing-"+this.form.id+"-"+this.id[0]))BX.hide(BX("uc-writing-"+this.form.id+"-"+this.id[0]))},this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",BX.delegate(function(e,t){this._checkWrite(e,t);if(!!this.id)this.showAnswering(this.id);BX.onCustomEvent(window,"OnUCFeedChanged",[this.id])},this));BX.addCustomEvent(this.eventNode,"OnClickSubmit",BX.delegate(this.submit,this));BX.addCustomEvent(this.eventNode,"OnClickCancel",BX.delegate(this.cancel,this));BX.onCustomEvent(this.eventNode,"OnUCFormInit",[this])}this.id=null;this.jsCommentId=null};window.FCForm.prototype={linkEntity:function(e){if(!!e){for(var t in e){if(e.hasOwnProperty(t)){BX.onCustomEvent(window,"OnUCUnlinkForm",[t]);this.entitiesId[t]=e[t]}}}if(!this.windowEventsSet&&!!this.entitiesId){BX.addCustomEvent(window,"OnUCUnlinkForm",this.windowEvents.OnUCUnlinkForm);BX.addCustomEvent(window,"OnUCUserReply",this.windowEvents.OnUCUserReply);BX.addCustomEvent(window,"OnUCUserQuote",this.windowEvents.OnUCUserQuote);BX.addCustomEvent(window,"OnUCAfterRecordEdit",this.windowEvents.OnUCAfterRecordEdit);BX.addCustomEvent(window,"OnUCUsersAreWriting",this.windowEvents.OnUCUsersAreWriting);BX.addCustomEvent(window,"OnUCRecordHasDrawn",this.windowEvents.OnUCRecordHasDrawn);this.windowEventsSet=true}},_checkTextSafety:function(e,t){if(t===true){t=e;if(this.id&&this.id.join("-")!=e.join("-")&&this.handler.editorIsLoaded&&this.handler.oEditor.IsContentChanged())return window.confirm(BX.message("MPL_SAFE_EDIT"));return true}return t===false},_checkWrite:function(e,t){if(this.handler.editorIsLoaded&&this._checkWriteTimeout!==false){this.__content_length=this.__content_length>0?this.__content_length:0;var i=this.handler.oEditor.GetContent(),s=BX.delegate(function(){this._checkWrite(e,t)},this),n=2e3;if(i.length>=4&&this.__content_length!=i.length&&!!this.id){BX.onCustomEvent(window,"OnUCUserIsWriting",[this.id[0],this.id[1],this.jsCommentId]);n=3e4}this._checkWriteTimeout=setTimeout(s,n);this.__content_length=i.length}},_getPlacehoder:function(e){e=!!e?e:this.id;return!!e?BX("record-"+e.join("-")+"-placeholder"):null},_getSwitcher:function(e){e=!!e?e:this.id;return!!e?BX("record-"+e[0]+"-switcher"):null},hide:function(e){if(this.eventNode.style.display!="none"){BX.onCustomEvent(this.eventNode,"OnShowLHE",[e===true?false:"hide"])}if(e){document.body.appendChild(this.form)}},clear:function(){this.editing=false;var e=this._getPlacehoder();if(!!e)BX.hide(e);var t=BX.findChildren(e,{tagName:"DIV",className:"feed-add-error"},true);if(!!t){e=t.pop();do{BX.remove(e)}while((e=t.pop())&&e)}BX.onCustomEvent(this.eventNode,"OnUCFormClear",[this]);var i=BX.findChild(this.form,{className:"wduf-placeholder-tbody"},true,false);if(i!==null&&typeof i!="undefined")BX.cleanNode(i,false);i=BX.findChild(this.form,{className:"wduf-selectdialog"},true,false);if(i!==null&&typeof i!="undefined")BX.hide(i);i=BX.findChild(this.form,{className:"file-placeholder-tbody"},true,false);if(i!==null&&typeof i!="undefined")BX.cleanNode(i,false);this.id=null;this.jsCommentId=null},show:function(e,t,i){if(this.id&&!!e&&this.id.join("-")==e.join("-"))return true;else this.hide(true);this.id=e;this.jsCommentId=BX.util.getRandomString(20);var s=this._getPlacehoder();s.appendChild(this.form);BX.onCustomEvent(this.eventNode,"OnUCFormBeforeShow",[this,t,i]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["show"]);BX.onCustomEvent(this.eventNode,"OnUCFormAfterShow",[this,t,i]);return true},submit:function(){if(this.busy===true)return"busy";var e=this.handler.editorIsLoaded?this.handler.oEditor.GetContent():"";if(!e){this.showError(BX.message("JERROR_NO_MESSAGE"));return false}this.showWait();this.busy=true;var t={};window.convertFormToArray(this.form,t);t["REVIEW_TEXT"]=e;t["NOREDIRECT"]="Y";t["MODE"]="RECORD";t["AJAX_POST"]="Y";t["id"]=this.id;if(this.jsCommentId!==null)t["COMMENT_EXEMPLAR_ID"]=this.jsCommentId;t["SITE_ID"]=BX.message("SITE_ID");t["LANGUAGE_ID"]=BX.message("LANGUAGE_ID");if(this.editing===true){t["REVIEW_ACTION"]="EDIT";t["FILTER"]={ID:this.id[1]}}BX.onCustomEvent(this.eventNode,"OnUCFormSubmit",[this,t]);BX.onCustomEvent(window,"OnUCFormSubmit",[this.id[0],this.id[1],this,t]);BX.ajax({method:"POST",url:this.form.action,data:t,dataType:"json",onsuccess:BX.proxy(function(e){this.closeWait();var t=e,i=this.id[0];BX.onCustomEvent(this.eventNode,"OnUCFormResponse",[this,e]);if(!!this.OnUCFormResponseData)e=this.OnUCFormResponseData;if(!!e){if(e["errorMessage"]){this.showError(e["errorMessage"])}else if(e["status"]=="error"){this.showError(BX.type.isNotEmptyString(e["message"])?e["message"]:"")}else{BX.onCustomEvent(window,"OnUCAfterRecordAdd",[this.id[0],e,t]);this.hide(true)}}this.busy=false;BX.onCustomEvent(window,"OnUCFormResponse",[i,e["messageId"],this,e])},this),onfailure:BX.delegate(function(){this.closeWait();this.busy=false;BX.onCustomEvent(window,"OnUCFormResponse",[this.id[0],this.id[1],this,[]])},this)})},cancel:function(){},showError:function(e){if(!e)return;var t=this._getPlacehoder(),i=BX.findChildren(t,{tagName:"DIV",className:"feed-add-error"},true);if(!!i){var s=i.pop();do{BX.remove(s);BX.remove(s)}while((s=i.pop())&&!!s)}t.insertBefore(BX.create("div",{attrs:{"class":"feed-add-error"},html:'<span class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+"<b>"+BX.message("FC_ERROR")+"</b><br />"+e+"</span>"}),t.firstChild);BX.show(t)},showNote:function(e){if(!e)return;var t=this._getPlacehoder(),i=BX.findChildren(t,{tagName:"DIV",className:"feed-add-successfully"},true),s=null;if(!!i){while((s=i.pop())&&!!s){BX.remove(s)}}t.insertBefore(BX.create("div",{attrs:{"class":"feed-add-successfully"},html:'<span class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+e+"</span>"}),t.firstChild);BX.show(t)},showWait:function(){var e=BX("lhe_button_submit_"+this.form.id);if(!!e){BX.addClass(e,"feed-add-button-load");BX.addClass(e,"feed-add-button-press");BX.defer(function(){e.disabled=true})()}},closeWait:function(){var e=BX("lhe_button_submit_"+this.form.id);if(!!e){e.disabled=false;BX.removeClass(e,"feed-add-button-press");BX.removeClass(e,"feed-add-button-load")}},objAnswering:null,showAnswering:function(e,t,i,s,n){t=t>0?t:0;if(t<=0)return;var o="uc-writing-"+this.form.id+"-"+e[0],r=BX(o+"-area"),a=this._getSwitcher(e),d=BX.localStorage.get("ucAnsweringStorage");d=!!d?d:{};if(!r&&a){r=BX.create("DIV",{attrs:{id:o+"-area",className:"feed-com-writers"},html:'<div id="'+o+'-users" class="feed-com-writers-wrap"></div><div class="feed-com-writers-pen"></div>'});a.appendChild(r)}if(!!r){if(t>0){if(!n){d["userId"+t]={id:e[0],userId:t,name:i,avatar:s,time:new Date};BX.localStorage.set("ucAnsweringStorage",d,3e3)}if(!BX(o+"-user-"+t)){BX.adjust(BX(o+"-users"),{children:[BX.create("DIV",{attrs:{className:"feed-com-avatar",id:o+"-user-"+t,title:i},children:[BX.create("IMG",{attrs:{src:s&&s.length>0?s:"/bitrix/images/1.gif"}})]})]})}}if(BX(o+"-users").childNodes.length>0){if(BX(r.parentNode).style.display=="none"){var h=BX("lhe_buttons_"+this.form.id);if(!h||h.style.display=="none")h=this.form;h.appendChild(r)}else if(r.parentNode!=a)a.appendChild(r);if(this.objAnswering&&this.objAnswering.name!="show")this.objAnswering.stop();if(!this.objAnswering||this.objAnswering.name!="show"){r.style.display="inline-block";this.objAnswering=new BX["easing"]({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){r.style.opacity=e.opacity/100}});this.objAnswering.name="show";this.objAnswering.animate()}var l=setTimeout(BX.delegate(function(){this.hideAnswering(e,t)},this),!!n?n:40500);if(BX(o+"-user-"+t)){clearTimeout(BX(o+"-user-"+t).getAttribute("bx-check-timeout"));BX(o+"-user-"+t).setAttribute("bx-check-timeout",l+"")}}}},hideAnswering:function(e,t){var i="uc-writing-"+this.form.id+"-"+e[0],s=BX(i+"-area"),n=BX(i+"-user-"+t,false);if(n&&s){if(BX(i+"-users").childNodes.length>1){new BX["easing"]({duration:500,start:{opacity:100},finish:{opacity:0},transition:BX["easing"].makeEaseOut(BX["easing"].transitions.quart),step:function(e){n.style.opacity=e.opacity/100},complete:function(){if(!!n&&!!n.parentNode)n.parentNode.removeChild(n)}}).animate()}else{if(this.objAnswering&&this.objAnswering.name!="hide")this.objAnswering.stop();if(!this.objAnswering||this.objAnswering.name!="hide"){this.objAnswering=new BX["easing"]({duration:500,start:{opacity:100},finish:{opacity:0},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quart),step:function(e){s.style.opacity=e.opacity/100},complete:function(){s.style.display="none";if(!!n&&!!n.parentNode)n.parentNode.removeChild(n)}});this.objAnswering.name="hide";this.objAnswering.animate()}}}}};window.convertFormToArray=function(e,t){t=!!t?t:[];if(!!e){var i,s=[],n=e.elements.length;for(i=0;i<n;i++){var o=e.elements[i];if(o.disabled)continue;switch(o.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":s.push({name:o.name,value:o.value});break;case"radio":case"checkbox":if(o.checked)s.push({name:o.name,value:o.value});break;case"select-multiple":for(var r=0;r<o.options.length;r++){if(o.options[r].selected)s.push({name:o.name,value:o.options[r].value})}break;default:break}}var a=t;i=0;while(i<s.length){var d=s[i].name.indexOf("[");if(d==-1){a[s[i].name]=s[i].value;a=t;i++}else{var h=s[i].name.substring(0,d);var l=s[i].name.substring(d+1);if(!a[h])a[h]=[];var f=l.indexOf("]");if(f==-1){a=t;i++}else if(f===0){a=a[h];s[i].name=""+a.length}else{a=a[h];s[i].name=l.substring(0,f)+l.substring(f+1)}}}}return t};window.FCForm.onUCUsersAreWriting=function(){BX.ready(function(){var e=null,t=null,i=BX.localStorage.get("ucAnsweringStorage");if(!!i){for(var s in i){if(i.hasOwnProperty(s)){e=i[s];if(!!e&&e.userId>0){t=new Date-e.time;if(t<3e4){BX.onCustomEvent(window,"OnUCUsersAreWriting",[e.id,e.userId,e.name,e.avatar,t])}}}}}})};window["fRefreshCaptcha"]=function(e){var t=null,i=BX.findChild(e,{attr:{name:"captcha_code"}},true),s=BX.findChild(e,{attr:{name:"captcha_word"}},true),n=BX.findChild(e,{className:"comments-reply-field-captcha-image"},true);if(n)t=BX.findChild(n,{tag:"img"});if(i&&s&&t){s.value="";BX.ajax.getCaptcha(function(e){i.value=e["captcha_sid"];t.src="/bitrix/tools/captcha.php?captcha_code="+e["captcha_sid"]})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_im.min.js?15096143588146";s:6:"source";s:77:"/bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_im.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){window["UC"]=!!window["UC"]?window["UC"]:{};if(!!window["UC"]["Informer"])return;window.SPC=function(){this.stack=[];this.stackTimeout=null;this.stackPopup={};this.stackPopupTimeout={};this.stackPopupTimeout2={};this.stackPopupId=0;this.stackOverflow=false;this.notifyShow=0;this.notifyHideTime=5e3;this.notifyHeightCurrent=10;this.notifyHeightMax=0;this.notifyGarbageTimeout=null;this.notifyAutoHide=true;this.notifyAutoHideTimeout=null};var t=window.SPC;t.prototype.add=function(t){if(typeof t!="object"||!t.html)return false;if(BX.type.isDomNode(t.html))t.html=t.html.outerHTML;this.stack.push(t);if(!this.stackOverflow)this.setShowTimer(300);return true};t.prototype.remove=function(t){delete this.stack[t]};t.prototype.show=function(){this.notifyHeightMax=document.body.offsetHeight;var t=BX.GetWindowInnerSize();for(var e=0;e<this.stack.length;e++){if(typeof this.stack[e]=="undefined")continue;var i=new BX.PopupWindow("bx-sbpc-notify-flash-"+this.stackPopupId,{top:0,left:0},{lightShadow:true,zIndex:200,events:{onPopupClose:BX.delegate(function(){BX.proxy_context.popupContainer.style.opacity=0;this.notifyShow--;this.notifyHeightCurrent-=BX.proxy_context.popupContainer.offsetHeight+10;this.stackOverflow=false;setTimeout(BX.delegate(function(){this.destroy()},BX.proxy_context),1500)},this),onPopupDestroy:BX.delegate(function(){BX.unbindAll(BX.findChild(BX.proxy_context.popupContainer,{className:"bx-spbc-notifier-item-delete"},true));BX.unbindAll(BX.proxy_context.popupContainer);delete this.stackPopup[BX.proxy_context.uniquePopupId];delete this.stackPopupTimeout[BX.proxy_context.uniquePopupId];delete this.stackPopupTimeout2[BX.proxy_context.uniquePopupId]},this)},bindOnResize:false,content:BX.create("div",{props:{className:"bx-notifyManager-item-sbpc"},html:this.stack[e].html})});i.notifyParams=this.stack[e];i.notifyParams.id=e;i.show();BX.removeClass(i.popupContainer.firstChild,"popup-window");i.popupContainer.style.left=10+"px";i.popupContainer.style.opacity=0;if(this.notifyHeightMax<this.notifyHeightCurrent+i.popupContainer.offsetHeight+10){if(this.notifyShow>0){i.destroy();this.stackOverflow=true;break}}BX.addClass(i.popupContainer,"bx-notifyManager-animation-spbc");new BX.easing({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(t){i.popupContainer.style.opacity=t.opacity/100}}).animate();i.popupContainer.style.top=t.innerHeight-this.notifyHeightCurrent-i.popupContainer.offsetHeight-10+"px";this.notifyHeightCurrent=this.notifyHeightCurrent+i.popupContainer.offsetHeight+10;this.stackPopupId++;this.notifyShow++;this.remove(e);this.stackPopupTimeout[i.uniquePopupId]=null;BX.bind(i.popupContainer,"mouseover",BX.delegate(function(){this.clearAutoHide()},this));BX.bind(i.popupContainer,"mouseout",BX.delegate(function(){this.setAutoHide(this.notifyHideTime/2)},this));BX.bind(i.popupContainer,"contextmenu",BX.delegate(function(t){if(this.stackPopup[BX.proxy_context.id].notifyParams.tag)this.closeByTag(this.stackPopup[BX.proxy_context.id].notifyParams.tag);else this.stackPopup[BX.proxy_context.id].close();return BX.PreventDefault(t)},this));var o=BX.findChildren(i.popupContainer,{tagName:"a"},true);for(var s=0;s<o.length;s++){if(o[s].href!="#")o[s].target="_blank"}BX.bind(BX.findChild(i.popupContainer,{className:"bx-spbc-notifier-item-delete"},true),"click",BX.delegate(function(t){var e=BX.proxy_context.parentNode.parentNode.parentNode.parentNode.id.replace("popup-window-content-","");if(this.stackPopup[e].notifyParams.close)this.stackPopup[e].notifyParams.close(this.stackPopup[e]);this.stackPopup[e].close();if(this.notifyAutoHide===false){this.clearAutoHide();this.setAutoHide(this.notifyHideTime/2)}return BX.PreventDefault(t)},this));if(i.notifyParams.click){i.popupContainer.style.cursor="pointer";BX.bind(i.popupContainer,"click",BX.delegate(function(t){this.notifyParams.click(this);return BX.PreventDefault(t)},i))}this.stackPopup[i.uniquePopupId]=i}if(this.stack.length>0){this.clearAutoHide(true);this.setAutoHide(this.notifyHideTime)}this.garbage()};t.prototype.closeByTag=function(t){for(var e=0;e<this.stack.length;e++){if(typeof this.stack[e]!="undefined"&&this.stack[e].tag==t){delete this.stack[e]}}for(e in this.stackPopup){if(this.stackPopup.hasOwnProperty(e))if(this.stackPopup[e].notifyParams.tag==t)this.stackPopup[e].close()}};t.prototype.setShowTimer=function(t){clearTimeout(this.stackTimeout);this.stackTimeout=setTimeout(BX.delegate(this.show,this),t)};t.prototype.setAutoHide=function(t){this.notifyAutoHide=true;clearTimeout(this.notifyAutoHideTimeout);this.notifyAutoHideTimeout=setTimeout(BX.delegate(function(){for(var e in this.stackPopupTimeout){if(this.stackPopupTimeout.hasOwnProperty(e)){this.stackPopupTimeout[e]=setTimeout(BX.delegate(function(){this.close()},this.stackPopup[e]),t-1e3);this.stackPopupTimeout2[e]=setTimeout(BX.delegate(function(){this.setShowTimer(300)},this),t-700)}}},this),1e3)};t.prototype.clearAutoHide=function(t){clearTimeout(this.notifyGarbageTimeout);this.notifyAutoHide=false;t=t===true;var e;if(t){clearTimeout(this.stackTimeout);for(e in this.stackPopupTimeout){if(this.stackPopupTimeout.hasOwnProperty(e)){clearTimeout(this.stackPopupTimeout[e]);clearTimeout(this.stackPopupTimeout2[e])}}}else{clearTimeout(this.notifyAutoHideTimeout);this.notifyAutoHideTimeout=setTimeout(BX.delegate(function(){clearTimeout(this.stackTimeout);for(var t in this.stackPopupTimeout){if(this.stackPopupTimeout.hasOwnProperty(t)){clearTimeout(this.stackPopupTimeout[t]);clearTimeout(this.stackPopupTimeout2[t])}}},this),300)}};t.prototype.garbage=function(){clearTimeout(this.notifyGarbageTimeout);this.notifyGarbageTimeout=setTimeout(BX.delegate(function(){var t=[];for(var e=0;e<this.stack.length;e++){if(typeof this.stack[e]!="undefined")t.push(this.stack[e])}this.stack=t},this),1e4)};t.prototype.check=function(t,e,i,o){if(t[1]<=0||!window["UC"]["Informer"]||!BX.type.isNotEmptyString(o))return;var s=/(\d+)/g.exec(t[0]),n=BX("record-"+t.join("-")+"-cover");s=!!s?parseInt(s):0;if(s<=0||!n)return false;else if(BX.util.in_array(s,window["UC"]["InformerTags"][i]))return true;window["UC"]["InformerTags"][i].push(s);var a=!!e&&!!e["messageFields"]?e["messageFields"]:false;if(!a)return;var r=BX.pos(n),p=BX.GetWindowScrollPos(),u=BX.GetWindowInnerSize();if(r.top<p.scrollTop||r.top>p.scrollTop+u.innerHeight-20){setTimeout(function(){if(parseInt(a["AUTHOR"]["ID"])!=parseInt(BX.message("USER_ID"))){var e=BX.create("div",{props:{className:"bx-spbc-notifier-item"},children:[BX.create("span",{props:{className:"bx-spbc-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-spbc-notifier-item-avatar"},children:[!!a["AUTHOR"]["AVATAR"]?BX.create("img",{props:{className:"bx-spbc-notifier-item-avatar-img"},attrs:{src:a["AUTHOR"]["AVATAR"]}}):""]}),BX.create("a",{attrs:{href:"#"},props:{className:"bx-spbc-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-spbc-notifier-item-name"},html:a["AUTHOR"]["NAME"]}),BX.create("span",{props:{className:"bx-spbc-notifier-item-time"},html:a["POST_TIME"]}),BX.create("span",{props:{className:"bx-spbc-notifier-item-text"}}),BX.create("span",{props:{className:"bx-spbc-notifier-item-text2"},html:'"'+o+'"'})]})]}),i=BX.GetWindowScrollPos();window["UC"]["Informer"].add({html:e,tag:"im-record-"+t.join("-"),click:BX.delegate(function(){var e=BX.pos(BX("record-"+t.join("-")));new BX.easing({duration:500,start:{scroll:i.scrollTop},finish:{scroll:e.top-100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(t){window.scrollTo(0,t.scroll)}}).animate()},this)})}},50)}};t.NativeNotify=function(){return window.webkitNotifications&&window.webkitNotifications.checkPermission()==0};window["UC"]["Informer"]=new t;window["UC"]["InformerTags"]={};t.notifyManagerShow=function(){BX.ready(function(){BX.addCustomEvent("onNotifyManagerShow",function(t){if(t.originalTag){var e=t.originalTag.lastIndexOf("|"),i=t.originalTag.substr(0,e);if(!!window["UC"]["InformerTags"][i]){var o=parseInt(t.originalTag.substr(e+1));window["UC"]["InformerTags"][i].push(o)}}})})}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?151457178766416";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.form/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){if(window["LHEPostForm"])return;var e={controller:{},handler:{}};BX.addCustomEvent(window,"BFileDLoadFormControllerWasBound",function(t){e.controller[t.id]=true});BX.addCustomEvent(window,"WDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"WDLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"DiskDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"DiskLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"OnEditorInitedBefore",function(t){if(e.handler[t.id]){t.__lhe_flags=["OnEditorInitedBefore"];if(e.handler[t.id]["params"]&&e.handler[t.id]["params"]["LHEJsObjName"])window[e.handler[t.id].params["LHEJsObjName"]]=t;e.handler[t.id].OnEditorInitedBefore(t)}});var t=function(t){if(e.handler[t.id]&&e.handler[t.id].editorIsLoaded!==true){e.handler[t.id].editorIsLoaded=true;e.handler[t.id].exec();BX.onCustomEvent(e.handler[t.id],"OnEditorIsLoaded",[e.handler[t.id],t])}};BX.addCustomEvent(window,"OnCreateIframeAfter",t);BX.addCustomEvent(window,"OnEditorInitedAfter",function(i,n){if(e.handler[i.id]){i.__lhe_flags.push("OnEditorInitedAfter");e.handler[i.id].OnEditorInitedAfter(i);if(e.handler[i.id].editorIsLoaded!==true&&n&&i.sandbox&&i.sandbox.inited)t.apply(i,[i])}});BX.util.object_search=function(e,t){for(var i in t){if(t.hasOwnProperty(i)){if(t[i]==e)return true;else if(typeof t[i]=="object"&&t[i]!==null){var n=BX.util.object_search_key(e,t[i]);if(n!==false)return n}}}return false};var i=function(e,t,i){i=i&&i.length>0?i:[];if(typeof t=="object"&&t.length>0){var n;while((n=t.pop())&&n&&t.length>0){i.push(n)}t=n}i.push(t);this.exist=true;this.bxTag=e;this.tag=t;this.tags=i;this.regexp=new RegExp("\\[("+i.join("|")+")=((?:\\s|\\S)*?)(?:\\s*?WIDTH=(\\d+)\\s*?HEIGHT=(\\d+))?\\]","ig");this.code="["+t+"=#ID##ADDITIONAL#]";this.wysiwyg='<span style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;" id="#ID#"#ADDITIONAL#>#NAME#</span>'},n=function(t,i,n){this.CID=this.id=i;this.parser=t.parser["disk_file"]||null;this.params=n;this.node=BX("diskuf-selectdialog-"+i);this.handler=e.controller[i];this.manager=t;this.eventNode=this.manager.eventNode;this.parserName="disk_file";this.prefixNode="disk-edit-attach";this.prefixHTMLNode="disk-attach-";this.props={valueEditClassName:"wd-inline-file",securityCID:"disk-upload-cid"};this.storage="disk";this.fileToAttach={};this.xmlToAttach={};this.events={onInit:"DiskDLoadFormControllerInit",onShow:"DiskLoadFormController",onBound:"DiskLoadFormControllerWasBound"}};n.prototype={parser:false,eventNode:null,values:{},initialized:false,functionsToExec:[],exec:function(e,t){if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.handler&&this.handler!==true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},init:function(){if(this.initialized!==true){this.values={};this.functionsToExec=[];this.initialized=true;this.bindMainEvents(this.manager);if(this.parser!==null){this.bindEvents(this.manager);return this.initValues()}}return false},initValues:function(){var e=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(e&&e.length>0){this.exec(this.runCheckText);return true}return false},bindMainEvents:function(t){var i=null;BX.addCustomEvent(t.eventNode,"onReinitializeBefore",BX.proxy(this.clean,this));BX.addCustomEvent(t.eventNode,"onShowControllers",BX.proxy(function(e){i=e;BX.onCustomEvent(t.eventNode,this.events.onShow,[e])},this));if(!e.controller[this.id]){var o=BX.delegate(function(e){if(e["UID"]==this.id||e["id"]==this.id){if(i==="show"||i==="hide"){BX.onCustomEvent(t.eventNode,this.events.onShow,[i]);i=null}BX.removeCustomEvent(window,this.events.onBound,o)}},this);BX.addCustomEvent(window,this.events.onBound,o)}if(BX["DD"]&&this.storage=="disk"){var s=BX.delegate(function(e){if((e["UID"]==this.id||e["id"]==this.id)&&this.manager["dropZoneExists"]!==true){BX.removeCustomEvent(window,this.events.onBound,s);this.manager["dropZoneExists"]=true;var i=this.eventNode,o=this.id;n.dndCatcher=n.dndCatcher||{};n.dndCatcher[o]={catch:true,files:[],dropZone:null,dropZoneMicro:null,initdrag:BX.delegate(function(){n.dndCatcher[o].dropZone=new BX.DD.dropFiles(t.eventNode);BX.addCustomEvent(t.eventNode,"OnImageDataUriHandle",BX.delegate(function(e,t){if(BX["UploaderUtils"]){var i=BX.UploaderUtils.dataURLToBlob(t.src);if(i&&i.size>0&&i.type.indexOf("image/")==0){i.name=i.name||t.title||"image."+i.type.substr(6);i.referrerToEditor=t;if(n.dndCatcher[o]["catch"]===true)n.dndCatcher[o]["drop"]([i]);else if(this.handler&&this.handler["addFile"])this.handler.addFile(i);BX.onCustomEvent(e,"OnImageDataUriCaught",[t])}}},this));BX.addCustomEvent(n.dndCatcher[o].dropZone,"dropFiles",n.dndCatcher[o]["drop"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragEnter",n.dndCatcher[o]["dragover"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragLeave",n.dndCatcher[o]["dragleave"]);if(BX("micro"+t.__divId)){n.dndCatcher[o].dropZoneMicro=new BX.DD.dropFiles(BX("micro"+t.__divId));BX.addCustomEvent(n.dndCatcher[o].dropZoneMicro,"dragEnter",function(){BX.onCustomEvent(t.eventNode,"OnShowLHE",["justShow"])})}BX.unbind(document,"dragover",n.dndCatcher[o]["initdrag"]);BX.onCustomEvent(t.eventNode,"onDropZoneExists",[])},this),dragover:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragover",[])},this),dragleave:BX.delegate(function(){BX.removeClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragleave",[])},this),dragenterwindow:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.addClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragenterwindow",[])},this),dragleavewindow:BX.delegate(function(e){BX.removeClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.removeClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragleavewindow",[])},this),drop:BX.delegate(function(e){BX.onCustomEvent(t.eventNode,"drop",[]);BX.onCustomEvent(window,"dragWindowLeave");BX.onCustomEvent(window,"__dragWindowLeave");var i=0;if(e&&e.length>0){if(n.dndCatcher[o]["catch"]===true){n.dndCatcher[o].files=e;i=1}else{i=2}BX.onCustomEvent(t.eventNode,this.events.onShow,["show"]);BX.removeClass(t.eventNode,"feed-add-post-dnd-ready feed-add-post-dnd-over")}return i},this)};BX.ready(function(){n.dndCatcher[o]["initdrag"]()});BX.addCustomEvent(i,"OnIframeDrop",BX.delegate(function(e){BX.PreventDefault(e);if(e["dataTransfer"]&&e["dataTransfer"]["files"]){if(n.dndCatcher[o].drop(e["dataTransfer"]["files"])===2){this.handler.agent.onChange(e["dataTransfer"]["files"])}}},this));BX.addCustomEvent(i,"OnIframeDragOver",n.dndCatcher[o].dragover);BX.addCustomEvent(i,"OnIframeDragLeave",n.dndCatcher[o].dragleave);if(!window["bxMpfDndCatcher"]){window["bxMpfDndCatcher"]=true;var a=false,r=function(){if(a===false){a=true;BX.bind(document,"dragleave",l);BX.bind(document,"dragover",l);BX.bind(document,"mouseout",d);BX.onCustomEvent(window,"dragWindowEnter")}},d=function(e){BX.unbind(document,"dragleave",l);BX.unbind(document,"dragover",l);BX.unbind(document,"mouseout",d);a=false;BX.onCustomEvent(window,"dragWindowLeave")},l=function(e){if(h>0){clearTimeout(h);h=0}BX.fixEventPageXY(e);var t=true;if(e.pageX>0&&e.pageY>0){var i=BX.GetWindowSize();if(e.pageY<i.scrollHeight&&e.pageX<i.scrollWidth){var n=e.pageY-i.scrollTop,o=e.pageX-i.scrollLeft;if(0<n&&n<i.innerHeight-20&&0<o&&o<i.innerWidth-20){t=false}}}if(t){d(e)}else{h=setTimeout(function(){l({type:"intervalLimit"})},100)}},h=0;BX.bind(document,"dragenter",function(e){if(window["bxMpfDndCatcher"]>0){clearTimeout(window["bxMpfDndCatcher"])}var t=true;if(e&&e["dataTransfer"]&&e["dataTransfer"]["types"]){for(var i=0;i<e["dataTransfer"]["types"].length;i++){if(e["dataTransfer"]["types"][i]=="Files"){t=true;break}}}if(t){r()}});BX.addCustomEvent(window,"__dragWindowLeave",d);BX.bind(document,"dragover",function(e){return BX.PreventDefault(e)});BX.bind(document,"drop",function(e){d(e);return BX.PreventDefault(e)})}BX.addCustomEvent(window,"dragWindowEnter",n.dndCatcher[o].dragenterwindow);BX.addCustomEvent(window,"dragWindowLeave",n.dndCatcher[o].dragleavewindow);this.__initCatcher=BX.delegate(function(e,i){if(e==this.id){BX.removeCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher);i.agent.initDropZone(t.eventNode);if(n.dndCatcher[e].files.length>0){i.agent.onChange(n.dndCatcher[e].files);n.dndCatcher[e].files=[]}n.dndCatcher[e]["catch"]=false;this.__initCatcher=null}},this);BX.addCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher)}},this);BX.addCustomEvent(window,this.events.onBound,s);if(e.controller[this.id])s(e.controller[this.id])}},bindEvents:function(e){this._catchHandler=BX.delegate(function(t){BX.removeCustomEvent(this.eventNode,this.events.onInit,this._catchHandler);this.handler=t;var i=BX.findChild(BX(e.formID),{attr:{id:this.props.securityCID}},true,false);if(i)i.value=this.handler.CID;this.exec();var n=BX.delegate(function(){BX.onCustomEvent(e.eventNode,"onUploadsHasBeenChanged",arguments)},this);BX.addCustomEvent(this.handler.agent,"onFileIsInited",n);BX.addCustomEvent(this.handler.agent,"ChangeFileInput",n);BX.onCustomEvent(e.eventNode,"onControllerInitialized",[this.id,t])},this);if(typeof this.handler!="object"||!this.handler)BX.addCustomEvent(e.eventNode,this.events.onInit,this._catchHandler);else this._catchHandler(this.handler);BX.addCustomEvent(e.eventNode,"OnFileUploadSuccess",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){i=i||{};i.usePostfix=true;this.addFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadFailed",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){this.failFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadRemove",BX.delegate(function(e,t){if(this.id==t.CID||this.id==t.id){this.deleteFile(e,{usePostfix:true},t)}},this));BX.addCustomEvent(this,"onFileIsInText",BX.proxy(function(e,t){this.adjustFile(this.checkFile(e),t)},this))},addFile:function(e,t,i){var n=this.checkFile(e.element_id,e,t);if(n){setTimeout(BX.proxy(function(){this.bindFile(n);this.adjustFile(n,false)},this),100);BX.onCustomEvent(this.eventNode,"onFileIsAdded",[n,this,i,t])}else{this.failFile(this,t,i)}return true},failFile:function(e,t,i){BX.onCustomEvent(this.eventNode,"onFileIsFailed",[this,i,t])},checkFile:function(e,t){e=""+(typeof e=="object"?e.id:e);if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(t.place)){var i={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(t.place,true),xmlID:BX(t.place,true).getAttribute("bx-attach-xml-id"),fileID:BX(t.place,true).getAttribute("bx-attach-file-id"),fileType:BX(t.place,true).getAttribute("bx-attach-file-type")},n;if(/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name)&&(n=BX.findChild(i.place,{className:"files-preview",tagName:"IMG"},true,false))&&n){i.type="image/xyz";i.lowsrc=n.src;i.element_url=i.src=n.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight=(\d+)/,"");i.isImage=true;i.width=parseInt(n.getAttribute("data-bx-full-width")||n.getAttribute("data-bx-width"));i.height=parseInt(n.getAttribute("data-bx-full-height")||n.getAttribute("data-bx-height"))}if(i.xmlID)this.xmlToAttach[i.xmlID+""]=e;if(i.fileID)this.fileToAttach[i.fileID+""]=e;this.values[e]=i}return this.values[e]||false},bindFile:function(e){var t=e.place;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){var i=BX.findChild(t,{className:"f-wrap"},true,false),n=BX.findChild(t,{className:"files-preview"},true,false);if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e.id)},this));i.style.cursor="pointer";i.title=BX.message("MPF_FILE")}if(n){BX.bind(n,"click",BX.delegate(function(){this.insertFile(e.id)},this))}}},adjustFile:function(e,t){var i=e.place;if(t===true||t===false){if(!e.info)e.info=BX.findChild(e.place,{className:"files-info"},true,false);i=e.info;if(BX.type.isDomNode(i)){var n="check-in-text-"+e.id,o=BX(n),s=t===false?{attrs:{"bx-file-is-in-text":"N"},props:{className:"insert-btn"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_INSERT_IN_TEXT")+"</span>"}:{attrs:{"bx-file-is-in-text":"Y"},props:{className:"insert-text"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_IN_TEXT")+"</span>"};if(!o){s.attrs.id=n;s.events={click:BX.proxy(function(){this.insertFile(e.id)},this)};i.appendChild(BX.create("SPAN",s))}else{BX.adjust(o,s)}}}},insertFile:function(e){BX.onCustomEvent(this.eventNode,"onFileIsInserted",[this.checkFile(e),this])},deleteFile:function(e,t){e=this.checkFile(e,t);if(e){BX.onCustomEvent(this.eventNode,"onFileIsDeleted",[e,this]);this.values[e.id].place=null;delete this.values[e.id].place;this.values[e.id]=null;delete this.values[e.id];e=null;return true}return false},reinitValues:function(e,t){var i,n,o={};while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("data-bx-title"),size:n.getAttribute("data-bx-size"),sizeInt:n.getAttribute("data-bx-size"),width:n.getAttribute("data-bx-width"),height:n.getAttribute("data-bx-height"),storage:"disk",previewUrl:n.tagName=="A"?"":n.getAttribute("data-bx-src"),fileId:n.getAttribute("bx-attach-file-id")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");if(n.hasAttribute("bx-attach-file-type"))o["E"+i]["fileType"]=n.getAttribute("bx-attach-file-type")}}this.handler.selectFile({},{},o);this.runCheckText()},runCheckText:function(){if(!this._checkText)this._checkText=BX.delegate(this.checkText,this);this.manager.exec(this._checkText)},checkText:function(){var e,t=this.manager.getContent(),i=[],n,o;if(t!=""){e=t;for(o in this.xmlToAttach){if(this.xmlToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]").replace(new RegExp("\\[DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]")}}for(o in this.fileToAttach){if(this.fileToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;"+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]").replace(new RegExp("\\["+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]")}}n=new RegExp("(?:\\&\\#91\\;)("+this.parser["tags"].join("|")+")=([a-z=0-9 ]+)(?:\\&\\#93\\;)","gim");if(n.test(t)){for(o in this.values){if(this.values.hasOwnProperty(o)){i.push(o)}}if(i.length>0){n=new RegExp("(?:\\&\\#91\\;|\\[)("+this.parser["tags"].join("|")+")=("+i.join("|")+")([WIDTHHEIGHT=0-9 ]*)(?:\\&\\#93\\;|\\])","gim");if(n.test(t))t=t.replace(n,BX.delegate(function(e,t,i,n){return"["+t+"="+i+n+"]"},this))}}if(e!=t)BX.onCustomEvent(this.eventNode,"onFileIsDetected",[t,this])}return t},clean:function(){if(this.handler&&this.handler.values){var e,t,i,n=BX(this.manager.formID);while((e=this.handler.values.pop())&&e){BX.remove(e)}if(this.handler.params&&this.handler.params.controlName){t=BX.findChildren(n,{tagName:"INPUT",attribute:{name:this.handler.params.controlName}},true)}if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}}},reinit:function(e,t){var i=[],n,o;for(n in t){if(t.hasOwnProperty(n)){if(t[n]["USER_TYPE_ID"]==this.parserName&&t[n]["VALUE"]){for(o in t[n]["VALUE"]){if(t[n]["VALUE"].hasOwnProperty(o)){i.push(t[n]["VALUE"][o])}}}}}if(i.length>0){this.exec(this.reinitValues,[e,i]);return true}return false}};var o=function(e,t,i){o.superclass.constructor.apply(this,arguments);this.parser=e.parser["webdav_element"]||null;this.node=BX("wduf-selectdialog-"+t);this.manager=e;this.parserName="webdav_element";this.prefixNode="wd-doc";this.prefixHTMLNode="wdif-doc-";this.storage="webdav";this.events={onInit:"WDLoadFormControllerInit",onShow:"WDLoadFormController",onBound:"WDLoadFormControllerWasBound"}};BX.extend(o,n);o.prototype.reinitValues=function(e,t){var i,n,o={};this.waitAnswerFromServer=[];while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("alt"),storage:"webdav",size:n.getAttribute("data-bx-size"),sizeInt:1,ext:"",link:n.getAttribute("data-bx-document")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");this.waitAnswerFromServer.push(i)}}if(this.waitAnswerFromServer.length>0){if(!this._defferCheckText)this._defferCheckText=BX.delegate(this.defferCheckText,this);BX.addCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText);this.handler.WDFD_SelectFile({},{},o)}};o.prototype.defferCheckText=function(e){var t=BX.util.array_search(e.element_id,this.waitAnswerFromServer);if(t>=0){this.runCheckText();this.waitAnswerFromServer=BX.util.deleteFromArray(this.waitAnswerFromServer,t)}if(this.waitAnswerFromServer.length<=0)BX.removeCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText)};var s=function(e,t,i){s.superclass.constructor.apply(this,arguments);this.parser=e.parser["file"]?e.parser["file"]:e.parser["postimage"]["exist"]?e.parser["postimage"]:null;this.postfix=i["postfix"]||"";this.node=BX("file-selectdialog-"+t);this.parserName="file";this.prefixNode="wd-doc";this.prefixHTMLNode="file-doc-";this.props={valueEditClassName:"file-inline-file",securityCID:"upload-cid"};this.storage="bfile";this.events={onInit:"BFileDLoadFormControllerInit",onShow:"BFileDLoadFormController",onBound:"BFileDLoadFormControllerWasBound"}};BX.extend(s,n);s.prototype.initValues=function(e){var t;if(e!==true){t=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(t&&t.length>1){this.exec(this.initValues,[true]);return true}return false}t=this.handler.agent.values||[];var i,n,o,s,a={},r="/bitrix/components/bitrix/main.file.input/file.php?mfi_mode=down&cid="+this.handler.CID+"&sessid="+BX.bitrix_sessid();for(var d=0;d<t.length;d++){s=parseInt(t[d].getAttribute("id").replace(this.prefixNode,""));if(a["id"+s])continue;a["id"+s]="Y";if(s>0){n=BX.findChild(t[d],{className:"f-wrap"},true,false);if(!n)continue;o={element_id:s,element_name:n.innerHTML,parser:this.parser.bxTag,storage:"bfile",element_url:r+"&fileID="+s};i=this.addFile(o,{usePostfix:true,hasPreview:false})}}this.runCheckText();return true};s.prototype.checkFile=function(e,t,i){e=""+(typeof e=="object"?e.id:e);e=e+(i&&i["usePostfix"]===true?this.postfix:"");if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(this.prefixNode+t.element_id,true)){var n={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(this.prefixNode+t.element_id,true)},o;if((t["element_type"]&&t["element_type"].indexOf("image/")===0||/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name))&&((o=BX.findChild(n.place,{tagName:"IMG"},true,false))&&o||i&&i["hasPreview"]===false)){n.type="image/xyz";n.src=t["element_thumbnail"]||t["element_url"];n.isImage=true;n.hasPreview=false;n.lowsrc="";n.width="";n.height="";if(BX(o)){n.hasPreview=true;n.lowsrc=t["element_thumbnail"]||o["src"];n.width=parseInt(o.getAttribute("data-bx-full-width"));n.height=parseInt(o.getAttribute("data-bx-full-height"))}}else if(this.parser.bxTag=="postimage"){return false}if(BX(n.place,true).getAttribute("bx-attach-file-type")){n.fileType=BX(n.place,true).getAttribute("bx-attach-file-type")}this.values[e]=n}return this.values[e]||false};s.prototype.bindFile=function(e){var t=e&&e["place"]?e["place"]:null;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){if(e.isImage&&e.hasPreview){var i=BX.findChild(t,{className:"feed-add-img-title"},true,false),n=BX.findChild(t,{className:"feed-add-img-wrap"},true,false);if(n){BX.bind(n,"click",BX.proxy(function(){this.insertFile(e)},this));n.style.cursor="pointer";n.title=BX.message("MPF_IMAGE")}if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e)},this));i.style.cursor="pointer";i.title=BX.message("MPF_IMAGE")}}else s.superclass.bindFile.apply(this,arguments)}};s.prototype.clean=function(){s.superclass.clean.apply(this,arguments);if(this["handler"]&&this.handler["agent"]&&this.handler.agent["inputName"]){var e,t,i=BX(this.manager.formID);e=BX.findChildren(i,{tagName:"INPUT",attribute:{name:this.handler.agent.inputName+"[]"}},true);if(e){for(t=0;t<e.length;t++){BX.remove(e[t])}}}};var a=function(t,i){this.params=i;this.formID=t;this.showPinButton=!!BX("lhe_button_editor_"+this.formID);if(this.showPinButton){this.params.showPanelEditor=!!this.params.pinEditorPanel}this.oEditorId=i["LHEJsObjId"];this.__divId=i["LHEJsObjName"]||i["LHEJsObjId"];e.handler[this.oEditorId]=this;this.oEditor=a.getEditor(this.oEditorId);this.urlPreview=this.initUrlPreview(i);this.eventNode=BX("div"+this.__divId);BX.addCustomEvent(this.eventNode,"OnShowLHE",BX.delegate(this.OnShowLHE,this));BX.addCustomEvent(this.eventNode,"OnButtonClick",BX.delegate(this.OnButtonClick,this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",function(e,t){if(t.oEditor&&t.oEditor["AllowBeforeUnloadHandler"])t.oEditor.AllowBeforeUnloadHandler();if(t.monitoringWakeUp===true)t.monitoringStart()});BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",function(e,t){t.monitoringWakeUp=t.monitoringStop();if(t.oEditor&&t.oEditor["DenyBeforeUnloadHandler"])t.oEditor.DenyBeforeUnloadHandler()});this.initParsers(i);this.initFiles(t,i);BX.ready(BX.delegate(function(){if(BX("lhe_button_submit_"+t,true)){BX.bind(BX("lhe_button_submit_"+t,true),"mousedown",function(){BX.addClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_submit_"+t,true),"mouseup",function(){BX.removeClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_submit_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["submit"]);return BX.PreventDefault(e)},this))}if(BX("lhe_button_cancel_"+t,true)){BX.bind(BX("lhe_button_cancel_"+t,true),"mousedown",function(){BX.addClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_cancel_"+t,true),"mouseup",function(){BX.removeClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_cancel_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["cancel"]);return BX.PreventDefault(e)},this))}},this));this.inited=true;BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){e.FORM.setAttribute("bx-lhe-autosave-prepared","Y")});BX.onCustomEvent(this,"onInitialized",[this,t,i,this.parsers]);BX.onCustomEvent(this.eventNode,"onInitialized",[this,t,i,this.parsers]);if(this.oEditor&&this.oEditor.inited&&!this.oEditor["__lhe_flags"]){BX.onCustomEvent(this.oEditor,"OnEditorInitedBefore",[this.oEditor]);BX.onCustomEvent(this.oEditor,"OnEditorInitedAfter",[this.oEditor,true])}};a.prototype={editorIsLoaded:false,arFiles:{},parser:{},controllers:{},exec:function(e,t){this.functionsToExec=this.functionsToExec||[];if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.editorIsLoaded===true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},initParsers:function(e){this.parser={postimage:{exist:false,bxTag:"postimage",tag:"IMG ID",tags:["IMG ID"],regexp:/\[(IMG ID)=((?:\s|\S)*?)(?:\s*?WIDTH=(\d+)\s*?HEIGHT=(\d+))?\]/gi,code:"[IMG ID=#ID##ADDITIONAL#]",wysiwyg:'<img id="#ID#" src="'+'#SRC#" lowsrc="'+'#LOWSRC#" title=""#ADDITIONAL# />'},player:{exist:false,bxTag:"player",tag:"FILE ID",tags:["FILE ID"],regexp:/\[(FILE ID)=((?:\s|\S)*?)?\]/gi,code:"[FILE ID=#ID##ADDITIONAL#]",wysiwyg:'<img class="bxhtmled-player-surrogate" id="#ID#" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" contenteditable="false" title=""#ADDITIONAL# />'}};var t=e["parsers"]?e["parsers"]:{};for(var n in t){if(t.hasOwnProperty(n)&&/[a-z]/gi.test(n+"")){this.parser[n]=new i(n,t[n])}}if(BX.util.object_search("UploadImage",t)){this.parser["postimage"]["exist"]=true}if(typeof e["arSize"]=="object"){var o="";if(e["arSize"]["width"])o+="max-width:"+e["arSize"]["width"]+"px;";if(e["arSize"]["height"])o+="max-height:"+e["arSize"]["height"]+"px;";if(o!=="")this.parser["postimage"]["wysiwyg"]=this.parser["postimage"]["wysiwyg"].replace("#ADDITIONAL#",' style="'+o+'" #ADDITIONAL#')}},initFiles:function(e,t){this.arFiles={};this.controllers={common:{postfix:"",storage:"bfile",parser:"postimage",node:window,obj:null,init:false}};if(!t["CID"]||typeof t["CID"]!=="object")return;BX.addCustomEvent(this.eventNode,"onFileIsAdded",BX.delegate(this.OnFileUploadSuccess,this));BX.addCustomEvent(this.eventNode,"onFileIsFailed",BX.delegate(this.OnFileUploadFailed,this));BX.addCustomEvent(this.eventNode,"onFileIsDeleted",BX.delegate(this.OnFileUploadRemove,this));BX.addCustomEvent(this.eventNode,"onFileIsDetected",BX.delegate(this.setContent,this));BX.addCustomEvent(this.eventNode,"onFileIsInserted",BX.delegate(this.insertFile,this));var i,a,r;for(a in t["CID"]){if(t["CID"].hasOwnProperty(a)){i=t["CID"][a]["parser"];if(i=="disk_file")this.controllers[a]=new n(this,a,t["CID"][a]);else if(i=="webdav_element")this.controllers[a]=new o(this,a,t["CID"][a]);else if(i=="file")this.controllers[a]=new s(this,a,t["CID"][a]);if(this.controllers[a]&&this.controllers[a].init()&&!r)r=true}}BX.ready(BX.delegate(function(){BX.bind(BX("bx-b-uploadfile-"+e),"click",BX.proxy(this.controllerInit,this));if(r)this.controllerInit("show")},this))},controllerInit:function(e){this.controllerInitStatus=e=="show"||e=="hide"?e:this.controllerInitStatus=="show"?"hide":"show";BX.onCustomEvent(this.eventNode,"onShowControllers",[this.controllerInitStatus])},initUrlPreview:function(){if(this.params["urlPreviewId"]&&window["BXUrlPreview"]&&BX(this.params["urlPreviewId"])){return new BXUrlPreview(BX(this.params["urlPreviewId"]))}return null},getContent:function(){return this.oEditor?this.oEditor.GetContent():""},setContent:function(e){if(this.oEditor)this.oEditor.SetContent(e)},OnFileUploadSuccess:function(e,t,i,n){if(this.controllers[t.id]){var o=t.parser.bxTag+e.id;this.arFiles[o]=this.arFiles[o]||[];this.arFiles[o].push(t.id);if(n&&n["referrerToEditor"]){var s=this.getFileToInsert(e,t);BX.onCustomEvent(n["referrerToEditor"],"OnImageDataUriCaughtUploaded",[s]);BX.onCustomEvent(this.oEditor,"OnImageDataUriCaughtUploaded",[n["referrerToEditor"],e,s])}else if(i===true&&e.isImage&&this.insertImageAfterUpload){if(!this._insertFile)this._insertFile=BX.delegate(this.insertFile,this);this.exec(this._insertFile,arguments)}}},OnFileUploadFailed:function(e,t,i){if(i&&i["referrerToEditor"]){BX.onCustomEvent(i["referrerToEditor"],"OnImageDataUriCaughtFailed",[]);BX.onCustomEvent(this.editor,"OnImageDataUriCaughtFailed",[i["referrerToEditor"]])}},OnFileUploadRemove:function(e,t){if(this.controllers[t.id]){var i=t.parser.bxTag+e.id;if(this.arFiles[i]){var n=BX.util.array_search(t.id,this.arFiles[i]);this.arFiles[i]=BX.util.deleteFromArray(this.arFiles[i],n);if(!this.arFiles[i]||this.arFiles[i].length<=0){this.arFiles[i]=null;delete this.arFiles[i];if(!this._deleteFile)this._deleteFile=BX.delegate(this.deleteFile,this);this.exec(this._deleteFile,arguments)}}}},showPanelEditor:function(e,t){if(e==undefined)e=!this.oEditor.toolbar.IsShown();this.params.showPanelEditor=e;var i=BX("lhe_button_editor_"+this.formID),n=BX("panel-close"+this.__divId);if(n){this.oEditor.dom.cont.appendChild(n)}if(e){this.oEditor.dom.toolbarCont.style.opacity="inherit";this.oEditor.toolbar.Show();if(i)BX.addClass(i,"feed-add-post-form-btn-active");if(n)n.style.display=""}else{this.oEditor.toolbar.Hide();if(i)BX.removeClass(i,"feed-add-post-form-btn-active");if(n)n.style.display="none"}if(t!==false)BX.userOptions.save("main.post.form","postEdit","showBBCode",e?"Y":"N")},monitoring:{interval:null,text:"",savedText:"",files:[],savedFiles:[]},monitoringStart:function(){if(this.monitoring.interval===null){if(!this._monitoringStart){this._monitoringStart=BX.delegate(this.checkFilesInText,this);BX.addCustomEvent(this.oEditor,"OnContentChanged",BX.proxy(function(e){this.monitoring.text=e},this))}this.monitoring.interval=setInterval(this._monitoringStart,1e3)}},monitoringStop:function(){var e=this.monitoring.interval!==null;if(this.monitoring.interval!==null)clearInterval(this.monitoring.interval);this.monitoring.interval=null;return e},monitoringSetStatus:function(e,t,i){if(this.arFiles[e+t]){var n;for(var o=0;o<this.arFiles[e+t].length;o++){n=this.arFiles[e+t][o];BX.onCustomEvent(this.controllers[n],"onFileIsInText",[t,i])}}},checkFilesInText:function(){if(this.monitoring.text!==this.monitoring.savedText){this.monitoring.savedText=this.monitoring.text;this.monitoring.files=[];var e=this.monitoring.savedText,t,i=function(e,t){return function(i,n,o){e.monitoring.files.push([t,o].join("/"))}};for(t in this.parser){if(this.parser.hasOwnProperty(t)){if(!this.parser[t]["checkFilesInText"]){this.parser[t]["checkFilesInText"]=i(this,t)}e.replace(this.parser[t]["regexp"],this.parser[t]["checkFilesInText"])}}if(this.monitoring.savedFiles.join(",")!==this.monitoring.files.join(",")){var n={},o;while(o=this.monitoring.savedFiles.pop()){n[o]=null}for(t=0;t<this.monitoring.files.length;t++){o=this.monitoring.files[t];n[o]=n[o]>=0?n[o]+1:1}for(t in n){if(n.hasOwnProperty(t)){o=t.split("/");this.monitoringSetStatus(o[0],o[1],n[t]>0)}}}this.monitoring.savedFiles=this.monitoring.files;if(this.monitoring.savedFiles.length<=0)this.monitoringStop()}},checkFile:function(e,t){var i=false;if(typeof e=="string"){var n=typeof t=="string"?t:t.parser;if(!!this.arFiles[n+e]){var o=this.arFiles[n+e][0];t=this.controllers[o];i={file:t.values[e],controller:t}}}else if(this.controllers[t.id]){i={file:e,controller:t}}return i},insertFile:function(e,t){var i=this.oEditor;if(i&&e){var n=i.GetViewMode(),o=this.getFileToInsert(e,t);if(n=="wysiwyg"){i.InsertHtml(o.replacement);setTimeout(BX.delegate(i.AutoResizeSceleton,i),500);setTimeout(BX.delegate(i.AutoResizeSceleton,i),1e3)}else if(n=="code"&&i.bbCode){i.textareaView.Focus();i.textareaView.WrapWith(false,false,o.replacement)}o["callback"]()}},getFileToInsert:function(e,t){var i=this.oEditor;if(i&&e){var n=e["id"],o="",s=t.parser,a=i.GetViewMode(),r=this.parser[s.bxTag][a];if(e["fileType"]&&this.parser[e["fileType"]]&&a=="wysiwyg"){r=this.parser[e["fileType"]][a]}if(e["isImage"]){r=a=="wysiwyg"?this.parser["postimage"][a]:r;if(e.width>0&&e.height>0&&i.sEditorMode=="html"){o=' style="width:'+e.width+"px;height:"+e.height+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}if(a=="wysiwyg"){r=r.replace("#ID#",i.SetBxTag(false,{tag:s.bxTag,params:{value:n}})).replace("#SRC#",e.src).replace("#URL#",e.url).replace("#LOWSRC#",e.lowsrc||"").replace("#NAME#",e.name).replace("#ADDITIONAL#",o)+"<span>&nbsp;</span>"}else if(a=="code"&&i.bbCode){r=r.replace("#ID#",n).replace("#ADDITIONAL#","")}return{replacement:r,callback:BX.proxy(function(){this.monitoringSetStatus(t.parser.bxTag,e.id,true);this.monitoringStart()},this)}}return{replacement:"",callback:BX.DoNothing}},deleteFile:function(e,t){var i=this.oEditor,n=t.parser,o=e.id,s=i.GetContent();if(n&&s.indexOf("="+o)>=0){if(i.GetViewMode()=="wysiwyg"){var a=i.GetIframeDoc(),r,d;for(r in i["bxTags"]){if(i["bxTags"].hasOwnProperty(r)){if(typeof i.bxTags[r]=="object"&&i.bxTags[r]["params"]&&i.bxTags[r]["params"]["value"]==e.id){d=a.getElementById(r);if(d)d.parentNode.removeChild(d)}}}i.SaveContent()}else{s=s.replace(n.regexp,function(t,i,n){return n==e.id?"":t});i.SetContent(s);i.Focus()}this.monitoringSetStatus(n.bxTag,e.id,false)}},reinit:function(e,t){BX.onCustomEvent(this.eventNode,"onReinitializeBefore",[this,e,t]);this.arFiles={};delete this.monitoringWakeUp;this.monitoringStop();this.oEditor.CheckAndReInit(e||"");BX.onCustomEvent(this.eventNode,"onReinitialize",[this,e,t]);var i,n=false;for(i in this.controllers){if(this.controllers.hasOwnProperty(i)){if(this.controllers[i]["init"]&&this.controllers[i].reinit(e,t))n=true}}this.controllerInit(n?"show":"hide");if(this.params["~height"]){this.oEditor.SetConfigHeight(this.params["~height"]);this.oEditor.ResizeSceleton()}if(this.urlPreview){this.urlPreview.detachUrlPreview();var o;for(var s in t){if(t.hasOwnProperty(s)&&t[s].hasOwnProperty("USER_TYPE_ID")&&t[s]["USER_TYPE_ID"]==="url_preview"){o=t[s]["VALUE"]}}if(o)this.urlPreview.attachUrlPreview({id:o})}},Parse:function(e,t,i){var n=this.parser[e],o=this;if(n){t=t.replace(n.regexp,function(t,s,a,r,d){var l=o.checkFile(a,e);if(l&&(l=l.file)&&l){var h="",f=l.isImage?o.parser.postimage.wysiwyg:n.wysiwyg;o.monitoringStart();if(l.fileType&&o.parser[l.fileType]&&o.parser[l.fileType].wysiwyg){f=o.parser[l.fileType].wysiwyg}if(l.isImage){r=parseInt(r);d=parseInt(d);h=r&&d?' width="'+r+'" height="'+d+'"':"";if(h===""&&l["width"]>0&&l["height"]>0){h=' style="width:'+l["width"]+"px;height:"+l["height"]+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}return f.replace("#ID#",i.SetBxTag(false,{tag:e,params:{value:a}})).replace("#NAME#",l.name).replace("#SRC#",l.src).replace("#LOWSRC#",l.lowsrc).replace("#ADDITIONAL#",h).replace("#WIDTH#",parseInt(r)).replace("#HEIGHT#",parseInt(d))}return t})}return t},Unparse:function(e,t){var i="",n=e.tag;if(this.parser[n]){var o=parseInt(t.node.hasAttribute("width")?t.node.getAttribute("width"):0),s=parseInt(t.node.hasAttribute("height")?t.node.getAttribute("height"):0),a="";if(o>0&&s>0){a=" WIDTH="+o+" HEIGHT="+s}i=this.parser[n]["code"].replace("#ID#",e.params.value).replace("#ADDITIONAL#",a).replace("#WIDTH#",o).replace("#HEIGHT#",s)}return i},OnShowLHE:function(e,t,i){var n=this.__divId;e=e===false?false:e==="hide"?"hide":e==="justShow"?"justShow":true;this.oEditor=this.oEditor||a.getEditor(this.oEditorId);if(!this.oEditor)return;this.oEditor.Init();var o=BX("micro"+n),s=this.eventNode;if(o){o.style.display=e===true||e==="justShow"?"none":"block"}if(e=="hide"){BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);if(this.eventNode.style.display=="none"){BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.eventNode.scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.height=e.height+"px";s.style.opacity=e.opacity/100},complete:BX.proxy(function(){this.eventNode.style.cssText="";this.eventNode.style.display="none";BX.onCustomEvent(s,"OnAfterHideLHE",[e,this])},this)}).animate()}}else if(e){BX.onCustomEvent(this.eventNode,"OnBeforeShowLHE",[e,this]);if(e=="justShow"){this.eventNode.style.display="block";BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else if(this.eventNode.style.display=="block"){BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else{BX.adjust(this.eventNode,{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:s.scrollHeight},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.height=e.height+"px";s.style.opacity=e.opacity/100},complete:BX.proxy(function(){BX.onCustomEvent(s,"OnAfterShowLHE",[e,this]);this.oEditor.Focus();this.eventNode.style.cssText=""},this)}).animate()}}else{BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);this.eventNode.style.display="none";BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}},OnButtonClick:function(e){if(e!=="cancel"){var t={result:true};BX.onCustomEvent(this.eventNode,"OnClickBeforeSubmit",[this,t]);if(t["result"]!==false)BX.onCustomEvent(this.eventNode,"OnClickSubmit",[this])}else{BX.onCustomEvent(this.eventNode,"OnClickCancel",[this]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["hide"])}},OnEditorInitedBefore:function(e){var t=this;this.oEditor=e;e.formID=this.formID;if(this.params)this.params["~height"]=e.config["height"];BX.addCustomEvent(e,"OnCtrlEnter",function(){e.SaveContent();if(t.params&&t.params["ctrlEnterHandler"]&&typeof window[t.params["ctrlEnterHandler"]]=="function")window[t.params["ctrlEnterHandler"]]();else BX.submit(BX(t.formID))});var i=this.params.parsers?this.params.parsers:[];if(BX.util.object_search("Spoiler",i)){e.AddButton({id:"spoiler",name:BX.message("spoilerText"),iconClassName:"spoiler",disabledForTextarea:false,src:BX.message("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.png",toolbarSort:205,handler:function(){var e=this,t=false;if(!e.editor.bbCode||!e.editor.synchro.IsFocusedOnTextarea()){t=e.editor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=e.editor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}});e.AddParser({name:"spoiler",obj:{Parse:function(e,t,i){if(/\[(cut|spoiler)(([^\]])*)\]/gi.test(t)){t=t.replace(/[\001-\006]/gi,"").replace(/\[cut(((?:=)[^\]]*)|)\]/gi,"$1").replace(/\[\/cut]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"$1").replace(/\[\/spoiler]/gi,"");var n=/(?:\001([^\001]*)\001)([^\001-\004]+)\002/gi,o=/(?:\003([^\003]*)\003)([^\001-\004]+)\004/gi,s=function(e,t){e=e.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'+i.SetBxTag(false,{tag:"spoiler"})+'" title="'+e+'">'+t+"</blockquote>"},a=function(e,t,i){return s(t,i)};while(t.match(n)||t.match(o)){t=t.replace(n,a).replace(o,a)}}t=t.replace(/\001([^\001]*)\001/gi,"[cut$1]").replace(/\003([^\003]*)\003/gi,"[spoiler$1]").replace(/\002/gi,"[/cut]").replace(/\004/gi,"[/spoiler]");return t},UnParse:function(t,i){if(t.tag=="spoiler"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}})}if(BX.util.object_search("MentionUser",i)){e.AddParser({name:"postuser",obj:{Parse:function(t,i){i=i.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(t,i,n){n=BX.util.trim(n);if(n=="")return"";return'<span id="'+e.SetBxTag(false,{tag:"postuser",params:{value:parseInt(i)}})+'" class="bxhtmled-metion">'+n+"</span>"});return i},UnParse:function(t,i){if(t.tag=="postuser"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[USER="+t.params.value+"]"+n+"[/USER]"}return""}}})}var n=function(i,n){return t.Parse(i,n,e)},o=function(e,i){return t.Unparse(e,i)};for(var s in this.parser){if(this.parser.hasOwnProperty(s)){e.AddParser({name:s,obj:{Parse:n,UnParse:o}})}}if(this.showPinButton){this.pinEditorPanel=this.params&&this.params.pinEditorPanel===true;var a="toolbar_pin";var r=function(e,i){r.superclass.constructor.apply(this,arguments);this.id=a;this.title=BX.message("MPF_PIN_EDITOR_PANNEL");this.className+=" "+(t.pinEditorPanel?"bxhtmled-button-toolbar-pined":"bxhtmled-button-toolbar-pin");this.Create();if(i)i.appendChild(this.GetCont())};BX.extend(r,window.BXHtmlEditor.Button);r.prototype.OnClick=function(){BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pined");BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pin");if(t.pinEditorPanel){t.pinEditorPanel=false;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pin")}else{t.pinEditorPanel=true;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pined")}BX.userOptions.save("main.post.form","postEdit","pinEditorPanel",t.pinEditorPanel?"Y":"N")};window.BXHtmlEditor.Controls[a]=r;BX.addCustomEvent(e,"GetControlsMap",function(e){e.push({id:a,compact:true,hidden:false,sort:500,checkWidth:true,offsetWidth:32,wrap:"right"})})}},OnEditorInitedAfter:function(t){BX.addCustomEvent(t,"OnIframeDrop",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDrop",arguments)},this));BX.addCustomEvent(t,"OnIframeDragOver",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragOver",arguments)},this));BX.addCustomEvent(t,"OnIframeDragLeave",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragLeave",arguments)},this));BX.addCustomEvent(t,"OnImageDataUriHandle",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnImageDataUriHandle",arguments)},this));BX.addCustomEvent(t,"OnAfterUrlConvert",this.OnAfterUrlConvert.bind(this));BX.addCustomEvent(t,"OnBeforeCommandExec",this.OnBeforeCommandExec.bind(this));t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:BX.message("BXEdDelFromText"),bbMode:true,ACTION:function(){var e=t.contextMenu.GetTargetItem("postimage");if(!e)e=t.contextMenu.GetTargetItem("postdocument");if(!e)e=t.contextMenu.GetTargetItem("postfile");if(e&&e.element){t.selection.RemoveNode(e.element)}t.contextMenu.Hide()}}];if(!this.params["lazyLoad"]){BX.onCustomEvent(this.eventNode,"OnShowLHE",["justShow",t,false])}if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){var i=e;setTimeout(function(){BX.addCustomEvent(t,"OnContentChanged",BX.proxy(function(e){this["mpfTextContent"]=e;this.Init()},i))},1500)});BX.addCustomEvent(BX(this.formID),"onAutoSave",BX.proxy(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"+this.formID]=e["mpfTextContent"]},this));BX.addCustomEvent(BX(this.formID),"onAutoSaveRestore",BX.proxy(function(i,n){if(e.handler[t.id]){for(var o in e.handler[t.id].controllers){if(e.handler[t.id].controllers.hasOwnProperty(o)&&e.handler[t.id].controllers[o].handler&&e.handler[t.id].controllers[o].handler.params&&e.handler[t.id].controllers[o].handler.params.controlName&&e.handler[t.id].controllers[o].handler.params.controlName){delete n[e.handler[t.id].controllers[o].handler.params.controlName]}}}if(n["text"+this.formID]&&/[^\s]+/gi.test(n["text"+this.formID])){t.CheckAndReInit(n["text"+this.formID])}},this));if(BX(this.formID)&&BX(this.formID).hasAttribute("bx-lhe-autosave-prepared")&&BX(this.formID).BXAUTOSAVE){BX(this.formID).removeAttribute("bx-lhe-autosave-prepared");setTimeout(BX.proxy(function(){BX(this.formID).BXAUTOSAVE.Prepare()},this),100)}var i=this.formID,n=this.params;this.showPanelEditor(n.showPanelEditor,false);if(!t.mainPostFormCustomized){t.mainPostFormCustomized=true;BX.addCustomEvent(t,"OnIframeKeydown",function(e){if(window.onKeyDownHandler){window.onKeyDownHandler(e,t,i)}});BX.addCustomEvent(t,"OnIframeKeyup",function(e){if(window.onKeyUpHandler){window.onKeyUpHandler(e,t,i)}});if(window["BXfpdStopMent"+i]){BX.addCustomEvent(t,"OnIframeClick",function(){window["BXfpdStopMent"+i]()})}if(t&&t.textareaView.GetCursorPosition){BX.addCustomEvent(t,"OnTextareaKeyup",function(e){if(window.onTextareaKeyUpHandler){window.onTextareaKeyUpHandler(e,t,i)}});BX.addCustomEvent(t,"OnTextareaKeydown",function(e){if(window.onTextareaKeyDownHandler){window.onTextareaKeyDownHandler(e,t,i)}})}}},OnAfterUrlConvert:function(e){if(this.urlPreview){this.urlPreview.attachUrlPreview({url:e})}},OnBeforeCommandExec:function(e,t,i,n){if(this.urlPreview&&t=="createLink"&&BX.type.isPlainObject(n)&&n.hasOwnProperty("href")){this.urlPreview.attachUrlPreview({url:n.href})}}};a.getEditor=function(e){return window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(typeof e=="object"?e.id:e):null};a.getHandler=function(t){return e.handler[typeof t=="object"?t.id:t]};a.unsetHandler=function(t){var i=typeof t=="object"?t.id:t;if(!e.handler[i])return;if(e.handler[i].oEditor)e.handler[i].oEditor.Destroy();e.handler[i]=null};a.reinitData=function(e,t,i){var n=a.getHandler(e);if(n)n.exec(n.reinit,[t,i]);return false};a.reinitDataBefore=function(e){var t=a.getHandler(e);if(t&&t["eventNode"])BX.onCustomEvent(t.eventNode,"onReinitializeBefore",[t])};window.LHEPostForm=a;window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var o=BX.util.trim(t[n]);if(o.length>0){var s=this.hiddenField.value.split(",");if(!BX.util.in_array(o,s)){var a;var r=BX.create("span",{children:[a=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});r.insertBefore(document.createTextNode(o),a);this.tagsContainer.insertBefore(r,this.addNewLink);BX.bind(a,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:r,tagValue:o}));this.hiddenField.value+=o+",";i.push(o)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy(function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)},this));BX.bind(this.activeBlock,"click",BX.proxy(function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)},this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var r=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"feed-add-button-load");r=e;BX.defer(function(){e.disabled=true})()}};window.MPFbuttonCloseWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||r||this;if(e){e.disabled=false;BX.removeClass(e,"feed-add-button-load");r=null}};window.__mpf_wd_getinfofromnode=function(e,t){var i=BX.findChild(BX((e["prefixNode"]||"wd-doc")+e.element_id),{className:"files-preview",tagName:"IMG"},true,false);if(i){e.lowsrc=i.src;e.element_url=i.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight\=(\d+)/,"");e.width=parseInt(i.getAttribute("data-bx-full-width"));e.height=parseInt(i.getAttribute("data-bx-full-height"))}else if(t.urlGet){e.element_url=t.urlGet.replace("#element_id#",e.element_id).replace("#ELEMENT_ID#",e.element_id).replace("#element_name#",e.element_name).replace("#ELEMENT_NAME#",e.element_name)}};var d={listen:false,plus:false,text:"",bSearch:false};window.BXfpdSelectCallback=function(e,t,i,n,o,s){BX.SocNetLogDestination.BXfpSelectCallback({item:e,type:t,bUndeleted:n,containerInput:BX("feed-add-post-destination-item"),valueInput:BX("feed-add-post-destination-input"),formName:o,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2"),state:typeof s!="undefined"?s:null})};window.BXfpdUnSelectCallback=function(e,t,i,n){BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:n,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")},e)};window.BXfpdOpenDialogCallback=function(e){BX.SocNetLogDestination.BXfpOpenDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseDialogCallback=function(e){BX.SocNetLogDestination.BXfpCloseDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseSearchCallback=function(e){BX.SocNetLogDestination.BXfpCloseSearchCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.onKeyDownHandler=function(e,t,i){var n=e.keyCode;if(!window["BXfpdStopMent"+i])return true;if(n==107||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(n,[187,50,107,43,61])||e.altKey&&BX.util.in_array(n,[76])){setTimeout(function(){var e=t.selection.GetRange(),n=t.GetIframeDoc(),o=e?e.endContainer.textContent:"",s=o?o.slice(e.endOffset-1,e.endOffset):"",a=o?o.slice(e.endOffset-2,e.endOffset-1):"";if((s=="@"||s=="+")&&(!a||BX.util.in_array(a,["+","@",",","("])||a.length==1&&BX.util.trim(a)==="")){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=true;e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);var r=BX.create("SPAN",{props:{id:"bx-mention-node"}},n);t.selection.Surround(r,e);e.setStart(r,1);e.setEnd(r,1);t.selection.SetSelection(e);if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}}},10)}if(d.listen){var o=d.bSearch?"search":BX.SocNetLogDestination.obTabSelected[window["BXSocNetLogDestinationFormNameMent"+i]];if(n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i]);t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["left"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"left");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["right"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"right");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["up"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"up");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["down"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"down");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}}if(!d.listen&&d.listenFlag&&n===t.KEY_CODES["enter"]){var s=t.selection.GetRange();if(s.collapsed){var a=s.endContainer,r=t.GetIframeDoc();if(a){if(a.className!=="bxhtmled-metion"){a=BX.findParent(a,function(e){return e.className=="bxhtmled-metion"},r.body)}if(a&&a.className=="bxhtmled-metion"){t.selection.SetAfter(a)}}}}};window.onKeyUpHandler=function(e,t,i){var n=e.keyCode,o,s,a;if(!window["BXfpdStopMent"+i])return true;if(d.listen===true){if(n==t.KEY_CODES["escape"]){window["BXfpdStopMent"+i]()}else if(n!==t.KEY_CODES["enter"]&&n!==t.KEY_CODES["left"]&&n!==t.KEY_CODES["right"]&&n!==t.KEY_CODES["up"]&&n!==t.KEY_CODES["down"]){o=t.GetIframeDoc();var r=o.getElementById("bx-mention-node");if(r){a=BX.util.trim(t.util.GetTextContent(r));var h=a;a=a.replace(/^[\+@]*/,"");d.bSearch=a.length>0;BX.SocNetLogDestination.search(a,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"),{bindNode:l(r,t)});if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&a===""){d.bSearch=false;window["BXfpdStopMent"+i]();BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}d.lastText=a;d._lastText=h}else{window["BXfpdStopMent"+i]()}}}else{if(!e.shiftKey&&(n===t.KEY_CODES["space"]||n===t.KEY_CODES["escape"]||n===188||n===190)){s=t.selection.GetRange();if(s.collapsed){var f=s.endContainer;o=t.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},o.body)}if(f&&f.className=="bxhtmled-metion"){a=t.util.GetTextContent(f);var u=a.match(/[\s\.\,]$/);if(u||n===t.KEY_CODES["escape"]){f.innerHTML=a.replace(/[\s\.\,]$/,"");var c=BX.create("SPAN",{html:u||t.INVISIBLE_SPACE},o);t.util.InsertAfter(c,f);t.selection.SetAfter(c)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,i){var n=e.keyCode;if(d.listen&&n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectFirstSearchItem(window["BXSocNetLogDestinationFormNameMent"+i]);t.textareaKeyDownPreventDefault=true;BX.PreventDefault(e)}};window.onTextareaKeyUpHandler=function(e,t,i){var n,o,s=e.keyCode;if(d.listen===true){if(s==27){window["BXfpdStopMent"+i]()}else if(s!==13){o=t.textareaView.GetValue(false);n=t.textareaView.GetCursorPosition();if(o.indexOf("+")!==-1||o.indexOf("@")!==-1){var a=o.substr(0,n),r=Math.max(a.lastIndexOf("+"),a.lastIndexOf("@"));if(r>=0){var l=a.substr(r),h=l;l=l.replace(/^[\+@]*/,"");if(BX.SocNetLogDestination&&!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.bSearch=l.length>0;if(BX.SocNetLogDestination)BX.SocNetLogDestination.search(l,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"));if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&l===""){window["BXfpdStopMent"+i]();if(BX.SocNetLogDestination)BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.lastText=l;d._lastText=h}}}}else{if(s==16){var f=this;this.shiftPressed=true;if(this.shiftTimeout)this.shiftTimeout=clearTimeout(this.shiftTimeout);this.shiftTimeout=setTimeout(function(){f.shiftPressed=false},100)}if(s==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(s,[187,50,107,43,61])){n=t.textareaView.element.selectionStart;if(n>0){o=t.textareaView.element.value;var u=o.substr(n-1,1);if(u&&(u==="+"||u==="@")){d.listen=true;d.listenFlag=true;d.text="";d.textarea=true;if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}}}}}};var l=function(e,t){var i=BX.pos(e),n=BX.pos(t.dom.areaCont),o=BX.GetWindowScrollPos(t.GetIframeDoc()),s=n.top+i.bottom-o.scrollTop+2,a=n.left+i.right-o.scrollLeft;return{top:s,left:a}};window.BxInsertMention=function(e){var t=e.item,i=e.type,n=e.formID,o=e.editorId,s=e.bNeedComa,r=a.getEditor(o),l;if(i=="users"&&t&&t.entityId>0&&r){if(r.GetViewMode()=="wysiwyg"){var h=r.GetIframeDoc(),f=r.selection.GetRange(),u=h.getElementById("bx-mention-node"),c=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},h);l=BX.create("SPAN",{html:s?",&nbsp;":"&nbsp;"},h);r.SetBxTag(c,{tag:"postuser",params:{value:t.entityId}});if(u){r.util.ReplaceNode(u,c)}else{r.selection.InsertNode(c,f)}if(c&&c.parentNode){var p=BX.findParent(c,{className:"bxhtmled-metion"},h.body);if(p){r.util.InsertAfter(c,p)}}if(c&&c.parentNode){r.util.InsertAfter(l,c);r.selection.SetAfter(l)}}else if(r.GetViewMode()=="code"&&r.bbCode){r.textareaView.Focus();var m=r.textareaView.GetValue(false),B=r.textareaView.GetCursorPosition(),g=m.substr(0,B),X=Math.max(g.lastIndexOf("+"),g.lastIndexOf("@"));if(X>=0&&B>X){r.textareaView.SetValue(m.substr(0,X)+m.substr(B));r.textareaView.element.setSelectionRange(X,X)}r.textareaView.WrapWith(false,false,"[USER="+t.entityId+"]"+t.name+"[/USER]"+(s?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t])}delete BX.SocNetLogDestination.obItemsSelected[window["BXSocNetLogDestinationFormNameMent"+n]][t.id];window["BXfpdStopMent"+n]();d["text"]="";if(r.GetViewMode()=="wysiwyg"){r.Focus();r.selection.SetAfter(l)}}};window.MPFMentionInit=function(e,t){if(!t["items"]["departmentRelation"]){t["items"]["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["department"])}window["departmentRelation"]=t["items"]["departmentRelation"];if(t.initDestination===true){window.BXSocNetLogDestinationFormName="destination"+(""+(new Date).getTime()).substr(6);window.BXSocNetLogDestinationDisableBackspace=null;BX.SocNetLogDestination.init({name:window.BXSocNetLogDestinationFormName,searchInput:BX("feed-add-post-destination-input"),extranetUser:t["extranetUser"],bindMainPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},callback:{select:window.BXfpdSelectCallback,unSelect:BX.delegate(BX.SocNetLogDestination.BXfpUnSelectCallback,{formName:window.BXSocNetLogDestinationFormName,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")}),openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})},items:t["items"],itemsLast:t["itemsLast"],itemsSelected:t["itemsSelected"],isCrmFeed:t["isCrmFeed"],useClientDatabase:!!t["useClientDatabase"],destSort:t["destSort"],allowAddUser:t["allowAddUser"],allowAddCrmContact:t["allowAddCrmContact"],allowSearchCrmEmailUsers:typeof t["allowSearchCrmEmailUsers"]!="undefined"?!!t["allowSearchCrmEmailUsers"]:false,userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",allowSonetGroupsAjaxSearch:typeof t["allowSonetGroupsAjaxSearch"]!="undefined"?t["allowSonetGroupsAjaxSearch"]:false,allowSonetGroupsAjaxSearchFeatures:typeof t["allowSonetGroupsAjaxSearchFeatures"]!="undefined"?t["allowSonetGroupsAjaxSearchFeatures"]:{},showVacations:true,usersVacation:typeof t["usersVacation"]!="undefined"?t["usersVacation"]:{}});BX.bind(BX("feed-add-post-destination-input"),"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}));BX.bind(BX("feed-add-post-destination-input"),"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",onPasteEvent:true}));BX.bind(BX("feed-add-post-destination-input"),"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input"}));BX.bind(BX("feed-add-post-destination-input"),"blur",BX.delegate(BX.SocNetLogDestination.BXfpBlurInput,{inputBoxName:"feed-add-post-destination-input-box",tagInputName:"bx-destination-tag"}));BX.bind(BX("bx-destination-tag"),"focus",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName,{bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(BX("feed-add-post-destination-container"),"click",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName);return BX.PreventDefault(e)});BX.addCustomEvent(window,"onMentionAdd",function(e){if(!BX.type.isPlainObject(BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id])){BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id]=e}BX.addCustomEvent(window,"BX.SocNetLogDestination:onBeforeSelectItemFocus",function(e){if(e.id==window.BXSocNetLogDestinationFormName){e.blockFocus=true}});if(typeof BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]=="undefined"||!BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]){BX.SocNetLogDestination.selectItem(window.BXSocNetLogDestinationFormName,null,null,e.id,"users",false)}});if(t["itemsHidden"]){for(var i in t["itemsHidden"]){if(t["itemsHidden"].hasOwnProperty(i)){window.BXfpdSelectCallback({id:(typeof t["itemsHidden"][i]["PREFIX"]!="undefined"?t["itemsHidden"][i]["PREFIX"]:"SG")+t["itemsHidden"][i]["ID"],name:t["itemsHidden"][i]["NAME"]},typeof t["itemsHidden"][i]["TYPE"]!="undefined"?t["itemsHidden"][i]["TYPE"]:"sonetgroups","",true,"","init")}}}BX.SocNetLogDestination.BXfpSetLinkName({formName:window.BXSocNetLogDestinationFormName,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})}window["BXfpdSelectCallbackMent"+e]=function(i,n,o){window.BxInsertMention({item:i,type:n,formID:e,editorId:t.editorId,fireAddEvent:t.initDestination})};window["BXfpdStopMent"+e]=function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false};window["BXfpdOnDialogOpen"+e]=function(){d.listen=true;d.listenFlag=true};window["BXfpdOnDialogClose"+e]=function(){d.listen=false;setTimeout(function(){d.listenFlag=false;if(!d.listen){var e=a.getEditor(t.editorId);if(e){var i=e.GetIframeDoc(),n=i.getElementById("bx-mention-node");if(n){e.selection.SetAfter(n);if(d.leaveContent){e.util.ReplaceWithOwnChildren(n)}else{BX.remove(n)}}e.Focus()}}},100)};window["BXSocNetLogDestinationFormNameMent"+e]="mention"+(""+(new Date).getTime()).substr(5);window["BXSocNetLogDestinationDisableBackspace"]=null;var n=BX("bx-b-mention-"+e);if(!t.extranetUser&&typeof t.items.extranetRoot!="undefined"){t["items"]["departmentExtranet"]=BX.clone(t["items"]["department"]);for(var o in t["items"]["extranetRoot"]){if(t["items"]["extranetRoot"].hasOwnProperty(o)){t["items"]["departmentExtranet"][o]=t["items"]["extranetRoot"][o]}}t["items"]["departmentRelationExtranet"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["departmentExtranet"])}BX.SocNetLogDestination.init({name:window["BXSocNetLogDestinationFormNameMent"+e],searchInput:n,extranetUser:t.extranetUser,bindMainPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},bindSearchPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},callback:{select:window["BXfpdSelectCallbackMent"+e],openDialog:window["BXfpdOnDialogOpen"+e],closeDialog:window["BXfpdOnDialogClose"+e],openSearch:window["BXfpdOnDialogOpen"+e],closeSearch:window["BXfpdOnDialogClose"+e]},items:{users:t["items"]["mentionUsers"],groups:{},sonetgroups:{},department:typeof t["items"]["departmentExtranet"]!="undefined"?t["items"]["departmentExtranet"]:t["items"]["department"],departmentRelation:typeof t["items"]["departmentRelationExtranet"]!="undefined"?t["items"]["departmentRelationExtranet"]:t["items"]["departmentRelation"]},itemsLast:{users:t["itemsLast"]["mentionUsers"],sonetgroups:{},department:{},groups:{}},itemsSelected:{},destSort:typeof t["mentionDestSort"]!="undefined"&&t["mentionDestSort"]?t["mentionDestSort"]:{},departmentSelectDisable:true,obWindowClass:"bx-lm-mention",obWindowCloseIcon:false,useClientDatabase:!!t["useClientDatabase"],userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",showVacations:false,showSearchInput:BX.browser.IsMobile()});BX.ready(function(){var i=BX("bx-b-mention-"+e);if(BX.browser.IsIE()&&!BX.browser.IsIE9()){i.style.width="1px";i.style.marginRight="0"}BX.bind(i,"mousedown",function(n){if(d.listen!==true){var o=a.getEditor(t.editorId),s=o.GetIframeDoc();if(o.GetViewMode()=="wysiwyg"&&s){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;var r=o.selection.GetRange(),l=s.getElementById("bx-mention-node");if(l){BX.remove(l)}o.InsertHtml('<span id="bx-mention-node">'+o.INVISIBLE_SPACE+"</span>",r);setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}var t=s.getElementById("bx-mention-node");if(t){r.setStart(t,0);if(t.firstChild&&t.firstChild.nodeType==3&&t.firstChild.nodeValue.length>0){r.setEnd(t,1)}else{r.setEnd(t,0)}o.selection.SetSelection(r)}o.Focus()},100)}else if(o.GetViewMode()=="code"){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}},100)}BX.onCustomEvent(i,"mentionClick")}})})}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:71:"/bitrix/components/bitrix/system.field.edit/script.min.js?1469256124814";s:6:"source";s:53:"/bitrix/components/bitrix/system.field.edit/script.js";s:3:"min";s:57:"/bitrix/components/bitrix/system.field.edit/script.min.js";s:3:"map";s:57:"/bitrix/components/bitrix/system.field.edit/script.map.js";}"*/
function addElement(e,n){if(document.getElementById("main_"+e)){var d=document.getElementById("main_"+e).getElementsByTagName("div");if(d&&d.length>0&&d[0]){var t=d[0].parentNode;t.appendChild(d[d.length-1].cloneNode(true))}}}function addElementFile(e,n){var d=document.getElementById("main_"+e);var t=document.getElementById("main_add_"+e);if(d&&t){t=t.cloneNode(true);t.id="";t.style.display="";d.appendChild(t)}}function addElementDate(e,n){var d=document.getElementById("date_container_"+n);var t=document.getElementById("hidden_"+n).innerHTML;if(d&&t){var a=e[n].fieldName;var i=e[n].index;t=t.replace(/[#]FIELD_NAME[#]/g,a+"["+i+"]");t=t.replace(/[\%]23FIELD_NAME[\%]23/g,escape(a+"["+i+"]"));var l=d.appendChild(document.createElement("DIV"));l.innerHTML+=t;e[n].index++}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?150659522327464";s:6:"source";s:67:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.js";s:3:"min";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js";s:3:"map";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.map.js";}"*/
(function(e){var t=false,i=false,s=0,o=null,n=null,a={};BX.namespace("BX.Disk");if(BX.Disk.UF)return;BX.Disk.UF=function(){var t=function(t){this.dialogName="DiskFileDialog";this.params=t;this.CID=t["UID"];this.controller=t.controller;this.values=t.values||[];this.prefix="diskuf-doc";this.onUploaderIsAlmostInited=BX.delegate(this.onUploaderIsAlmostInited,this);BX.addCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);this.agent=BX.Uploader.getInstance({id:t["UID"],streams:3,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:t["urlUpload"],showImage:false,sortItems:false,input:t["input"],dropZone:t["dropZone"],placeHolder:t["placeHolder"],queueFields:{thumb:{tagName:"TR",className:"wd-inline-file"}},fields:{thumb:{tagName:"",template:BX.message("DISK_TMPLT_THUMB")}}});this.urlSelect=!!t["urlSelect"]?t["urlSelect"]:null;this.urlRenameFile=!!t["urlRenameFile"]?t["urlRenameFile"]:null;this.urlDeleteFile=!!t["urlDeleteFile"]?t["urlDeleteFile"]:null;this.urlSelect=this._addUrlParam(this.urlSelect,"dialog2=Y&ACTION=SELECT&MULTI=Y");this.urlUpload=!!t["urlUpload"]?t["urlUpload"]:null;this.urlShow=!!t["urlShow"]?t["urlShow"]:null;this.params.controlName=this.params.controlName||"FILES[]";this.init();return this};t.prototype={_addUrlParam:function(e,t){if(!e)return null;if(e.indexOf(t)==-1)e+=(e.indexOf("?")==-1?"?":"&")+t;return e},_camelToSNAKE:function(e){var t={},i,s;for(i in e){s=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[s]=e[i];t[i]=e[i]}return t},onUploaderIsAlmostInited:function(t,i){if(this.CID!=i["id"])return;BX.removeCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);var s=BX.findChild(this.controller,{className:"diskuf-simple"},true),o=BX.findChild(this.controller,{className:"diskuf-extended"},true);if(t=="BX.UploaderSimple"){BX.remove(o);BX.show(s)}else{BX.remove(s);BX.show(o)}i.input=BX.findChild(this.controller,{className:"diskuf-fileUploader"},true);i.dropZone=BX.findChild(this.controller,{className:"diskuf-extended"},false);this.params.placeHolder=i["placeHolder"]=BX.findChild(this.controller,{className:"diskuf-placeholder-tbody"},true)},init:function(){this._onItemIsAdded=BX.delegate(this.onItemIsAdded,this);this._onFileIsAppended=BX.delegate(this.onFileIsAppended,this);this._onFileIsAttached=BX.delegate(this.onFileIsAttached,this);this._onFileIsBound=BX.delegate(this.onFileIsBound,this);this._onFileIsInited=BX.delegate(this.onFileIsInited,this);this._onError=BX.delegate(this.onError,this);BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.addCustomEvent(this.agent,"onFileIsInited",this._onFileIsInited);BX.addCustomEvent(this.agent,"onError",this._onError);this._onUploadProgress=BX.delegate(this.onUploadProgress,this);this._onUploadDone=BX.delegate(this.onUploadDone,this);this._onUploadError=BX.delegate(this.onUploadError,this);this._onUploadRestore=BX.delegate(this.onUploadRestore,this);BX.onCustomEvent(BX(this.controller.parentNode),"DiskDLoadFormControllerInit",[this]);var e=[],t=[],i;for(var s=0;s<this.values.length;s++){i=BX.findChild(this.values[s],{className:"f-wrap"},true);if(!!i){e.push({name:i.innerHTML});t.push(this.values[s])}}this.values=[];this.agent.onAttach(e,t);var o=BX.findChild(this.controller,{className:"diskuf-selector-link"},true);if(!!o){BX.bind(o,"click",BX.proxy(this.showSelectDialog,this))}var n=BX.findChildren(this.controller,{className:"diskuf-selector-link-cloud"},true);if(!!n){for(var a in n){if(!n.hasOwnProperty(a))continue;BX.bind(n[a],"click",BX.proxy(this.showSelectDialogCloudImport,this))}}return false},addFile:function(e){return this.agent&&this.agent.onChange([e])},onItemIsAdded:function(){BX.removeCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.show(BX.findParent(this.params.placeHolder,{className:"diskuf-files-block"}))},onFileIsInited:function(e,t){BX.addCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.addCustomEvent(t,"onFileIsAfterCreated",function(e,t,i,s){if(t&&!t.sizeInt){e.size=" "}});BX.addCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.addCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.addCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.addCustomEvent(t,"onUploadDone",this._onUploadDone);BX.addCustomEvent(t,"onUploadError",this._onUploadError)},onFileIs:function(e,t,i){this.bindEventsHandlers(e,t,i);var s={element_id:i.element_id,element_name:i.element_name||t.name,element_url:i.element_name||i.previewUrl||i.preview_url,place:e,storage:"disk"};this.values.push(e);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadSuccess",[s,this,t.file,t]);t.__disk_element_id=i.element_id;BX.onCustomEvent(t,"OnFileUploadSuccess",[s,this])},onFileIsAppended:function(e,t){var i=this.agent.getItem(e),s=i.node;this.bindEventsHandlers(s,t,{})},onFileIsBound:function(e,t){var i=this.agent.getItem(e),s=i.node,o=s.getAttribute("id").replace("disk-edit-attach","");this.onFileIs(s,t,{element_id:o})},onFileIsAttached:function(e,t,i,s){if(!!s["sizeFormatted"])s["size"]=s["sizeFormatted"];if(!s.hasOwnProperty("service")){this.onUploadDone(t,{file:s});return}BX.Disk.ExternalLoader.startLoad({file:{id:s.id,name:s.name,service:s.service},onFinish:BX.delegate(function(e){var i=this.agent.getItem(t.id).node;BX.hide(i);var s={id:e.ufId,name:e.name,storage:e.storage,ext:t.ext,size:e.sizeFormatted,previewUrl:e.previewUrl,preview_url:e.previewUrl,element_url:e.previewUrl,size_int:parseInt(e.size,10)};var o;var n=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName);for(var a in s){o=s[a];if(s.hasOwnProperty(a)){if(a.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0||isNaN(s["size_int"])){o=""}}if(s.hasOwnProperty("SIZE_INT")||isNaN(s["SIZE_INT"])){if(parseInt(s["SIZE_INT"],10)==0){o=""}}}n=n.replace(new RegExp("#"+a.toLowerCase()+"#","gi"),o).replace(new RegExp("#"+a.toUpperCase()+"#","gi"),o)}}var l={id:"disk-edit-attach"+s.id,"bx-agentFileId":t.id},r;r=BX.create("TR",{attrs:l,props:{className:"wd-inline-file"},html:n});var d=BX.findChild(r,{className:"files-name-edit-btn"},true);if(d){BX.remove(d)}i.parentNode.insertBefore(r,i);s.element_id=s.id;this.agent.onAttach([s],[r]);t.deleteFile()},this),onProgress:BX.delegate(function(e){this.onUploadProgress(t,e)},this)})},onUploadProgress:function(e,t){t=Math.min(t,98);var i=e.id;if(!e.__progressBarWidth)e.__progressBarWidth=5;if(t>e.__progressBarWidth){e.__progressBarWidth=Math.ceil(t);e.__progressBarWidth=e.__progressBarWidth>100?100:e.__progressBarWidth;if(BX("wdu"+i+"Progressbar"))BX.adjust(BX("wdu"+i+"Progressbar"),{style:{width:e.__progressBarWidth+"%"}});if(BX("wdu"+i+"ProgressbarText"))BX.adjust(BX("wdu"+i+"ProgressbarText"),{text:e.__progressBarWidth+"%"})}},onUploadDone:function(e,t){if(t["file"]&&t["file"]["attachId"]&&t["file"]["attachId"]!=t["file"]["id"]){t["file"]["id"]=t["file"]["attachId"];delete t["file"]["attachId"]}var i=this.agent.getItem(e.id).node,s=this._camelToSNAKE(t["file"]);if(BX(i)){var o=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName),n;for(var a in s){if(s.hasOwnProperty(a)){n=s[a];if(a.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0){n=""}}if(s.hasOwnProperty("SIZE_INT")){if(parseInt(s["SIZE_INT"],10)==0){n=""}}}o=o.replace(new RegExp("#"+a.toLowerCase()+"#","gi"),n).replace(new RegExp("#"+a.toUpperCase()+"#","gi"),n)}}o=o.replace(new RegExp("#(width|height)#","gi"),"0").replace(new RegExp("#preview_url#","gi"),"javascript:void(0);");var l={id:"disk-edit-attach"+s.id,"bx-agentFileId":e.id},r;if(s["XML_ID"])l["bx-attach-xml-id"]=s["XML_ID"];if(s["FILE_ID"])l["bx-attach-file-id"]="n"+s["FILE_ID"];if(s["FILE_TYPE"])l["bx-attach-file-type"]=s["FILE_TYPE"];r=BX.create("TR",{attrs:l,props:{className:"wd-inline-file"},html:o});if(!t.file.canChangeName){var d=BX.findChild(r,{className:"files-name-edit-btn"},true);if(d){BX.remove(d)}}i.parentNode.replaceChild(r,i);s.element_id=s.id;this.onFileIs(r,e,s)}else{this.onUploadError(e,t,this.agent)}},onUploadError:function(e,t,i){var s=this.agent.getItem(e.id);if(!!s&&(s=s.node)&&BX(s)&&(i==true||!BX(s).hasAttribute("bx-disk-error"))){BX(s).setAttribute("bx-disk-error","Y");BX.adjust(s,{props:{className:"error-load"}});var o=t&&t["error"]?t["error"]:"Uploading error";s.cells[1].innerHTML="";s.cells[2].innerHTML='<span class="info-icon"></span><span class="error-text">'+o+"</span>";BX.onCustomEvent(e,"OnFileUploadFailed",[s,this]);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadFailed",[s,this,e.file,e])}},onError:function(e,t,i){var s="Uploading error.",o=s,n,a;if(i){if(i["error"]&&typeof i["error"]=="string")o=i["error"];else if(i["message"]&&typeof i["message"]=="string")o=i["message"];else if(BX.type.isArray(i["errors"])&&i["errors"].length>0){o=[];for(var l=0;l<i["errors"].length;l++){if(typeof i["errors"][l]=="object"&&i["errors"][l]["message"])o.push(i["errors"][l]["message"])}if(o.length<=0)o.push("Uploading error.");o=o.join(" ")}}e.files=e.files||{};for(a in e.files){if(e.files.hasOwnProperty(a)){n=this.agent.queue.items.getItem(a);this.onUploadError(n,{error:o},o!=s)}}},onBlurRenameInput:function(e){var t=e.target||e.srcElement;var i=BX.findChild(t.parentNode,{className:"files-name-edit-btn"},true);if(!!i)BX.fireEvent(i,"click")},bindEventsHandlers:function(t,i,s){var o=s.element_id,n="file-action-control",a=BX.findChild(t,{className:"files-path"},true),l=BX.findChild(t,{className:"files-name-edit-btn"},true),r=BX.findChild(t,{className:"f-wrap"},true);if(!!l&&!!a&&!!r&&!a.getAttribute(n)){a.setAttribute(n,"enabled");BX.show(a,"inline");BX.hide(BX.findChild(t,{className:"files-placement"},true));BX.bind(a,"click",BX.delegate(function(){this.move(o,r.innerHTML,t)},this))}if(!!l){BX.bind(l,"click",BX.delegate(function(){BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t)},this));var d=BX.findChild(t,{className:"files-name-edit-inp"},true);if(d){BX.bind(d,"keydown",BX.delegate(function(i){var s=(i||e.event).keyCode||(i||e.event).charCode;if(s==13){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t);return BX.PreventDefault(i)}if(s==27){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.revertRename(o,t);return BX.PreventDefault(i)}},this))}}var h=BX.findChild(t,{className:"feed-add-post-loading"},true),u=BX.delegate(function(){this.deleteFile(t,i)},this),c=BX.create("SPAN",{props:{className:"del-but"},events:{click:u}});if(!!h){var m=BX.findChild(h,{className:"del-but"},true);if(!!m)BX.bind(m,"click",u);else h.appendChild(c.cloneNode(true))}if(!BX.findChild(t,{className:"files-info"},true)){t.appendChild(BX.create("TD",{props:{className:"files-info"}}))}if(!BX.findChild(t,{className:"files-del-btn"},true)){t.appendChild(BX.create("TD",{props:{className:"files-del-btn"},children:[c]}))}if(!c.hasAttribute("bx-bound")){c.setAttribute("bx-bound","Y");BX.bind(c,"click",u);BX.onCustomEvent(t,"OnMkClose",[t])}},deleteFile:function(e,t){if(!!t.__disk_element_id){BX.Disk.ajax({url:this.urlDeleteFile,method:"POST",dataType:"json",data:{attachedId:t.__disk_element_id},onsuccess:function(e){}});BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[t.__disk_element_id,this])}BX.removeCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.removeCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.removeCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.removeCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.removeCustomEvent(t,"onUploadDone",this._onUploadDone);BX.removeCustomEvent(t,"onUploadError",this._onUploadError);delete t.hash;t.deleteFile("deleteFile");BX.remove(e)},move:function(e,t,i){var s=this._addUrlParam(this.urlSelect.replace("ACTION=SELECT","").replace("MULTI=Y",""),"ID=E"+e+"&NAME="+t+"&wish=fakemove");while(s.indexOf("&&")>=0)s=s.replace("&&","&");if(!this._checkFileName){this._checkFileName=BX.proxy(this.checkFileName,this);this._selectFolder=BX.proxy(this.selectFolder,this);this._openSection=BX.proxy(this.openSection,this);this._selectItem=BX.proxy(this.selectItem,this);this._unSelectItem=BX.proxy(this.unSelectItem,this)}var o=i||BX("disk-edit-attach"+e),n=BX.findChild(o,{className:"f-wrap"},true);BX.DiskFileDialog.arParams={};BX.DiskFileDialog.arParams[this.dialogName]={element_id:e,element_name:n.innerHTML};BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.addCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.addCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem);return BX.ajax.get(s,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFolder};BX.DiskFileDialog.openDialog(this.dialogName)},this),100)},this))},rename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var n=o.textContent||o.innerText;var a=n.split(".").pop();var l=s.value+"."+a;if(!!i){BX.focus(s);BX.bind(s,"blur",BX.proxy(this.onBlurRenameInput,this))}else if(s.value&&l!==n){BX.adjust(o,{text:l});var r=t.getAttribute("bx-agentFileId");var d=r?this.agent.getItem(r):null;if(!!d){d.item.file.name=l;d.item.name=l}var h=this.manager?this.manager.checkFile("disk_file"+e):null;if(!!h){h.name=l}BX.Disk.ajax({url:this.urlRenameFile,method:"POST",dataType:"json",data:{newName:l,attachedId:e},onsuccess:function(e){}})}},revertRename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var n=o.textContent||o.innerText;var a=n.split(".");var l=a.pop();s.value=a.join(".")},showMovedFile:function(e,t,i){if(!e)return false;var s,o=e,n=BX("disk-edit-attach"+o),a=BX.findChild(n,{className:"files-path"},true);BX.cleanNode(a);i=i.split("/").join(" / ");a.innerHTML=i;var l=parseInt(a.offsetWidth);var r=parseInt(a.parentNode.offsetWidth)-150,d;s=r/(l/i.length);if(l>r){d=Math.floor(s/2)+1;i=i.substr(0,d)+" ... "+i.substr(i.length-d);a.innerHTML=i}var h=BX("diskuf-doc"+o);if(!!h){var u=this._fileUnserialize(h.value);u.section=t["sectionID"];u.iblock=t["iblockID"];h.value=this._fileSerialize(u)}return true},_fileUnserialize:function(e){if(!BX.type.isString(e))return false;var t=e.split("|");return{id:t[0]||0,section:t[1]||0,iblock:t[2]||0}},_fileSerialize:function(e){var t=[e.id,e.section,e.iblock];return t.join("|")},selectFolder:function(e,t,i,s){var o=false,n=false,a,l,r;if(BX.DiskFileDialog.arParams&&BX.DiskFileDialog.arParams[this.dialogName]&&BX.DiskFileDialog.arParams[this.dialogName]["element_id"])o=BX.DiskFileDialog.arParams[this.dialogName]["element_id"];var d=BX.delegate(function(e,t,i,s){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","moveUploadedFile"),data:{attachedId:e,targetFolderId:t},onsuccess:BX.delegate(function(t){if(!t||t.status!="success"){BX.Disk.showModalWithStatusAction(t);return}this.showMovedFile(e,i,s)},this)})},this);for(a in i){if(i.hasOwnProperty(a)&&i[a].type==="folder"){l=e.name+i[a].path;r={sectionID:a,iblockID:e.iblock_id};d(o,i[a].id,r,l);n=true}}if(!n){l=e.name;r={sectionID:e.section_id,iblockID:e.iblock_id};if(!!s&&!!s.path&&s.path!="/"){l+=s.path;r.sectionID=s.id;if(!!s){d(o,s.id,r,l)}}}BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.removeCustomEvent(BX.DiskFileDialog,"loadItemsDone",this._checkFileName);BX.removeCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.removeCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem)},checkFileName:function(e){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}if(!!e&&e!=this.dialogName)return;var t=BX.DiskFileDialog.arParams[this.dialogName]["element_name"];var i=false,s;for(s in BX.DiskFileDialog.obItems[this.dialogName]){if(BX.DiskFileDialog.obItems[this.dialogName].hasOwnProperty(s)){if(BX.DiskFileDialog.obItems[this.dialogName][s]["name"]==t)i=true;if(i)break}}if(i)BX.DiskFileDialog.showNotice(BX.message("DISK_FILE_EXISTS"),this.dialogName);else BX.DiskFileDialog.closeNotice(this.dialogName)},selectItem:function(e,t,i){if(i!=this.dialogName)return;var s=t.substr(1);var o=BX.DiskFileDialog.obCurrentTab[i].link;o=o.replace("/index.php","")+"/element/upload/"+s+"/?use_light_view=Y&AJAX_CALL=Y&SIMPLE_UPLOAD=Y&IFRAME=Y&sessid="+BX.bitrix_sessid()+"&SECTION_ID="+s+"&CHECK_NAME="+BX.DiskFileDialog.arParams[this.dialogName]["element_name"];o=o.replace("/files/lib/","/files/");BX.ajax.loadJSON(o,BX.delegate(function(e){var t=e.permission===true&&e["okmsg"]!="";if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){if(t){BX.DiskFileDialog.showNotice(this.msg.file_exists,this.dialogName)}else{BX.DiskFileDialog.closeNotice(this.dialogName)}},this),200)},this))},unSelectItem:function(){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){this.checkFileName()},this),200)},openSection:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y")}},openSectionCloud:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y");BX.DiskFileDialog.target[t]=this._addUrlParam(BX.DiskFileDialog.target[t],"cloudImport=1")}},selectFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},selectCloudFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){if(i[o].hasOwnProperty("provider")){i[o].service=i[o].provider}else{i[o].service=n}i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},showSelectDialog:function(){this._openSection=BX.proxy(this.openSection,this);this._selectFile=BX.proxy(this.selectFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))},showSelectDialogCloudImport:function(e){var t=e.target||e.srcElement;if(!BX.hasClass(t,"diskuf-selector-link-cloud")){t=BX.findParent(t,{className:"diskuf-selector-link-cloud"})}if(!t||!t.getAttribute("data-bx-doc-handler"))return;n=t.getAttribute("data-bx-doc-handler");this._openSection=BX.proxy(this.openSectionCloud,this);this._selectFile=BX.proxy(this.selectFile,this);this._selectCloudFile=BX.proxy(this.selectCloudFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"&cloudImport=1&service="+n+"&dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectCloudFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))}};return t}();BX.Disk.UF.dndCatcher={};BX.Disk.UF.add=function(e){e["controller"]=BX("diskuf-selectdialog-"+e["UID"]);if(e["controller"]&&BX.isNodeInDom(e["controller"])){e["values"]=BX.findChildren(e["controller"],{className:"wd-inline-file"},true);var t=BX(e["controller"]).parentNode;BX.onCustomEvent(e["controller"],"DiskLoadFormControllerWasBound",[e,"DiskLoadFormControllerWasBound"]);if(!BX(e["controller"]).hasAttribute("bx-disk-load-is-bound")){BX(e["controller"]).setAttribute("bx-disk-load-is-bound","Y");BX.addCustomEvent(t,"DiskLoadFormController",function(t){BX.Disk.UF.initialize(t,e)})}if(!!e["values"]&&e["values"].length>0&&!e["hideSelectDialog"])BX.onCustomEvent(e["controller"].parentNode,"DiskLoadFormController",["show"])}};BX.Disk.UF.initialize=function(e,t){e=e==="show"||e==="hide"?e:t["controller"].style.display!="none"?"hide":"show";if(!t["controller"].loaded){t["controller"].loaded=true;a[t["UID"]]=new BX.Disk.UF(t)}if(e=="show"){if(t["controller"].style.display!="block"){BX.fx.show(t["controller"],"fade",{time:.2});if(t["switcher"]&&t["switcher"].style.display!="none")BX.fx.hide(t["switcher"],"fade",{time:.1});BX.onCustomEvent(t["controller"],"onControllerIsShown",[t["controller"],a[t["UID"]]]);o=a[t["UID"]]}}else if(t["controller"].style.display!="none"){o=null;BX.fx.hide(t["controller"],"fade",{time:.2});BX.onCustomEvent(t["controller"],"onControllerIsHidden",[t["controller"],a[t["UID"]]])}return a[t["UID"]]};var l=function(e){if(!BX(e)||e.hasAttribute("bx-is-bound"))return;e.setAttribute("bx-is-bound","Y");this.img=e;this.node=e.parentNode.parentNode.parentNode;BX.unbindAll(e);BX.unbindAll(this.node);BX.show(this.node);BX.remove(this.node.nextSibling);this.id="wufdp_"+Math.random();BX.bind(this.node,"mouseover",BX.delegate(function(){this.turnOn()},this));BX.bind(this.node,"mouseout",BX.delegate(function(){this.turnOff()},this))};l.prototype={turnOn:function(){this.timeout=setTimeout(BX.delegate(function(){this.show()},this),500)},turnOff:function(){clearTimeout(this.timeout);this.timeout=null;this.hide()},show:function(){if(this.popup!=null)this.popup.close();if(this.popup==null){var e={width:this.img.naturalWidth,height:this.img.naturalHeight};if(BX["UploaderUtils"]){var t=BX.UploaderUtils.scaleImage(e,{width:parseInt(BX.message("DISK_THUMB_WIDTH")),height:parseInt(BX.message("DISK_THUMB_HEIGHT"))});e=t.destin}this.popup=new BX.PopupWindow("bx-wufd-preview-img-"+this.id,this.img.parentNode,{lightShadow:true,offsetTop:-7,offsetLeft:(51-28)/2+14,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popup=null},this)},content:BX.create("DIV",{props:e,children:[BX.create("IMG",{props:e,attrs:{src:this.img.src}})]})});this.popup.show()}this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false},hide:function(){if(this.popup!=null)this.popup.close()}};BX.addCustomEvent("onDiskPreviewIsReady",function(e){new l(e)});BX.Disk.UF.runImport=function(e){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_PROCESS_LOADING"),showLoaderIcon:true,autoHide:false});BX.Disk.ExternalLoader.reloadLoadAttachedObject({attachedObject:{id:e.id,name:e.name,service:e.service},onFinish:BX.delegate(function(e){if(e.hasOwnProperty("hasNewVersion")&&!e.hasNewVersion){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_HAS_LAST_VERSION"),showSuccessIcon:true,autoHide:true})}else if(e.status==="success"){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_SUCCESS_LOADING"),showSuccessIcon:true,autoHide:true})}else{BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_FAIL_LOADING"),autoHide:true})}},this),onProgress:BX.delegate(function(e){},this)}).start()};BX.Disk.UF.disableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","disableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};BX.Disk.UF.enableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","enableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};e.DiskCreateDocument=function(e){if(!o){return false}if(!e){return false}var t=new BX.CViewer({createDoc:true});var i=t.createBlankElementByParams({docType:e,editUrl:BX.message("DISK_CREATE_BLANK_URL"),renameUrl:BX.message("DISK_RENAME_FILE_URL")});t.setCurrent(i);i.afterSuccessCreate=function(e){var t={};var i=e.name.split(".");i.pop();t["E"+e.objectId]={type:"file",id:"n"+e.objectId,name:e.name,label:i.join("."),storage:e.folderName,size:e.size,sizeInt:e.sizeInt,ext:e.extension,canChangeName:true,link:e.link};setTimeout(function(){o.selectFile({},{},t)},200)};t.runActionByCurrentElement("create",{obElementViewer:t});try{BX.PreventDefault()}catch(s){}return false};e.DiskOpenMenuCreateService=function(e){var t=new BX.CViewer({});t.openMenu("disk_open_menu_with_services",BX(e),[BX.CViewer.isDisabledLocalEdit?null:{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT"),className:"bx-viewer-popup-item item-b24",href:"#",onclick:BX.delegate(function(t){if(BX.CViewer.isEnableLocalEditInDesktop()){this.setEditService("l");BX.adjust(e,{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT")});BX.PopupMenu.destroy("disk_open_menu_with_services")}else{this.helpDiskDialog()}return BX.PreventDefault(t)},t)},{text:t.getNameEditService("google"),className:"bx-viewer-popup-item item-gdocs",href:"#",onclick:BX.delegate(function(t){this.setEditService("google");BX.adjust(e,{text:this.getNameEditService("google")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("office365"),className:"bx-viewer-popup-item item-office365",href:"#",onclick:BX.delegate(function(t){this.setEditService("office365");BX.adjust(e,{text:this.getNameEditService("office365")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("skydrive"),className:"bx-viewer-popup-item item-office",href:"#",onclick:BX.delegate(function(t){this.setEditService("skydrive");BX.adjust(e,{text:this.getNameEditService("skydrive")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)}],{offsetTop:0,offsetLeft:25})};e.DiskOpenMenuImportService=function(e,t){var i=[];for(var s in t){if(!t.hasOwnProperty(s))continue;i.push({text:t[s].name,code:t[s].id,href:"#",onclick:function(e,t){var i=t.layout.item;BX.addClass(i,"diskuf-selector-link-cloud");i.setAttribute("data-bx-doc-handler",t.code);BX.onCustomEvent("onManualChooseCloudImport",[{target:i}]);BX.removeClass(i,"diskuf-selector-link-cloud");i.removeAttribute("data-bx-doc-handler");BX.PopupMenu.destroy("disk_open_menu_with_import_services");return BX.PreventDefault(e)}})}var o=new BX.CViewer({});o.openMenu("disk_open_menu_with_import_services",BX(e),i,{offsetTop:0,offsetLeft:25});return BX.PreventDefault()};e.DiskActionFileMenu=function(e,t,i){s++;BX.PopupMenu.show("bx-viewer-wd-popup"+s+"_"+e,BX(t),i,{angle:{position:"top",offset:25},autoHide:true});return false};e.WDInlineElementClickDispatcher=function(e,t){var i=BX(t);if(i){BX.fireEvent(i,"click")}return false}})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.urlpreview/templates/.default/script.min.js?15145718454537";s:6:"source";s:70:"/bitrix/components/bitrix/main.urlpreview/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
var BXUrlPreview=function(e){this.element=e;this.inputElement=null;this.id=this.element.id;this.carouselElement=null;this.carouselImages=[];this.currentImageId=null;this.init()};BXUrlPreview.prototype.init=function(){this.inputElement=this.element.querySelector(".urlpreview__ufvalue");this.initCarousel();this.bindEventHandlers()};BXUrlPreview.prototype.detachUrlPreview=function(){if(this.inputElement){this.inputElement.value=""}this.element.style.display="none"};BXUrlPreview.prototype.attachUrlPreview=function(e){var t,i;if(this.element.style.display!=="none"){return}i=this.element.getAttribute("data-field-id");requestParams={action:"attachUrlPreview",userFieldId:i,elementId:this.id,sessid:BX.bitrix_sessid()};if(e.hasOwnProperty("url"))requestParams.url=e.url;else if(e.hasOwnProperty("id"))requestParams.id=e.id;else return;BX.ajax({url:"/bitrix/components/bitrix/main.urlpreview/ajax.php",method:"POST",data:requestParams,onsuccess:function(e){if(e.length>0){var t=document.createElement("div");var i=this.element.style.cssText;t.innerHTML=e;var r=t.firstElementChild;this.element.parentNode.replaceChild(r,this.element);this.element=r;this.element.style.cssText=i;this.element.style.removeProperty("display");this.init()}}.bind(this)})};BXUrlPreview.prototype.bindEventHandlers=function(){var e=this;var t=this.element.querySelector(".urlpreview__detach");if(t){t.addEventListener("click",e.detachUrlPreview.bind(e))}var i=this.element.querySelector(".urlpreview__container-switchable");if(i){i.addEventListener("click",BXUrlPreview.showEmbed)}if(this.carouselElement){var r=this.carouselElement.querySelector(".urlpreview__button-prev");var l=this.carouselElement.querySelector(".urlpreview__button-next");if(r)r.addEventListener("click",e.previousImage.bind(e));if(l)l.addEventListener("click",e.nextImage.bind(e))}};BXUrlPreview.prototype.initCarousel=function(){var e;var t;var i;var r;if(e=this.element.querySelector(".urlpreview__carousel")){this.carouselElement=e;t=e.querySelectorAll(".urlpreview__image");for(i=0;i<t.length;i++){t[i].dataset.imageId=i;this.carouselImages[i]=t[i]}r=this.element.dataset.imageId?parseInt(this.element.dataset.imageId):0;this.setCarouselImage(r);this.carouselElement.style.removeProperty("display")}};BXUrlPreview.prototype.setCarouselImage=function(e){var t;var i;var r;if(!(e>=0||e<=this.carouselImages.length-1))return null;this.carouselImages.map(function(e){e.style.display="none"});this.carouselImages[e].style.removeProperty("display");if(i=this.carouselImages[e].querySelector("img")){t=i.getAttribute("src");if(this.inputElement){r=this.inputElement.value.split(";");this.inputElement.value=r[0]+";"+t}}this.currentImageId=e};BXUrlPreview.prototype.nextImage=function(){var e=this.currentImageId+1;if(e>this.carouselImages.length-1)e=0;this.setCarouselImage(e)};BXUrlPreview.prototype.previousImage=function(){var e=this.currentImageId-1;if(e<0)e=this.carouselImages.length-1;this.setCarouselImage(e)};BXUrlPreview.showEmbed=function(){if(BX.hasClass(this,"urlpreview__container-hide-embed")){BX.addClass(this,"urlpreview__container-hide-image");BX.removeClass(this,"urlpreview__container-hide-embed");var e=BX.findChildByClassName(this,"video-js");if(e){if(BX.getClass("BX.Fileman.PlayerManager")){var t=BX.Fileman.PlayerManager.getPlayerById(e.getAttribute("id"));if(t){t.play()}}}else{var i=BX.findChildByClassName(this,"urlpreview-iframe-html-embed");if(i){BXUrlPreview.adjustFrameHeight(i,5)}}}};BXUrlPreview.bindEmbedHandler=function(){var e=document.querySelectorAll(".urlpreview__container-switchable");var t;for(t=0;t<e.length;t++){e.item(t).addEventListener("click",BXUrlPreview.showEmbed)}};BXUrlPreview.adjustFrameHeight=function(e,t){if(BX.hasClass(e,"urlpreview-iframe-html-embed-adjusted")){return}t=t||0;if(t>10){return}var i=50;if(e.contentWindow.document.body.scrollHeight>e.height){e.height=e.contentWindow.document.body.scrollHeight+i+"px";BX.addClass(e,"urlpreview-iframe-html-embed-adjusted");return}var r=e.contentWindow.document.getElementsByTagName("video");if(r[0]){e.height=e.contentWindow.document.body.scrollHeight+i+"px";BX.addClass(e,"urlpreview-iframe-html-embed-adjusted");return}else{var l=e.contentWindow.document.getElementsByTagName("iframe");if(l[0]&&l[0].height>0){e.height=l[0].height+i;BX.addClass(e,"urlpreview-iframe-html-embed-adjusted")}else if(l[0]&&l[0].style.height){e.height=l[0].style.height+i;BX.addClass(e,"urlpreview-iframe-html-embed-adjusted")}else{setTimeout(function(){t++;BXUrlPreview.adjustFrameHeight(e,t)},500)}}};
/* End */
;; /* /local/components/micros/knowledge.base/templates/.default/script.js?151332154410509*/
; /* /local/components/micros/knowledge.breadcrumbs/templates/.default/script.min.js?14444693623353*/
; /* /local/components/micros/knowledge.base.folder.content/templates/.default/script.js?150398876020258*/
; /* /local/components/micros/knowledge.base/js/editormd.js?1497875504165100*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/script.min.js?151124257227443*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/action-panel.min.js?150459572111207*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/resize.min.js?14980344533275*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/baseclass.min.js?1491454246207*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows.min.js?14988222185401*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/cols-sortable.min.js?14980344535340*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window-column.min.js?15145717862950*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/data.min.js?15145717865232*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown-manager.min.js?1491454246996*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-panel.min.js?14980344534993*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/dropdown.min.js?14950213673586*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings-window.min.js?15145718318369*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/element.min.js?1498034453857*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/settings.min.js?15112425725162*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/fader.min.js?15045957215868*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/gridupdater.min.js?15096143322660*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/inline-editor.min.js?15096143325273*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/useroptions.min.js?14980344532994*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/loader.min.js?15096143322398*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/manager.min.js?1492513428903*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/utils.min.js?15096143322120*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/message.min.js?14980344531571*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/observer.min.js?1492513428175*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagesize.min.js?1495021367593*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/pagination.min.js?1491454246842*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/pin-header.min.js?15096143323104*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/row.min.js?151124257214764*/
; /* /bitrix/components/bitrix/main.ui.grid/templates/.default/js/rows-sortable.min.js?149803445310600*/
; /* /bitrix/components/bitrix/forum.comments/templates/.default/script.min.js?1453385126678*/
; /* /bitrix/components/bitrix/main.post.list/templates/.default/script.min.js?151457184536636*/
; /* /bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_form.min.js?149502136714797*/
; /* /bitrix/components/bitrix/main.post.list/templates/.default/scripts_for_im.min.js?15096143588146*/
; /* /bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?151457178766416*/
; /* /bitrix/components/bitrix/system.field.edit/script.min.js?1469256124814*/
; /* /bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?150659522327464*/
; /* /bitrix/components/bitrix/main.urlpreview/templates/.default/script.min.js?15145718454537*/

//# sourceMappingURL=page_0f5587a18de9898e223f52c553ddd8a4.map.js